<% @page_title = "Rejoindre Trayo" %>

<div class="mx-auto w-full max-w-4xl">
  <%= form_with url: onboarding_next_step_path(code: @invitation.code), method: :post, local: true, id: "onboarding-form" do |f| %>
    <div data-controller="stepper"
         data-stepper-current-step-value="<%= [@invitation.step - 1, 0].max %>"
         data-stepper-validate-on-next-value="true"
         data-stepper-save-progress-value="true"
         data-stepper-storage-key-value="trayo-onboarding-<%= @invitation.code %>">
      
      <!-- Step Indicators -->
      <div class="max-w-sm mx-auto mb-6 md:mb-12 md:max-w-lg">
        <ul class="relative flex flex-row gap-x-2">
          <% steps = ["Bienvenue", "Avantages", "Offre", "Compte", "Broker", "Paiement"] %>
          <% steps.each_with_index do |label, index| %>
            <li class="group relative shrink flex-1 last:flex-none">
              <div class="w-full inline-flex items-center align-middle text-xs">
                <div class="relative inline-flex flex-col items-center">
                  <button type="button" data-stepper-target="indicator" data-action="click->stepper#goToStep" data-step="<%= index %>" class="flex size-6 shrink-0 items-center justify-center rounded-full text-sm font-semibold md:size-7">
                    <span class="step-number"><%= index + 1 %></span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="step-check hidden size-4" width="12" height="12" viewBox="0 0 12 12"><g fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" stroke="currentColor"><path d="m1.75,6c1.047,1.048,1.803,2.153,2.461,3.579,1.524-3.076,3.659-5.397,6.039-7.158"></path></g></svg>
                  </button>
                  <span class="absolute top-10 hidden text-xs font-medium whitespace-nowrap text-neutral-600 md:block dark:text-neutral-400"><%= label %></span>
                </div>
                <div data-stepper-target="line" class="ms-2 h-0.5 w-full flex-1 group-last:hidden"></div>
              </div>
            </li>
          <% end %>
        </ul>
      </div>

      <!-- Step Content -->
      <div class="min-h-[500px] rounded-xl border border-black/10 bg-white p-6 md:p-8 dark:border-white/10 dark:bg-neutral-900">
        
        <!-- Step 1: Bienvenue -->
        <div data-stepper-target="step" class="hidden">
          <h2 class="mb-2 text-xl font-bold text-neutral-900 dark:text-white">Bienvenue chez Trayo</h2>
          <p class="mb-6 text-sm text-neutral-600 dark:text-neutral-400">D√©couvrez le trading automatis√© en quelques points</p>

          <div class="space-y-4">
            <div class="rounded-lg bg-neutral-50 p-4 dark:bg-neutral-800">
              <div class="flex items-start gap-4">
                <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/30 shrink-0">
                  <i class="fa-solid fa-robot text-blue-600 dark:text-blue-400"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-neutral-900 dark:text-white mb-1">Trading 100% Automatis√©</h3>
                  <p class="text-sm text-neutral-600 dark:text-neutral-400">Nos robots tradent pour vous 24h/24, 7j/7 sur les march√©s financiers.</p>
                </div>
              </div>
            </div>

            <div class="rounded-lg bg-neutral-50 p-4 dark:bg-neutral-800">
              <div class="flex items-start gap-4">
                <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 shrink-0">
                  <i class="fa-solid fa-shield-halved text-emerald-600 dark:text-emerald-400"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-neutral-900 dark:text-white mb-1">Vos fonds restent chez vous</h3>
                  <p class="text-sm text-neutral-600 dark:text-neutral-400">Votre argent reste sur votre compte broker. Nous n'avons jamais acc√®s √† vos fonds.</p>
                </div>
              </div>
            </div>

            <div class="rounded-lg bg-neutral-50 p-4 dark:bg-neutral-800">
              <div class="flex items-start gap-4">
                <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-amber-100 dark:bg-amber-900/30 shrink-0">
                  <i class="fa-solid fa-chart-line text-amber-600 dark:text-amber-400"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-neutral-900 dark:text-white mb-1">Performance transparente</h3>
                  <p class="text-sm text-neutral-600 dark:text-neutral-400">Suivez vos trades et performances en temps r√©el depuis votre tableau de bord.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2: Avantages -->
        <div data-stepper-target="step" class="hidden">
          <h2 class="mb-2 text-xl font-bold text-neutral-900 dark:text-white">Pourquoi choisir Trayo ?</h2>
          <p class="mb-6 text-sm text-neutral-600 dark:text-neutral-400">Les avantages qui font la diff√©rence</p>

          <div class="space-y-4">
            <div class="rounded-lg bg-neutral-50 p-4 dark:bg-neutral-800">
              <div class="flex items-center gap-3 mb-2">
                <i class="fa-solid fa-check-circle text-emerald-500"></i>
                <h3 class="font-semibold text-neutral-900 dark:text-white">VPS D√©di√© inclus</h3>
              </div>
              <p class="text-sm text-neutral-600 dark:text-neutral-400 ml-7">Un serveur d√©di√© pour faire tourner vos robots 24h/24 sans interruption.</p>
            </div>

            <div class="rounded-lg bg-neutral-50 p-4 dark:bg-neutral-800">
              <div class="flex items-center gap-3 mb-2">
                <i class="fa-solid fa-check-circle text-emerald-500"></i>
                <h3 class="font-semibold text-neutral-900 dark:text-white">Support prioritaire</h3>
              </div>
              <p class="text-sm text-neutral-600 dark:text-neutral-400 ml-7">Une √©quipe d√©di√©e pour vous accompagner dans votre exp√©rience de trading.</p>
            </div>

            <div class="rounded-lg bg-neutral-50 p-4 dark:bg-neutral-800">
              <div class="flex items-center gap-3 mb-2">
                <i class="fa-solid fa-check-circle text-emerald-500"></i>
                <h3 class="font-semibold text-neutral-900 dark:text-white">Commission sur profits uniquement</h3>
              </div>
              <p class="text-sm text-neutral-600 dark:text-neutral-400 ml-7">Nous ne gagnons que si vous gagnez. Aucune commission sur vos pertes.</p>
            </div>

            <div class="rounded-lg bg-neutral-50 p-4 dark:bg-neutral-800">
              <div class="flex items-center gap-3 mb-2">
                <i class="fa-solid fa-check-circle text-emerald-500"></i>
                <h3 class="font-semibold text-neutral-900 dark:text-white">Bots test√©s et optimis√©s</h3>
              </div>
              <p class="text-sm text-neutral-600 dark:text-neutral-400 ml-7">Tous nos robots sont backtest√©s et optimis√©s avant mise en production.</p>
            </div>
          </div>
        </div>

        <!-- Step 3: Choix de l'offre -->
        <div data-stepper-target="step" class="hidden" data-validate-offer="true">
          <h2 class="mb-2 text-xl font-bold text-neutral-900 dark:text-white">Choisissez votre formule</h2>
          <p class="mb-6 text-sm text-neutral-600 dark:text-neutral-400">Deux options pour d√©marrer votre aventure trading</p>

          <div id="offer-error" class="hidden mb-4 p-3 rounded-lg bg-red-500/10 border border-red-500/20 text-red-400 text-sm">
            <i class="fa-solid fa-exclamation-circle mr-2"></i>
            Veuillez s√©lectionner une offre
          </div>

          <!-- Toggle Abonnement / Licence -->
          <div class="flex items-center justify-center gap-2 mb-6 p-1.5 rounded-xl bg-neutral-100 dark:bg-neutral-800">
            <button type="button" id="toggle-subscription" class="flex-1 px-4 py-2.5 rounded-lg text-sm font-medium transition-colors bg-gradient-to-r from-emerald-500 to-teal-500 text-white shadow-sm">
              üöÄ Abonnements tout inclus
            </button>
            <button type="button" id="toggle-licence" class="flex-1 px-4 py-2.5 rounded-lg text-sm font-medium transition-colors text-neutral-500 dark:text-neutral-400 hover:text-neutral-700 dark:hover:text-neutral-200">
              üíé Licences √† vie
            </button>
          </div>

          <!-- Section Licences -->
          <div id="section-licence" class="hidden space-y-4">
            <div class="p-4 rounded-lg bg-gradient-to-r from-blue-500/10 to-purple-500/10 border border-blue-500/20 dark:border-blue-500/30 mb-4">
              <p class="text-sm text-blue-700 dark:text-blue-300">
                <i class="fa-solid fa-infinity mr-2"></i>
                <strong>Achat unique</strong> ‚Äî Payez une fois, utilisez √† vie. Id√©al pour un investissement long terme.
              </p>
            </div>

            <div class="grid gap-3 max-h-[280px] overflow-y-auto pr-2">
              <% @trading_bots.each do |bot| %>
                <label class="flex items-center gap-4 p-4 rounded-lg bg-neutral-50 dark:bg-neutral-800 cursor-pointer hover:bg-neutral-100 dark:hover:bg-neutral-700 transition-colors border border-transparent hover:border-neutral-200 dark:hover:border-neutral-600">
                  <input type="checkbox" name="selected_bots[]" value="<%= bot.id %>" data-price="<%= bot.price %>" data-bot-checkbox class="size-5 rounded border-neutral-300 dark:border-neutral-600 text-blue-600 focus:ring-blue-500">
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between">
                      <span class="font-medium text-neutral-900 dark:text-white"><%= bot.name %></span>
                      <span class="font-bold text-neutral-900 dark:text-white"><%= number_to_currency(bot.price, unit: "‚Ç¨", format: "%n%u") %></span>
                    </div>
                    <p class="text-sm text-neutral-500 dark:text-neutral-400 truncate"><%= bot.description %></p>
                  </div>
                </label>
              <% end %>
            </div>

            <div class="mt-4 space-y-2">
              <div class="flex items-center justify-between p-3 rounded-lg bg-neutral-50 dark:bg-neutral-800">
                <span class="text-neutral-600 dark:text-neutral-400">Total Bots</span>
                <span class="font-bold text-neutral-900 dark:text-white" data-bots-total>0 ‚Ç¨</span>
              </div>
              <div class="flex items-center justify-between p-3 rounded-lg bg-neutral-50 dark:bg-neutral-800">
                <span class="text-neutral-600 dark:text-neutral-400">VPS D√©di√©</span>
                <span class="font-bold text-neutral-900 dark:text-white">399.99 ‚Ç¨/an</span>
              </div>
            </div>
          </div>

          <!-- Section Abonnements -->
          <div id="section-subscription" class="space-y-4">
            <div class="p-4 rounded-lg bg-gradient-to-r from-emerald-500/10 to-teal-500/10 border border-emerald-500/20 dark:border-emerald-500/30 mb-4">
              <p class="text-sm text-emerald-700 dark:text-emerald-300">
                <i class="fa-solid fa-rocket mr-2"></i>
                <strong>Tout inclus</strong> ‚Äî Bots + VPS + Mises √† jour + Support prioritaire. Sans engagement.
              </p>
            </div>

            <div class="grid gap-4">
              <!-- Starter -->
              <label class="relative flex flex-col p-5 rounded-xl cursor-pointer transition-all border-2 hover:shadow-lg subscription-card" data-plan="starter">
                <input type="radio" name="subscription_plan" value="starter" data-price="99" class="sr-only subscription-radio">
                <div class="absolute top-4 right-4">
                  <div class="w-5 h-5 rounded-full border-2 border-neutral-300 dark:border-neutral-600 subscription-check flex items-center justify-center">
                    <div class="w-2.5 h-2.5 rounded-full bg-white scale-0 transition-transform"></div>
                  </div>
                </div>
                <div class="flex items-center gap-3 mb-3">
                  <span class="text-2xl">ü•â</span>
                  <div>
                    <h4 class="font-bold text-lg text-neutral-900 dark:text-white">Starter</h4>
                    <p class="text-sm text-neutral-500 dark:text-neutral-400">Pour d√©buter sereinement</p>
                  </div>
                </div>
                <div class="flex items-baseline gap-1 mb-4">
                  <span class="text-3xl font-bold text-neutral-900 dark:text-white">99‚Ç¨</span>
                  <span class="text-neutral-500 dark:text-neutral-400">/mois</span>
                </div>
                <ul class="space-y-2 text-sm">
                  <li class="flex items-center gap-2 text-neutral-600 dark:text-neutral-300">
                    <i class="fa-solid fa-check text-emerald-500"></i> Bot GBP/USD
                  </li>
                  <li class="flex items-center gap-2 text-neutral-600 dark:text-neutral-300">
                    <i class="fa-solid fa-check text-emerald-500"></i> VPS D√©di√© inclus
                  </li>
                  <li class="flex items-center gap-2 text-neutral-600 dark:text-neutral-300">
                    <i class="fa-solid fa-check text-emerald-500"></i> Support email
                  </li>
                </ul>
              </label>

              <!-- Pro - Recommand√© -->
              <label class="relative flex flex-col p-5 rounded-xl cursor-pointer transition-all border-2 hover:shadow-lg subscription-card ring-2 ring-blue-500 selected" data-plan="pro">
                <input type="radio" name="subscription_plan" value="pro" data-price="149.99" class="sr-only subscription-radio" checked>
                <div class="absolute -top-3 left-1/2 -translate-x-1/2">
                  <span class="px-3 py-1 rounded-full bg-blue-500 text-white text-xs font-bold">POPULAIRE</span>
                </div>
                <div class="absolute top-4 right-4">
                  <div class="w-5 h-5 rounded-full border-2 border-neutral-300 dark:border-neutral-600 subscription-check flex items-center justify-center">
                    <div class="w-2.5 h-2.5 rounded-full bg-white scale-0 transition-transform"></div>
                  </div>
                </div>
                <div class="flex items-center gap-3 mb-3">
                  <span class="text-2xl">ü•à</span>
                  <div>
                    <h4 class="font-bold text-lg text-neutral-900 dark:text-white">Pro</h4>
                    <p class="text-sm text-neutral-500 dark:text-neutral-400">Le meilleur rapport qualit√©/prix</p>
                  </div>
                </div>
                <div class="flex items-baseline gap-1 mb-4">
                  <span class="text-3xl font-bold text-neutral-900 dark:text-white">149,99‚Ç¨</span>
                  <span class="text-neutral-500 dark:text-neutral-400">/mois</span>
                </div>
                <ul class="space-y-2 text-sm">
                  <li class="flex items-center gap-2 text-neutral-600 dark:text-neutral-300">
                    <i class="fa-solid fa-check text-emerald-500"></i> Bot GBP/USD
                  </li>
                  <li class="flex items-center gap-2 text-neutral-600 dark:text-neutral-300">
                    <i class="fa-solid fa-check text-emerald-500"></i> Bot Or (XAU/USD)
                  </li>
                  <li class="flex items-center gap-2 text-neutral-600 dark:text-neutral-300">
                    <i class="fa-solid fa-check text-emerald-500"></i> VPS D√©di√© inclus
                  </li>
                  <li class="flex items-center gap-2 text-neutral-600 dark:text-neutral-300">
                    <i class="fa-solid fa-check text-emerald-500"></i> Support prioritaire
                  </li>
                </ul>
              </label>

              <!-- Premium -->
              <label class="relative flex flex-col p-5 rounded-xl cursor-pointer transition-all border-2 hover:shadow-lg subscription-card" data-plan="premium">
                <input type="radio" name="subscription_plan" value="premium" data-price="299.99" class="sr-only subscription-radio">
                <div class="absolute top-4 right-4">
                  <div class="w-5 h-5 rounded-full border-2 border-neutral-300 dark:border-neutral-600 subscription-check flex items-center justify-center">
                    <div class="w-2.5 h-2.5 rounded-full bg-white scale-0 transition-transform"></div>
                  </div>
                </div>
                <div class="flex items-center gap-3 mb-3">
                  <span class="text-2xl">ü•á</span>
                  <div>
                    <h4 class="font-bold text-lg text-neutral-900 dark:text-white">Premium</h4>
                    <p class="text-sm text-neutral-500 dark:text-neutral-400">Acc√®s complet √† tous les bots</p>
                  </div>
                </div>
                <div class="flex items-baseline gap-1 mb-4">
                  <span class="text-3xl font-bold text-neutral-900 dark:text-white">299,99‚Ç¨</span>
                  <span class="text-neutral-500 dark:text-neutral-400">/mois</span>
                </div>
                <ul class="space-y-2 text-sm">
                  <li class="flex items-center gap-2 text-neutral-600 dark:text-neutral-300">
                    <i class="fa-solid fa-check text-emerald-500"></i> <strong>Tous les bots inclus</strong>
                  </li>
                  <li class="flex items-center gap-2 text-neutral-600 dark:text-neutral-300">
                    <i class="fa-solid fa-check text-emerald-500"></i> VPS D√©di√© inclus
                  </li>
                  <li class="flex items-center gap-2 text-neutral-600 dark:text-neutral-300">
                    <i class="fa-solid fa-check text-emerald-500"></i> Support VIP 24/7
                  </li>
                  <li class="flex items-center gap-2 text-neutral-600 dark:text-neutral-300">
                    <i class="fa-solid fa-check text-emerald-500"></i> Nouveaux bots en avant-premi√®re
                  </li>
                </ul>
              </label>
            </div>
          </div>

          <input type="hidden" name="offer_type" id="offer-type" value="subscription">
        </div>

        <!-- Step 4: Cr√©ation de compte -->
        <div data-stepper-target="step" class="hidden">
          <h2 class="mb-2 text-xl font-bold text-neutral-900 dark:text-white">Cr√©ez votre compte</h2>
          <p class="mb-6 text-sm text-neutral-600 dark:text-neutral-400">Vos informations personnelles</p>

          <div class="space-y-4">
            <div>
              <label class="mb-1.5 block text-sm font-medium text-neutral-700 dark:text-neutral-300">Pr√©nom <span class="text-red-500">*</span></label>
              <input type="text" name="first_name" required placeholder="Jean" class="form-control" value="<%= @invitation.first_name %>">
            </div>

            <div>
              <label class="mb-1.5 block text-sm font-medium text-neutral-700 dark:text-neutral-300">Nom <span class="text-red-500">*</span></label>
              <input type="text" name="last_name" required placeholder="Dupont" class="form-control" value="<%= @invitation.last_name %>">
            </div>

            <div>
              <label class="mb-1.5 block text-sm font-medium text-neutral-700 dark:text-neutral-300">Email <span class="text-red-500">*</span></label>
              <input type="email" name="email" required placeholder="jean.dupont@email.com" class="form-control" value="<%= @invitation.email %>">
            </div>

            <div>
              <label class="mb-1.5 block text-sm font-medium text-neutral-700 dark:text-neutral-300">T√©l√©phone <span class="text-red-500">*</span></label>
              <input type="tel" name="phone" required placeholder="+33 6 12 34 56 78" class="form-control" value="<%= @invitation.phone %>">
            </div>
          </div>
        </div>

        <!-- Step 5: Broker -->
        <div data-stepper-target="step" class="hidden">
          <h2 class="mb-2 text-xl font-bold text-neutral-900 dark:text-white">Connectez votre broker</h2>
          <p class="mb-6 text-sm text-neutral-600 dark:text-neutral-400">Entrez vos identifiants MetaTrader 5</p>

          <div class="space-y-4">
            <div>
              <label class="mb-1.5 block text-sm font-medium text-neutral-700 dark:text-neutral-300">Broker <span class="text-red-500">*</span></label>
              <select name="broker_name" required class="form-control">
                <option value="">S√©lectionnez un broker...</option>
                <% @brokers.each do |broker| %>
                  <option value="<%= broker[:name] %>"><%= broker[:name] %></option>
                <% end %>
              </select>
            </div>

            <div>
              <label class="mb-1.5 block text-sm font-medium text-neutral-700 dark:text-neutral-300">Num√©ro de compte MT5 <span class="text-red-500">*</span></label>
              <input type="text" name="account_id" required placeholder="123456789" class="form-control">
            </div>

            <div>
              <label class="mb-1.5 block text-sm font-medium text-neutral-700 dark:text-neutral-300">Mot de passe MT5 <span class="text-red-500">*</span></label>
              <input type="password" name="account_password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="form-control">
            </div>

            <div class="rounded-lg bg-blue-50 p-4 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800/50">
              <div class="flex items-start gap-3">
                <i class="fa-solid fa-info-circle text-blue-500 mt-0.5"></i>
                <p class="text-sm text-blue-700 dark:text-blue-300">Vos identifiants sont chiffr√©s et ne servent qu'√† connecter nos robots √† votre compte MT5.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 6: Paiement -->
        <div data-stepper-target="step" class="hidden">
          <h2 class="mb-2 text-xl font-bold text-neutral-900 dark:text-white">Finalisez votre commande</h2>
          <p class="mb-6 text-sm text-neutral-600 dark:text-neutral-400">R√©capitulatif et paiement s√©curis√©</p>

          <div class="space-y-6">
            <div class="rounded-lg bg-neutral-50 p-4 dark:bg-neutral-800">
              <h3 class="mb-3 text-sm font-semibold text-neutral-900 dark:text-white">R√©capitulatif</h3>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-neutral-600 dark:text-neutral-400">Nom</span>
                  <span class="font-medium text-neutral-900 dark:text-white" data-review-field="full_name">‚Äî</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-neutral-600 dark:text-neutral-400">Email</span>
                  <span class="font-medium text-neutral-900 dark:text-white" data-review-field="email">‚Äî</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-neutral-600 dark:text-neutral-400">Broker</span>
                  <span class="font-medium text-neutral-900 dark:text-white" data-review-field="broker_name">‚Äî</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-neutral-600 dark:text-neutral-400">Formule</span>
                  <span class="font-medium text-neutral-900 dark:text-white" id="review-offer">‚Äî</span>
                </div>
              </div>
            </div>

            <div class="rounded-lg bg-neutral-50 p-4 dark:bg-neutral-800">
              <div class="flex justify-between items-center mb-4">
                <span class="text-neutral-600 dark:text-neutral-400">Total √† payer</span>
                <span class="text-2xl font-bold text-neutral-900 dark:text-white" id="total-amount">‚Äî</span>
              </div>
              <div id="subscription-notice" class="hidden mb-4 p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-sm text-blue-700 dark:text-blue-300">
                <i class="fa-solid fa-sync mr-2"></i>
                Abonnement mensuel renouvel√© automatiquement. Annulable √† tout moment.
              </div>
              <div>
                <label class="mb-1.5 block text-sm font-medium text-neutral-700 dark:text-neutral-300">Carte bancaire</label>
                <div id="card-element" class="form-control"></div>
                <div id="card-errors" class="mt-2 text-sm text-red-500"></div>
              </div>
            </div>

            <div class="flex items-center gap-2 p-3 rounded-lg bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-100 dark:border-emerald-800/50 text-emerald-700 dark:text-emerald-300 text-sm">
              <i class="fa-solid fa-shield-halved"></i>
              <span>Paiement 100% s√©curis√© par Stripe</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="mt-6 flex items-center justify-between gap-2">
        <button type="button" data-stepper-target="prevButton" data-action="click->stepper#previous" class="hidden w-full flex items-center justify-center gap-1.5 rounded-lg border border-neutral-200 bg-white/90 px-3.5 py-2 text-sm font-medium whitespace-nowrap text-neutral-800 shadow-xs select-none hover:bg-neutral-50 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-neutral-600 disabled:cursor-not-allowed disabled:opacity-50 dark:border-neutral-700 dark:bg-neutral-800/50 dark:text-neutral-50 dark:hover:bg-neutral-700/50 dark:focus-visible:outline-neutral-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="size-3.5" width="12" height="12" viewBox="0 0 12 12"><g fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" stroke="currentColor"><line x1="11" y1="6" x2="1.25" y2="6"></line><polyline points="4.25 2.75 1 6 4.25 9.25"></polyline></g></svg>
          Retour
        </button>

        <button type="button" data-stepper-target="nextButton" data-action="click->stepper#next" class="w-full flex items-center justify-center gap-1.5 rounded-lg border border-neutral-400/30 bg-neutral-800 px-3.5 py-2 text-sm font-medium whitespace-nowrap text-white shadow-sm select-none hover:bg-neutral-700 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-neutral-600 disabled:cursor-not-allowed disabled:opacity-50 dark:bg-white dark:text-neutral-800 dark:hover:bg-neutral-100 dark:focus-visible:outline-neutral-200">
          Suivant
          <svg xmlns="http://www.w3.org/2000/svg" class="size-3.5" width="12" height="12" viewBox="0 0 12 12"><g fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" stroke="currentColor"><line x1="1" y1="6" x2="10.75" y2="6"></line><polyline points="7.75 9.25 11 6 7.75 2.75"></polyline></g></svg>
        </button>

        <button type="button" data-stepper-target="submitButton" data-action="click->stepper#submit" class="hidden w-full flex items-center justify-center gap-1.5 rounded-lg border border-neutral-400/30 bg-neutral-800 px-3.5 py-2 text-sm font-medium whitespace-nowrap text-white shadow-sm select-none hover:bg-neutral-700 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-neutral-600 disabled:cursor-not-allowed disabled:opacity-50 dark:bg-white dark:text-neutral-800 dark:hover:bg-neutral-100 dark:focus-visible:outline-neutral-200" id="submit-payment">
          <svg xmlns="http://www.w3.org/2000/svg" class="size-3.5" width="12" height="12" viewBox="0 0 12 12"><g fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" stroke="currentColor"><path d="m1.75,6c1.047,1.048,1.803,2.153,2.461,3.579,1.524-3.076,3.659-5.397,6.039-7.158"></path></g></svg>
          Payer
        </button>
      </div>
    </div>
  <% end %>
</div>

<style>
  .subscription-card {
    border-color: #e5e5e5;
    background: #fafafa;
  }
  .dark .subscription-card {
    border-color: #404040;
    background: #262626;
  }
  .subscription-card.selected {
    border-color: #3b82f6;
    background: #eff6ff;
  }
  .dark .subscription-card.selected {
    border-color: #3b82f6;
    background: rgba(59, 130, 246, 0.1);
  }
  .subscription-card.selected .subscription-check {
    border-color: #3b82f6;
    background: #3b82f6;
  }
  .subscription-card.selected .subscription-check div {
    transform: scale(1);
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let stripe, cardElement, elements;
  let currentOfferType = 'subscription';
  let selectedPlan = 'pro'; // Pro s√©lectionn√© par d√©faut
  
  // Toggle Licence / Subscription
  const toggleLicence = document.getElementById('toggle-licence');
  const toggleSubscription = document.getElementById('toggle-subscription');
  const sectionLicence = document.getElementById('section-licence');
  const sectionSubscription = document.getElementById('section-subscription');
  const offerTypeInput = document.getElementById('offer-type');
  
  function setOfferType(type) {
    currentOfferType = type;
    offerTypeInput.value = type;
    
    if (type === 'subscription') {
      toggleSubscription.className = 'flex-1 px-4 py-2.5 rounded-lg text-sm font-medium transition-colors bg-gradient-to-r from-emerald-500 to-teal-500 text-white shadow-sm';
      toggleLicence.className = 'flex-1 px-4 py-2.5 rounded-lg text-sm font-medium transition-colors text-neutral-500 dark:text-neutral-400 hover:text-neutral-700 dark:hover:text-neutral-200';
      sectionSubscription.classList.remove('hidden');
      sectionLicence.classList.add('hidden');
      // Clear licence selection
      document.querySelectorAll('[data-bot-checkbox]').forEach(c => c.checked = false);
    } else {
      toggleLicence.className = 'flex-1 px-4 py-2.5 rounded-lg text-sm font-medium transition-colors bg-white dark:bg-neutral-700 text-neutral-900 dark:text-white shadow-sm';
      toggleSubscription.className = 'flex-1 px-4 py-2.5 rounded-lg text-sm font-medium transition-colors text-neutral-500 dark:text-neutral-400 hover:text-neutral-700 dark:hover:text-neutral-200';
      sectionLicence.classList.remove('hidden');
      sectionSubscription.classList.add('hidden');
      // Clear subscription selection
      document.querySelectorAll('.subscription-card').forEach(c => c.classList.remove('selected'));
      document.querySelectorAll('.subscription-radio').forEach(r => r.checked = false);
      selectedPlan = null;
    }
    updateTotal();
  }
  
  toggleLicence?.addEventListener('click', () => setOfferType('licence'));
  toggleSubscription?.addEventListener('click', () => setOfferType('subscription'));
  
  // Subscription card selection
  document.querySelectorAll('.subscription-card').forEach(card => {
    card.addEventListener('click', function() {
      document.querySelectorAll('.subscription-card').forEach(c => c.classList.remove('selected'));
      this.classList.add('selected');
      this.querySelector('.subscription-radio').checked = true;
      selectedPlan = this.dataset.plan;
      updateTotal();
      // Hide error
      const offerError = document.getElementById('offer-error');
      if (offerError) offerError.classList.add('hidden');
    });
  });
  
  function initStripe() {
    const cardEl = document.getElementById('card-element');
    if (cardEl && !cardElement) {
      stripe = Stripe(window.stripePublicKey);
      elements = stripe.elements({
        appearance: {
          theme: 'night',
          variables: {
            colorPrimary: '#3b82f6',
            colorBackground: '#262626',
            colorText: '#ffffff',
            colorDanger: '#ef4444',
            borderRadius: '8px'
          }
        }
      });
      cardElement = elements.create('card');
      cardElement.mount('#card-element');
      cardElement.on('change', function(event) {
        const displayError = document.getElementById('card-errors');
        if (displayError) displayError.textContent = event.error ? event.error.message : '';
      });
    }
  }

  function updateTotal() {
    let total = 0;
    let offerLabel = '';
    const subscriptionNotice = document.getElementById('subscription-notice');
    
    if (currentOfferType === 'licence') {
      const checkboxes = document.querySelectorAll('input[data-bot-checkbox]:checked');
      let botsTotal = 0;
      checkboxes.forEach(cb => botsTotal += parseFloat(cb.dataset.price || 0));
      const vpsPrice = 399.99;
      total = botsTotal + vpsPrice;
      
      const botsTotalEl = document.querySelector('[data-bots-total]');
      if (botsTotalEl) botsTotalEl.textContent = botsTotal.toFixed(2) + ' ‚Ç¨';
      
      offerLabel = 'Licences √† vie';
      if (subscriptionNotice) subscriptionNotice.classList.add('hidden');
    } else {
      const planPrices = { starter: 99, pro: 149.99, premium: 299.99 };
      const planLabels = { starter: 'Starter (99‚Ç¨/mois)', pro: 'Pro (149,99‚Ç¨/mois)', premium: 'Premium (299,99‚Ç¨/mois)' };
      
      if (selectedPlan) {
        total = planPrices[selectedPlan];
        offerLabel = 'Abonnement ' + planLabels[selectedPlan];
      }
      if (subscriptionNotice) subscriptionNotice.classList.remove('hidden');
    }
    
    const totalEl = document.getElementById('total-amount');
    if (totalEl) totalEl.textContent = total.toFixed(2) + ' ‚Ç¨' + (currentOfferType === 'subscription' ? '/mois' : '');
    
    const reviewOffer = document.getElementById('review-offer');
    if (reviewOffer) reviewOffer.textContent = offerLabel || '‚Äî';
  }

  document.querySelectorAll('input[data-bot-checkbox]').forEach(cb => {
    cb.addEventListener('change', function() {
      updateTotal();
      // Hide error if at least one bot selected
      const selectedBots = document.querySelectorAll('input[data-bot-checkbox]:checked');
      const offerError = document.getElementById('offer-error');
      if (selectedBots.length > 0 && offerError) {
        offerError.classList.add('hidden');
      }
    });
  });

  document.addEventListener('stepper:change', function(event) {
    const newStep = event.detail.step + 1;
    
    fetch('<%= onboarding_update_step_path(code: @invitation.code) %>', {
      method: 'PATCH',
      headers: { 
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || '',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ step: newStep })
    }).catch(err => console.log('Step update error:', err));
    
    if (event.detail.step === 5) {
      setTimeout(initStripe, 100);
      updateTotal();
    }
  });

  // Validation: offer required
  document.addEventListener('stepper:validate', function(event) {
    const step = event.detail.step;
    if (step === 2) { // Offer step
      const offerError = document.getElementById('offer-error');
      
      if (currentOfferType === 'licence') {
        const selectedBots = document.querySelectorAll('input[data-bot-checkbox]:checked');
        if (selectedBots.length === 0) {
          event.preventDefault();
          if (offerError) offerError.classList.remove('hidden');
        } else {
          if (offerError) offerError.classList.add('hidden');
        }
      } else {
        const selectedPlanRadio = document.querySelector('.subscription-radio:checked');
        if (!selectedPlanRadio) {
          event.preventDefault();
          if (offerError) offerError.classList.remove('hidden');
        } else {
          if (offerError) offerError.classList.add('hidden');
        }
      }
    }
  });

  const form = document.getElementById('onboarding-form');
  if (form) {
    form.addEventListener('submit', async function(event) {
      event.preventDefault();
      const submitBtn = document.getElementById('submit-payment');
      const errorEl = document.getElementById('card-errors');
      
      if (!submitBtn || !stripe || !cardElement) return;
      
      submitBtn.disabled = true;
      const originalHTML = submitBtn.innerHTML;
      submitBtn.innerHTML = '<svg class="animate-spin size-3.5 inline mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Paiement en cours...';
      errorEl.textContent = '';
      
      try {
        const formData = new FormData(form);
        const intentResponse = await fetch('<%= onboarding_payment_intent_path(code: @invitation.code) %>', {
          method: 'POST',
          headers: { 
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            offer_type: currentOfferType,
            subscription_plan: selectedPlan,
            selected_bots: Array.from(formData.getAll('selected_bots[]'))
          })
        });
        
        const intentData = await intentResponse.json();
        
        if (intentData.error) {
          throw new Error(intentData.error);
        }
        
        const { error, paymentIntent } = await stripe.confirmCardPayment(intentData.clientSecret, {
          payment_method: {
            card: cardElement,
            billing_details: {
              name: formData.get('first_name') + ' ' + formData.get('last_name'),
              email: formData.get('email')
            }
          }
        });
        
        if (error) {
          throw new Error(error.message);
        }
        
        if (paymentIntent.status === 'succeeded') {
          const response = await fetch('<%= onboarding_next_step_path(code: @invitation.code) %>', {
            method: 'POST',
            headers: { 'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content },
            body: formData
          });
          
          if (response.ok) {
            window.location.href = '<%= onboarding_complete_path(code: @invitation.code) %>';
          } else {
            throw new Error('Erreur lors de la cr√©ation du compte');
          }
        }
      } catch (error) {
        errorEl.textContent = error.message || 'Une erreur est survenue. Veuillez r√©essayer.';
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalHTML;
      }
    });
  }

  updateTotal();
});
</script>
