<% @page_title = "Rejoindre Trayo" %>

<div class="min-h-screen bg-neutral-950">
  <div class="mx-auto w-full max-w-4xl px-4 py-8 md:py-12">
    <%= form_with url: onboarding_next_step_path(code: @invitation.code), method: :post, local: true, id: "onboarding-form" do |f| %>
      <div data-controller="stepper"
           data-stepper-current-step-value="<%= [@invitation.step - 1, 0].max %>"
           data-stepper-validate-on-next-value="true"
           data-stepper-save-progress-value="true"
           data-stepper-storage-key-value="trayo-onboarding-<%= @invitation.code %>">
        
        <!-- Step Indicators -->
        <div class="max-w-2xl mx-auto mb-8 md:mb-12">
          <ul class="relative flex flex-row gap-x-2">
            <% steps = ["Bienvenue", "Avantages", "Offre", "Compte", "Broker", "Paiement"] %>
            <% steps.each_with_index do |label, index| %>
              <li class="group relative shrink flex-1 last:flex-none">
                <div class="w-full inline-flex items-center align-middle text-xs">
                  <div class="relative inline-flex flex-col items-center">
                    <button type="button" data-stepper-target="indicator" data-action="click->stepper#goToStep" data-step="<%= index %>" class="flex size-8 shrink-0 items-center justify-center rounded-full text-sm font-bold md:size-9 transition-all duration-300 step-indicator">
                      <span class="step-number"><%= index + 1 %></span>
                      <svg xmlns="http://www.w3.org/2000/svg" class="step-check hidden size-4" width="12" height="12" viewBox="0 0 12 12"><g fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" stroke="currentColor"><path d="m1.75,6c1.047,1.048,1.803,2.153,2.461,3.579,1.524-3.076,3.659-5.397,6.039-7.158"></path></g></svg>
                    </button>
                    <span class="absolute top-12 hidden text-xs font-medium whitespace-nowrap text-neutral-500 md:block"><%= label %></span>
                  </div>
                  <div data-stepper-target="line" class="ms-2 h-1 w-full flex-1 group-last:hidden rounded-full transition-all duration-500"></div>
                </div>
              </li>
            <% end %>
          </ul>
        </div>

        <!-- Step Content -->
        <div class="rounded-2xl border border-neutral-800 bg-neutral-900 p-6 md:p-8">
          
          <!-- Step 1: Bienvenue -->
          <div data-stepper-target="step" class="hidden">
            <div class="text-center mb-8">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-emerald-500 to-teal-600 shadow-lg shadow-emerald-500/25 mb-4">
                <i class="fa-solid fa-rocket text-white text-2xl"></i>
              </div>
              <h2 class="text-2xl md:text-3xl font-bold text-white mb-2">Bienvenue chez Trayo</h2>
              <p class="text-neutral-400">D√©couvrez le trading automatis√© en quelques points</p>
            </div>

            <div class="space-y-4">
              <div class="group rounded-xl bg-gradient-to-r from-blue-500/10 to-cyan-500/10 border border-blue-500/20 p-5 transition-all hover:border-blue-500/40 hover:shadow-lg hover:shadow-blue-500/10">
                <div class="flex items-start gap-4">
                  <div class="flex items-center justify-center w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 shadow-lg shadow-blue-500/25 shrink-0">
                    <i class="fa-solid fa-robot text-white text-lg"></i>
                  </div>
                  <div>
                    <h3 class="font-bold text-white mb-1 text-lg">Trading 100% Automatis√©</h3>
                    <p class="text-neutral-400">Nos robots tradent pour vous 24h/24, 7j/7 sur les march√©s financiers.</p>
                  </div>
                </div>
              </div>

              <div class="group rounded-xl bg-gradient-to-r from-emerald-500/10 to-teal-500/10 border border-emerald-500/20 p-5 transition-all hover:border-emerald-500/40 hover:shadow-lg hover:shadow-emerald-500/10">
                <div class="flex items-start gap-4">
                  <div class="flex items-center justify-center w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 shadow-lg shadow-emerald-500/25 shrink-0">
                    <i class="fa-solid fa-shield-halved text-white text-lg"></i>
                  </div>
                  <div>
                    <h3 class="font-bold text-white mb-1 text-lg">Vos fonds restent chez vous</h3>
                    <p class="text-neutral-400">Votre argent reste sur votre compte broker. Nous n'avons jamais acc√®s √† vos fonds.</p>
                  </div>
                </div>
              </div>

              <div class="group rounded-xl bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-500/20 p-5 transition-all hover:border-purple-500/40 hover:shadow-lg hover:shadow-purple-500/10">
                <div class="flex items-start gap-4">
                  <div class="flex items-center justify-center w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 shadow-lg shadow-purple-500/25 shrink-0">
                    <i class="fa-solid fa-chart-line text-white text-lg"></i>
                  </div>
                  <div>
                    <h3 class="font-bold text-white mb-1 text-lg">Performance transparente</h3>
                    <p class="text-neutral-400">Suivez vos trades et performances en temps r√©el depuis votre tableau de bord.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 2: Avantages -->
          <div data-stepper-target="step" class="hidden">
            <div class="text-center mb-8">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-purple-500 to-pink-600 shadow-lg shadow-purple-500/25 mb-4">
                <i class="fa-solid fa-star text-white text-2xl"></i>
              </div>
              <h2 class="text-2xl md:text-3xl font-bold text-white mb-2">Pourquoi choisir Trayo ?</h2>
              <p class="text-neutral-400">Les avantages qui font la diff√©rence</p>
            </div>

            <div class="grid gap-4 md:grid-cols-2">
              <div class="rounded-xl bg-neutral-800/50 border border-neutral-700/50 p-5 hover:border-emerald-500/30 transition-all">
                <div class="flex items-center gap-3 mb-3">
                  <div class="w-10 h-10 rounded-lg bg-emerald-500/20 flex items-center justify-center">
                    <i class="fa-solid fa-server text-emerald-400"></i>
                  </div>
                  <h3 class="font-bold text-white">VPS D√©di√© inclus</h3>
                </div>
                <p class="text-sm text-neutral-400">Un serveur d√©di√© pour faire tourner vos robots 24h/24 sans interruption.</p>
              </div>

              <div class="rounded-xl bg-neutral-800/50 border border-neutral-700/50 p-5 hover:border-blue-500/30 transition-all">
                <div class="flex items-center gap-3 mb-3">
                  <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center">
                    <i class="fa-solid fa-headset text-blue-400"></i>
                  </div>
                  <h3 class="font-bold text-white">Support prioritaire</h3>
                </div>
                <p class="text-sm text-neutral-400">Une √©quipe d√©di√©e pour vous accompagner dans votre exp√©rience de trading.</p>
              </div>

              <div class="rounded-xl bg-neutral-800/50 border border-neutral-700/50 p-5 hover:border-amber-500/30 transition-all">
                <div class="flex items-center gap-3 mb-3">
                  <div class="w-10 h-10 rounded-lg bg-amber-500/20 flex items-center justify-center">
                    <i class="fa-solid fa-percent text-amber-400"></i>
                  </div>
                  <h3 class="font-bold text-white">Commission sur profits</h3>
                </div>
                <p class="text-sm text-neutral-400">Nous ne gagnons que si vous gagnez. Aucune commission sur vos pertes.</p>
              </div>

              <div class="rounded-xl bg-neutral-800/50 border border-neutral-700/50 p-5 hover:border-purple-500/30 transition-all">
                <div class="flex items-center gap-3 mb-3">
                  <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center">
                    <i class="fa-solid fa-flask text-purple-400"></i>
                  </div>
                  <h3 class="font-bold text-white">Bots test√©s et optimis√©s</h3>
                </div>
                <p class="text-sm text-neutral-400">Tous nos robots sont backtest√©s et optimis√©s avant mise en production.</p>
              </div>
            </div>
          </div>

          <!-- Step 3: Choix de l'offre -->
          <div data-stepper-target="step" class="hidden" data-validate-offer="true">
            <div class="text-center mb-8">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-amber-500 to-orange-600 shadow-lg shadow-amber-500/25 mb-4">
                <i class="fa-solid fa-gem text-white text-2xl"></i>
              </div>
              <h2 class="text-2xl md:text-3xl font-bold text-white mb-2">Choisissez votre formule</h2>
              <p class="text-neutral-400">Deux options pour d√©marrer votre aventure trading</p>
            </div>

            <div id="offer-error" class="hidden mb-4 p-4 rounded-xl bg-red-500/10 border border-red-500/30 text-red-400 text-sm flex items-center gap-2">
              <i class="fa-solid fa-exclamation-circle"></i>
              Veuillez s√©lectionner une offre
            </div>

            <!-- Toggle Abonnement / Licence -->
            <div class="flex items-center justify-center gap-1 mb-6 p-1 rounded-xl bg-neutral-800 border border-neutral-700">
              <button type="button" id="toggle-subscription" class="flex-1 px-4 py-3 rounded-lg text-sm font-bold transition-all bg-gradient-to-r from-emerald-500 to-teal-500 text-white shadow-lg">
                üöÄ Abonnements tout inclus
              </button>
              <button type="button" id="toggle-licence" class="flex-1 px-4 py-3 rounded-lg text-sm font-bold transition-all text-neutral-400 hover:text-white">
                üíé Licences √† vie
              </button>
            </div>

            <!-- Section Licences -->
            <div id="section-licence" class="hidden space-y-4">
              <div class="p-4 rounded-xl bg-gradient-to-r from-blue-500/10 to-purple-500/10 border border-blue-500/30">
                <p class="text-sm text-blue-300">
                  <i class="fa-solid fa-infinity mr-2"></i>
                  <strong>Achat unique</strong> ‚Äî Payez une fois, utilisez √† vie. Id√©al pour un investissement long terme.
                </p>
              </div>

              <div class="grid gap-3 max-h-[280px] overflow-y-auto pr-2 custom-scrollbar">
                <% @trading_bots.each do |bot| %>
                  <label class="flex items-center gap-4 p-4 rounded-xl bg-neutral-800/50 border border-neutral-700 cursor-pointer hover:bg-neutral-800 hover:border-purple-500/50 transition-all">
                    <input type="checkbox" name="selected_bots[]" value="<%= bot.id %>" data-price="<%= bot.price %>" data-bot-checkbox class="size-5 rounded border-neutral-600 text-purple-500 focus:ring-purple-500 bg-neutral-700">
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center justify-between">
                        <span class="font-bold text-white"><%= bot.name %></span>
                        <span class="font-bold text-emerald-400"><%= number_to_currency(bot.price, unit: "‚Ç¨", format: "%n%u") %></span>
                      </div>
                      <p class="text-sm text-neutral-400 truncate"><%= bot.description %></p>
                    </div>
                  </label>
                <% end %>
              </div>

              <div class="mt-4 space-y-2">
                <div class="flex items-center justify-between p-4 rounded-xl bg-neutral-800/50 border border-neutral-700">
                  <span class="text-neutral-400">Total Bots</span>
                  <span class="font-bold text-white" data-bots-total>0 ‚Ç¨</span>
                </div>
                <div class="flex items-center justify-between p-4 rounded-xl bg-neutral-800/50 border border-neutral-700">
                  <span class="text-neutral-400">VPS D√©di√©</span>
                  <span class="font-bold text-white">399.99 ‚Ç¨/an</span>
                </div>
              </div>
            </div>

            <!-- Section Abonnements -->
            <div id="section-subscription" class="space-y-6">
              <div class="p-4 rounded-xl bg-gradient-to-r from-emerald-500/10 to-teal-500/10 border border-emerald-500/30">
                <p class="text-sm text-emerald-300 text-center">
                  <i class="fa-solid fa-rocket mr-2"></i>
                  <strong>Tout inclus</strong> ‚Äî Bots + VPS + Mises √† jour + Support prioritaire. Sans engagement.
                </p>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-5 pt-6">
                <!-- Starter -->
                <label class="subscription-card flex flex-col rounded-2xl cursor-pointer transition-all duration-200 border-2 border-neutral-700 bg-neutral-800/50 hover:border-neutral-500" data-plan="starter">
                  <input type="radio" name="subscription_plan" value="starter" data-price="99" class="sr-only subscription-radio">
                  
                  <div class="p-6 flex flex-col h-full">
                    <div class="text-center mb-auto">
                      <h4 class="font-bold text-lg text-white mb-4">Starter</h4>
                      <div class="flex items-baseline justify-center gap-1 mb-6">
                        <span class="text-4xl font-black text-white">99‚Ç¨</span>
                        <span class="text-neutral-500 text-sm">/mois</span>
                      </div>
                    </div>
                    
                    <ul class="space-y-3 text-sm mb-6 flex-1">
                      <li class="text-neutral-400 text-center">Bot GBP/USD</li>
                      <li class="text-neutral-400 text-center">VPS D√©di√© inclus</li>
                      <li class="text-neutral-400 text-center">Support email</li>
                      <li class="text-neutral-400 text-center">Mises √† jour incluses</li>
                    </ul>
                    
                    <div class="subscription-btn py-3 rounded-xl border-2 border-neutral-600 text-white font-semibold text-center transition-all hover:bg-neutral-700">
                      Choisir
                    </div>
                  </div>
                </label>

                <!-- Pro - Recommand√© -->
                <label class="subscription-card selected relative flex flex-col rounded-2xl cursor-pointer transition-all duration-200 border-2 border-emerald-500 bg-neutral-800 shadow-lg shadow-emerald-500/10" data-plan="pro">
                  <input type="radio" name="subscription_plan" value="pro" data-price="149.99" class="sr-only subscription-radio" checked>
                  
                  <div class="absolute -top-3 left-1/2 -translate-x-1/2 z-10">
                    <span class="px-4 py-1.5 rounded-full bg-gradient-to-r from-emerald-500 to-teal-500 text-white text-xs font-bold shadow-lg">Populaire</span>
                  </div>
                  
                  <div class="p-6 pt-8 flex flex-col h-full">
                    <div class="text-center mb-auto">
                      <h4 class="font-bold text-lg text-white mb-4">Pro</h4>
                      <div class="flex items-baseline justify-center gap-1 mb-6">
                        <span class="text-4xl font-black text-white">149‚Ç¨</span>
                        <span class="text-neutral-500 text-sm">/mois</span>
                      </div>
                    </div>
                    
                    <ul class="space-y-3 text-sm mb-6 flex-1">
                      <li class="text-neutral-400 text-center">Bot GBP/USD</li>
                      <li class="text-neutral-400 text-center">Bot Or (XAU/USD)</li>
                      <li class="text-neutral-400 text-center">VPS D√©di√© inclus</li>
                      <li class="text-neutral-400 text-center">Support prioritaire</li>
                      <li class="text-neutral-400 text-center">Mises √† jour incluses</li>
                    </ul>
                    
                    <div class="subscription-btn py-3 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-semibold text-center transition-all">
                      Choisir
                    </div>
                  </div>
                </label>

                <!-- Premium -->
                <label class="subscription-card flex flex-col rounded-2xl cursor-pointer transition-all duration-200 border-2 border-neutral-700 bg-neutral-800/50 hover:border-neutral-500" data-plan="premium">
                  <input type="radio" name="subscription_plan" value="premium" data-price="299.99" class="sr-only subscription-radio">
                  
                  <div class="p-6 flex flex-col h-full">
                    <div class="text-center mb-auto">
                      <h4 class="font-bold text-lg text-white mb-4">Premium</h4>
                      <div class="flex items-baseline justify-center gap-1 mb-6">
                        <span class="text-4xl font-black text-white">299‚Ç¨</span>
                        <span class="text-neutral-500 text-sm">/mois</span>
                      </div>
                    </div>
                    
                    <ul class="space-y-3 text-sm mb-6 flex-1">
                      <li class="text-neutral-400 text-center font-medium">Tous les bots inclus</li>
                      <li class="text-neutral-400 text-center">VPS D√©di√© inclus</li>
                      <li class="text-neutral-400 text-center">Support VIP 24/7</li>
                      <li class="text-neutral-400 text-center">Nouveaux bots en avant-premi√®re</li>
                      <li class="text-neutral-400 text-center">Mises √† jour incluses</li>
                    </ul>
                    
                    <div class="subscription-btn py-3 rounded-xl border-2 border-neutral-600 text-white font-semibold text-center transition-all hover:bg-neutral-700">
                      Choisir
                    </div>
                  </div>
                </label>
              </div>
            </div>

            <input type="hidden" name="offer_type" id="offer-type" value="subscription">
          </div>

          <!-- Step 4: Cr√©ation de compte -->
          <div data-stepper-target="step" class="hidden">
            <div class="text-center mb-8">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-500 to-cyan-600 shadow-lg shadow-blue-500/25 mb-4">
                <i class="fa-solid fa-user-plus text-white text-2xl"></i>
              </div>
              <h2 class="text-2xl md:text-3xl font-bold text-white mb-2">Cr√©ez votre compte</h2>
              <p class="text-neutral-400">Vos informations personnelles</p>
            </div>

            <div class="space-y-5 max-w-md mx-auto">
              <div>
                <label class="mb-2 block text-sm font-medium text-neutral-300">Pr√©nom <span class="text-red-400">*</span></label>
                <input type="text" name="first_name" required placeholder="Jean" class="w-full px-4 py-3 rounded-xl bg-neutral-800 border border-neutral-700 text-white placeholder-neutral-500 focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition-all" value="<%= @invitation.first_name %>">
              </div>

              <div>
                <label class="mb-2 block text-sm font-medium text-neutral-300">Nom <span class="text-red-400">*</span></label>
                <input type="text" name="last_name" required placeholder="Dupont" class="w-full px-4 py-3 rounded-xl bg-neutral-800 border border-neutral-700 text-white placeholder-neutral-500 focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition-all" value="<%= @invitation.last_name %>">
              </div>

              <div>
                <label class="mb-2 block text-sm font-medium text-neutral-300">Email <span class="text-red-400">*</span></label>
                <input type="email" name="email" required placeholder="jean.dupont@email.com" class="w-full px-4 py-3 rounded-xl bg-neutral-800 border border-neutral-700 text-white placeholder-neutral-500 focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition-all" value="<%= @invitation.email %>">
              </div>

              <div>
                <label class="mb-2 block text-sm font-medium text-neutral-300">T√©l√©phone <span class="text-red-400">*</span></label>
                <input type="tel" name="phone" required placeholder="+33 6 12 34 56 78" class="w-full px-4 py-3 rounded-xl bg-neutral-800 border border-neutral-700 text-white placeholder-neutral-500 focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition-all" value="<%= @invitation.phone %>">
              </div>
            </div>
          </div>

          <!-- Step 5: Broker -->
          <div data-stepper-target="step" class="hidden">
            <div class="text-center mb-8">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 shadow-lg shadow-indigo-500/25 mb-4">
                <i class="fa-solid fa-link text-white text-2xl"></i>
              </div>
              <h2 class="text-2xl md:text-3xl font-bold text-white mb-2">Connectez votre broker</h2>
              <p class="text-neutral-400">Entrez vos identifiants MetaTrader 5</p>
            </div>

            <div class="space-y-5 max-w-md mx-auto">
              <div>
                <label class="mb-2 block text-sm font-medium text-neutral-300">Broker <span class="text-red-400">*</span></label>
                <select name="broker_name" required class="w-full px-4 py-3 rounded-xl bg-neutral-800 border border-neutral-700 text-white focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition-all">
                  <option value="">S√©lectionnez un broker...</option>
                  <% @brokers.each do |broker| %>
                    <option value="<%= broker[:name] %>"><%= broker[:name] %></option>
                  <% end %>
                </select>
              </div>

              <div>
                <label class="mb-2 block text-sm font-medium text-neutral-300">Num√©ro de compte MT5 <span class="text-red-400">*</span></label>
                <input type="text" name="account_id" required placeholder="123456789" class="w-full px-4 py-3 rounded-xl bg-neutral-800 border border-neutral-700 text-white placeholder-neutral-500 focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition-all">
              </div>

              <div>
                <label class="mb-2 block text-sm font-medium text-neutral-300">Mot de passe MT5 <span class="text-red-400">*</span></label>
                <input type="password" name="account_password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-3 rounded-xl bg-neutral-800 border border-neutral-700 text-white placeholder-neutral-500 focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition-all">
              </div>

              <div class="rounded-xl bg-blue-500/10 border border-blue-500/30 p-4">
                <div class="flex items-start gap-3">
                  <i class="fa-solid fa-shield-halved text-blue-400 mt-0.5"></i>
                  <p class="text-sm text-blue-300">Vos identifiants sont chiffr√©s et ne servent qu'√† connecter nos robots √† votre compte MT5.</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 6: Paiement -->
          <div data-stepper-target="step" class="hidden">
            <div class="text-center mb-8">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-emerald-500 to-teal-600 shadow-lg shadow-emerald-500/25 mb-4">
                <i class="fa-solid fa-credit-card text-white text-2xl"></i>
              </div>
              <h2 class="text-2xl md:text-3xl font-bold text-white mb-2">Finalisez votre commande</h2>
              <p class="text-neutral-400">R√©capitulatif et paiement s√©curis√©</p>
            </div>

            <div class="space-y-6 max-w-md mx-auto">
              <div class="rounded-xl bg-neutral-800/50 border border-neutral-700 p-5">
                <h3 class="mb-4 text-sm font-bold text-neutral-400 uppercase tracking-wide">R√©capitulatif</h3>
                <div class="space-y-3 text-sm">
                  <div class="flex justify-between">
                    <span class="text-neutral-400">Nom</span>
                    <span class="font-medium text-white" data-review-field="full_name">‚Äî</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-neutral-400">Email</span>
                    <span class="font-medium text-white" data-review-field="email">‚Äî</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-neutral-400">Broker</span>
                    <span class="font-medium text-white" data-review-field="broker_name">‚Äî</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-neutral-400">Formule</span>
                    <span class="font-medium text-white" id="review-offer">‚Äî</span>
                  </div>
                </div>
              </div>

              <div class="rounded-xl bg-gradient-to-br from-emerald-500/10 to-teal-500/10 border border-emerald-500/30 p-5">
                <div class="flex justify-between items-center mb-5">
                  <span class="text-neutral-300">Total √† payer</span>
                  <span class="text-3xl font-black text-emerald-400" id="total-amount">‚Äî</span>
                </div>
                <div id="subscription-notice" class="hidden mb-5 p-3 rounded-lg bg-blue-500/10 border border-blue-500/30 text-sm text-blue-300">
                  <i class="fa-solid fa-sync mr-2"></i>
                  Abonnement mensuel renouvel√© automatiquement. Annulable √† tout moment.
                </div>
                <div>
                  <label class="mb-2 block text-sm font-medium text-neutral-300">Carte bancaire</label>
                  <div id="card-element" class="p-4 rounded-xl bg-neutral-800 border border-neutral-700"></div>
                  <div id="card-errors" class="mt-2 text-sm text-red-400"></div>
                </div>
              </div>

              <div class="flex items-center gap-3 p-4 rounded-xl bg-emerald-500/10 border border-emerald-500/30">
                <i class="fa-solid fa-shield-halved text-emerald-400 text-lg"></i>
                <span class="text-emerald-300 text-sm font-medium">Paiement 100% s√©curis√© par Stripe</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="mt-6 flex items-center justify-between gap-3">
          <button type="button" data-stepper-target="prevButton" data-action="click->stepper#previous" class="hidden flex-1 flex items-center justify-center gap-2 h-14 rounded-xl border border-neutral-700 bg-neutral-800/50 text-sm font-bold text-neutral-300 transition-all hover:bg-neutral-800 hover:border-neutral-600">
            <i class="fa-solid fa-arrow-left"></i>
            Retour
          </button>

          <button type="button" data-stepper-target="nextButton" data-action="click->stepper#next" class="flex-1 flex items-center justify-center gap-2 h-14 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 text-base font-bold text-white shadow-lg shadow-emerald-500/25 transition-all hover:scale-[1.02] hover:shadow-emerald-500/40">
            Suivant
            <i class="fa-solid fa-arrow-right"></i>
          </button>

          <button type="button" data-stepper-target="submitButton" data-action="click->stepper#submit" class="hidden flex-1 flex items-center justify-center gap-2 h-14 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 text-base font-bold text-white shadow-lg shadow-emerald-500/25 transition-all hover:scale-[1.02] hover:shadow-emerald-500/40" id="submit-payment">
            <i class="fa-solid fa-lock"></i>
            Payer maintenant
          </button>
        </div>
      </div>
    <% end %>
  </div>
</div>

<style>
  .step-indicator {
    background: #262626;
    border: 2px solid #404040;
    color: #737373;
  }
  .step-indicator.active {
    background: linear-gradient(135deg, #10b981, #14b8a6);
    border-color: #10b981;
    color: white;
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
  }
  .step-indicator.completed {
    background: linear-gradient(135deg, #10b981, #14b8a6);
    border-color: #10b981;
    color: white;
  }
  [data-stepper-target="line"] {
    background: #404040;
  }
  [data-stepper-target="line"].completed {
    background: linear-gradient(90deg, #10b981, #14b8a6);
  }
  
  .subscription-card.selected {
    border-color: #3b82f6;
    background: rgba(59, 130, 246, 0.1);
  }
  .subscription-card.selected .subscription-check {
    border-color: #3b82f6;
    background: #3b82f6;
  }
  .subscription-card.selected .subscription-check i {
    opacity: 1;
  }
  
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: #262626;
    border-radius: 3px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #525252;
    border-radius: 3px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #737373;
  }
</style>

<script>
let stripe, cardElement, elements;
let currentOfferType = 'subscription';
let selectedPlan = 'pro';
let onboardingInitialized = false;

function initOnboarding() {
  if (onboardingInitialized) return;
  onboardingInitialized = true;
  
  const toggleLicence = document.getElementById('toggle-licence');
  const toggleSubscription = document.getElementById('toggle-subscription');
  const sectionLicence = document.getElementById('section-licence');
  const sectionSubscription = document.getElementById('section-subscription');
  const offerTypeInput = document.getElementById('offer-type');
  
  function setOfferType(type) {
    currentOfferType = type;
    offerTypeInput.value = type;
    
    if (type === 'subscription') {
      toggleSubscription.className = 'flex-1 px-4 py-3 rounded-lg text-sm font-bold transition-all bg-gradient-to-r from-emerald-500 to-teal-500 text-white shadow-lg';
      toggleLicence.className = 'flex-1 px-4 py-3 rounded-lg text-sm font-bold transition-all text-neutral-400 hover:text-white';
      sectionSubscription.classList.remove('hidden');
      sectionLicence.classList.add('hidden');
      document.querySelectorAll('[data-bot-checkbox]').forEach(c => c.checked = false);
    } else {
      toggleLicence.className = 'flex-1 px-4 py-3 rounded-lg text-sm font-bold transition-all bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg';
      toggleSubscription.className = 'flex-1 px-4 py-3 rounded-lg text-sm font-bold transition-all text-neutral-400 hover:text-white';
      sectionLicence.classList.remove('hidden');
      sectionSubscription.classList.add('hidden');
      document.querySelectorAll('.subscription-card').forEach(c => c.classList.remove('selected'));
      document.querySelectorAll('.subscription-radio').forEach(r => r.checked = false);
      selectedPlan = null;
    }
    updateTotal();
  }
  
  toggleLicence?.addEventListener('click', () => setOfferType('licence'));
  toggleSubscription?.addEventListener('click', () => setOfferType('subscription'));
  
  document.querySelectorAll('.subscription-card').forEach(card => {
    card.addEventListener('click', function() {
      document.querySelectorAll('.subscription-card').forEach(c => {
        c.classList.remove('selected');
        c.classList.add('border-neutral-700', 'bg-neutral-800/50');
        c.classList.remove('border-blue-500', 'bg-blue-500/10', 'ring-2', 'ring-blue-500/50');
      });
      this.classList.add('selected', 'border-blue-500', 'bg-blue-500/10', 'ring-2', 'ring-blue-500/50');
      this.classList.remove('border-neutral-700', 'bg-neutral-800/50');
      this.querySelector('.subscription-radio').checked = true;
      selectedPlan = this.dataset.plan;
      updateTotal();
      const offerError = document.getElementById('offer-error');
      if (offerError) offerError.classList.add('hidden');
    });
  });
  
  function initStripe() {
    const cardEl = document.getElementById('card-element');
    if (cardEl && !cardElement && window.stripePublicKey) {
      stripe = Stripe(window.stripePublicKey);
      elements = stripe.elements({
        appearance: {
          theme: 'night',
          variables: {
            colorPrimary: '#10b981',
            colorBackground: '#262626',
            colorText: '#ffffff',
            colorDanger: '#ef4444',
            borderRadius: '8px',
            fontFamily: 'system-ui, sans-serif'
          }
        }
      });
      cardElement = elements.create('card', {
        style: {
          base: {
            fontSize: '16px',
            color: '#ffffff',
            '::placeholder': { color: '#737373' }
          }
        }
      });
      cardElement.mount('#card-element');
      cardElement.on('change', function(event) {
        const displayError = document.getElementById('card-errors');
        if (displayError) displayError.textContent = event.error ? event.error.message : '';
      });
    }
  }

  function updateTotal() {
    let total = 0;
    let offerLabel = '';
    const subscriptionNotice = document.getElementById('subscription-notice');
    
    if (currentOfferType === 'licence') {
      const checkboxes = document.querySelectorAll('input[data-bot-checkbox]:checked');
      let botsTotal = 0;
      checkboxes.forEach(cb => botsTotal += parseFloat(cb.dataset.price || 0));
      const vpsPrice = 399.99;
      total = botsTotal + vpsPrice;
      
      const botsTotalEl = document.querySelector('[data-bots-total]');
      if (botsTotalEl) botsTotalEl.textContent = botsTotal.toFixed(2) + ' ‚Ç¨';
      
      offerLabel = 'Licences √† vie';
      if (subscriptionNotice) subscriptionNotice.classList.add('hidden');
    } else {
      const planPrices = { starter: 99, pro: 149.99, premium: 299.99 };
      const planLabels = { starter: 'Starter (99‚Ç¨/mois)', pro: 'Pro (149,99‚Ç¨/mois)', premium: 'Premium (299,99‚Ç¨/mois)' };
      
      if (selectedPlan) {
        total = planPrices[selectedPlan];
        offerLabel = 'Abonnement ' + planLabels[selectedPlan];
      }
      if (subscriptionNotice) subscriptionNotice.classList.remove('hidden');
    }
    
    const totalEl = document.getElementById('total-amount');
    if (totalEl) totalEl.textContent = total.toFixed(2).replace('.', ',') + ' ‚Ç¨' + (currentOfferType === 'subscription' ? '/mois' : '');
    
    const reviewOffer = document.getElementById('review-offer');
    if (reviewOffer) reviewOffer.textContent = offerLabel || '‚Äî';
  }

  document.querySelectorAll('input[data-bot-checkbox]').forEach(cb => {
    cb.addEventListener('change', function() {
      updateTotal();
      const selectedBots = document.querySelectorAll('input[data-bot-checkbox]:checked');
      const offerError = document.getElementById('offer-error');
      if (selectedBots.length > 0 && offerError) {
        offerError.classList.add('hidden');
      }
    });
  });

  document.addEventListener('stepper:change', function(event) {
    const newStep = event.detail.step + 1;
    
    fetch('<%= onboarding_update_step_path(code: @invitation.code) %>', {
      method: 'PATCH',
      headers: { 
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || '',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ step: newStep })
    }).catch(err => console.log('Step update error:', err));
    
    if (event.detail.step === 5) {
      setTimeout(initStripe, 100);
      updateTotal();
    }
  });

  document.addEventListener('stepper:validate', function(event) {
    const step = event.detail.step;
    if (step === 2) {
      const offerError = document.getElementById('offer-error');
      
      if (currentOfferType === 'licence') {
        const selectedBots = document.querySelectorAll('input[data-bot-checkbox]:checked');
        if (selectedBots.length === 0) {
          event.preventDefault();
          if (offerError) offerError.classList.remove('hidden');
        } else {
          if (offerError) offerError.classList.add('hidden');
        }
      } else {
        const selectedPlanRadio = document.querySelector('.subscription-radio:checked');
        if (!selectedPlanRadio) {
          event.preventDefault();
          if (offerError) offerError.classList.remove('hidden');
        } else {
          if (offerError) offerError.classList.add('hidden');
        }
      }
    }
  });

  const form = document.getElementById('onboarding-form');
  if (form) {
    form.addEventListener('submit', async function(event) {
      event.preventDefault();
      const submitBtn = document.getElementById('submit-payment');
      const errorEl = document.getElementById('card-errors');
      
      if (!submitBtn || !stripe || !cardElement) return;
      
      submitBtn.disabled = true;
      const originalHTML = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Paiement en cours...';
      errorEl.textContent = '';
      
      try {
        const formData = new FormData(form);
        const intentResponse = await fetch('<%= onboarding_payment_intent_path(code: @invitation.code) %>', {
          method: 'POST',
          headers: { 
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            offer_type: currentOfferType,
            subscription_plan: selectedPlan,
            selected_bots: Array.from(formData.getAll('selected_bots[]'))
          })
        });
        
        const intentData = await intentResponse.json();
        
        if (intentData.error) {
          throw new Error(intentData.error);
        }
        
        const { error, paymentIntent } = await stripe.confirmCardPayment(intentData.clientSecret, {
          payment_method: {
            card: cardElement,
            billing_details: {
              name: formData.get('first_name') + ' ' + formData.get('last_name'),
              email: formData.get('email')
            }
          }
        });
        
        if (error) {
          throw new Error(error.message);
        }
        
        if (paymentIntent.status === 'succeeded') {
          const response = await fetch('<%= onboarding_next_step_path(code: @invitation.code) %>', {
            method: 'POST',
            headers: { 'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content },
            body: formData
          });
          
          if (response.ok) {
            window.location.href = '<%= onboarding_complete_path(code: @invitation.code) %>';
          } else {
            throw new Error('Erreur lors de la cr√©ation du compte');
          }
        }
      } catch (error) {
        errorEl.textContent = error.message || 'Une erreur est survenue. Veuillez r√©essayer.';
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalHTML;
      }
    });
  }

  updateTotal();
}

document.addEventListener('DOMContentLoaded', initOnboarding);
document.addEventListener('turbo:load', function() { onboardingInitialized = false; initOnboarding(); });
document.addEventListener('turbo:render', function() { onboardingInitialized = false; initOnboarding(); });
</script>
