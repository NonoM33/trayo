<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Choisir un Broker - Trayo</title>
  <%= stylesheet_link_tag "onboarding", "data-turbo-track": "reload" %>
</head>
<body class="onboarding-page">
  <div class="onboarding-container">
    <div class="step-indicator">
      <div class="step completed">✓</div>
      <div class="step active">2</div>
      <div class="step">3</div>
      <div class="step">4</div>
    </div>
    
    <div class="onboarding-card">
      <h2>Choisissez votre Broker</h2>
      <p class="subtitle">Sélectionnez un broker partenaire et créez votre compte. Ensuite, rentrez vos identifiants pour que les bots puissent travailler.</p>
      
      <%= form_with url: onboarding_next_step_path(@invitation.code), method: :post, local: true do |f| %>
        <div class="broker-options" id="broker-options">
          <% @brokers.each_with_index do |broker, index| %>
            <div class="broker-option" data-broker="<%= broker[:name] %>" data-link="<%= broker[:affiliate_link] %>">
              <div class="header">
                <div class="logo"><%= broker[:logo] %></div>
                <div class="info">
                  <h3><%= broker[:name] %></h3>
                  <p><%= broker[:description] %></p>
                </div>
              </div>
              <div class="advantages">
                <% broker[:advantages].each do |advantage| %>
                  <span class="tag"><%= advantage %></span>
                <% end %>
              </div>
              <div class="broker-actions" style="margin-top: 16px; display: flex; gap: 12px;">
                <a href="<%= broker[:affiliate_link] %>" target="_blank" class="btn-broker-link" onclick="event.stopPropagation();">
                  <i class="fa-icon fa-sm fa-external-link"></i> Créer un compte
                </a>
              </div>
              <%= f.hidden_field :broker_name, value: broker[:name], id: "broker_name_#{index}" %>
              <%= f.hidden_field :affiliate_link, value: broker[:affiliate_link], id: "affiliate_link_#{index}" %>
            </div>
          <% end %>
        </div>
        
        <div class="broker-credentials">
          <h3>Identifiants de votre compte</h3>
          
          <div class="form-group">
            <%= f.label :account_id, "ID du compte MT5" %>
            <%= f.text_field :account_id, required: true, placeholder: "12345678" %>
          </div>
          
          <div class="form-group">
            <%= f.label :account_password, "Mot de passe du compte MT5" %>
            <%= f.password_field :account_password, required: true, placeholder: "Votre mot de passe trader" %>
          </div>
        </div>
        
        <p style="font-size: 14px; color: #64748b; margin-bottom: 24px;">
          <strong>Note :</strong> C'est le mot de passe de votre compte MetaTrader 5, pas celui de votre compte client. 
          Vous le trouverez dans MT5 : Outils → Options → Serveur → Détails → Mot de passe trader.
        </p>
        
        <%= f.submit "Continuer", class: "btn-primary" %>
      <% end %>
    </div>
  </div>
  
  <style>
    .broker-option {
      position: relative;
      transition: all 0.3s ease;
    }
    
    .broker-option:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }
    
    .broker-option.selected {
      border-color: #3b82f6;
      background: #eff6ff;
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
    }
    
    .btn-broker-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      background: #3b82f6;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
      flex: 1;
      justify-content: center;
    }
    
    .btn-broker-link:hover {
      background: #2563eb;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .broker-option.selected .btn-broker-link {
      background: #2563eb;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
  </style>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const brokerOptions = document.querySelectorAll('.broker-option');
      
      brokerOptions.forEach(option => {
        option.addEventListener('click', function(e) {
          if (e.target.tagName === 'A' || e.target.closest('a')) {
            return;
          }
          
          brokerOptions.forEach(opt => opt.classList.remove('selected'));
          this.classList.add('selected');
          
          const brokerNameInput = this.querySelector('[name="broker_name"]');
          const affiliateLinkInput = this.querySelector('[name="affiliate_link"]');
          
          document.querySelectorAll('[name="broker_name"]').forEach(input => {
            if (input !== brokerNameInput) {
              input.disabled = true;
            }
          });
          
          document.querySelectorAll('[name="affiliate_link"]').forEach(input => {
            if (input !== affiliateLinkInput) {
              input.disabled = true;
            }
          });
        });
      });
    });
  </script>
</body>
</html>

