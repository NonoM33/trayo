<!DOCTYPE html>
<html>
<head>
  <title>Trayo Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>
  <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
  <%= stylesheet_link_tag "admin", "data-turbo-track": "reload" %>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <%= javascript_importmap_tags %>
</head>
<body class="dark-mode">
  <a href="#main-content" class="skip-to-main">Aller au contenu principal</a>
  <script>
    (function() {
      // Activer le mode sombre par défaut
      document.body.classList.add('dark-mode');
      localStorage.setItem('theme', 'dark');
      
      // Debug: Check FontAwesome loading
      console.log('=== FONTAWESOME DEBUG ===');
      console.log('FontAwesome CSS loaded:', document.querySelector('link[href*="font-awesome"]') !== null);
      
      // Test FontAwesome classes
      const testIcon = document.createElement('i');
      testIcon.className = 'fa-solid fa-home';
      document.body.appendChild(testIcon);
      
      const computedStyle = window.getComputedStyle(testIcon);
      console.log('FontAwesome font-family:', computedStyle.fontFamily);
      console.log('FontAwesome font-weight:', computedStyle.fontWeight);
      
      document.body.removeChild(testIcon);
      console.log('=== END FONTAWESOME DEBUG ===');
    })();
  </script>
  
  <%= render 'admin/shared/navbar' %>
  <%= render 'admin/shared/sidebar' %>
  <%= render 'admin/shared/onboarding' %>
  
  <main id="main-content" class="main-content" role="main">
    <%= yield %>
  </main>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Toast System JavaScript -->
  <script>
    function showToast(message, type = 'info', title = null) {
      const container = document.getElementById('toastContainer');
      if (!container) return;
      
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      
      const icons = {
        success: '<i class="fa-icon fa-md fa-check-circle"></i>',
        error: '<i class="fa-icon fa-md fa-exclamation-circle"></i>',
        warning: '<i class="fa-icon fa-md fa-exclamation-triangle"></i>',
        info: '<i class="fa-icon fa-md fa-info-circle"></i>'
      };
      
      const titles = {
        success: 'Succès',
        error: 'Erreur',
        warning: 'Attention',
        info: 'Information'
      };
      
      toast.innerHTML = `
        <div class="toast-icon">${icons[type] || icons.info}</div>
        <div class="toast-content">
          ${title ? `<div class="toast-title">${title}</div>` : ''}
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()" aria-label="Fermer">×</button>
      `;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    }
    
    function humanizeMessage(message) {
      const translations = {
        'api.*key.*error': 'Connexion impossible avec votre plateforme. Vérifiez votre clé API.',
        'connection.*failed': 'La connexion au serveur a échoué. Vérifiez votre connexion internet.',
        'timeout': 'La requête a pris trop de temps. Veuillez réessayer.',
        'not found': 'La ressource demandée est introuvable.',
        'unauthorized': 'Vous n\'avez pas les permissions nécessaires pour effectuer cette action.',
        'validation failed': 'Certaines informations sont incorrectes. Veuillez vérifier les champs en erreur.',
        'can\'t be blank': 'Ce champ est obligatoire.',
        'has already been taken': 'Cette valeur est déjà utilisée. Veuillez en choisir une autre.',
        'is invalid': 'Cette valeur n\'est pas valide.',
        'too short': 'Cette valeur est trop courte.',
        'too long': 'Cette valeur est trop longue.'
      };
      
      const lowerMessage = message.toLowerCase();
      for (const [pattern, translation] of Object.entries(translations)) {
        if (new RegExp(pattern, 'i').test(lowerMessage)) {
          return translation;
        }
      }
      
      return message;
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      const flashNotice = document.querySelector('.notice');
      const flashAlert = document.querySelector('.alert');
      
      if (flashNotice) {
        showToast(humanizeMessage(flashNotice.textContent.trim()), 'success', 'Succès');
        flashNotice.remove();
      }
      
      if (flashAlert) {
        showToast(humanizeMessage(flashAlert.textContent.trim()), 'error', 'Erreur');
        flashAlert.remove();
      }
    });
  </script>

  <!-- Dropdown JavaScript -->
  <script>
    // Gestionnaire de dropdowns personnalisé
    document.addEventListener('DOMContentLoaded', function() {
      initializeDropdowns();
    });
    
    document.addEventListener('turbo:load', function() {
      initializeDropdowns();
    });
    
    document.addEventListener('turbo:render', function() {
      initializeDropdowns();
    });
    
    function initializeDropdowns() {
      // Fermer tous les dropdowns ouverts
      document.querySelectorAll('.dropdown.active').forEach(dropdown => {
        dropdown.classList.remove('active');
      });
      
      // Ajouter les event listeners aux dropdowns
      document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const dropdown = this.closest('.dropdown');
          const isActive = dropdown.classList.contains('active');
          
          // Fermer tous les autres dropdowns
          document.querySelectorAll('.dropdown.active').forEach(activeDropdown => {
            if (activeDropdown !== dropdown) {
              activeDropdown.classList.remove('active');
            }
          });
          
          // Toggle le dropdown actuel
          dropdown.classList.toggle('active', !isActive);
        });
      });
      
      // Fermer les dropdowns quand on clique ailleurs
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.dropdown')) {
          document.querySelectorAll('.dropdown.active').forEach(dropdown => {
            dropdown.classList.remove('active');
          });
        }
      });
      
      // Gérer les touches clavier
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          document.querySelectorAll('.dropdown.active').forEach(dropdown => {
            dropdown.classList.remove('active');
          });
        }
      });
    }
  </script>
</body>
</html>

