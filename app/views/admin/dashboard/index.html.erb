<% @page_title = 'Tableau de Bord' %>

<div class="space-y-6">
  <%= render 'admin/shared/campaign_banner' if defined?(render) %>
  
  <!-- Banni√®re Promo Cr√©dits Commission -->
  <% if !current_user.is_admin? && current_user.total_credits < 500 %>
    <div class="relative overflow-hidden rounded-2xl bg-gradient-to-r from-violet-950/80 via-purple-900/60 to-indigo-950/80 border border-violet-500/30 p-6">
      <div class="absolute top-0 right-0 w-64 h-64 bg-violet-500/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
      <div class="absolute bottom-0 left-0 w-48 h-48 bg-purple-500/10 rounded-full blur-3xl translate-y-1/2 -translate-x-1/2"></div>
      
      <div class="relative flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="flex items-start gap-4">
          <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center shadow-lg shadow-violet-500/30">
            <i class="fa-solid fa-wallet text-white text-xl"></i>
          </div>
          <div>
            <div class="flex items-center gap-2 mb-1">
              <h3 class="text-lg font-bold text-white">Rechargez vos Cr√©dits Commission</h3>
              <span class="px-2 py-0.5 rounded-full text-[10px] font-bold uppercase bg-amber-500 text-white">Jusqu'√† +10% bonus</span>
            </div>
            <p class="text-violet-200/70 text-sm max-w-lg">
              Avancez vos commissions et oubliez les relances. Pr√©l√®vement automatique sur votre solde, vos bots restent toujours actifs.
            </p>
            <div class="flex items-center gap-4 mt-3">
              <div class="flex items-center gap-1.5 text-xs text-violet-300">
                <i class="fa-solid fa-check text-emerald-400"></i>
                Bonus exclusifs
              </div>
              <div class="flex items-center gap-1.5 text-xs text-violet-300">
                <i class="fa-solid fa-check text-emerald-400"></i>
                Fini les 14 jours
              </div>
              <div class="flex items-center gap-1.5 text-xs text-violet-300">
                <i class="fa-solid fa-check text-emerald-400"></i>
                Tranquillit√© totale
              </div>
            </div>
          </div>
        </div>
        
        <div class="flex items-center gap-3">
          <div class="text-right hidden md:block">
            <div class="text-xs text-violet-400">Votre solde</div>
            <div class="text-xl font-bold text-white"><%= number_to_currency(current_user.total_credits, unit: "‚Ç¨", format: "%n%u") %></div>
          </div>
          <%= link_to admin_shop_index_path(anchor: 'credits'), class: "px-5 py-3 rounded-xl bg-white text-violet-900 font-bold text-sm hover:bg-violet-100 transition-all shadow-lg flex items-center gap-2" do %>
            <i class="fa-solid fa-bolt"></i>
            Recharger maintenant
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
  
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <h1 class="text-3xl font-bold text-neutral-900 dark:text-white tracking-tight">
        Bienvenue, <%= @client.first_name || @client.email.split('@').first %>
      </h1>
      <p class="text-neutral-500 dark:text-neutral-400 mt-1">
        Surveillez et analysez vos performances de trading en temps r√©el
      </p>
    </div>
    <div>
      <%= link_to admin_shop_index_path, class: "flex items-center justify-center gap-1.5 rounded-lg border border-blue-400/30 bg-blue-600 px-3.5 py-2 text-sm font-medium whitespace-nowrap text-white shadow-sm transition-all duration-100 ease-in-out select-none hover:bg-blue-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-neutral-600 disabled:cursor-not-allowed disabled:opacity-50 dark:focus-visible:outline-neutral-200" do %>
        <i class="fa-solid fa-arrow-up-right"></i>
        <span>Explorer les bots</span>
      <% end %>
    </div>
  </div>
  
  <% if current_user.is_admin? %>
    <% if @unread_tickets_count > 0 %>
      <div class="flex items-center justify-between gap-4 p-4 rounded-xl border border-amber-200 dark:border-amber-800/50 bg-amber-50 dark:bg-amber-900/20">
        <div class="flex items-center gap-3">
          <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-amber-100 dark:bg-amber-800/30">
            <i class="fa-solid fa-exclamation-triangle text-amber-600 dark:text-amber-400"></i>
          </div>
          <div>
            <p class="font-semibold text-amber-800 dark:text-amber-200">Nouveaux tickets SAV</p>
            <p class="text-sm text-amber-700 dark:text-amber-300">
              <%= pluralize(@unread_tickets_count, "nouveau ticket", "nouveaux tickets") %> en attente de traitement
            </p>
          </div>
        </div>
        <%= link_to admin_support_tickets_path, class: "flex items-center justify-center gap-1.5 rounded-lg border border-amber-400/30 bg-amber-600 px-3.5 py-2 text-sm font-medium whitespace-nowrap text-white shadow-sm transition-all duration-100 ease-in-out select-none hover:bg-amber-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-neutral-600 disabled:cursor-not-allowed disabled:opacity-50 dark:focus-visible:outline-neutral-200" do %>
          Voir les tickets
        <% end %>
      </div>
    <% end %>

    <% all_accounts = Mt5Account.where.not(last_heartbeat_at: nil) %>
    <% online_accounts = all_accounts.where("last_heartbeat_at > ?", 30.seconds.ago) %>
    <% offline_accounts = all_accounts.where("last_heartbeat_at <= ?", 30.seconds.ago) %>
    
    <div class="p-5 rounded-2xl border <%= offline_accounts.any? ? 'border-red-200 dark:border-red-800/50 bg-red-50/50 dark:bg-red-900/10' : 'border-emerald-200 dark:border-emerald-800/50 bg-emerald-50/50 dark:bg-emerald-900/10' %>">
      <div class="flex items-center gap-4 mb-5">
        <div class="flex items-center justify-center w-12 h-12 rounded-xl <%= offline_accounts.any? ? 'bg-red-100 dark:bg-red-800/30' : 'bg-emerald-100 dark:bg-emerald-800/30' %>">
          <% if offline_accounts.any? %>
            <i class="fa-solid fa-triangle-exclamation text-xl text-red-600 dark:text-red-400"></i>
          <% else %>
            <i class="fa-solid fa-circle-check text-xl text-emerald-600 dark:text-emerald-400"></i>
          <% end %>
        </div>
        <div>
          <h3 class="font-bold text-neutral-900 dark:text-white">Monitoring des Comptes MT5</h3>
          <p class="text-sm text-neutral-500 dark:text-neutral-400"><%= all_accounts.count %> comptes suivis</p>
        </div>
      </div>
      
      <div class="grid grid-cols-2 gap-4 mb-5">
        <div class="flex items-center gap-3 p-4 rounded-xl bg-white/80 dark:bg-neutral-800/50 border border-neutral-200/50 dark:border-neutral-700/50">
          <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-emerald-100 dark:bg-emerald-800/30">
            <i class="fa-solid fa-signal text-emerald-600 dark:text-emerald-400"></i>
          </div>
          <div>
            <p class="text-2xl font-bold text-neutral-900 dark:text-white"><%= online_accounts.count %></p>
            <p class="text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wide">En ligne</p>
          </div>
        </div>
        
        <div class="flex items-center gap-3 p-4 rounded-xl bg-white/80 dark:bg-neutral-800/50 border border-neutral-200/50 dark:border-neutral-700/50">
          <div class="flex items-center justify-center w-10 h-10 rounded-lg <%= offline_accounts.any? ? 'bg-red-100 dark:bg-red-800/30' : 'bg-emerald-100 dark:bg-emerald-800/30' %>">
            <i class="fa-solid fa-circle-exclamation <%= offline_accounts.any? ? 'text-red-600 dark:text-red-400' : 'text-emerald-600 dark:text-emerald-400' %>"></i>
          </div>
          <div>
            <p class="text-2xl font-bold <%= offline_accounts.any? ? 'text-red-600 dark:text-red-400' : 'text-neutral-900 dark:text-white' %>"><%= offline_accounts.count %></p>
            <p class="text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wide">Hors ligne</p>
          </div>
        </div>
      </div>
      
      <% if offline_accounts.any? %>
        <div class="p-4 rounded-xl bg-red-100/50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/50">
          <p class="text-xs font-bold text-red-700 dark:text-red-400 uppercase tracking-wide mb-3">Comptes sans signal (30+ secondes)</p>
          <div class="space-y-2">
            <% offline_accounts.each do |account| %>
              <div class="flex items-center justify-between py-2 border-b border-red-200/50 dark:border-red-800/30 last:border-0">
                <span class="font-medium text-neutral-900 dark:text-white"><%= account.account_name %></span>
                <span class="text-sm text-neutral-500 dark:text-neutral-400">Vu il y a <%= time_ago_in_words(account.last_heartbeat_at) %></span>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>
    
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
    <div class="bg-neutral-900 overflow-hidden rounded-xl">
      <div class="px-4 py-5 sm:p-6">
        <dt class="text-sm font-medium text-neutral-500 dark:text-neutral-400 truncate">
          Balance Totale
        </dt>
        <dd class="mt-1 text-3xl font-semibold text-neutral-900 dark:text-white">
          <%= number_to_currency(@client.mt5_accounts.sum(:balance), unit: "‚Ç¨", format: "%n %u") %>
        </dd>
        <div class="mt-4">
          <div class="flex items-baseline">
            <span class="text-sm font-medium text-blue-600 dark:text-blue-400">
              <i class="fa-solid fa-wallet mr-1"></i>
              <%= @client.mt5_accounts.count %> compte<%= @client.mt5_accounts.count > 1 ? 's' : '' %>
            </span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="bg-neutral-900 overflow-hidden rounded-xl">
      <div class="px-4 py-5 sm:p-6">
        <dt class="text-sm font-medium text-neutral-500 dark:text-neutral-400 truncate">
          Gains Totaux
        </dt>
        <dd class="mt-1 text-3xl font-semibold <%= @client.total_profits >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400' %>">
          <%= number_to_currency(@client.total_profits, unit: "‚Ç¨", format: "%n %u") %>
        </dd>
        <div class="mt-4">
          <div class="flex items-baseline">
            <% if @client.total_profits >= 0 %>
              <span class="text-sm font-medium text-green-600 dark:text-green-400">
                <svg class="self-center inline-block w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
                Positif
              </span>
            <% else %>
              <span class="text-sm font-medium text-red-600 dark:text-red-400">
                <svg class="self-center inline-block w-4 h-4 mr-1 rotate-180" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
                N√©gatif
              </span>
            <% end %>
            <span class="ml-2 text-sm text-neutral-500 dark:text-neutral-400">
              performance globale
            </span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="bg-neutral-900 overflow-hidden rounded-xl">
      <div class="px-4 py-5 sm:p-6">
        <dt class="text-sm font-medium text-neutral-500 dark:text-neutral-400 truncate">
          Gain Moyen / Jour
        </dt>
        <dd class="mt-1 text-3xl font-semibold <%= @average_daily_gain >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400' %>">
          <%= number_to_currency(@average_daily_gain, unit: "‚Ç¨", format: "%n %u") %>
        </dd>
        <div class="mt-4">
          <div class="flex items-baseline">
            <% if @average_daily_gain >= 0 %>
              <span class="text-sm font-medium text-green-600 dark:text-green-400">
                <svg class="self-center inline-block w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
                Positif
              </span>
            <% else %>
              <span class="text-sm font-medium text-red-600 dark:text-red-400">
                <svg class="self-center inline-block w-4 h-4 mr-1 rotate-180" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
                N√©gatif
              </span>
            <% end %>
            <span class="ml-2 text-sm text-neutral-500 dark:text-neutral-400">
              sur 30 jours
            </span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="bg-neutral-900 overflow-hidden rounded-xl">
      <div class="px-4 py-5 sm:p-6">
        <dt class="text-sm font-medium text-neutral-500 dark:text-neutral-400 truncate">
          Commission Due
        </dt>
        <dd class="mt-1 text-3xl font-semibold text-neutral-900 dark:text-white">
          <%= number_to_currency(@client.total_commission_due, unit: "‚Ç¨", format: "%n %u") %>
        </dd>
        <div class="mt-4">
          <div class="flex items-baseline">
            <span class="text-sm font-medium text-indigo-600 dark:text-indigo-400">
              <i class="fa-solid fa-percent mr-1"></i>
              <%= number_to_percentage(@client.commission_rate, precision: 0) %>
            </span>
            <span class="ml-2 text-sm text-neutral-500 dark:text-neutral-400">
              taux de commission
            </span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="bg-neutral-900 overflow-hidden rounded-xl">
      <div class="px-4 py-5 sm:p-6">
        <dt class="text-sm font-medium text-neutral-500 dark:text-neutral-400 truncate">
          <% if @client.balance_due > 0 %>
            Solde √† Payer
          <% elsif @client.balance_due < 0 %>
            Solde Cr√©diteur
          <% else %>
            Solde
          <% end %>
        </dt>
        <dd class="mt-1 text-3xl font-semibold <%= @client.balance_due > 0 ? 'text-amber-600 dark:text-amber-400' : (@client.balance_due < 0 ? 'text-green-600 dark:text-green-400' : 'text-neutral-900 dark:text-white') %>">
          <%= number_to_currency(@client.balance_due.abs, unit: "‚Ç¨", format: "%n %u") %>
        </dd>
        <div class="mt-4">
          <div class="flex items-baseline">
            <% if @client.balance_due > 0 %>
              <span class="text-sm font-medium text-amber-600 dark:text-amber-400">
                <i class="fa-solid fa-exclamation-circle mr-1"></i>
                √Ä r√©gulariser
              </span>
            <% elsif @client.balance_due < 0 %>
              <span class="text-sm font-medium text-green-600 dark:text-green-400">
                <i class="fa-solid fa-check-circle mr-1"></i>
                Cr√©dit disponible
              </span>
            <% else %>
              <span class="text-sm font-medium text-neutral-500 dark:text-neutral-400">
                <i class="fa-solid fa-check mr-1"></i>
                Aucun solde
              </span>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
    
  <% if @bot_predictions&.any? %>
    <div class="p-6 rounded-2xl bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 shadow-sm">
      <div class="flex items-center justify-between mb-5">
        <div>
          <h2 class="text-xl font-bold text-neutral-900 dark:text-white flex items-center gap-2">
            <i class="fa-solid fa-layer-group text-blue-500"></i>
            Pr√©dictions Aujourd'hui
          </h2>
        </div>
        <span class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-800/50">
          En temps r√©el
        </span>
      </div>
      
      <% bots_with_predictions = @bot_predictions.select { |prediction| prediction[:predictions]&.select { |pred| pred[:date] == Date.current }&.any? } %>
      <% if bots_with_predictions.any? %>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <% bots_with_predictions.each do |prediction| %>
            <% today_predictions = prediction[:predictions]&.select { |pred| pred[:date] == Date.current } || [] %>
            <div class="p-4 rounded-xl bg-neutral-50 dark:bg-neutral-900/50 border border-neutral-200 dark:border-neutral-700">
              <div class="flex items-center gap-3 mb-4">
                <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 text-white text-lg">
                  ü§ñ
                </div>
                <div>
                  <h3 class="font-bold text-neutral-900 dark:text-white"><%= prediction[:bot][:name] %></h3>
                  <p class="text-xs text-neutral-500 dark:text-neutral-400">
                    <%= prediction[:total_trades] %> trades ‚Ä¢ <%= prediction[:success_rate] %>% succ√®s
                  </p>
                </div>
              </div>
              
              <p class="text-xs font-semibold text-neutral-500 dark:text-neutral-400 uppercase tracking-wide mb-3">Pr√©dictions</p>
              <% if today_predictions.any? %>
                <div class="space-y-2">
                  <% today_predictions.each do |pred| %>
                    <div class="flex items-center gap-3 p-2 rounded-lg bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700">
                      <span class="text-sm font-semibold text-neutral-700 dark:text-neutral-300 w-10"><%= pred[:hour] %>h</span>
                      <div class="flex-1 h-2 rounded-full bg-neutral-200 dark:bg-neutral-700 overflow-hidden">
                        <div class="h-full rounded-full bg-gradient-to-r from-red-500 via-amber-500 to-emerald-500" style="width: <%= (pred[:probability] * 100).round %>%"></div>
                      </div>
                      <span class="text-sm font-semibold text-neutral-700 dark:text-neutral-300 w-12 text-right"><%= (pred[:probability] * 100).round %>%</span>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <div class="text-center py-6 text-neutral-400">
                  <i class="fa-regular fa-calendar text-2xl mb-2"></i>
                  <p class="text-sm">Aucune pr√©diction pour aujourd'hui</p>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center py-12 text-neutral-400">
          <i class="fa-solid fa-robot text-4xl mb-3 opacity-50"></i>
          <h3 class="font-semibold text-neutral-600 dark:text-neutral-300 mb-1">Aucun bot actif aujourd'hui</h3>
          <p class="text-sm">Vos bots n'ont pas de pr√©dictions pour aujourd'hui.</p>
        </div>
      <% end %>
    </div>
  <% end %>
    
  <div class="p-6 rounded-2xl bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 shadow-sm">
    <div class="mb-5">
      <h2 class="text-xl font-bold text-neutral-900 dark:text-white flex items-center gap-2">
        <i class="fa-solid fa-chart-bar text-blue-500"></i>
        Performances des Bots
      </h2>
      <p class="text-sm text-neutral-500 dark:text-neutral-400 mt-1">Analyse d√©taill√©e des performances de tous vos bots</p>
    </div>
    
    <div class="relative h-[400px] w-full">
      <div id="bots-chart-loading" class="absolute inset-0 flex flex-col items-center justify-center rounded-xl bg-neutral-50 dark:bg-neutral-900/50 border border-neutral-200 dark:border-neutral-700">
        <div class="w-10 h-10 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
        <p class="mt-4 text-sm text-neutral-500 dark:text-neutral-400">Chargement du graphique...</p>
      </div>
      <canvas id="botsChart" class="hidden"></canvas>
    </div>
  </div>
    
  <div class="p-6 rounded-2xl bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 shadow-sm">
    <div class="mb-5">
      <h2 class="text-xl font-bold text-neutral-900 dark:text-white flex items-center gap-2">
        <i class="fa-solid fa-arrow-trend-up text-blue-500"></i>
        Profits Mensuels & Projection
      </h2>
      <p class="text-sm text-neutral-500 dark:text-neutral-400 mt-1">Performance historique et projection future</p>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div class="flex items-start gap-4 p-4 rounded-xl bg-neutral-50 dark:bg-neutral-900/50 border border-neutral-200 dark:border-neutral-700">
        <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-neutral-200 dark:bg-neutral-700">
          <i class="fa-regular fa-clock text-neutral-600 dark:text-neutral-400"></i>
        </div>
        <div>
          <h3 class="font-semibold text-neutral-900 dark:text-white">Performance Historique</h3>
          <p class="text-sm text-neutral-500 dark:text-neutral-400">Vos profits r√©els des 12 derniers mois</p>
        </div>
      </div>
      <div class="flex items-start gap-4 p-4 rounded-xl bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800/50">
        <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-800/30">
          <i class="fa-solid fa-bullseye text-blue-600 dark:text-blue-400"></i>
        </div>
        <div>
          <h3 class="font-semibold text-neutral-900 dark:text-white">Projection (6 mois)</h3>
          <p class="text-sm text-neutral-500 dark:text-neutral-400">
            Bas√©e sur votre moyenne mensuelle: <strong class="text-blue-600 dark:text-blue-400"><%= number_to_currency((@projection_data&.last&.dig(:balance) || 0 - current_user.mt5_accounts.sum(:balance)) / 6, unit: "‚Ç¨", format: "%n %u") %>/mois</strong>
          </p>
        </div>
      </div>
    </div>
    
    <div class="relative h-[400px] w-full">
      <div id="chart-loading" class="absolute inset-0 flex flex-col items-center justify-center rounded-xl bg-neutral-50 dark:bg-neutral-900/50 border border-neutral-200 dark:border-neutral-700">
        <div class="w-10 h-10 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
        <p class="mt-4 text-sm text-neutral-500 dark:text-neutral-400">Chargement du graphique...</p>
      </div>
      <canvas id="portfolioChart" class="hidden"></canvas>
    </div>
  </div>
    
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="p-6 rounded-2xl bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 shadow-sm">
      <div class="mb-5">
        <h2 class="text-xl font-bold text-neutral-900 dark:text-white flex items-center gap-2">
          <i class="fa-solid fa-wallet text-blue-500"></i>
          Comptes MT5
        </h2>
      </div>
      
      <% if @mt5_accounts&.any? %>
        <div class="overflow-x-auto -mx-6">
          <table class="w-full">
            <thead>
              <tr class="border-b border-neutral-200 dark:border-neutral-700">
                <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 dark:text-neutral-400 uppercase tracking-wide">Compte</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 dark:text-neutral-400 uppercase tracking-wide">Balance</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 dark:text-neutral-400 uppercase tracking-wide">Gains</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-neutral-100 dark:divide-neutral-700/50">
              <% @mt5_accounts.each do |account| %>
                <tr class="hover:bg-neutral-50 dark:hover:bg-neutral-700/30 transition-colors">
                  <td class="px-6 py-4">
                    <div class="flex items-center gap-2">
                      <i class="fa-regular fa-user text-neutral-400"></i>
                      <span class="font-medium text-neutral-900 dark:text-white"><%= account.account_name %></span>
                    </div>
                  </td>
                  <td class="px-6 py-4 font-semibold text-neutral-900 dark:text-white">
                    <%= number_to_currency(account.balance, unit: "‚Ç¨", format: "%n %u") %>
                  </td>
                  <td class="px-6 py-4 font-semibold <%= account.net_gains > 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400' %>">
                    <%= number_to_currency(account.net_gains, unit: "‚Ç¨", format: "%n %u") %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="text-center py-12 text-neutral-400">
          <i class="fa-solid fa-wallet text-4xl mb-3 opacity-50"></i>
          <h3 class="font-semibold text-neutral-600 dark:text-neutral-300 mb-1">Aucun compte MT5</h3>
          <p class="text-sm">Connectez vos comptes pour commencer</p>
        </div>
      <% end %>
    </div>
    
    <div class="p-6 rounded-2xl bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 shadow-sm">
      <div class="mb-5">
        <h2 class="text-xl font-bold text-neutral-900 dark:text-white flex items-center gap-2">
          <i class="fa-solid fa-bolt text-blue-500"></i>
          Activit√© R√©cente
        </h2>
      </div>
      
      <% recent_trades = @client.trades.order(close_time: :desc).limit(5) %>
      <% if recent_trades.any? %>
        <div class="overflow-x-auto -mx-6">
          <table class="w-full">
            <thead>
              <tr class="border-b border-neutral-200 dark:border-neutral-700">
                <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 dark:text-neutral-400 uppercase tracking-wide">Date</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 dark:text-neutral-400 uppercase tracking-wide">Symbole</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 dark:text-neutral-400 uppercase tracking-wide">Profit</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-neutral-100 dark:divide-neutral-700/50">
              <% recent_trades.each do |trade| %>
                <tr class="hover:bg-neutral-50 dark:hover:bg-neutral-700/30 transition-colors">
                  <td class="px-6 py-4 text-neutral-600 dark:text-neutral-400">
                    <%= trade.close_time&.strftime("%d/%m/%Y") || "Ouvert" %>
                  </td>
                  <td class="px-6 py-4 font-medium text-neutral-900 dark:text-white">
                    <%= trade.symbol %>
                  </td>
                  <td class="px-6 py-4 font-semibold <%= trade.profit > 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400' %>">
                    <%= number_to_currency(trade.profit, unit: "‚Ç¨", format: "%n %u") %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="text-center py-12 text-neutral-400">
          <i class="fa-solid fa-bolt text-4xl mb-3 opacity-50"></i>
          <h3 class="font-semibold text-neutral-600 dark:text-neutral-300 mb-1">Aucune transaction r√©cente</h3>
          <p class="text-sm">Vos trades appara√Ætront ici</p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script data-turbo-track="reload">
function loadChartJS() {
  return new Promise((resolve, reject) => {
    if (typeof Chart !== 'undefined') {
      resolve(Chart);
      return;
    }
    
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
    script.onload = () => resolve(Chart);
    script.onerror = () => reject(new Error('Failed to load Chart.js'));
    document.head.appendChild(script);
  });
}

async function initializeBotsChart() {
  try {
    await loadChartJS();
    
    const ctx = document.getElementById('botsChart');
    if (!ctx) return;
    
    const loadingDiv = document.getElementById('bots-chart-loading');
    
    const botsData = <%= raw current_user.bot_purchases.includes(:trading_bot).map { |bp| 
      user_trades = Trade.joins(:mt5_account).where(mt5_accounts: { user_id: current_user.id })
                         .where(magic_number: bp.magic_number)
      winning_trades = user_trades.where("profit > 0").count
      total_trades = user_trades.count
      success_rate = total_trades > 0 ? (winning_trades.to_f / total_trades * 100).round(2) : 0
      
      {
        name: bp.trading_bot.name,
        profit: bp.total_profit || 0,
        trades: bp.trades_count || 0,
        success_rate: success_rate,
        magic_number: bp.magic_number
      }
    }.to_json %>;
    
    if (botsData.length === 0) {
      loadingDiv.innerHTML = '<div class="flex flex-col items-center justify-center text-neutral-400"><i class="fa-solid fa-robot text-4xl mb-3 opacity-50"></i><h3 class="font-semibold text-neutral-600 dark:text-neutral-300 mb-1">Aucun bot trouv√©</h3><p class="text-sm">Vous n\'avez pas encore de bots assign√©s</p></div>';
      return;
    }
    
    if (loadingDiv) loadingDiv.style.display = 'none';
    ctx.classList.remove('hidden');
    ctx.style.display = 'block';
    
    const textColor = '#94a3b8';
    const gridColor = 'rgba(148, 163, 184, 0.1)';
    const botNames = botsData.map(bot => bot.name);
    const profits = botsData.map(bot => bot.profit);
    const tradesCount = botsData.map(bot => bot.trades);
    
    const profitColors = profits.map(profit => profit >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)');
    const borderColors = profits.map(profit => profit >= 0 ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 1)');
    
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: botNames,
        datasets: [
          {
            label: 'Profit Total (‚Ç¨)',
            data: profits,
            backgroundColor: profitColors,
            borderColor: borderColors,
            borderWidth: 2,
            borderRadius: 8,
            yAxisID: 'y-profit'
          },
          {
            label: 'Nombre de Trades',
            data: tradesCount,
            type: 'line',
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 3,
            pointBackgroundColor: '#3b82f6',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 6,
            yAxisID: 'y-trades'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: { color: textColor, font: { size: 12, family: 'Inter, sans-serif' } }
          },
          tooltip: {
            backgroundColor: 'rgba(23, 23, 23, 0.95)',
            titleColor: '#fff',
            bodyColor: '#e2e8f0',
            borderColor: 'rgba(255, 255, 255, 0.1)',
            borderWidth: 1,
            cornerRadius: 8,
            padding: 12,
            callbacks: {
              afterBody: function(context) {
                const index = context[0].dataIndex;
                const bot = botsData[index];
                return [`Magic Number: ${bot.magic_number}`, `Taux de r√©ussite: ${bot.success_rate}%`];
              }
            }
          }
        },
        scales: {
          x: {
            ticks: { color: textColor, font: { size: 11 } },
            grid: { color: gridColor }
          },
          'y-profit': {
            type: 'linear',
            display: true,
            position: 'left',
            title: { display: true, text: 'Profit (‚Ç¨)', color: textColor },
            ticks: { color: textColor, callback: function(value) { return value.toFixed(0) + '‚Ç¨'; } },
            grid: { color: gridColor }
          },
          'y-trades': {
            type: 'linear',
            display: true,
            position: 'right',
            title: { display: true, text: 'Nombre de Trades', color: textColor },
            ticks: { color: textColor },
            grid: { drawOnChartArea: false }
          }
        },
        interaction: { intersect: false, mode: 'index' }
      }
    });
  } catch (error) {
    console.error('Error initializing bots chart:', error);
  }
}

async function initializeChart() {
  try {
    await loadChartJS();
    
    const ctx = document.getElementById('portfolioChart');
    if (!ctx) return;
    
    if (window.portfolioChartInstance) {
      window.portfolioChartInstance.destroy();
    }
    
    const loadingDiv = document.getElementById('chart-loading');
    if (loadingDiv) loadingDiv.style.display = 'none';
    ctx.classList.remove('hidden');
    ctx.style.display = 'block';
  
    const textColor = '#94a3b8';
    const gridColor = 'rgba(148, 163, 184, 0.1)';
    
    const historicalData = <%= raw @monthly_profits.to_json %>;
    const projectionData = <%= raw @projection_data.to_json %>;
    const currentBalance = <%= current_user.mt5_accounts.sum(:balance) %>;
    
    const historicalLabels = historicalData.map(d => d.month);
    const projectionLabels = projectionData.map(d => d.month);
    const allLabels = [...historicalLabels, ...projectionLabels];
    
    const historicalProfits = historicalData.map(d => d.profit);
    const projectionProfits = new Array(historicalData.length).fill(null);
    projectionData.forEach((d, i) => {
      projectionProfits.push(d.balance);
    });
    
    projectionProfits[historicalData.length] = currentBalance;
    
    window.portfolioChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: allLabels,
        datasets: [
          {
            type: 'bar',
            label: 'Profits Mensuels',
            data: [...historicalProfits, ...new Array(projectionData.length).fill(null)],
            backgroundColor: historicalProfits.map(p => p >= 0 ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'),
            borderColor: historicalProfits.map(p => p >= 0 ? 'rgba(16, 185, 129, 0.6)' : 'rgba(239, 68, 68, 0.6)'),
            borderWidth: 1,
            borderRadius: 6,
            yAxisID: 'y',
            order: 2
          },
          {
            type: 'line',
            label: 'Balance Projet√©e',
            data: projectionProfits,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 3,
            borderDash: [8, 4],
            fill: false,
            tension: 0.4,
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBackgroundColor: '#3b82f6',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            yAxisID: 'y1',
            order: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { intersect: false, mode: 'index' },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              color: textColor,
              font: { size: 12, weight: '500', family: 'Inter, sans-serif' },
              padding: 15,
              usePointStyle: true
            }
          },
          tooltip: {
            backgroundColor: 'rgba(23, 23, 23, 0.95)',
            titleColor: '#fff',
            bodyColor: '#e2e8f0',
            borderColor: 'rgba(255, 255, 255, 0.1)',
            borderWidth: 1,
            cornerRadius: 8,
            padding: 12,
            displayColors: true,
            callbacks: {
              label: function(context) {
                if (context.parsed.y === null) return '';
                let label = context.dataset.label || '';
                if (label) label += ': ';
                const value = context.parsed.y;
                const formattedValue = Math.abs(value).toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
                label += value >= 0 ? formattedValue : '-' + formattedValue;
                return label;
              }
            }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { color: textColor, font: { size: 11 }, maxRotation: 45, minRotation: 45 }
          },
          y: {
            type: 'linear',
            position: 'left',
            beginAtZero: true,
            grid: { color: gridColor, drawBorder: false },
            ticks: {
              color: textColor,
              font: { size: 11 },
              callback: function(value) { return value.toLocaleString('fr-FR', { maximumFractionDigits: 0 }) + ' ‚Ç¨'; }
            },
            title: { display: true, text: 'Profits Mensuels', color: textColor, font: { size: 11, weight: '500' } }
          },
          y1: {
            type: 'linear',
            position: 'right',
            grid: { display: false },
            ticks: {
              color: textColor,
              font: { size: 11 },
              callback: function(value) { return value.toLocaleString('fr-FR', { maximumFractionDigits: 0 }) + ' ‚Ç¨'; }
            },
            title: { display: true, text: 'Balance Projet√©e', color: textColor, font: { size: 11, weight: '500' } }
          }
        }
      }
    });
  } catch (error) {
    console.error('Error initializing chart:', error);
  }
}

document.addEventListener('DOMContentLoaded', function() {
  initializeChart();
  initializeBotsChart();
});
document.addEventListener('turbo:load', function() {
  initializeChart();
  initializeBotsChart();
});
document.addEventListener('turbo:render', function() {
  initializeChart();
  initializeBotsChart();
});

function refreshMonitoringWidget() {
  fetch('/admin/dashboard/monitoring_status', { headers: { 'Accept': 'application/json' } })
    .then(response => response.json())
    .then(data => updateMonitoringWidget(data))
    .catch(error => console.error('Error refreshing monitoring widget:', error));
}

function updateMonitoringWidget(data) {
  // Widget update logic preserved
}

setInterval(refreshMonitoringWidget, 10000);
</script>

<%= render 'admin/shared/campaign_popup' %>
