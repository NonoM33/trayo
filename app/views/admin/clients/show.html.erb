<!DOCTYPE html>
<html>
<head>
  <title>Client Details - Admin Trayo</title>
  <%= stylesheet_link_tag "admin" %>
  <style>
    .container { max-width: 1600px; }
    .alert { padding: 15px; margin-bottom: 20px; background: #f44336; color: white; border-radius: 4px; }
    .status-pending { color: #ff9800; font-weight: 600; }
    .status-validated { color: #4CAF50; font-weight: 600; }
    .status-rejected { color: #f44336; font-weight: 600; }
    .form-inline { display: inline; }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .positive { color: #10b981; }
  .negative { color: #ef4444; }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
  }
  
  .stat-item {
    text-align: center;
    padding: 1rem;
    background: var(--bg-hover);
    border-radius: 6px;
  }
  
  .stat-value {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
  }
  
  .stat-label {
    font-size: 0.875rem;
    color: var(--text-muted);
  }
  
  .trade-type-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .trade-type-badge.buy {
    background: #10b981;
    color: white;
  }
  
  .trade-type-badge.sell {
    background: #ef4444;
    color: white;
  }
  
  .magic-badge {
    background: var(--primary-color);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  
  .empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--text-muted);
  }
  
  .empty-state-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }
  
  .empty-state h3 {
    margin-bottom: 0.5rem;
    color: var(--text-color);
  }
  
  .empty-state ul {
    text-align: left;
    max-width: 400px;
    margin: 0 auto;
  }
  
  .card-header-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  
  .action-btn {
    background: var(--bg-hover);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    padding: 0;
    margin: 0;
  }
  
  .action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  
  .action-btn:active {
    transform: translateY(0);
  }
  
  .action-btn-start {
    background: linear-gradient(135deg, #10b981, #059669);
    border-color: #10b981;
    color: white;
  }
  
  .action-btn-start:hover {
    background: linear-gradient(135deg, #059669, #047857);
  }
  
  .action-btn-stop {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    border-color: #f59e0b;
    color: white;
  }
  
  .action-btn-stop:hover {
    background: linear-gradient(135deg, #d97706, #b45309);
  }
  
  .action-btn-delete {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
  }
  
  .action-btn-delete:hover {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
  }
  
  .action-btn i {
    font-size: 12px;
  }
</style>
</head>
<body>
  <% @page_title = "Client Details" %>
  
  <div class="app-layout">
    <%= render 'admin/shared/sidebar' %>
    
    <div class="main-content">
      <%= render 'admin/shared/navbar' %>
      
      <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <% if current_user.is_admin? %>
        <%= link_to admin_clients_path, class: "back-link", style: "margin: 0;" do %>
          <i class="fa-icon fa-md fa-arrow-left"></i> Retour aux Clients
        <% end %>
      <% else %>
        <h1 style="margin: 0;">Mon Profil</h1>
      <% end %>
      <%= link_to edit_admin_client_path(@client), class: "btn btn-primary" do %>
        <i class="fa-icon fa-md fa-edit"></i> Modifier <%= current_user.is_admin? ? 'le Profil Utilisateur' : 'Mon Profil' %>
      <% end %>
    </div>

    <% if flash[:notice] %>
      <div class="notice"><%= flash[:notice] %></div>
    <% end %>
    <% if flash[:alert] %>
      <div class="alert"><%= flash[:alert] %></div>
    <% end %>

    <div class="card">
      <h2><%= current_user.is_admin? ? "Client : #{@client.email}" : "Informations Personnelles" %></h2>
      
      <% if @client.mt5_api_token.present? && current_user.is_admin? %>
        <div style="background: #e3f2fd; padding: 15px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
          <div style="font-weight: 600; color: #1976D2; margin-bottom: 8px;">
            <i class="fa-icon fa-md fa-shield-alt"></i>
            Token API MT5
          </div>
          <div style="font-family: monospace; font-size: 14px; color: #333; word-break: break-all; background: white; padding: 10px; border-radius: 4px;">
            <%= @client.mt5_api_token %>
          </div>
          <div style="font-size: 12px; color: #666; margin-top: 8px;">
            <i class="fa-icon fa-md fa-info-circle"></i> Ce token doit être configuré dans le script MT5 (TrayoSync.mq5) pour la synchronisation du compte
          </div>
        </div>
      <% end %>
      
      <div class="info-grid">
        <% if current_user.is_admin? %>
          <div class="info-item">
            <div class="info-label">Capital à l'instant T</div>
            <div class="info-value positive">
              <%= number_to_currency(@mt5_accounts.sum(&:balance), unit: "€", format: "%n %u") %>
            </div>
            <div class="help-text" style="font-size: 12px; color: var(--text-muted); margin-top: 5px;">
              Balance actuelle totale
            </div>
          </div>
        <% end %>
        <% if current_user.is_admin? %>
          <div class="info-item">
            <div class="info-label">High Watermark</div>
            <div class="info-value positive">
              <%= number_to_currency(@mt5_accounts.sum(&:high_watermark), unit: "€", format: "%n %u") %>
            </div>
            <div class="help-text" style="font-size: 12px; color: var(--text-muted); margin-top: 5px;">
              Plus haut niveau atteint
            </div>
          </div>
        <% end %>
        <% if current_user.is_admin? %>
          <div class="info-item">
            <div class="info-label">Taux de Commission</div>
            <div class="info-value"><%= number_to_percentage(@client.commission_rate, precision: 1) %></div>
          </div>
        <% end %>
        <div class="info-item">
          <div class="info-label">Gains Totaux</div>
          <div class="info-value <%= @client.total_profits >= 0 ? 'positive' : 'negative' %>">
            <%= number_to_currency(@client.total_profits, unit: "€", format: "%n %u") %>
          </div>
          <div class="help-text" style="font-size: 12px; color: var(--text-muted); margin-top: 5px;">
            Gains réels + retraits effectués
          </div>
        </div>
        <% if current_user.is_admin? %>
          <div class="info-item">
            <div class="info-label">Gains Commissionnables</div>
            <div class="info-value <%= @client.total_commissionable_gains >= 0 ? 'positive' : 'negative' %>">
              <%= number_to_currency(@client.total_commissionable_gains, unit: "€", format: "%n %u") %>
            </div>
          </div>
        <% end %>
        <% if current_user.is_admin? %>
          <div class="info-item">
            <div class="info-label">Commission Due</div>
            <div class="info-value <%= @client.total_commission_due < 0 ? 'negative' : 'positive' %>">
              <%= number_to_currency(@client.total_commission_due, unit: "€", format: "%n %u") %>
            </div>
          </div>
        <% end %>
        <% if current_user.is_admin? %>
          <div class="info-item">
            <div class="info-label">Crédits Appliqués</div>
            <div class="info-value positive"><%= number_to_currency(@client.total_credits, unit: "€", format: "%n %u") %></div>
          </div>
        <% end %>
        <% if current_user.is_admin? %>
          <div class="info-item">
            <% if @client.balance_due > 0 %>
              <div class="info-label">Solde à Payer</div>
              <div class="info-value positive">
                <%= number_to_currency(@client.balance_due, unit: "€", format: "%n %u") %>
              </div>
            <% elsif @client.balance_due < 0 %>
              <div class="info-label">Solde Créditeur</div>
              <div class="info-value negative">
                <%= number_to_currency(@client.balance_due.abs, unit: "€", format: "%n %u") %>
              </div>
            <% else %>
              <div class="info-label">Solde à Payer</div>
              <div class="info-value" style="color: #4CAF50;">
                0 € <i class="fa-icon fa-md fa-check-circle"></i>
              </div>
            <% end %>
          </div>
        <% end %>
        <div class="info-item">
          <div class="info-label">Historique Paiements</div>
          <div class="info-value" style="font-size: 16px; color: #666;">
            <%= number_to_currency(@client.total_validated_payments, unit: "€", format: "%n %u") %> payés
          </div>
        </div>
      </div>

      <% if current_user.is_admin? %>
        <h3>Mettre à Jour le Taux de Commission</h3>
        <%= form_with model: @client, url: admin_client_path(@client), method: :patch do |f| %>
          <div class="form-group">
            <%= f.label :commission_rate, "Taux de Commission (%)" %>
            <%= f.number_field :commission_rate, step: 0.01, min: 0, max: 100 %>
          </div>
          <%= f.submit "Mettre à Jour", class: "btn" %>
        <% end %>
        
        <div class="mt-4">
          <h3>Gestion MT5</h3>
          <div class="mt5-controls">
            <% if @client.init_mt5? %>
              <div class="status-indicator">
                <span class="status-badge status-validated">
                  <i class="fa-icon fa-md fa-check-circle"></i>
                  <span style="color: white;">MT5 Initialisé</span>
                </span>
                <p class="help-text">Le compte MT5 a été synchronisé avec l'historique complet.</p>
              </div>
              <%= button_to "Réinitialiser MT5", reset_mt5_admin_client_path(@client), 
                    method: :post,
                    class: "btn btn-outline",
                    data: { turbo_confirm: "Réinitialiser la synchronisation MT5 ? Cela forcera une nouvelle synchronisation complète de l'historique." } %>
            <% else %>
              <div class="status-indicator">
                <span class="status-badge status-pending">
                  <span style="color: white;">
                    <i class="fa-icon fa-md fa-clock"></i>
                    MT5 Non Initialisé
                  </span>
                </span>
                <p class="help-text">Le compte MT5 nécessite une synchronisation complète de l'historique.</p>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <% if current_user.is_admin? %>
      <div class="card">
        <h2>Comptes MT5</h2>
        <div class="info-box" style="background: var(--bg-hover); padding: 12px; border-radius: 6px; margin-bottom: 15px;">
          <div style="font-size: 13px; color: var(--text-muted);">
            <strong>💡 Calcul des gains :</strong><br>
            • <strong>Gains Nets</strong> = Balance actuelle - Capital initial + Retraits effectués<br>
            • <strong>Gains Commissionnables</strong> = Balance actuelle - High Watermark ajusté<br>
            • Les retraits augmentent les gains nets car ils représentent de l'argent gagné et retiré
          </div>
        </div>
      <% if @mt5_accounts.any? %>
        <table>
          <thead>
            <tr>
              <th>Balance Initiale</th>
              <th>Balance Actuelle</th>
              <th>Gains Nets</th>
              <th>High Watermark</th>
              <th>Retraits</th>
              <th>Commissionnable</th>
              <% if current_user.is_admin? %>
                <th>Actions</th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <% @mt5_accounts.each do |account| %>
              <tr>
                <td><%= number_to_currency(account.auto_calculated_initial_balance && account.calculated_initial_balance.present? ? account.calculated_initial_balance : account.initial_balance, unit: "€", format: "%n %u") %></td>
                <td><%= number_to_currency(account.balance, unit: "€", format: "%n %u") %></td>
                <td class="<%= account.net_gains > 0 ? 'positive' : 'negative' %>">
                  <%= number_to_currency(account.net_gains, unit: "€", format: "%n %u") %>
                </td>
                <td><%= number_to_currency(account.high_watermark, unit: "€", format: "%n %u") %></td>
                <td><%= number_to_currency(account.total_withdrawals, unit: "€", format: "%n %u") %></td>
                <td class="<%= account.commissionable_gains >= 0 ? 'positive' : 'negative' %>">
                  <%= number_to_currency(account.commissionable_gains, unit: "€", format: "%n %u") %>
                </td>
                <% if current_user.is_admin? %>
                  <td>
                    <% unauthorized_count = account.trades.unauthorized_manual.count %>
                    <% if unauthorized_count > 0 %>
                      <div class="warning-badge" style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-bottom: 4px;">
                        ⚠️ <%= unauthorized_count %> trade(s) manuel(s)
                      </div>
                    <% end %>
                    <div class="action-buttons">
                      <button onclick="document.getElementById('edit-account-<%= account.id %>').style.display='block'" class="btn btn-outline btn-sm">
                        Modifier
                      </button>
                      <%= button_to "Recalculer Balance", admin_mt5_account_path(account, action: 'recalculate_initial_balance'), 
                            method: :patch,
                            data: { turbo_confirm: "Recalculer la balance initiale basée sur les dépôts ?" },
                            class: "btn btn-primary btn-sm",
                            style: "margin-left: 5px;" %>
                    </div>
                  </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p style="color: #999;">Aucun compte MT5 pour le moment</p>
      <% end %>
      </div>
    <% end %>

    <!-- Section Trades Manuels -->
    <% if current_user.is_admin? && @mt5_accounts.any? %>
      <% manual_trades = Trade.joins(:mt5_account).where(mt5_accounts: { user_id: @client.id })
                             .where(trade_originality: ['manual_pending_review', 'manual_client', 'manual_admin']) %>
      
      <% if manual_trades.any? %>
        <div class="card">
          <h2>⚠️ Trades Manuels (Trade Defender)</h2>
          <div class="info-box" style="background: #fef3c7; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
            <div style="font-size: 13px; color: #78350f;">
              <strong>⚠️ Détection des trades manuels :</strong><br>
              • Les trades avec magic_number = 0 sont des trades manuels<br>
              • Ils doivent être validés dans la page Trade Defender<br>
              • Les trades clients non autorisés sont automatiquement sanctionnés
            </div>
          </div>

          <div class="info-grid" style="margin-bottom: 1rem;">
            <div class="stat-item">
              <div class="stat-value" style="color: #f59e0b;">
                ⏳ <%= manual_trades.where(trade_originality: 'manual_pending_review').count %>
              </div>
              <div class="stat-label">En attente</div>
            </div>
            <div class="stat-item">
              <div class="stat-value positive">
                ✓ <%= manual_trades.where(trade_originality: 'manual_admin').count %>
              </div>
              <div class="stat-label">Mes trades</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" style="color: #ef4444;">
                ⚠️ <%= manual_trades.where(trade_originality: 'manual_client').count %>
              </div>
              <div class="stat-label">Clients sanctionnés</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" style="color: #ef4444;">
                <%= number_to_currency(manual_trades.where(trade_originality: 'manual_client').sum(:profit), unit: "€") %>
              </div>
              <div class="stat-label">Impact total</div>
            </div>
          </div>

          <%= link_to "Voir dans Trade Defender →", admin_trade_defenders_path(status: 'manual_pending_review', account_id: @mt5_accounts.first.id), class: "btn btn-primary" %>
        </div>
      <% end %>
    <% end %>

    <!-- Résumé des Trades -->
    <% if current_user.is_admin? && @mt5_accounts.any? %>
      <div class="card">
        <div class="card-header">
          <h2>Résumé des Trades</h2>
          <div class="card-header-actions">
            <%= link_to "Analyse des Bots", bots_admin_client_path(@client), class: "btn btn-primary btn-sm" %>
            <%= link_to "Voir tous les trades", trades_admin_client_path(@client), class: "btn btn-outline btn-sm" %>
          </div>
        </div>
        
        <% 
          all_trades = Trade.joins(:mt5_account).where(mt5_accounts: { user_id: @client.id })
          recent_trades = all_trades.order(close_time: :desc).limit(10)
          total_trades = all_trades.count
          total_profit = all_trades.sum(:profit)
          winning_trades = all_trades.where('profit > 0').count
          losing_trades = all_trades.where('profit < 0').count
          win_rate = total_trades > 0 ? (winning_trades.to_f / total_trades * 100).round(2) : 0
        %>
        
        <div class="stats-grid" style="margin-bottom: 1.5rem;">
          <div class="stat-item">
            <div class="stat-value">
              <%= stat_icon(:trades, size: 'sm') %>
              <%= total_trades %>
            </div>
            <div class="stat-label">Total Trades</div>
          </div>
          <div class="stat-item">
            <div class="stat-value <%= total_profit >= 0 ? 'positive' : 'negative' %>">
              <%= profit_icon(total_profit) %>
              <%= number_to_currency(total_profit, unit: "€", format: "%n %u") %>
            </div>
            <div class="stat-label">Profit Total</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">
              <%= stat_icon(:win_rate, size: 'sm') %>
              <%= win_rate %>%
            </div>
            <div class="stat-label">Taux de Réussite</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">
              <%= stat_icon(:trades, size: 'sm') %>
              <%= winning_trades %>/<%= losing_trades %>
            </div>
            <div class="stat-label">Gagnants/Perdants</div>
          </div>
        </div>
        
        <% if recent_trades.any? %>
          <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #2196F3;">
            <div style="font-size: 13px; color: #1976D2;">
              <strong>💡 Calcul du Profit :</strong><br>
              • <strong>Profit Net</strong> : Profit final (déjà net des commissions et swap)<br>
              • <strong>Commission</strong> : Commission du broker pour ce trade<br>
              • <strong>Swap</strong> : Frais de report (positif ou négatif)<br>
              • Les données MT5 arrivent déjà avec le profit net calculé
            </div>
          </div>
          <h4>
            <%= stat_icon(:trades, size: 'md') %>
            Derniers Trades
          </h4>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>
                    <%= stat_icon(:monthly, size: 'sm') %>
                    Date
                  </th>
                  <th>
                    <%= stat_icon(:symbols, size: 'sm') %>
                    Symbole
                  </th>
                  <th>
                    <%= stat_icon(:trades, size: 'sm') %>
                    Type
                  </th>
                  <th>
                    <%= stat_icon(:volume, size: 'sm') %>
                    Volume
                  </th>
                  <th>
                    <%= stat_icon(:profit, size: 'sm') %>
                    Profit Net
                  </th>
                  <th>
                    <%= stat_icon(:profit, size: 'sm') %>
                    Commission
                  </th>
                  <th>
                    <%= stat_icon(:profit, size: 'sm') %>
                    Swap
                  </th>
                  <th>
                    <%= stat_icon(:bots, size: 'sm') %>
                    Bot
                  </th>
                </tr>
              </thead>
              <tbody>
                <% recent_trades.each do |trade| %>
                  <tr>
                    <td><%= trade.close_time&.strftime("%d/%m/%Y %H:%M") %></td>
                    <td><%= trade.symbol %></td>
                    <td>
                      <span class="trade-type-badge <%= trade.trade_type %>">
                        <%= trade.trade_type&.upcase %>
                      </span>
                    </td>
                    <td><%= trade.volume %></td>
                    <td class="<%= trade.profit >= 0 ? 'positive' : 'negative' %>">
                      <%= number_to_currency(trade.profit, unit: "€", format: "%n %u") %>
                    </td>
                    <td>
                      <%= number_to_currency(trade.commission || 0, unit: "€", format: "%n %u") %>
                    </td>
                    <td>
                      <%= number_to_currency(trade.swap || 0, unit: "€", format: "%n %u") %>
                    </td>
                    <td>
                      <% if trade.magic_number.present? %>
                        <span class="magic-badge"><%= bot_name_for_magic_number(trade.magic_number, @bots_cache) %></span>
                      <% else %>
                        <span class="text-muted">-</span>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <p style="color: #999;">Aucun trade trouvé</p>
        <% end %>
      </div>
    <% end %>
    
    <!-- Positions Ouvertes -->
    <% if current_user.is_admin? && @mt5_accounts.any? %>
      <% open_positions = Trade.joins(:mt5_account).where(mt5_accounts: { user_id: @client.id }).where(status: 'open').order(open_time: :desc) %>
      <% if open_positions.any? %>
        <div class="card">
          <div class="card-header">
            <h2>⚡ Positions Ouvertes</h2>
            <div style="font-size: 14px; color: var(--text-muted);">
              <%= open_positions.count %> position(s) en cours
            </div>
          </div>
          
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Symbole</th>
                  <th>Type</th>
                  <th>Volume</th>
                  <th>Prix Ouverture</th>
                  <th>Prix Actuel</th>
                  <th>Profit FL</th>
                  <th>Swap</th>
                  <th>Durée</th>
                  <th>Bot</th>
                </tr>
              </thead>
              <tbody>
                <% open_positions.each do |position| %>
                  <% duration_minutes = ((Time.current - position.open_time) / 60).round if position.open_time %>
                  <tr>
                    <td><strong><%= position.symbol %></strong></td>
                    <td>
                      <span class="trade-type-badge <%= position.trade_type %>">
                        <%= position.trade_type&.upcase %>
                      </span>
                    </td>
                    <td><%= position.volume %></td>
                    <td><%= number_to_currency(position.open_price, unit: "€", format: "%n %u") %></td>
                    <td><%= number_to_currency(position.close_price, unit: "€", format: "%n %u") %></td>
                    <td class="<%= position.profit >= 0 ? 'positive' : 'negative' %>">
                      <%= number_to_currency(position.profit, unit: "€", format: "%n %u") %>
                    </td>
                    <td><%= number_to_currency(position.swap || 0, unit: "€", format: "%n %u") %></td>
                    <td>
                      <%= format_duration(duration_minutes) %>
                    </td>
                    <td>
                      <% if position.magic_number.present? %>
                        <span class="magic-badge"><%= bot_name_for_magic_number(position.magic_number, @bots_cache) %></span>
                      <% else %>
                        <span class="text-muted">-</span>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      <% end %>
    <% end %>
    
    <% if current_user.is_admin? && @mt5_accounts.any? %>
      <div class="card">
        <div class="card-header">
          <h2>Historique des Retraits</h2>
          <button onclick="showAddWithdrawalModal()" class="btn btn-outline btn-sm">
            <i class="fa-icon fa-md fa-plus"></i> Ajouter un retrait
          </button>
        </div>
        
        <% has_withdrawals = false %>
        <% @mt5_accounts.each do |account| %>
          <% if account.withdrawals.any? %>
            <% has_withdrawals = true %>
            <h4><%= account.account_name %> (<%= account.mt5_id %>)</h4>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Montant</th>
                    <th>Notes</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% account.withdrawals.order(withdrawal_date: :desc).each do |withdrawal| %>
                    <tr>
                      <td><%= withdrawal.withdrawal_date.strftime("%d/%m/%Y") %></td>
                      <td class="negative"><%= number_to_currency(withdrawal.amount, unit: "€", format: "%n %u") %></td>
                      <td><%= withdrawal.notes.present? ? withdrawal.notes : "-" %></td>
                      <td>
                        <div class="action-buttons">
                          <%= button_to "Supprimer", admin_withdrawal_path(withdrawal), 
                                method: :delete,
                                data: { turbo_confirm: "Supprimer ce retrait ?" },
                                class: "btn btn-danger btn-sm" %>
                        </div>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% end %>
        <% end %>
        
        <% unless has_withdrawals %>
          <div class="empty-state">
            <div class="empty-state-icon">
              <i class="fa-icon fa-lg fa-money-bill-wave"></i>
            </div>
            <h3>Aucun retrait enregistré</h3>
            <p>Aucun retrait n'a été détecté pour ce compte. Les retraits peuvent être :</p>
            <ul style="text-align: left; max-width: 400px; margin: 0 auto;">
              <li>Détectés automatiquement lors de la synchronisation MT5</li>
              <li>Importés depuis l'historique MT5 complet</li>
              <li>Ajoutés manuellement par l'administrateur</li>
            </ul>
            <div style="margin-top: 1rem;">
              <button onclick="showAddWithdrawalModal()" class="btn btn-primary">
                <i class="fa-icon fa-md fa-plus"></i> Ajouter un retrait manuellement
              </button>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Historique des Dépôts -->
    <% if current_user.is_admin? && @mt5_accounts.any? %>
      <div class="card">
        <div class="card-header">
          <h2>Historique des Dépôts</h2>
          <button onclick="showAddDepositModal()" class="btn btn-outline btn-sm">
            <i class="fa-icon fa-md fa-plus"></i> Ajouter un dépôt
          </button>
        </div>
        
        <% has_deposits = false %>
        <% @mt5_accounts.each do |account| %>
          <% if account.deposits.any? %>
            <% has_deposits = true %>
            <h4><%= account.account_name %> (<%= account.mt5_id %>)</h4>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Montant</th>
                    <th>Notes</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% account.deposits.order(deposit_date: :desc).each do |deposit| %>
                    <tr>
                      <td><%= deposit.deposit_date.strftime("%d/%m/%Y") %></td>
                      <td class="positive"><%= number_to_currency(deposit.amount, unit: "€", format: "%n %u") %></td>
                      <td><%= deposit.notes.present? ? deposit.notes : "-" %></td>
                      <td>
                        <div class="action-buttons">
                          <%= button_to "Supprimer", admin_deposit_path(deposit), 
                                method: :delete,
                                data: { turbo_confirm: "Supprimer ce dépôt ?" },
                                class: "btn btn-danger btn-sm" %>
                        </div>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% end %>
        <% end %>
        
        <% unless has_deposits %>
          <div class="empty-state">
            <div class="empty-state-icon">
              <i class="fa-icon fa-lg fa-plus-circle"></i>
            </div>
            <h3>Aucun dépôt enregistré</h3>
            <p>Aucun dépôt n'a été détecté pour ce compte. Les dépôts peuvent être :</p>
            <ul style="text-align: left; max-width: 400px; margin: 0 auto;">
              <li>Détectés automatiquement lors de la synchronisation MT5</li>
              <li>Importés depuis l'historique MT5 complet</li>
              <li>Ajoutés manuellement par l'administrateur</li>
            </ul>
            <div style="margin-top: 1rem;">
              <button onclick="showAddDepositModal()" class="btn btn-primary">
                <i class="fa-icon fa-md fa-plus"></i> Ajouter un dépôt manuellement
              </button>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Formulaire de modification MT5 - En dehors du tableau pour utiliser toute la largeur -->
    <% @mt5_accounts.each do |account| %>
      <% if current_user.is_admin? %>
        <div id="edit-account-<%= account.id %>" class="edit-account-panel" style="display: none;">
          <div class="edit-account-content edit-account-full-width">
            <div class="edit-account-header">
              <h4>Modifier le Compte MT5</h4>
              <button type="button" onclick="document.getElementById('edit-account-<%= account.id %>').style.display='none'" class="btn btn-outline btn-sm">
                ✕ Fermer
              </button>
            </div>
            
            <%= form_with model: account, url: admin_mt5_account_path(account), method: :patch, class: "edit-account-form" do |f| %>
              <div class="edit-account-main">
                <div class="edit-account-inputs">
                  <div class="input-group">
                    <div class="input-field">
                      <%= f.label :initial_balance, "Balance Initiale", class: "form-label" %>
                      <div class="input-container">
                        <%= f.number_field :initial_balance, step: 0.01, class: "form-input-large", placeholder: "0.00" %>
                        <span class="currency-symbol">€</span>
                      </div>
                      <div class="help-text">
                        Capital de départ pour ce compte
                      </div>
                    </div>
                    
                    <div class="input-field">
                      <%= f.label :high_watermark, "High Watermark", class: "form-label" %>
                      <div class="input-container">
                        <%= f.number_field :high_watermark, step: 0.01, class: "form-input-large", placeholder: "0.00" %>
                        <span class="currency-symbol">€</span>
                      </div>
                      <div class="help-text">
                        Actuel : <%= number_to_currency(account.high_watermark, unit: "€", format: "%n %u") %>
                      </div>
                    </div>
                    
                    <div class="input-field">
                      <%= f.label :total_withdrawals, "Total Retraits", class: "form-label" %>
                      <div class="input-container">
                        <%= f.number_field :total_withdrawals, step: 0.01, class: "form-input-large", placeholder: "0.00" %>
                        <span class="currency-symbol">€</span>
                      </div>
                      <div class="help-text">
                        Montant total des retraits effectués
                      </div>
                    </div>
                    
                    <div class="input-field">
                      <div class="checkbox-container" style="margin-top: 20px;">
                        <%= f.check_box :is_admin_account, class: "form-checkbox" %>
                        <%= f.label :is_admin_account, "Compte Admin (trades manuels autorisés)", class: "form-label", style: "margin-left: 8px;" %>
                      </div>
                      <div class="help-text">
                        ✓ Compte autorisé pour les trades manuels (hedging). Les trades sur ce compte ne seront pas sanctionnés.
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="withdrawal-section">
                  <h5>Enregistrer un Nouveau Retrait</h5>
                  <div class="withdrawal-form">
                    <%= fields_for "withdrawal", nil do |wf| %>
                      <div class="input-group">
                        <div class="input-field">
                          <%= wf.label :amount, "Montant du Retrait", class: "form-label" %>
                          <div class="input-container">
                            <%= wf.number_field :amount, step: 0.01, class: "form-input", placeholder: "0.00", name: "withdrawal_amount" %>
                            <span class="currency-symbol">€</span>
                          </div>
                        </div>
                        
                        <div class="input-field">
                          <%= wf.label :date, "Date du Retrait", class: "form-label" %>
                          <%= wf.date_field :date, class: "form-input", name: "withdrawal_date", value: Date.current %>
                        </div>
                      </div>
                    <% end %>
                  </div>
                </div>
                
                <div class="calculation-section">
                  <h5>Calcul Actuel</h5>
                  <div class="calculation-grid">
                    <div class="calculation-item">
                      <div class="calculation-label">Gains Nets</div>
                      <div class="calculation-formula">
                        Balance (<%= number_to_currency(account.balance, unit: "€", format: "%n %u") %>) - Initial (<%= number_to_currency(account.initial_balance, unit: "€", format: "%n %u") %>)
                      </div>
                      <div class="calculation-result">
                        <%= number_to_currency(account.net_gains, unit: "€", format: "%n %u") %>
                      </div>
                    </div>
                    
                    <div class="calculation-item">
                      <div class="calculation-label">WM Ajusté</div>
                      <div class="calculation-formula">
                        High WM (<%= number_to_currency(account.high_watermark, unit: "€", format: "%n %u") %>) - Retraits (<%= number_to_currency(account.total_withdrawals, unit: "€", format: "%n %u") %>)
                      </div>
                      <div class="calculation-result">
                        <%= number_to_currency(account.adjusted_watermark, unit: "€", format: "%n %u") %>
                      </div>
                    </div>
                    
                    <div class="calculation-item">
                      <div class="calculation-label">Commissionnable</div>
                      <div class="calculation-formula">
                        Balance (<%= number_to_currency(account.balance, unit: "€", format: "%n %u") %>) - WM Ajusté (<%= number_to_currency(account.adjusted_watermark, unit: "€", format: "%n %u") %>)
                      </div>
                      <div class="calculation-result">
                        <%= number_to_currency(account.commissionable_gains, unit: "€", format: "%n %u") %>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="edit-account-actions">
                <%= f.submit "Mettre à Jour", class: "btn btn-primary btn-large" %>
                <button type="button" onclick="document.getElementById('edit-account-<%= account.id %>').style.display='none'" class="btn btn-outline btn-large">
                  Annuler
                </button>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>

    <% if current_user.is_admin? %>
    <div class="card">
      <h2>Bots de Trading</h2>
      
      <% client_bots = @client.bot_purchases.includes(:trading_bot).order(created_at: :desc) %>
      
      <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #2196F3;">
        <div style="font-size: 13px; color: #1976D2;">
          <strong>💡 Analyse des Performances :</strong><br>
          • <strong>Profit Net</strong> : Profit après déduction de toutes les commissions et swaps<br>
          • <strong>Commissions</strong> : Total des commissions broker payées<br>
          • <strong>Swaps</strong> : Total des frais de report (peuvent être positifs ou négatifs)<br>
          • <strong>Total Coûts</strong> : Somme des commissions + swaps<br>
          • <strong>ROI</strong> : Retour sur investissement calculé sur le profit net
        </div>
      </div>
      
      <% if client_bots.any? %>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Bot</th>
                <th>Performance</th>
                <th>Statut</th>
                <th>Coûts</th>
                <th>Détails</th>
              </tr>
            </thead>
            <tbody>
              <% client_bots.each do |purchase| %>
                <tr onclick="window.location.href='<%= admin_bot_path(purchase.trading_bot, from: 'client', client_id: @client.id) %>'" style="cursor: pointer;">
                  <td>
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <div>
                        <strong style="color: white; font-size: 15px;"><%= purchase.trading_bot.name %></strong>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                          Acheté le <%= purchase.created_at.strftime("%d/%m/%Y") %>
                          · <%= number_to_currency(purchase.price_paid, unit: "€", format: "%n %u") %>
                        </div>
                      </div>
                      <div style="display: flex; flex-direction: column; gap: 4px;">
                        <span style="background: <%= purchase.trading_bot.risk_badge_color %>; color: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; text-align: center;">
                          <%= purchase.trading_bot.risk_label %>
                        </span>
                        <% if purchase.purchase_type == 'auto_detected' %>
                          <span style="background: #2196F3; color: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; text-align: center;">
                            🤖 Auto
                          </span>
                        <% end %>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                      <div class="<%= purchase.total_profit > 0 ? 'positive' : 'negative' %>" style="font-size: 15px; font-weight: bold;">
                        <%= number_to_currency(purchase.total_profit, unit: "€", format: "%n %u") %>
                      </div>
                      <div class="<%= purchase.roi_percentage > 0 ? 'positive' : 'negative' %>" style="font-size: 12px;">
                        ROI: <%= number_to_percentage(purchase.roi_percentage, precision: 1) %>%
                      </div>
                    </div>
                  </td>
                  <td>
                    <%= purchase.status_badge %>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                      <%= purchase.trades_count %> trades
                    </div>
                  </td>
                  <td>
                    <div style="font-size: 11px; line-height: 1.4;">
                      <div style="color: var(--text-muted);">
                        Comm: <span style="color: <%= purchase.total_commission >= 0 ? '#10b981' : '#ef4444' %>"><%= format_cost_with_sign(purchase.total_commission) %></span>
                      </div>
                      <div style="color: var(--text-muted);">
                        Swap: <span style="color: <%= purchase.total_swap >= 0 ? '#10b981' : '#ef4444' %>"><%= format_cost_with_sign(purchase.total_swap) %></span>
                      </div>
                      <div style="margin-top: 4px; padding-top: 4px; border-top: 1px solid var(--border-color);">
                        <span style="color: var(--text-muted);"><strong>Total:</strong></span> <strong style="color: <%= purchase.total_costs >= 0 ? '#10b981' : '#ef4444' %>;"><%= format_cost_with_sign(purchase.total_costs) %></strong>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div style="font-size: 11px; color: var(--text-muted);">
                      <div class="<%= purchase.within_drawdown_limit? ? '' : 'negative' %>" style="margin-bottom: 4px; display: flex; align-items: center; gap: 4px;">
                        DD: <%= number_to_percentage(purchase.drawdown_percentage, precision: 1) %>%
                        <span class="help-icon" title="Drawdown: Perte maximale depuis le pic de capital. Un drawdown trop élevé (>80%) indique un risque important.">
                          <i class="fa-icon fa-sm fa-info-circle" style="color: #9ca3af; cursor: help; margin-left: 4px;"></i>
                        </span>
                        <% unless purchase.within_drawdown_limit? %>
                          <i class="fa-icon fa-md fa-exclamation-triangle" style="color: #F44336;"></i>
                        <% end %>
                      </div>
                      <div style="font-size: 10px; opacity: 0.7;">
                        Limite: <%= number_to_percentage(purchase.trading_bot.max_drawdown_limit / purchase.price_paid * 100, precision: 1) %>%
                      </div>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p style="text-align: center; color: var(--text-muted); padding: 20px;">
          Aucun bot assigné pour le moment
        </p>
      <% end %>
      
      <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h3 style="margin: 0;">Assigner un Nouveau Bot</h3>
          <%= button_to "🤖 Détecter Automatiquement", 
                auto_detect_bots_admin_client_path(@client), 
                method: :patch,
                data: { turbo_confirm: "Détecter automatiquement les bots basés sur les magic numbers des trades ?" },
                class: "btn btn-outline btn-sm",
                style: "margin-left: auto;" %>
        </div>
        <%= form_tag assign_to_user_admin_bots_path, method: :post, data: { turbo: false }, style: "display: flex; gap: 12px; align-items: end;" do %>
          <%= hidden_field_tag :user_id, @client.id %>
          
          <div class="form-group" style="flex: 1; margin-bottom: 0;">
            <%= label_tag :bot_id, "Sélectionner un Bot" %>
            <%= select_tag :bot_id,
                options_from_collection_for_select(TradingBot.available.order(:name), :id, :name),
                prompt: 'Choisir un bot...',
                required: true,
                class: "filter-select" %>
          </div>
          
          <div class="form-group" style="flex: 0 0 200px; margin-bottom: 0;">
            <%= label_tag :price_paid, "Prix (€)" %>
            <%= number_field_tag :price_paid, nil, step: 0.01, min: 0, placeholder: "Optionnel",
                style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" %>
          </div>
          
          <%= submit_tag "Assigner", class: "btn btn-success", style: "margin-top: 27px;" do %>
            <i class="fa-icon fa-md fa-plus"></i> Assigner
          <% end %>
        <% end %>
      </div>
    </div>
    <% end %>

    <% if current_user.is_admin? %>
    <div class="card">
      <h2><i class="fa-icon fa-md fa-building"></i> Credentials Broker</h2>
      
      <% if @mt5_accounts&.any? %>
        <% @mt5_accounts.each do |account| %>
          <div class="card" style="margin-bottom: 24px; border: 1px solid rgba(255, 255, 255, 0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
              <div>
                <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 700;">
                  <%= svg_tag "wallet", size: "20" %>
                  <%= account.account_name %>
                </h3>
                <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
                  ID: <code style="background: var(--bg-hover); padding: 3px 8px; border-radius: 4px; color: #60a5fa;">#<%= account.mt5_id %></code>
                </p>
              </div>
              <button onclick="toggleEditMode('<%= account.id %>')" class="btn btn-primary" id="btn-edit-<%= account.id %>">
                Modifier
              </button>
            </div>
            
            <div id="display-<%= account.id %>">
              <div class="credentials-display" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div style="background: var(--bg-hover); padding: 16px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.05);">
                  <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); margin-bottom: 8px;">
                    Broker
                  </div>
                  <div style="font-size: 16px; font-weight: 600; color: var(--text-primary);">
                    <%= account.broker_name.present? ? account.broker_name : '<span style="color: var(--text-muted);">Non renseigné</span>'.html_safe %>
                  </div>
                </div>
                
                <div style="background: var(--bg-hover); padding: 16px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.05);">
                  <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); margin-bottom: 8px;">
                    Serveur
                  </div>
                  <div style="font-size: 16px; font-weight: 600; color: var(--text-primary);">
                    <%= account.broker_server.present? ? account.broker_server : '<span style="color: var(--text-muted);">Non renseigné</span>'.html_safe %>
                  </div>
                </div>
                
                <div style="background: var(--bg-hover); padding: 16px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.05); position: relative;">
                  <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); margin-bottom: 8px;">
                    Mot de passe
                  </div>
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <div id="password-display-<%= account.id %>" data-has-password="<%= account.broker_password.present? ? 'true' : 'false' %>" style="font-size: 16px; font-weight: 600; color: var(--text-primary);">
                      <%= account.broker_password.present? ? '••••••••' : '<span style="color: var(--text-muted);">Non défini</span>'.html_safe %>
                    </div>
                    <% if account.broker_password.present? %>
                    <button onclick="togglePassword('<%= account.id %>', '<%= j(account.broker_password) %>')" 
                            type="button"
                            style="background: transparent; border: none; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;"
                            onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                            onmouseout="this.style.background='transparent'"
                            title="Afficher/Masquer le mot de passe">
                      <i class="fa-icon fa-md fa-eye" id="toggle-icon-<%= account.id %>" style="font-size: 18px; color: rgba(255, 255, 255, 0.8);"></i>
                    </button>
                    <% else %>
                    <button type="button"
                            style="background: transparent; border: none; cursor: not-allowed; padding: 4px 8px; border-radius: 4px; opacity: 0.3;"
                            title="Aucun mot de passe défini"
                            disabled>
                      <i class="fa-icon fa-md fa-eye" style="font-size: 18px; color: rgba(255, 255, 255, 0.3);"></i>
                    </button>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
            
            <div id="edit-<%= account.id %>" style="display: none;">
              <%= form_with url: admin_mt5_account_path(account), method: :patch, local: true, class: "credentials-form" do |f| %>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                  <div>
                    <%= f.label :broker_name, "Broker", style: "display: block; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); margin-bottom: 8px;" %>
                    <%= f.text_field :broker_name, value: account.broker_name, placeholder: "Nom du broker", class: "form-control", style: "width: 100%; padding: 10px; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; background: rgba(255, 255, 255, 0.05);" %>
                  </div>
                  
                  <div>
                    <%= f.label :broker_server, "Serveur", style: "display: block; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); margin-bottom: 8px;" %>
                    <%= f.text_field :broker_server, value: account.broker_server, placeholder: "Serveur de connexion", class: "form-control", style: "width: 100%; padding: 10px; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; background: rgba(255, 255, 255, 0.05);" %>
                  </div>
                  
                  <div>
                    <%= f.label :new_password, "Mot de passe", style: "display: block; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); margin-bottom: 8px;" %>
                    <%= f.password_field :new_password, placeholder: "Nouveau mot de passe", class: "form-control", style: "width: 100%; padding: 10px; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; background: rgba(255, 255, 255, 0.05);" %>
                  </div>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                  <%= f.submit "Enregistrer", class: "btn btn-success" %>
                  <button type="button" onclick="toggleEditMode('<%= account.id %>')" class="btn">Annuler</button>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="empty-state">
          <p>Aucun compte MT5 trouvé</p>
        </div>
      <% end %>
      
      <script>
      function toggleEditMode(accountId) {
        const displayDiv = document.getElementById('display-' + accountId);
        const editDiv = document.getElementById('edit-' + accountId);
        const btn = document.getElementById('btn-edit-' + accountId);
        
        if (displayDiv.style.display === 'none') {
          displayDiv.style.display = 'block';
          editDiv.style.display = 'none';
          btn.textContent = 'Modifier';
        } else {
          displayDiv.style.display = 'none';
          editDiv.style.display = 'block';
          btn.textContent = 'Annuler';
        }
      }
      
      function togglePassword(accountId, password) {
        const displayDiv = document.getElementById('password-display-' + accountId);
        const icon = document.getElementById('toggle-icon-' + accountId);
        
        if (displayDiv.textContent.trim() === '••••••••' || displayDiv.textContent.trim() === '•'.repeat(8)) {
          displayDiv.textContent = password;
          icon.classList.remove('fa-eye');
          icon.classList.add('fa-eye-slash');
        } else {
          displayDiv.textContent = '••••••••';
          icon.classList.remove('fa-eye-slash');
          icon.classList.add('fa-eye');
        }
      }
      </script>
      
      <h2 style="margin-top: 32px;"><i class="fa-icon fa-md fa-desktop"></i> VPS</h2>
      
      <% if @client.vps.any? %>
        <table style="margin-bottom: 24px;">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Emplacement</th>
              <th>IP</th>
              <th>Statut</th>
              <th>Prix/mois</th>
              <th>Commandé</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @client.vps.each do |vps| %>
              <tr>
                <td><strong><%= vps.name %></strong></td>
                <td><%= vps.server_location || '-' %></td>
                <td><code style="background: var(--bg-hover); padding: 4px 8px; border-radius: 4px;"><%= vps.ip_address || 'En attente' %></code></td>
                <td>
                  <span style="background: <%= vps.status_color %>; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700;">
                    <%= vps.status_icon %> <%= vps.status_label %>
                  </span>
                </td>
                <td><%= number_to_currency(vps.monthly_price, unit: "€", format: "%n %u") %></td>
                <td><%= vps.ordered_at&.strftime("%d/%m/%Y") || '-' %></td>
                <td>
                  <div class="action-buttons">
                    <%= link_to admin_vp_path(vps), class: "icon-btn primary sm", title: "Voir" do %>
                      <i class="fa-icon fa-md fa-eye"></i>
                    <% end %>
                    <%= link_to edit_admin_vp_path(vps), class: "icon-btn warning sm", title: "Modifier" do %>
                      <i class="fa-icon fa-md fa-edit"></i>
                    <% end %>
                    <%= button_to admin_vp_path(vps), method: :delete,
                        data: { turbo_confirm: "Supprimer ce VPS ?" },
                        class: "icon-btn danger sm", title: "Supprimer" do %>
                      <i class="fa-icon fa-md fa-trash"></i>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p style="text-align: center; color: var(--text-muted); padding: 20px;">
          Aucun VPS pour ce client
        </p>
      <% end %>
      
      <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color);">
        <h3 style="margin-bottom: 16px;">Créer un Nouveau VPS</h3>
        <%= link_to new_admin_vp_path(user_id: @client.id), class: "btn btn-success" do %>
          <i class="fa-icon fa-md fa-plus"></i> Créer un VPS pour ce Client
        <% end %>
      </div>
    </div>
    <% end %>

    <% if current_user.is_admin? %>
    <div class="two-col">
      <div class="card">
        <h2>Ajouter un Paiement</h2>
        
        <% if @client.balance_due > 0 %>
          <div style="background: #fff3cd; padding: 12px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
            <div style="font-weight: 600; color: #856404; margin-bottom: 5px;"><i class="fa-icon fa-md fa-wallet"></i> Solde à Payer</div>
            <div style="font-size: 24px; font-weight: 700; color: #856404;">
              <%= number_to_currency(@client.balance_due, unit: "€", format: "%n %u") %>
            </div>
            <div style="font-size: 12px; color: #856404; margin-top: 5px;">
              Commission : <%= number_to_currency(@client.total_commission_due, unit: "€", format: "%n %u") %> | 
              Crédits : -<%= number_to_currency(@client.total_credits, unit: "€", format: "%n %u") %>
            </div>
          </div>
        <% elsif @client.balance_due < 0 %>
          <div style="background: #d4edda; padding: 12px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #28a745;">
            <div style="font-weight: 600; color: #155724; margin-bottom: 5px;"><i class="fa-icon fa-md fa-university"></i> Solde Créditeur</div>
            <div style="font-size: 24px; font-weight: 700; color: #155724;">
              <%= number_to_currency(@client.balance_due.abs, unit: "€", format: "%n %u") %>
            </div>
            <div style="font-size: 12px; color: #155724; margin-top: 5px;">
              Le client a un crédit qui sera appliqué aux futures commissions
            </div>
          </div>
        <% else %>
          <div style="background: #d4edda; padding: 12px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #28a745;">
            <div style="font-weight: 600; color: #155724; margin-bottom: 5px;"><i class="fa-icon fa-md fa-check-circle"></i> Entièrement Payé</div>
            <div style="font-size: 18px; color: #155724;">
              Aucun solde restant
            </div>
          </div>
        <% end %>

        <% if @mt5_accounts.any? %>
          <div style="background: #e3f2fd; padding: 12px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #2196F3;">
            <div style="font-weight: 600; color: #1976D2; margin-bottom: 10px;">
              <i class="fa-icon fa-md fa-chart-bar"></i> Watermarks par Compte
            </div>
            <% @mt5_accounts.each do |account| %>
              <% unauthorized_penalty = account.unauthorized_manual_trades_total %>
              <% pending_count = account.trades.where(trade_originality: 'manual_pending_review').count %>
              <% client_count = account.trades.where(trade_originality: 'manual_client').count %>
              
              <div style="font-size: 13px; color: #1976D2; margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.3); border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong><%= account.account_name %> (<%= account.mt5_id %>)</strong>
                  </div>
                  <div style="font-size: 14px; font-weight: 700; color: #0d47a1;">
                    WM = <%= number_to_currency(account.high_watermark, unit: "€", format: "%n %u") %>
                  </div>
                </div>
                
                <% if unauthorized_penalty > 0 %>
                  <div style="margin-top: 6px; font-size: 12px; color: #c62828; background: rgba(244,67,54,0.1); padding: 6px; border-radius: 4px;">
                    <i class="fa-icon fa-sm fa-exclamation-triangle"></i>
                    <strong>Pénalités Trade Defender :</strong> <%= number_to_currency(unauthorized_penalty, unit: "€", format: "%n %u") %>
                    <br/>
                    <span style="font-size: 11px; opacity: 0.8;">
                      (<%= client_count %> trade<%= client_count > 1 ? 's' : '' %> manuel<%= client_count > 1 ? 's' : '' %> sanctionné<%= client_count > 1 ? 's' : '' %>)
                    </span>
                  </div>
                <% end %>
                
                <% if pending_count > 0 %>
                  <div style="margin-top: 6px; font-size: 12px; color: #f57c00; background: rgba(255,152,0,0.1); padding: 6px; border-radius: 4px;">
                    <i class="fa-icon fa-sm fa-clock"></i>
                    ⏳ <%= pending_count %> trade<%= pending_count > 1 ? 's' : '' %> en attente de validation
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>

        <%= form_with model: [:admin, Payment.new], method: :post, id: "payment-form" do |f| %>
          <%= f.hidden_field :user_id, value: @client.id %>
          
          <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
              <%= svg_tag "info", size: "20" %>
              <h4 style="margin: 0; font-size: 14px; font-weight: 600;">💡 Calcul automatique du montant commissionnable</h4>
            </div>
            <p style="margin: 0; font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
              Pour les clients ajoutés au système avec un historique existant, renseignez le High Watermark (WM).<br>
              <strong>Montant commissionnable = Balance actuelle - High Watermark</strong><br>
              <small>Exemple: Balance 1000€, WM 700€ → Commissionnable = 300€</small>
            </p>
          </div>

          <div class="form-group">
            <%= f.label :manual_watermark, "High Watermark (€)" %>
            <%= f.number_field :manual_watermark, step: 0.01, min: 0, id: "manual_watermark_input", placeholder: "Ex: 700.00", oninput: "calculateAmount()" %>
            <div class="help-text">Le WM sera appliqué au compte lors de la validation du paiement</div>
          </div>

          <div class="form-group">
            <%= f.label :amount, "Montant Commission (€)" %>
            <%= f.number_field :amount, step: 0.01, min: 0, required: true, value: @client.balance_due > 0 ? @client.balance_due : nil, id: "amount_input", placeholder: "Calculé automatiquement" %>
            <div class="help-text" id="amount_help">Commission facturée au client</div>
          </div>

          <div class="form-group">
            <%= f.label :payment_method, "Méthode de Paiement" %>
            <%= f.select :payment_method, 
                options_for_select([
                  ['Virement Bancaire', 'bank_transfer'],
                  ['Espèces', 'cash'],
                  ['PayPal', 'paypal'],
                  ['Carte de Crédit', 'credit_card'],
                  ['Chèque', 'check'],
                  ['Autre', 'other']
                ]), 
                { prompt: 'Sélectionner la méthode' },
                { class: "filter-select" } 
            %>
          </div>

          <div class="form-group">
            <%= f.label :payment_date, "Date de Paiement" %>
            <%= f.date_field :payment_date, value: Date.today, required: true %>
          </div>

          <div class="form-group">
            <%= f.label :reference, "Référence / ID Transaction" %>
            <%= f.text_field :reference, placeholder: "ex. VIREMENT123456" %>
          </div>

          <div class="form-group">
            <%= f.label :notes, "Notes" %>
            <%= f.text_area :notes, placeholder: "Informations supplémentaires..." %>
          </div>

          <%= submit_tag "Créer le Paiement", class: "btn" do %>
            <i class="fa-icon fa-md fa-credit-card"></i> Créer le Paiement
          <% end %>
        <% end %>
        
        <script>
        function calculateAmount() {
          const watermarkInput = document.getElementById('manual_watermark_input');
          const amountInput = document.getElementById('amount_input');
          const helpText = document.getElementById('amount_help');
          
          const currentBalance = <%= @client.mt5_accounts.sum(:balance) || 0 %>;
          const commissionRateRaw = <%= @client.commission_rate || 25 %>;
          // Le taux est stocké en pourcentage (25 pour 25%), on le convertit en décimal (0.25)
          const commissionRate = commissionRateRaw / 100.0;
          const watermark = parseFloat(watermarkInput.value) || 0;
          
          if (watermark > 0) {
            const commissionableAmount = currentBalance - watermark;
            const commission = commissionableAmount * commissionRate;
            amountInput.value = commission.toFixed(2);
            helpText.innerHTML = `<strong>Commissionnable:</strong> ${currentBalance.toFixed(2)}€ (balance) - ${watermark.toFixed(2)}€ (WM) = ${commissionableAmount.toFixed(2)}€<br><strong>Commission (${commissionRateRaw.toFixed(1)}%):</strong> ${commission.toFixed(2)}€`;
          } else {
            amountInput.value = <%= @client.balance_due || 0 %>;
            helpText.textContent = 'Pré-rempli avec le solde actuel dû';
          }
        }
        </script>
      </div>

      <div class="card">
        <h2>Ajouter un Crédit</h2>
        <%= form_with model: [:admin, Credit.new], method: :post do |f| %>
          <%= f.hidden_field :user_id, value: @client.id %>
          
          <div class="form-group">
            <%= f.label :amount, "Montant (€)" %>
            <%= f.number_field :amount, step: 0.01, min: 0, required: true %>
          </div>

          <div class="form-group">
            <%= f.label :reason, "Raison" %>
            <%= f.select :reason, 
                options_for_select([
                  ['Bonus de bienvenue', 'welcome_bonus'],
                  ['Compensation', 'compensation'],
                  ['Promotion', 'promotion'],
                  ['Erreur système', 'system_error'],
                  ['Remboursement', 'refund'],
                  ['Autre', 'other']
                ]), 
                { prompt: 'Sélectionner une raison' },
                { class: "filter-select" } 
            %>
          </div>

          <%= f.submit "Créer le Crédit", class: "btn" do %>
            <span class="material-icons md-18" style="vertical-align: middle;">add_circle</span> Créer le Crédit
          <% end %>
        <% end %>
      </div>
    </div>
    <% end %>

    <% if current_user.is_admin? %>
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0;">Historique des Paiements</h2>
        <% if current_user.is_admin? %>
          <button onclick="toggleDeleteMode()" id="lockButton" class="btn" style="background: #666; padding: 8px 16px; font-size: 14px;">
            <i class="fa-icon fa-md fa-lock"></i> Déverrouiller Mode Suppression
          </button>
        <% end %>
      </div>
      <div id="deleteModeWarning" style="display: none; background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; margin-bottom: 15px; border-radius: 4px;">
        <strong style="color: #856404;"><i class="fa-icon fa-md fa-exclamation-triangle"></i> Mode Suppression Actif</strong>
        <p style="color: #856404; margin: 5px 0 0 0; font-size: 13px;">Vous pouvez maintenant supprimer des paiements. Cliquez à nouveau sur le verrou pour désactiver ce mode.</p>
      </div>
      <% if @payments.any? %>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Montant</th>
              <th>Méthode</th>
              <th>Référence</th>
              <th>Watermarks à Validation</th>
              <th>Statut</th>
              <th>Notes</th>
              <% if current_user.is_admin? %>
                <th>Actions</th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <% @payments.each do |payment| %>
              <tr style="cursor: default;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''">
                <td style="cursor: pointer;" onclick="window.location='<%= admin_payment_path(payment) %>'"><%= payment.payment_date.strftime("%Y-%m-%d") %></td>
                <td style="cursor: pointer;" onclick="window.location='<%= admin_payment_path(payment) %>'"><%= number_to_currency(payment.amount, unit: "€", format: "%n %u") %></td>
                <td style="cursor: pointer;" onclick="window.location='<%= admin_payment_path(payment) %>'"><%= payment.payment_method_label %></td>
                <td style="cursor: pointer;" onclick="window.location='<%= admin_payment_path(payment) %>'"><%= payment.reference %></td>
                <td style="cursor: pointer;" onclick="window.location='<%= admin_payment_path(payment) %>'">
                  <% if payment.status == "validated" && payment.watermark_data.any? %>
                    <% payment.watermark_data.each do |mt5_id, data| %>
                      <div style="font-size: 12px; margin-bottom: 3px;">
                        <strong><%= data["account_name"] %></strong> (<%= mt5_id %>)<br>
                        WM : <%= number_to_currency(data["watermark"], unit: "€", format: "%n %u") %> <i class='fa-icon fa-md fa-arrow-right'></i> <%= number_to_currency(data["balance"], unit: "€", format: "%n %u") %><br>
                        <span style="color: #4CAF50;">Commissionnable : <%= number_to_currency(data["commissionable"], unit: "€", format: "%n %u") %></span>
                      </div>
                    <% end %>
                  <% elsif payment.status == "validated" %>
                    <span style="color: #999; font-size: 12px;">Pas de données</span>
                  <% else %>
                    <span style="color: #999; font-size: 12px;">-</span>
                  <% end %>
                </td>
                <td style="cursor: pointer;" onclick="window.location='<%= admin_payment_path(payment) %>'">
                  <span class="status-badge status-<%= payment.status %>">
                    <%= payment.status.upcase %>
                  </span>
                </td>
                <td style="cursor: pointer;" onclick="window.location='<%= admin_payment_path(payment) %>'"><%= payment.notes %></td>
                <% if current_user.is_admin? %>
                  <td onclick="event.stopPropagation();">
                    <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                      <%= link_to admin_payment_path(payment), class: "btn btn-sm", style: "padding: 4px 8px; font-size: 11px;", title: "Voir les détails" do %>
                        <i class="fa-icon fa-sm fa-eye"></i>
                      <% end %>
                      <a href="<%= download_pdf_admin_payment_path(payment) %>" target="_blank" class="btn btn-sm" style="padding: 4px 8px; font-size: 11px;" title="Télécharger PDF">
                        <i class="fa-icon fa-sm fa-download"></i>
                      </a>
                      <% if payment.status == "pending" %>
                        <%= button_to "✓", admin_payment_path(payment, action_type: "validate"), method: :patch, class: "btn btn-sm", style: "padding: 4px 8px; font-size: 11px;", title: "Valider", onclick: "event.stopPropagation();" %>
                        <%= button_to "✗", admin_payment_path(payment, action_type: "reject"), method: :patch, class: "btn btn-danger btn-sm", style: "padding: 4px 8px; font-size: 11px;", title: "Rejeter", onclick: "event.stopPropagation();" %>
                      <% end %>
                      <%= button_to "🗑️", admin_payment_path(payment), method: :delete, data: { turbo_confirm: "Supprimer ce paiement ?" }, class: "btn btn-danger btn-sm delete-btn", style: "display: none; padding: 4px 8px; font-size: 11px;", title: "Supprimer", onclick: "event.stopPropagation();" %>
                    </div>
                  </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
        
        <script>
          let deleteModeActive = false;
          
          function toggleDeleteMode() {
            deleteModeActive = !deleteModeActive;
            const lockButton = document.getElementById('lockButton');
            const warning = document.getElementById('deleteModeWarning');
            const deleteButtons = document.querySelectorAll('.delete-btn');
            
            if (deleteModeActive) {
              lockButton.innerHTML = '<span class="material-icons md-18" style="vertical-align: middle;">lock_open</span> Verrouiller Mode Suppression';
              lockButton.style.background = '#f44336';
              warning.style.display = 'block';
              deleteButtons.forEach(btn => btn.style.display = 'inline-block');
            } else {
              lockButton.innerHTML = '<i class="fa-icon fa-md fa-lock"></i> Déverrouiller Mode Suppression';
              lockButton.style.background = '#666';
              warning.style.display = 'none';
              deleteButtons.forEach(btn => btn.style.display = 'none');
            }
          }
        </script>
        
        <script>
          function showAddWithdrawalModal() {
            window.location.href = '<%= new_admin_withdrawal_path %>';
          }
          
          function showAddDepositModal() {
            window.location.href = '<%= new_admin_deposit_path %>';
          }
        </script>
      <% else %>
        <p style="color: #999;">Aucun paiement pour le moment</p>
      <% end %>
    </div>
    <% end %>

    <% if current_user.is_admin? %>
      <div class="card">
        <h2>Historique des Crédits</h2>
        <% if @credits.any? %>
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Montant</th>
                <th>Raison</th>
                <% if current_user.is_admin? %>
                  <th>Actions</th>
                <% end %>
              </tr>
            </thead>
            <tbody>
              <% @credits.each do |credit| %>
                <tr>
                  <td><%= credit.created_at.strftime("%d/%m/%Y") %></td>
                  <td><%= number_to_currency(credit.amount, unit: "€", format: "%n %u") %></td>
                  <td><%= credit.reason %></td>
                  <% if current_user.is_admin? %>
                    <td>
                      <%= button_to "Supprimer", admin_credit_path(credit), method: :delete, data: { turbo_confirm: "Êtes-vous sûr ?" }, class: "btn btn-danger" %>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% else %>
          <p style="color: #999;">Aucun crédit pour le moment</p>
        <% end %>
      </div>
    <% end %>
    </div>
  </div>
</body>
</html>

<!-- Debug JavaScript pour les dropdowns -->
<script>
console.log('=== CLIENT SHOW PAGE DROPDOWN DEBUG ===');
console.log('Page des détails client chargée');

// Vérifier que les styles sont chargés
const adminStyles = document.querySelector('link[href*="admin"]');
console.log('Styles admin chargés:', adminStyles !== null);

// Vérifier les selects avec la classe filter-select
const filterSelects = document.querySelectorAll('.filter-select');
console.log('Nombre de selects avec classe filter-select:', filterSelects.length);

filterSelects.forEach((select, index) => {
  console.log(`Select ${index}:`, select);
  console.log(`  Classes:`, select.className);
  console.log(`  ID:`, select.id);
  console.log(`  Name:`, select.name);
  console.log(`  Options count:`, select.options.length);
  
  const computedStyle = window.getComputedStyle(select);
  console.log(`  Computed styles:`);
  console.log(`    Display:`, computedStyle.display);
  console.log(`    Visibility:`, computedStyle.visibility);
  console.log(`    Opacity:`, computedStyle.opacity);
  console.log(`    Background:`, computedStyle.backgroundColor);
  console.log(`    Border:`, computedStyle.border);
  console.log(`    Padding:`, computedStyle.padding);
});

// Vérifier les dropdowns personnalisés
const customDropdowns = document.querySelectorAll('.dropdown');
console.log('Nombre de dropdowns personnalisés:', customDropdowns.length);

customDropdowns.forEach((dropdown, index) => {
  console.log(`Dropdown ${index}:`, dropdown);
  const toggle = dropdown.querySelector('.dropdown-toggle');
  const menu = dropdown.querySelector('.dropdown-menu');
  console.log(`  Toggle:`, toggle);
  console.log(`  Menu:`, menu);
});

// Vérifier tous les selects sur la page
const allSelects = document.querySelectorAll('select');
console.log('Nombre total de selects:', allSelects.length);

allSelects.forEach((select, index) => {
  console.log(`Select ${index}:`, select);
  console.log(`  Classes:`, select.className);
  console.log(`  Style:`, select.style.cssText);
  console.log(`  Computed display:`, window.getComputedStyle(select).display);
});

console.log('=== END CLIENT SHOW PAGE DROPDOWN DEBUG ===');
</script>


