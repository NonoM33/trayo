<% content_for :title, "Client - #{@client.full_name}" %>

<div class="space-y-6">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div class="flex items-center gap-4">
      <div class="flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-500 to-purple-600 text-white text-2xl font-bold">
        <%= @client.first_name&.first&.upcase %><%= @client.last_name&.first&.upcase %>
      </div>
      <div>
        <h1 class="text-2xl font-bold text-white"><%= @client.full_name %></h1>
        <p class="text-neutral-400"><%= @client.email %></p>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <%= link_to admin_clients_path, class: "inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-neutral-700 text-neutral-300 hover:bg-neutral-800 transition-colors" do %>
        <i class="fa-solid fa-arrow-left"></i>
        Retour
      <% end %>
      <%= link_to edit_admin_client_path(@client), class: "inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-white text-neutral-900 hover:bg-neutral-100 transition-colors" do %>
        <i class="fa-solid fa-pen"></i>
        Modifier
      <% end %>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <% balance = @client.mt5_accounts.sum(:balance) %>
    <div class="p-4 rounded-xl bg-neutral-900 border border-neutral-800">
      <div class="text-sm text-neutral-400 mb-1">Solde Total</div>
      <div class="text-2xl font-bold <%= balance >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
        <%= number_to_currency(balance, unit: "€", format: "%n%u") %>
      </div>
    </div>
    
    <% total_profit = @client.bot_purchases.sum(:total_profit) %>
    <div class="p-4 rounded-xl bg-neutral-900 border border-neutral-800">
      <div class="text-sm text-neutral-400 mb-1">Profit Total</div>
      <div class="text-2xl font-bold <%= total_profit >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
        <%= number_to_currency(total_profit, unit: "€", format: "%n%u") %>
      </div>
    </div>
    
    <div class="p-4 rounded-xl bg-neutral-900 border border-neutral-800">
      <div class="text-sm text-neutral-400 mb-1">Bots Actifs</div>
      <div class="text-2xl font-bold text-white">
        <%= @client.bot_purchases.where(is_running: true).count %> / <%= @client.bot_purchases.count %>
      </div>
    </div>
    
    <div class="p-4 rounded-xl bg-neutral-900 border border-neutral-800">
      <div class="text-sm text-neutral-400 mb-1">Commission</div>
      <div class="text-2xl font-bold text-blue-400">
        <%= @client.commission_rate %>%
      </div>
    </div>
  </div>

  <!-- Tabs Navigation -->
  <div data-controller="tabs" data-tabs-default-value="overview">
    <div class="flex items-center gap-1 p-1 rounded-xl bg-neutral-900 border border-neutral-800 overflow-x-auto">
      <button type="button" data-tabs-target="tab" data-action="click->tabs#select" data-tab="overview" class="px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors">
        <i class="fa-solid fa-chart-pie mr-2"></i>Vue d'ensemble
      </button>
      <button type="button" data-tabs-target="tab" data-action="click->tabs#select" data-tab="mt5" class="px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors">
        <i class="fa-solid fa-wallet mr-2"></i>Comptes MT5
      </button>
      <button type="button" data-tabs-target="tab" data-action="click->tabs#select" data-tab="bots" class="px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors">
        <i class="fa-solid fa-robot mr-2"></i>Bots
      </button>
      <button type="button" data-tabs-target="tab" data-action="click->tabs#select" data-tab="trades" class="px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors">
        <i class="fa-solid fa-chart-line mr-2"></i>Trades
      </button>
      <button type="button" data-tabs-target="tab" data-action="click->tabs#select" data-tab="invoices" class="px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors">
        <i class="fa-solid fa-file-invoice mr-2"></i>Factures
      </button>
      <button type="button" data-tabs-target="tab" data-action="click->tabs#select" data-tab="subscriptions" class="px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors">
        <i class="fa-solid fa-repeat mr-2"></i>Abonnements
        <% if @client.subscriptions.active.any? %>
          <span class="ml-1 px-1.5 py-0.5 text-xs rounded-full bg-emerald-500/20 text-emerald-400"><%= @client.subscriptions.active.count %></span>
        <% end %>
      </button>
      <button type="button" data-tabs-target="tab" data-action="click->tabs#select" data-tab="vps" class="px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors">
        <i class="fa-solid fa-server mr-2"></i>VPS
      </button>
      <% if current_user.is_admin? %>
        <button type="button" data-tabs-target="tab" data-action="click->tabs#select" data-tab="admin" class="px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors">
          <i class="fa-solid fa-shield mr-2"></i>Admin
        </button>
      <% end %>
    </div>

    <!-- Tab: Overview -->
    <div data-tabs-target="panel" data-tab="overview" class="mt-6 space-y-6">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Informations Client -->
        <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-6">
          <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <i class="fa-solid fa-user text-blue-400"></i>
            Informations
          </h3>
          <div class="space-y-3">
            <div class="flex justify-between py-2 border-b border-neutral-800">
              <span class="text-neutral-400">Email</span>
              <span class="text-white font-medium"><%= @client.email %></span>
            </div>
            <div class="flex justify-between py-2 border-b border-neutral-800">
              <span class="text-neutral-400">Téléphone</span>
              <span class="text-white font-medium"><%= @client.phone || "—" %></span>
            </div>
            <div class="flex justify-between py-2 border-b border-neutral-800">
              <span class="text-neutral-400">Inscrit le</span>
              <span class="text-white font-medium"><%= @client.created_at.strftime("%d/%m/%Y") %></span>
            </div>
            <div class="flex justify-between py-2">
              <span class="text-neutral-400">Commission</span>
              <span class="text-blue-400 font-bold"><%= @client.commission_rate %>%</span>
            </div>
          </div>
        </div>

        <!-- Résumé Financier ou Abonnement -->
        <% active_subscription = @client.subscriptions.active.first %>
        <% if active_subscription %>
          <!-- Abonnement Actif -->
          <div class="rounded-xl bg-gradient-to-br from-emerald-900/50 to-green-900/30 border border-emerald-700/50 p-6">
            <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
              <i class="fa-solid fa-repeat text-emerald-400"></i>
              Abonnement Actif
            </h3>
            <div class="flex items-center gap-4 mb-4">
              <div class="w-12 h-12 rounded-xl bg-emerald-500 flex items-center justify-center">
                <i class="fa-solid fa-crown text-white text-xl"></i>
              </div>
              <div>
                <div class="text-2xl font-bold text-white"><%= active_subscription.plan_name %></div>
                <div class="text-emerald-400"><%= number_to_currency(active_subscription.monthly_price, unit: "€", format: "%n%u") %>/mois</div>
              </div>
            </div>
            <div class="space-y-3">
              <div class="flex justify-between py-2 border-b border-emerald-800/50">
                <span class="text-neutral-400">Statut</span>
                <span class="px-2 py-1 rounded-full text-xs font-semibold bg-emerald-500/20 text-emerald-400">✓ Actif</span>
              </div>
              <div class="flex justify-between py-2 border-b border-emerald-800/50">
                <span class="text-neutral-400">Prochain prélèvement</span>
                <span class="text-white font-medium"><%= active_subscription.current_period_end&.strftime("%d/%m/%Y") || "—" %></span>
              </div>
              <div class="flex justify-between py-2">
                <span class="text-neutral-400">Inclus</span>
                <span class="text-emerald-400 font-medium">Bots + VPS</span>
              </div>
            </div>
          </div>
        <% else %>
          <!-- Résumé Financier (pas d'abonnement) -->
          <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-6">
            <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
              <i class="fa-solid fa-coins text-amber-400"></i>
              Résumé Financier
            </h3>
            <% invoices = @client.invoices.order(created_at: :desc) %>
            <% total_invoiced = invoices.sum(:total_amount) %>
            <% total_due = invoices.sum(:balance_due) %>
            <% total_paid = total_invoiced - total_due %>
            <div class="space-y-3">
              <div class="flex justify-between py-2 border-b border-neutral-800">
                <span class="text-neutral-400">Total Facturé</span>
                <span class="text-white font-medium"><%= number_to_currency(total_invoiced, unit: "€", format: "%n%u") %></span>
              </div>
              <div class="flex justify-between py-2 border-b border-neutral-800">
                <span class="text-neutral-400">Total Payé</span>
                <span class="text-emerald-400 font-medium"><%= number_to_currency(total_paid, unit: "€", format: "%n%u") %></span>
              </div>
              <div class="flex justify-between py-2">
                <span class="text-neutral-400">Reste à Payer</span>
                <span class="<%= total_due > 0 ? 'text-red-400' : 'text-emerald-400' %> font-bold"><%= number_to_currency(total_due, unit: "€", format: "%n%u") %></span>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Dernières Factures -->
      <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-white flex items-center gap-2">
            <i class="fa-solid fa-file-invoice text-purple-400"></i>
            Dernières Factures
          </h3>
        </div>
        <% recent_invoices = @client.invoices.order(created_at: :desc).limit(5) %>
        <% if recent_invoices.any? %>
          <div class="space-y-3">
            <% recent_invoices.each do |invoice| %>
              <div class="flex items-center justify-between p-4 rounded-lg bg-neutral-800/50 hover:bg-neutral-800 transition-colors">
                <div class="flex items-center gap-4">
                  <div class="w-10 h-10 rounded-lg bg-neutral-700 flex items-center justify-center">
                    <i class="fa-solid fa-file-invoice text-neutral-400"></i>
                  </div>
                  <div>
                    <div class="font-medium text-white"><%= invoice.reference %></div>
                    <div class="text-sm text-neutral-400"><%= invoice.created_at.strftime("%d/%m/%Y") %></div>
                  </div>
                </div>
                <div class="flex items-center gap-4">
                  <div class="text-right">
                    <div class="font-bold text-white"><%= number_to_currency(invoice.total_amount, unit: "€", format: "%n%u") %></div>
                    <% if invoice.balance_due <= 0 %>
                      <span class="text-xs px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-400">Payée</span>
                    <% elsif invoice.balance_due < invoice.total_amount %>
                      <span class="text-xs px-2 py-0.5 rounded-full bg-amber-500/20 text-amber-400">Partiel</span>
                    <% else %>
                      <span class="text-xs px-2 py-0.5 rounded-full bg-red-500/20 text-red-400">En attente</span>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="text-center py-8 text-neutral-500">
            <i class="fa-solid fa-file-invoice text-4xl mb-2"></i>
            <p>Aucune facture</p>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Tab: MT5 -->
    <div data-tabs-target="panel" data-tab="mt5" class="mt-6 hidden space-y-6">
      <% @client.mt5_accounts.each do |account| %>
        <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center">
                <i class="fa-solid fa-wallet text-white text-xl"></i>
              </div>
              <div>
                <h3 class="font-semibold text-white"><%= account.account_name %></h3>
                <p class="text-sm text-neutral-400">ID: <%= account.mt5_id %> • <%= account.broker_name %></p>
              </div>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold <%= account.balance >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
                <%= number_to_currency(account.balance, unit: "€", format: "%n%u") %>
              </div>
              <div class="text-sm text-neutral-400">Solde</div>
            </div>
          </div>
          
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 pt-4 border-t border-neutral-800">
            <div>
              <div class="text-sm text-neutral-400">Balance Initiale</div>
              <div class="font-semibold text-white"><%= number_to_currency(account.initial_balance, unit: "€", format: "%n%u") %></div>
            </div>
            <div>
              <div class="text-sm text-neutral-400">High Watermark</div>
              <div class="font-semibold text-white"><%= number_to_currency(account.high_watermark, unit: "€", format: "%n%u") %></div>
            </div>
            <div>
              <div class="text-sm text-neutral-400">Serveur</div>
              <div class="font-semibold text-white"><%= account.broker_server %></div>
            </div>
            <div>
              <div class="text-sm text-neutral-400">Mot de passe</div>
              <div class="font-mono text-sm text-neutral-400 bg-neutral-800 px-2 py-1 rounded"><%= account.broker_password&.gsub(/./, '•') || '—' %></div>
            </div>
          </div>
        </div>
      <% end %>
      
      <% if @client.mt5_accounts.empty? %>
        <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-12 text-center">
          <i class="fa-solid fa-wallet text-4xl text-neutral-600 mb-4"></i>
          <p class="text-neutral-400">Aucun compte MT5</p>
        </div>
      <% end %>
    </div>

    <!-- Tab: Bots -->
    <div data-tabs-target="panel" data-tab="bots" class="mt-6 hidden space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <% @client.bot_purchases.includes(:trading_bot).each do |purchase| %>
          <% bot = purchase.trading_bot %>
          <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-5 hover:border-neutral-700 transition-colors">
            <div class="flex items-start justify-between mb-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br <%= purchase.is_running ? 'from-emerald-500 to-green-600' : 'from-neutral-600 to-neutral-700' %> flex items-center justify-center">
                  <i class="fa-solid fa-robot text-white"></i>
                </div>
                <div>
                  <h4 class="font-semibold text-white"><%= bot.name %></h4>
                  <p class="text-xs text-neutral-400">Magic: <%= purchase.magic_number %></p>
                </div>
              </div>
              <span class="px-2 py-1 rounded-full text-xs font-medium <%= purchase.is_running ? 'bg-emerald-500/20 text-emerald-400' : 'bg-neutral-700 text-neutral-400' %>">
                <%= purchase.is_running ? 'Actif' : 'Inactif' %>
              </span>
            </div>
            
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-neutral-400">Profit Total</span>
                <span class="font-semibold <%= purchase.total_profit >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
                  <%= number_to_currency(purchase.total_profit, unit: "€", format: "%n%u") %>
                </span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral-400">Trades</span>
                <span class="text-white"><%= purchase.trades_count %></span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral-400">Drawdown</span>
                <span class="text-amber-400"><%= number_to_currency(purchase.current_drawdown, unit: "€", format: "%n%u") %></span>
              </div>
            </div>

          </div>
        <% end %>
      </div>
      
      <% if @client.bot_purchases.empty? %>
        <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-12 text-center">
          <i class="fa-solid fa-robot text-4xl text-neutral-600 mb-4"></i>
          <p class="text-neutral-400">Aucun bot assigné</p>
        </div>
      <% end %>

      <% if current_user.is_admin? %>
        <!-- Assigner un Bot -->
        <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-6">
          <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <i class="fa-solid fa-plus text-blue-400"></i>
            Assigner un Bot
          </h3>
          <%= form_with url: assign_to_user_admin_bots_path, method: :post, local: true, class: "flex flex-col md:flex-row gap-4" do |f| %>
            <input type="hidden" name="user_id" value="<%= @client.id %>">
            <div class="flex-1">
              <select name="trading_bot_id" required class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                <option value="">Sélectionner un bot...</option>
                <% TradingBot.active.each do |bot| %>
                  <option value="<%= bot.id %>"><%= bot.name %> - <%= number_to_currency(bot.price, unit: "€", format: "%n%u") %></option>
                <% end %>
              </select>
            </div>
            <button type="submit" class="px-6 py-2.5 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors">
              <i class="fa-solid fa-plus mr-2"></i>Assigner
            </button>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- Tab: Trades -->
    <div data-tabs-target="panel" data-tab="trades" class="mt-6 hidden space-y-6">
      <% trades = Trade.joins(mt5_account: :user).where(users: { id: @client.id }).order(close_time: :desc).limit(50) %>
      
      <div class="rounded-xl bg-neutral-900 border border-neutral-800 overflow-hidden">
        <div class="p-4 border-b border-neutral-800">
          <h3 class="text-lg font-semibold text-white">Derniers Trades</h3>
        </div>
        <% if trades.any? %>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-neutral-800/50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-neutral-400 uppercase">Symbol</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-neutral-400 uppercase">Type</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-neutral-400 uppercase">Volume</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-neutral-400 uppercase">Prix Entrée</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-neutral-400 uppercase">Prix Sortie</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-neutral-400 uppercase">Profit</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-neutral-400 uppercase">Date</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-neutral-800">
                <% trades.each do |trade| %>
                  <tr class="hover:bg-neutral-800/30">
                    <td class="px-4 py-3 text-white font-medium"><%= trade.symbol %></td>
                    <td class="px-4 py-3">
                      <span class="px-2 py-1 rounded text-xs font-semibold <%= trade.trade_type&.downcase == 'buy' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400' %>">
                        <%= trade.trade_type %>
                      </span>
                    </td>
                    <td class="px-4 py-3 text-neutral-300"><%= trade.volume %></td>
                    <td class="px-4 py-3 text-neutral-300"><%= trade.open_price %></td>
                    <td class="px-4 py-3 text-neutral-300"><%= trade.close_price %></td>
                    <td class="px-4 py-3 font-semibold <%= trade.profit >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
                      <%= number_to_currency(trade.profit, unit: "€", format: "%n%u") %>
                    </td>
                    <td class="px-4 py-3 text-neutral-400 text-sm"><%= trade.close_time&.strftime("%d/%m/%Y %H:%M") %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="p-12 text-center">
            <i class="fa-solid fa-chart-line text-4xl text-neutral-600 mb-4"></i>
            <p class="text-neutral-400">Aucun trade</p>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Tab: Invoices -->
    <div data-tabs-target="panel" data-tab="invoices" class="mt-6 hidden space-y-6">
      <% @client.invoices.order(created_at: :desc).each do |invoice| %>
        <div class="rounded-xl bg-neutral-900 border border-neutral-800 overflow-hidden">
          <div class="p-4 flex items-center justify-between flex-wrap gap-4">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-lg bg-neutral-800 flex items-center justify-center">
                <i class="fa-solid fa-file-invoice text-neutral-400"></i>
              </div>
              <div>
                <h4 class="font-semibold text-white"><%= invoice.reference %></h4>
                <p class="text-sm text-neutral-400"><%= invoice.created_at.strftime("%d/%m/%Y") %></p>
              </div>
            </div>
            <div class="flex items-center gap-6 flex-wrap">
              <div class="text-right">
                <div class="text-sm text-neutral-400">Total</div>
                <div class="font-bold text-white"><%= number_to_currency(invoice.total_amount, unit: "€", format: "%n%u") %></div>
              </div>
              <div class="text-right">
                <div class="text-sm text-neutral-400">Payé</div>
                <div class="font-bold text-emerald-400"><%= number_to_currency(invoice.total_amount - invoice.balance_due, unit: "€", format: "%n%u") %></div>
              </div>
              <div class="text-right">
                <div class="text-sm text-neutral-400">Reste</div>
                <div class="font-bold <%= invoice.balance_due > 0 ? 'text-red-400' : 'text-emerald-400' %>"><%= number_to_currency(invoice.balance_due, unit: "€", format: "%n%u") %></div>
              </div>
              <% if invoice.balance_due <= 0 %>
                <span class="px-3 py-1 rounded-full text-sm font-medium bg-emerald-500/20 text-emerald-400">Payée</span>
              <% elsif invoice.balance_due < invoice.total_amount %>
                <span class="px-3 py-1 rounded-full text-sm font-medium bg-amber-500/20 text-amber-400">Partiel</span>
              <% else %>
                <span class="px-3 py-1 rounded-full text-sm font-medium bg-red-500/20 text-red-400">En attente</span>
              <% end %>
              
              <% if invoice.stripe_payment_intent_id.present? %>
                <a href="https://dashboard.stripe.com/payments/<%= invoice.stripe_payment_intent_id %>" 
                   target="_blank" 
                   rel="noopener noreferrer"
                   class="px-3 py-1 rounded-lg text-sm font-medium bg-purple-600 text-white hover:bg-purple-700 transition-colors flex items-center gap-2">
                  <i class="fa-brands fa-stripe"></i>
                  Voir sur Stripe
                </a>
              <% end %>
            </div>
          </div>
          
          <% if invoice.invoice_items.any? %>
            <div class="border-t border-neutral-800 p-4">
              <div class="space-y-2">
                <% invoice.invoice_items.each do |item| %>
                  <div class="flex justify-between py-2 px-3 rounded bg-neutral-800/50">
                    <span class="text-neutral-300"><%= item.label %></span>
                    <span class="text-white font-medium"><%= number_to_currency(item.total_price, unit: "€", format: "%n%u") %></span>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
          
          <% if invoice.invoice_payments.any? %>
            <div class="border-t border-neutral-800 p-4">
              <h5 class="text-sm font-semibold text-neutral-400 mb-3 flex items-center gap-2">
                <i class="fa-solid fa-credit-card"></i>
                Paiements enregistrés
              </h5>
              <div class="space-y-2">
                <% invoice.invoice_payments.each do |payment| %>
                  <div class="flex justify-between items-center py-2 px-3 rounded bg-emerald-500/10">
                    <div class="flex items-center gap-3">
                      <i class="fa-solid fa-check-circle text-emerald-400"></i>
                      <div>
                        <span class="text-neutral-300"><%= payment.payment_method == 'stripe' ? 'Paiement Stripe' : payment.payment_method %></span>
                        <% if payment.notes.present? %>
                          <p class="text-xs text-neutral-500"><%= payment.notes.truncate(50) %></p>
                        <% end %>
                      </div>
                    </div>
                    <div class="text-right">
                      <span class="text-emerald-400 font-medium"><%= number_to_currency(payment.amount, unit: "€", format: "%n%u") %></span>
                      <span class="text-xs text-neutral-500 block"><%= payment.paid_at&.strftime("%d/%m/%Y %H:%M") %></span>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
      
      <% if @client.invoices.empty? %>
        <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-12 text-center">
          <i class="fa-solid fa-file-invoice text-4xl text-neutral-600 mb-4"></i>
          <p class="text-neutral-400">Aucune facture</p>
        </div>
      <% end %>
    </div>

    <!-- Tab: Subscriptions -->
    <div data-tabs-target="panel" data-tab="subscriptions" class="mt-6 hidden space-y-6">
      <% @client.subscriptions.order(created_at: :desc).each do |subscription| %>
        <div class="rounded-xl bg-neutral-900 border border-neutral-800 overflow-hidden">
          <div class="p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-4">
                <div class="w-14 h-14 rounded-xl bg-gradient-to-br <%= subscription.active? ? 'from-emerald-500 to-green-600' : 'from-neutral-600 to-neutral-700' %> flex items-center justify-center">
                  <i class="fa-solid fa-repeat text-white text-2xl"></i>
                </div>
                <div>
                  <h3 class="text-xl font-bold text-white">Abonnement <%= subscription.plan_name %></h3>
                  <p class="text-sm text-neutral-400">
                    Depuis le <%= subscription.created_at.strftime("%d/%m/%Y") %>
                  </p>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <div class="text-right">
                  <div class="text-2xl font-bold text-white"><%= number_to_currency(subscription.monthly_price, unit: "€", format: "%n%u") %></div>
                  <div class="text-sm text-neutral-400">par mois</div>
                </div>
                <span class="px-4 py-2 rounded-full text-sm font-semibold <%= 
                  case subscription.status
                  when 'active' then 'bg-emerald-500/20 text-emerald-400'
                  when 'past_due' then 'bg-amber-500/20 text-amber-400'
                  when 'canceled' then 'bg-red-500/20 text-red-400'
                  else 'bg-neutral-700 text-neutral-400'
                  end
                %>">
                  <%= case subscription.status
                      when 'active' then '✓ Actif'
                      when 'past_due' then '⚠️ Impayé'
                      when 'canceled' then '✕ Annulé'
                      when 'paused' then '⏸ En pause'
                      else subscription.status.titleize
                      end
                  %>
                </span>
              </div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6 pt-6 border-t border-neutral-800">
              <div>
                <div class="text-sm text-neutral-400">Prochain prélèvement</div>
                <div class="font-semibold text-white"><%= subscription.current_period_end&.strftime("%d/%m/%Y") || "—" %></div>
              </div>
              <div>
                <div class="text-sm text-neutral-400">Échecs de paiement</div>
                <div class="font-semibold <%= subscription.failed_payment_count > 0 ? 'text-amber-400' : 'text-white' %>">
                  <%= subscription.failed_payment_count %>
                </div>
              </div>
              <div>
                <div class="text-sm text-neutral-400">ID Stripe</div>
                <div class="font-mono text-xs text-neutral-400 truncate"><%= subscription.stripe_subscription_id %></div>
              </div>
              <div>
                <div class="text-sm text-neutral-400">Dernier rappel</div>
                <div class="font-semibold text-white"><%= subscription.last_reminder_sent_at&.strftime("%d/%m/%Y %H:%M") || "—" %></div>
              </div>
            </div>
            
            <% if subscription.stripe_subscription_id.present? && !subscription.stripe_subscription_id.start_with?('sub_manual') %>
              <div class="mt-6 pt-6 border-t border-neutral-800 flex gap-3">
                <a href="https://dashboard.stripe.com/subscriptions/<%= subscription.stripe_subscription_id %>" 
                   target="_blank" 
                   rel="noopener noreferrer"
                   class="px-4 py-2 rounded-lg bg-purple-600 text-white text-sm font-medium hover:bg-purple-700 transition-colors flex items-center gap-2">
                  <i class="fa-brands fa-stripe"></i>
                  Voir sur Stripe
                </a>
                
                <% if subscription.active? && current_user.is_admin? %>
                  <%= button_to "#", method: :post, class: "px-4 py-2 rounded-lg bg-amber-600 text-white text-sm font-medium hover:bg-amber-700 transition-colors", disabled: true do %>
                    <i class="fa-solid fa-pause mr-2"></i>Mettre en pause
                  <% end %>
                  <%= button_to "#", method: :delete, class: "px-4 py-2 rounded-lg bg-red-600 text-white text-sm font-medium hover:bg-red-700 transition-colors", disabled: true, data: { confirm: "Annuler cet abonnement ?" } do %>
                    <i class="fa-solid fa-times mr-2"></i>Annuler
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>
          
          <% if subscription.past_due? && subscription.failed_payment_count > 0 %>
            <div class="bg-amber-500/10 border-t border-amber-500/30 p-4">
              <div class="flex items-center gap-3 text-amber-400">
                <i class="fa-solid fa-exclamation-triangle text-lg"></i>
                <div>
                  <span class="font-semibold">Paiement échoué</span>
                  <p class="text-sm text-amber-300/80">
                    <% if subscription.last_reminder_sent_at %>
                      Dernier SMS de relance envoyé le <%= subscription.last_reminder_sent_at.strftime("%d/%m/%Y à %H:%M") %>
                    <% else %>
                      Un SMS de relance sera envoyé automatiquement.
                    <% end %>
                  </p>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
      
      <% if @client.subscriptions.empty? %>
        <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-12 text-center">
          <i class="fa-solid fa-repeat text-4xl text-neutral-600 mb-4"></i>
          <p class="text-neutral-400">Aucun abonnement</p>
        </div>
      <% end %>
    </div>

    <!-- Tab: VPS -->
    <div data-tabs-target="panel" data-tab="vps" class="mt-6 hidden space-y-6">
      <% @client.vps.each do |vps| %>
        <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
                <i class="fa-solid fa-server text-white text-xl"></i>
              </div>
              <div>
                <h3 class="font-semibold text-white"><%= vps.name %></h3>
                <p class="text-sm text-neutral-400"><%= vps.ip_address || "IP non assignée" %></p>
              </div>
            </div>
            <span class="px-3 py-1 rounded-full text-sm font-medium" style="background: <%= vps.status_color %>20; color: <%= vps.status_color %>;">
              <%= vps.status_icon %> <%= vps.status_label %>
            </span>
          </div>
          
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 pt-4 border-t border-neutral-800">
            <div>
              <div class="text-sm text-neutral-400">Prix Mensuel</div>
              <div class="font-semibold text-white"><%= number_to_currency(vps.monthly_price, unit: "€", format: "%n%u") %></div>
            </div>
            <div>
              <div class="text-sm text-neutral-400">Commandé le</div>
              <div class="font-semibold text-white"><%= vps.ordered_at&.strftime("%d/%m/%Y") || "—" %></div>
            </div>
            <div>
              <div class="text-sm text-neutral-400">Renouvellement</div>
              <div class="font-semibold text-white"><%= vps.renewal_date&.strftime("%d/%m/%Y") || "—" %></div>
            </div>
            <div>
              <div class="text-sm text-neutral-400">Localisation</div>
              <div class="font-semibold text-white"><%= vps.server_location || "—" %></div>
            </div>
          </div>

        </div>
      <% end %>
      
      <% if @client.vps.empty? %>
        <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-12 text-center">
          <i class="fa-solid fa-server text-4xl text-neutral-600 mb-4"></i>
          <p class="text-neutral-400">Aucun VPS</p>
        </div>
      <% end %>
    </div>

    <!-- Tab: Admin -->
    <% if current_user.is_admin? %>
      <div data-tabs-target="panel" data-tab="admin" class="mt-6 hidden space-y-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Modifier Commission -->
          <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-6">
            <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
              <i class="fa-solid fa-percent text-amber-400"></i>
              Taux de Commission
            </h3>
            <%= form_with url: admin_client_path(@client), method: :patch, local: true, class: "flex gap-4" do |f| %>
              <div class="flex-1">
                <input type="number" name="user[commission_rate]" value="<%= @client.commission_rate %>" step="0.1" min="0" max="100" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white focus:border-blue-500">
              </div>
              <button type="submit" class="px-6 py-2.5 rounded-lg bg-amber-600 text-white font-medium hover:bg-amber-700 transition-colors">
                Mettre à jour
              </button>
            <% end %>
          </div>

          <!-- Ajouter Paiement -->
          <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-6">
            <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
              <i class="fa-solid fa-credit-card text-emerald-400"></i>
              Ajouter un Paiement
            </h3>
            <%= form_with url: admin_payments_path, method: :post, local: true, class: "space-y-4" do |f| %>
              <input type="hidden" name="payment[user_id]" value="<%= @client.id %>">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm text-neutral-400 mb-1">Montant</label>
                  <input type="number" name="payment[amount]" step="0.01" required class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white focus:border-blue-500">
                </div>
                <div>
                  <label class="block text-sm text-neutral-400 mb-1">Méthode</label>
                  <select name="payment[payment_method]" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white focus:border-blue-500">
                    <option value="bank_transfer">Virement</option>
                    <option value="card">Carte</option>
                    <option value="cash">Espèces</option>
                  </select>
                </div>
              </div>
              <button type="submit" class="w-full px-6 py-2.5 rounded-lg bg-emerald-600 text-white font-medium hover:bg-emerald-700 transition-colors">
                <i class="fa-solid fa-plus mr-2"></i>Enregistrer le paiement
              </button>
            <% end %>
          </div>
        </div>

        <!-- Zone Danger -->
        <div class="rounded-xl bg-red-950/20 border border-red-900/50 p-6">
          <h3 class="text-lg font-semibold text-red-400 mb-4 flex items-center gap-2">
            <i class="fa-solid fa-triangle-exclamation"></i>
            Zone Dangereuse
          </h3>
          <div class="flex flex-wrap gap-4">
            <%= button_to admin_client_path(@client), method: :delete, data: { confirm: "Êtes-vous sûr de vouloir supprimer ce client ? Cette action est irréversible." }, class: "px-4 py-2 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition-colors" do %>
              <i class="fa-solid fa-trash mr-2"></i>Supprimer le client
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const controller = document.querySelector('[data-controller="tabs"]');
  if (!controller) return;
  
  const tabs = controller.querySelectorAll('[data-tabs-target="tab"]');
  const panels = controller.querySelectorAll('[data-tabs-target="panel"]');
  const defaultTab = controller.dataset.tabsDefaultValue || 'overview';
  
  function selectTab(tabName) {
    tabs.forEach(tab => {
      const isActive = tab.dataset.tab === tabName;
      tab.classList.toggle('bg-white', isActive);
      tab.classList.toggle('text-neutral-900', isActive);
      tab.classList.toggle('text-neutral-400', !isActive);
      tab.classList.toggle('hover:text-white', !isActive);
      tab.classList.toggle('hover:bg-neutral-800', !isActive);
    });
    
    panels.forEach(panel => {
      const isActive = panel.dataset.tab === tabName;
      panel.classList.toggle('hidden', !isActive);
    });
  }
  
  tabs.forEach(tab => {
    tab.addEventListener('click', () => selectTab(tab.dataset.tab));
  });
  
  selectTab(defaultTab);
});
</script>
