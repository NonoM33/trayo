<!DOCTYPE html>
<html>
<head>
  <title>Client Details - Admin Trayo</title>
  <%= stylesheet_link_tag "admin" %>
  <style>
    .container { max-width: 1600px; }
    .alert { padding: 15px; margin-bottom: 20px; background: #f44336; color: white; border-radius: 4px; }
    .status-pending { color: #ff9800; font-weight: 600; }
    .status-validated { color: #4CAF50; font-weight: 600; }
    .status-rejected { color: #f44336; font-weight: 600; }
    .form-inline { display: inline; }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .positive { color: #10b981; }
  .negative { color: #ef4444; }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
  }
  
  .stat-item {
    text-align: center;
    padding: 1rem;
    background: var(--bg-hover);
    border-radius: 6px;
  }
  
  .stat-value {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
  }
  
  .stat-label {
    font-size: 0.875rem;
    color: var(--text-muted);
  }
  
  .trade-type-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .trade-type-badge.buy {
    background: #10b981;
    color: white;
  }
  
  .trade-type-badge.sell {
    background: #ef4444;
    color: white;
  }
  
  .magic-badge {
    background: var(--primary-color);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  
  .empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--text-muted);
  }
  
  .empty-state-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }
  
  .empty-state h3 {
    margin-bottom: 0.5rem;
    color: var(--text-color);
  }
  
  .empty-state ul {
    text-align: left;
    max-width: 400px;
    margin: 0 auto;
  }
</style>
</head>
<body>
  <% @page_title = "Client Details" %>
  
  <div class="app-layout">
    <%= render 'admin/shared/sidebar' %>
    
    <div class="main-content">
      <%= render 'admin/shared/navbar' %>
      
      <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <% if current_user.is_admin? %>
        <%= link_to admin_clients_path, class: "back-link", style: "margin: 0;" do %>
          <i class="fa-icon fa-md fa-arrow-left"></i> Retour aux Clients
        <% end %>
      <% else %>
        <h1 style="margin: 0;">Mon Profil</h1>
      <% end %>
      <%= link_to edit_admin_client_path(@client), class: "btn btn-primary" do %>
        <i class="fa-icon fa-md fa-edit"></i> Modifier <%= current_user.is_admin? ? 'le Profil Utilisateur' : 'Mon Profil' %>
      <% end %>
    </div>

    <% if flash[:notice] %>
      <div class="notice"><%= flash[:notice] %></div>
    <% end %>
    <% if flash[:alert] %>
      <div class="alert"><%= flash[:alert] %></div>
    <% end %>

    <div class="card">
      <h2><%= current_user.is_admin? ? "Client : #{@client.email}" : "Informations Personnelles" %></h2>
      
      <% if @client.mt5_api_token.present? && current_user.is_admin? %>
        <div style="background: #e3f2fd; padding: 15px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
          <div style="font-weight: 600; color: #1976D2; margin-bottom: 8px;">
            <i class="fa-icon fa-md fa-shield-alt"></i>
            Token API MT5
          </div>
          <div style="font-family: monospace; font-size: 14px; color: #333; word-break: break-all; background: white; padding: 10px; border-radius: 4px;">
            <%= @client.mt5_api_token %>
          </div>
          <div style="font-size: 12px; color: #666; margin-top: 8px;">
            <i class="fa-icon fa-md fa-info-circle"></i> Ce token doit √™tre configur√© dans le script MT5 (TrayoSync.mq5) pour la synchronisation du compte
          </div>
        </div>
      <% end %>
      
      <div class="info-grid">
        <% if current_user.is_admin? %>
          <div class="info-item">
            <div class="info-label">Capital √† l'instant T</div>
            <div class="info-value positive">
              <%= number_to_currency(@mt5_accounts.sum(&:balance), unit: "‚Ç¨", format: "%n %u") %>
            </div>
            <div class="help-text" style="font-size: 12px; color: var(--text-muted); margin-top: 5px;">
              Balance actuelle totale
            </div>
          </div>
        <% end %>
        <% if current_user.is_admin? %>
          <div class="info-item">
            <div class="info-label">High Watermark</div>
            <div class="info-value positive">
              <%= number_to_currency(@mt5_accounts.sum(&:high_watermark), unit: "‚Ç¨", format: "%n %u") %>
            </div>
            <div class="help-text" style="font-size: 12px; color: var(--text-muted); margin-top: 5px;">
              Plus haut niveau atteint
            </div>
          </div>
        <% end %>
        <% if current_user.is_admin? %>
          <div class="info-item">
            <div class="info-label">Taux de Commission</div>
            <div class="info-value"><%= number_to_percentage(@client.commission_rate, precision: 1) %></div>
          </div>
        <% end %>
        <div class="info-item">
          <div class="info-label">Gains Totaux</div>
          <div class="info-value <%= @client.total_profits >= 0 ? 'positive' : 'negative' %>">
            <%= number_to_currency(@client.total_profits, unit: "‚Ç¨", format: "%n %u") %>
          </div>
          <div class="help-text" style="font-size: 12px; color: var(--text-muted); margin-top: 5px;">
            Gains r√©els + retraits effectu√©s
          </div>
        </div>
        <% if current_user.is_admin? %>
          <div class="info-item">
            <div class="info-label">Gains Commissionnables</div>
            <div class="info-value <%= @client.total_commissionable_gains >= 0 ? 'positive' : 'negative' %>">
              <%= number_to_currency(@client.total_commissionable_gains, unit: "‚Ç¨", format: "%n %u") %>
            </div>
          </div>
        <% end %>
        <% if current_user.is_admin? %>
          <div class="info-item">
            <div class="info-label">Commission Due</div>
            <div class="info-value <%= @client.total_commission_due > 0 ? 'negative' : 'positive' %>">
              <%= number_to_currency(@client.total_commission_due, unit: "‚Ç¨", format: "%n %u") %>
            </div>
          </div>
        <% end %>
        <% if current_user.is_admin? %>
          <div class="info-item">
            <div class="info-label">Cr√©dits Appliqu√©s</div>
            <div class="info-value positive"><%= number_to_currency(@client.total_credits, unit: "‚Ç¨", format: "%n %u") %></div>
          </div>
        <% end %>
        <% if current_user.is_admin? %>
          <div class="info-item">
            <% if @client.balance_due > 0 %>
              <div class="info-label">Solde √† Payer</div>
              <div class="info-value negative">
                <%= number_to_currency(@client.balance_due, unit: "‚Ç¨", format: "%n %u") %>
              </div>
            <% elsif @client.balance_due < 0 %>
              <div class="info-label">Solde Cr√©diteur</div>
              <div class="info-value positive">
                <%= number_to_currency(@client.balance_due.abs, unit: "‚Ç¨", format: "%n %u") %>
              </div>
            <% else %>
              <div class="info-label">Solde √† Payer</div>
              <div class="info-value" style="color: #4CAF50;">
                0 ‚Ç¨ <i class="fa-icon fa-md fa-check-circle"></i>
              </div>
            <% end %>
          </div>
        <% end %>
        <div class="info-item">
          <div class="info-label">Historique Paiements</div>
          <div class="info-value" style="font-size: 16px; color: #666;">
            <%= number_to_currency(@client.total_validated_payments, unit: "‚Ç¨", format: "%n %u") %> pay√©s
          </div>
        </div>
      </div>

      <% if current_user.is_admin? %>
        <h3>Mettre √† Jour le Taux de Commission</h3>
        <%= form_with model: @client, url: admin_client_path(@client), method: :patch do |f| %>
          <div class="form-group">
            <%= f.label :commission_rate, "Taux de Commission (%)" %>
            <%= f.number_field :commission_rate, step: 0.01, min: 0, max: 100 %>
          </div>
          <%= f.submit "Mettre √† Jour", class: "btn" %>
        <% end %>
        
        <div class="mt-4">
          <h3>Gestion MT5</h3>
          <div class="mt5-controls">
            <% if @client.init_mt5? %>
              <div class="status-indicator">
                <span class="status-badge status-validated">
                  <i class="fa-icon fa-md fa-check-circle"></i>
                  MT5 Initialis√©
                </span>
                <p class="help-text">Le compte MT5 a √©t√© synchronis√© avec l'historique complet.</p>
              </div>
              <%= button_to "R√©initialiser MT5", reset_mt5_admin_client_path(@client), 
                    method: :post,
                    class: "btn btn-outline",
                    data: { turbo_confirm: "R√©initialiser la synchronisation MT5 ? Cela forcera une nouvelle synchronisation compl√®te de l'historique." } %>
            <% else %>
              <div class="status-indicator">
                <span class="status-badge status-pending">
                  <span style="color: white;">
                    <i class="fa-icon fa-md fa-clock"></i>
                    MT5 Non Initialis√©
                  </span>
                </span>
                <p class="help-text">Le compte MT5 n√©cessite une synchronisation compl√®te de l'historique.</p>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <% if current_user.is_admin? %>
      <div class="card">
        <h2>Comptes MT5</h2>
        <div class="info-box" style="background: var(--bg-hover); padding: 12px; border-radius: 6px; margin-bottom: 15px;">
          <div style="font-size: 13px; color: var(--text-muted);">
            <strong>üí° Calcul des gains :</strong><br>
            ‚Ä¢ <strong>Gains Nets</strong> = Balance actuelle - Capital initial + Retraits effectu√©s<br>
            ‚Ä¢ <strong>Gains Commissionnables</strong> = Balance actuelle - High Watermark ajust√©<br>
            ‚Ä¢ Les retraits augmentent les gains nets car ils repr√©sentent de l'argent gagn√© et retir√©
          </div>
        </div>
      <% if @mt5_accounts.any? %>
        <table>
          <thead>
            <tr>
              <th>Balance Initiale</th>
              <th>Balance Actuelle</th>
              <th>Gains Nets</th>
              <th>High Watermark</th>
              <th>Retraits</th>
              <th>Commissionnable</th>
              <% if current_user.is_admin? %>
                <th>Actions</th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <% @mt5_accounts.each do |account| %>
              <tr>
                <td><%= number_to_currency(account.auto_calculated_initial_balance && account.calculated_initial_balance.present? ? account.calculated_initial_balance : account.initial_balance, unit: "‚Ç¨", format: "%n %u") %></td>
                <td><%= number_to_currency(account.balance, unit: "‚Ç¨", format: "%n %u") %></td>
                <td class="<%= account.net_gains > 0 ? 'positive' : 'negative' %>">
                  <%= number_to_currency(account.net_gains, unit: "‚Ç¨", format: "%n %u") %>
                </td>
                <td><%= number_to_currency(account.high_watermark, unit: "‚Ç¨", format: "%n %u") %></td>
                <td><%= number_to_currency(account.total_withdrawals, unit: "‚Ç¨", format: "%n %u") %></td>
                <td class="<%= account.commissionable_gains >= 0 ? 'positive' : 'negative' %>">
                  <%= number_to_currency(account.commissionable_gains, unit: "‚Ç¨", format: "%n %u") %>
                </td>
                <% if current_user.is_admin? %>
                  <td>
                    <button onclick="document.getElementById('edit-account-<%= account.id %>').style.display='block'" class="btn btn-outline btn-sm">
                      Modifier
                    </button>
                  </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p style="color: #999;">Aucun compte MT5 pour le moment</p>
      <% end %>
      </div>
    <% end %>

    <!-- R√©sum√© des Trades -->
    <% if current_user.is_admin? && @mt5_accounts.any? %>
      <div class="card">
        <div class="card-header">
          <h2>R√©sum√© des Trades</h2>
          <%= link_to "Voir tous les trades", trades_admin_client_path(@client), class: "btn btn-outline btn-sm" %>
        </div>
        
        <% 
          all_trades = Trade.joins(:mt5_account).where(mt5_accounts: { user_id: @client.id })
          recent_trades = all_trades.order(close_time: :desc).limit(10)
          total_trades = all_trades.count
          total_profit = all_trades.sum(:profit)
          winning_trades = all_trades.where('profit > 0').count
          losing_trades = all_trades.where('profit < 0').count
          win_rate = total_trades > 0 ? (winning_trades.to_f / total_trades * 100).round(2) : 0
        %>
        
        <div class="stats-grid" style="margin-bottom: 1.5rem;">
          <div class="stat-item">
            <div class="stat-value"><%= total_trades %></div>
            <div class="stat-label">Total Trades</div>
          </div>
          <div class="stat-item">
            <div class="stat-value <%= total_profit >= 0 ? 'positive' : 'negative' %>">
              <%= number_to_currency(total_profit, unit: "‚Ç¨", format: "%n %u") %>
            </div>
            <div class="stat-label">Profit Total</div>
          </div>
          <div class="stat-item">
            <div class="stat-value"><%= win_rate %>%</div>
            <div class="stat-label">Taux de R√©ussite</div>
          </div>
          <div class="stat-item">
            <div class="stat-value"><%= winning_trades %>/<%= losing_trades %></div>
            <div class="stat-label">Gagnants/Perdants</div>
          </div>
        </div>
        
        <% if recent_trades.any? %>
          <h4>Derniers Trades</h4>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Symbole</th>
                  <th>Type</th>
                  <th>Volume</th>
                  <th>Profit</th>
                  <th>Bot</th>
                </tr>
              </thead>
              <tbody>
                <% recent_trades.each do |trade| %>
                  <tr>
                    <td><%= trade.close_time&.strftime("%d/%m/%Y %H:%M") %></td>
                    <td><%= trade.symbol %></td>
                    <td>
                      <span class="trade-type-badge <%= trade.trade_type %>">
                        <%= trade.trade_type&.upcase %>
                      </span>
                    </td>
                    <td><%= trade.volume %></td>
                    <td class="<%= trade.profit >= 0 ? 'positive' : 'negative' %>">
                      <%= number_to_currency(trade.profit, unit: "‚Ç¨", format: "%n %u") %>
                    </td>
                    <td>
                      <% if trade.magic_number.present? %>
                        <span class="magic-badge">Bot <%= trade.magic_number %></span>
                      <% else %>
                        <span class="text-muted">-</span>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <p style="color: #999;">Aucun trade trouv√©</p>
        <% end %>
      </div>
    <% end %>
    <% if current_user.is_admin? && @mt5_accounts.any? %>
      <div class="card">
        <div class="card-header">
          <h2>Historique des Retraits</h2>
          <button onclick="showAddWithdrawalModal()" class="btn btn-outline btn-sm">
            <i class="fa-icon fa-md fa-plus"></i> Ajouter un retrait
          </button>
        </div>
        
        <% has_withdrawals = false %>
        <% @mt5_accounts.each do |account| %>
          <% if account.withdrawals.any? %>
            <% has_withdrawals = true %>
            <h4><%= account.account_name %> (<%= account.mt5_id %>)</h4>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Montant</th>
                    <th>Notes</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% account.withdrawals.order(withdrawal_date: :desc).each do |withdrawal| %>
                    <tr>
                      <td><%= withdrawal.withdrawal_date.strftime("%d/%m/%Y") %></td>
                      <td class="negative"><%= number_to_currency(withdrawal.amount, unit: "‚Ç¨", format: "%n %u") %></td>
                      <td><%= withdrawal.notes.present? ? withdrawal.notes : "-" %></td>
                      <td>
                        <div class="action-buttons">
                          <%= button_to "Supprimer", admin_withdrawal_path(withdrawal), 
                                method: :delete,
                                data: { turbo_confirm: "Supprimer ce retrait ?" },
                                class: "btn btn-danger btn-sm" %>
                        </div>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% end %>
        <% end %>
        
        <% unless has_withdrawals %>
          <div class="empty-state">
            <div class="empty-state-icon">
              <i class="fa-icon fa-lg fa-money-bill-wave"></i>
            </div>
            <h3>Aucun retrait enregistr√©</h3>
            <p>Aucun retrait n'a √©t√© d√©tect√© pour ce compte. Les retraits peuvent √™tre :</p>
            <ul style="text-align: left; max-width: 400px; margin: 0 auto;">
              <li>D√©tect√©s automatiquement lors de la synchronisation MT5</li>
              <li>Import√©s depuis l'historique MT5 complet</li>
              <li>Ajout√©s manuellement par l'administrateur</li>
            </ul>
            <div style="margin-top: 1rem;">
              <button onclick="showAddWithdrawalModal()" class="btn btn-primary">
                <i class="fa-icon fa-md fa-plus"></i> Ajouter un retrait manuellement
              </button>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Historique des D√©p√¥ts -->
    <% if current_user.is_admin? && @mt5_accounts.any? %>
      <div class="card">
        <div class="card-header">
          <h2>Historique des D√©p√¥ts</h2>
          <button onclick="showAddDepositModal()" class="btn btn-outline btn-sm">
            <i class="fa-icon fa-md fa-plus"></i> Ajouter un d√©p√¥t
          </button>
        </div>
        
        <% has_deposits = false %>
        <% @mt5_accounts.each do |account| %>
          <% if account.deposits.any? %>
            <% has_deposits = true %>
            <h4><%= account.account_name %> (<%= account.mt5_id %>)</h4>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Montant</th>
                    <th>Notes</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% account.deposits.order(deposit_date: :desc).each do |deposit| %>
                    <tr>
                      <td><%= deposit.deposit_date.strftime("%d/%m/%Y") %></td>
                      <td class="positive"><%= number_to_currency(deposit.amount, unit: "‚Ç¨", format: "%n %u") %></td>
                      <td><%= deposit.notes.present? ? deposit.notes : "-" %></td>
                      <td>
                        <div class="action-buttons">
                          <%= button_to "Supprimer", admin_deposit_path(deposit), 
                                method: :delete,
                                data: { turbo_confirm: "Supprimer ce d√©p√¥t ?" },
                                class: "btn btn-danger btn-sm" %>
                        </div>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% end %>
        <% end %>
        
        <% unless has_deposits %>
          <div class="empty-state">
            <div class="empty-state-icon">
              <i class="fa-icon fa-lg fa-plus-circle"></i>
            </div>
            <h3>Aucun d√©p√¥t enregistr√©</h3>
            <p>Aucun d√©p√¥t n'a √©t√© d√©tect√© pour ce compte. Les d√©p√¥ts peuvent √™tre :</p>
            <ul style="text-align: left; max-width: 400px; margin: 0 auto;">
              <li>D√©tect√©s automatiquement lors de la synchronisation MT5</li>
              <li>Import√©s depuis l'historique MT5 complet</li>
              <li>Ajout√©s manuellement par l'administrateur</li>
            </ul>
            <div style="margin-top: 1rem;">
              <button onclick="showAddDepositModal()" class="btn btn-primary">
                <i class="fa-icon fa-md fa-plus"></i> Ajouter un d√©p√¥t manuellement
              </button>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Formulaire de modification MT5 - En dehors du tableau pour utiliser toute la largeur -->
    <% @mt5_accounts.each do |account| %>
      <% if current_user.is_admin? %>
        <div id="edit-account-<%= account.id %>" class="edit-account-panel" style="display: none;">
          <div class="edit-account-content edit-account-full-width">
            <div class="edit-account-header">
              <h4>Modifier le Compte MT5</h4>
              <button type="button" onclick="document.getElementById('edit-account-<%= account.id %>').style.display='none'" class="btn btn-outline btn-sm">
                ‚úï Fermer
              </button>
            </div>
            
            <%= form_with model: account, url: admin_mt5_account_path(account), method: :patch, class: "edit-account-form" do |f| %>
              <div class="edit-account-main">
                <div class="edit-account-inputs">
                  <div class="input-group">
                    <div class="input-field">
                      <%= f.label :initial_balance, "Balance Initiale", class: "form-label" %>
                      <div class="input-container">
                        <%= f.number_field :initial_balance, step: 0.01, class: "form-input-large", placeholder: "0.00" %>
                        <span class="currency-symbol">‚Ç¨</span>
                      </div>
                      <div class="help-text">
                        Capital de d√©part pour ce compte
                      </div>
                    </div>
                    
                    <div class="input-field">
                      <%= f.label :high_watermark, "High Watermark", class: "form-label" %>
                      <div class="input-container">
                        <%= f.number_field :high_watermark, step: 0.01, class: "form-input-large", placeholder: "0.00" %>
                        <span class="currency-symbol">‚Ç¨</span>
                      </div>
                      <div class="help-text">
                        Actuel : <%= number_to_currency(account.high_watermark, unit: "‚Ç¨", format: "%n %u") %>
                      </div>
                    </div>
                    
                    <div class="input-field">
                      <%= f.label :total_withdrawals, "Total Retraits", class: "form-label" %>
                      <div class="input-container">
                        <%= f.number_field :total_withdrawals, step: 0.01, class: "form-input-large", placeholder: "0.00" %>
                        <span class="currency-symbol">‚Ç¨</span>
                      </div>
                      <div class="help-text">
                        Montant total des retraits effectu√©s
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="withdrawal-section">
                  <h5>Enregistrer un Nouveau Retrait</h5>
                  <div class="withdrawal-form">
                    <%= fields_for "withdrawal", nil do |wf| %>
                      <div class="input-group">
                        <div class="input-field">
                          <%= wf.label :amount, "Montant du Retrait", class: "form-label" %>
                          <div class="input-container">
                            <%= wf.number_field :amount, step: 0.01, class: "form-input", placeholder: "0.00", name: "withdrawal_amount" %>
                            <span class="currency-symbol">‚Ç¨</span>
                          </div>
                        </div>
                        
                        <div class="input-field">
                          <%= wf.label :date, "Date du Retrait", class: "form-label" %>
                          <%= wf.date_field :date, class: "form-input", name: "withdrawal_date", value: Date.current %>
                        </div>
                      </div>
                    <% end %>
                  </div>
                </div>
                
                <div class="calculation-section">
                  <h5>Calcul Actuel</h5>
                  <div class="calculation-grid">
                    <div class="calculation-item">
                      <div class="calculation-label">Gains Nets</div>
                      <div class="calculation-formula">
                        Balance (<%= number_to_currency(account.balance, unit: "‚Ç¨", format: "%n %u") %>) - Initial (<%= number_to_currency(account.initial_balance, unit: "‚Ç¨", format: "%n %u") %>)
                      </div>
                      <div class="calculation-result">
                        <%= number_to_currency(account.net_gains, unit: "‚Ç¨", format: "%n %u") %>
                      </div>
                    </div>
                    
                    <div class="calculation-item">
                      <div class="calculation-label">WM Ajust√©</div>
                      <div class="calculation-formula">
                        High WM (<%= number_to_currency(account.high_watermark, unit: "‚Ç¨", format: "%n %u") %>) - Retraits (<%= number_to_currency(account.total_withdrawals, unit: "‚Ç¨", format: "%n %u") %>)
                      </div>
                      <div class="calculation-result">
                        <%= number_to_currency(account.adjusted_watermark, unit: "‚Ç¨", format: "%n %u") %>
                      </div>
                    </div>
                    
                    <div class="calculation-item">
                      <div class="calculation-label">Commissionnable</div>
                      <div class="calculation-formula">
                        Balance (<%= number_to_currency(account.balance, unit: "‚Ç¨", format: "%n %u") %>) - WM Ajust√© (<%= number_to_currency(account.adjusted_watermark, unit: "‚Ç¨", format: "%n %u") %>)
                      </div>
                      <div class="calculation-result">
                        <%= number_to_currency(account.commissionable_gains, unit: "‚Ç¨", format: "%n %u") %>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="edit-account-actions">
                <%= f.submit "Mettre √† Jour", class: "btn btn-primary btn-large" %>
                <button type="button" onclick="document.getElementById('edit-account-<%= account.id %>').style.display='none'" class="btn btn-outline btn-large">
                  Annuler
                </button>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>

    <% if current_user.is_admin? %>
    <div class="card">
      <h2>Bots de Trading</h2>
      
      <% client_bots = @client.bot_purchases.includes(:trading_bot).order(created_at: :desc) %>
      
      <% if client_bots.any? %>
        <table>
          <thead>
            <tr>
              <th>Bot</th>
              <th>Prix Pay√©</th>
              <th>Date d'Achat</th>
              <th>Statut</th>
              <th>Profit Total</th>
              <th>Trades</th>
              <th>Drawdown Max</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% client_bots.each do |purchase| %>
              <tr>
                <td>
                  <%= link_to admin_bot_path(purchase.trading_bot) do %>
                    <strong><%= purchase.trading_bot.name %></strong>
                  <% end %>
                  <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                    <span style="background: <%= purchase.trading_bot.risk_badge_color %>; color: white; padding: 2px 8px; border-radius: 8px; font-size: 11px;">
                      <%= purchase.trading_bot.risk_label %>
                    </span>
                  </div>
                </td>
                <td><%= number_to_currency(purchase.price_paid, unit: "‚Ç¨", format: "%n %u") %></td>
                <td><%= purchase.created_at.strftime("%d/%m/%Y") %></td>
                <td>
                  <%= purchase.status_badge %>
                </td>
                <td class="<%= purchase.total_profit > 0 ? 'positive' : 'negative' %>">
                  <%= number_to_currency(purchase.total_profit, unit: "‚Ç¨", format: "%n %u") %>
                </td>
                <td><%= purchase.trades_count %></td>
                <td class="<%= purchase.within_drawdown_limit? ? '' : 'negative' %>">
                  <%= number_to_currency(purchase.max_drawdown_recorded, unit: "‚Ç¨", format: "%n %u") %>
                  <% unless purchase.within_drawdown_limit? %>
                    <span style="color: #F44336; font-size: 12px;"><i class="fa-icon fa-md fa-exclamation-triangle"></i> Limite d√©pass√©e</span>
                  <% end %>
                </td>
                <td>
                  <%= button_to purchase.is_running? ? "Arr√™ter" : "D√©marrer",
                      toggle_status_admin_my_bot_path(purchase),
                      method: :post,
                      class: purchase.is_running? ? "btn btn-warning btn-sm" : "btn btn-success btn-sm" %>
                  <%= button_to "Retirer",
                      remove_from_user_admin_bot_path(purchase.trading_bot, purchase_id: purchase.id),
                      method: :delete,
                      data: { turbo_confirm: "Retirer ce bot du client ?" },
                      class: "btn btn-danger btn-sm" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p style="text-align: center; color: var(--text-muted); padding: 20px;">
          Aucun bot assign√© pour le moment
        </p>
      <% end %>
      
      <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color);">
        <h3 style="margin-bottom: 16px;">Assigner un Nouveau Bot</h3>
        <%= form_tag assign_to_user_admin_bots_path, method: :post, data: { turbo: false }, style: "display: flex; gap: 12px; align-items: end;" do %>
          <%= hidden_field_tag :user_id, @client.id %>
          
          <div class="form-group" style="flex: 1; margin-bottom: 0;">
            <%= label_tag :bot_id, "S√©lectionner un Bot" %>
            <%= select_tag :bot_id,
                options_from_collection_for_select(TradingBot.available.order(:name), :id, :name),
                prompt: 'Choisir un bot...',
                required: true,
                style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" %>
          </div>
          
          <div class="form-group" style="flex: 0 0 200px; margin-bottom: 0;">
            <%= label_tag :price_paid, "Prix (‚Ç¨)" %>
            <%= number_field_tag :price_paid, nil, step: 0.01, min: 0, placeholder: "Optionnel",
                style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" %>
          </div>
          
          <%= submit_tag "Assigner", class: "btn btn-success", style: "margin-top: 27px;" do %>
            <i class="fa-icon fa-md fa-plus"></i> Assigner
          <% end %>
        <% end %>
      </div>
    </div>
    <% end %>

    <% if current_user.is_admin? %>
    <div class="card">
      <h2><i class="fa-icon fa-md fa-desktop"></i> VPS</h2>
      
      <% if @client.vps.any? %>
        <table style="margin-bottom: 24px;">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Emplacement</th>
              <th>IP</th>
              <th>Statut</th>
              <th>Prix/mois</th>
              <th>Command√©</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @client.vps.each do |vps| %>
              <tr>
                <td><strong><%= vps.name %></strong></td>
                <td><%= vps.server_location || '-' %></td>
                <td><code style="background: var(--bg-hover); padding: 4px 8px; border-radius: 4px;"><%= vps.ip_address || 'En attente' %></code></td>
                <td>
                  <span style="background: <%= vps.status_color %>; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700;">
                    <%= vps.status_icon %> <%= vps.status_label %>
                  </span>
                </td>
                <td><%= number_to_currency(vps.monthly_price, unit: "‚Ç¨", format: "%n %u") %></td>
                <td><%= vps.ordered_at&.strftime("%d/%m/%Y") || '-' %></td>
                <td>
                  <div class="action-buttons">
                    <%= link_to admin_vp_path(vps), class: "icon-btn primary sm", title: "Voir" do %>
                      <i class="fa-icon fa-md fa-eye"></i>
                    <% end %>
                    <%= link_to edit_admin_vp_path(vps), class: "icon-btn warning sm", title: "Modifier" do %>
                      <i class="fa-icon fa-md fa-edit"></i>
                    <% end %>
                    <%= button_to admin_vp_path(vps), method: :delete,
                        data: { turbo_confirm: "Supprimer ce VPS ?" },
                        class: "icon-btn danger sm", title: "Supprimer" do %>
                      <i class="fa-icon fa-md fa-trash"></i>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p style="text-align: center; color: var(--text-muted); padding: 20px;">
          Aucun VPS pour ce client
        </p>
      <% end %>
      
      <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color);">
        <h3 style="margin-bottom: 16px;">Cr√©er un Nouveau VPS</h3>
        <%= link_to new_admin_vp_path(user_id: @client.id), class: "btn btn-success" do %>
          <i class="fa-icon fa-md fa-plus"></i> Cr√©er un VPS pour ce Client
        <% end %>
      </div>
    </div>
    <% end %>

    <% if current_user.is_admin? %>
    <div class="two-col">
      <div class="card">
        <h2>Ajouter un Paiement</h2>
        
        <% if @client.balance_due > 0 %>
          <div style="background: #fff3cd; padding: 12px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
            <div style="font-weight: 600; color: #856404; margin-bottom: 5px;"><i class="fa-icon fa-md fa-wallet"></i> Solde √† Payer</div>
            <div style="font-size: 24px; font-weight: 700; color: #856404;">
              <%= number_to_currency(@client.balance_due, unit: "‚Ç¨", format: "%n %u") %>
            </div>
            <div style="font-size: 12px; color: #856404; margin-top: 5px;">
              Commission : <%= number_to_currency(@client.total_commission_due, unit: "‚Ç¨", format: "%n %u") %> | 
              Cr√©dits : -<%= number_to_currency(@client.total_credits, unit: "‚Ç¨", format: "%n %u") %>
            </div>
          </div>
        <% elsif @client.balance_due < 0 %>
          <div style="background: #d4edda; padding: 12px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #28a745;">
            <div style="font-weight: 600; color: #155724; margin-bottom: 5px;"><i class="fa-icon fa-md fa-university"></i> Solde Cr√©diteur</div>
            <div style="font-size: 24px; font-weight: 700; color: #155724;">
              <%= number_to_currency(@client.balance_due.abs, unit: "‚Ç¨", format: "%n %u") %>
            </div>
            <div style="font-size: 12px; color: #155724; margin-top: 5px;">
              Le client a un cr√©dit qui sera appliqu√© aux futures commissions
            </div>
          </div>
        <% else %>
          <div style="background: #d4edda; padding: 12px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #28a745;">
            <div style="font-weight: 600; color: #155724; margin-bottom: 5px;"><i class="fa-icon fa-md fa-check-circle"></i> Enti√®rement Pay√©</div>
            <div style="font-size: 18px; color: #155724;">
              Aucun solde restant
            </div>
          </div>
        <% end %>

        <% if @mt5_accounts.any? %>
          <div style="background: #e3f2fd; padding: 12px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #2196F3;">
            <div style="font-weight: 600; color: #1976D2; margin-bottom: 5px;"><i class="fa-icon fa-md fa-chart-bar"></i> Watermarks par Compte</div>
            <% @mt5_accounts.each do |account| %>
              <div style="font-size: 13px; color: #1976D2; margin-top: 3px;">
                ‚Ä¢ <%= account.account_name %> (<%= account.mt5_id %>) : WM = <%= number_to_currency(account.high_watermark, unit: "‚Ç¨", format: "%n %u") %>
              </div>
            <% end %>
          </div>
        <% end %>

        <%= form_with model: [:admin, Payment.new], method: :post do |f| %>
          <%= f.hidden_field :user_id, value: @client.id %>
          
          <div class="form-group">
            <%= f.label :amount, "Montant (‚Ç¨)" %>
            <%= f.number_field :amount, step: 0.01, min: 0, required: true, value: @client.balance_due > 0 ? @client.balance_due : nil, placeholder: "Entrer le montant" %>
            <div class="help-text">Pr√©-rempli avec le solde actuel d√ª</div>
          </div>

          <div class="form-group">
            <%= f.label :payment_method, "M√©thode de Paiement" %>
            <%= f.select :payment_method, 
                options_for_select([
                  ['Virement Bancaire', 'bank_transfer'],
                  ['Esp√®ces', 'cash'],
                  ['PayPal', 'paypal'],
                  ['Carte de Cr√©dit', 'credit_card'],
                  ['Ch√®que', 'check'],
                  ['Autre', 'other']
                ]), 
                { prompt: 'S√©lectionner la m√©thode' },
                { style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" } 
            %>
          </div>

          <div class="form-group">
            <%= f.label :payment_date, "Date de Paiement" %>
            <%= f.date_field :payment_date, value: Date.today, required: true %>
          </div>

          <div class="form-group">
            <%= f.label :reference, "R√©f√©rence / ID Transaction" %>
            <%= f.text_field :reference, placeholder: "ex. VIREMENT123456" %>
          </div>

          <div class="form-group">
            <%= f.label :notes, "Notes" %>
            <%= f.text_area :notes, placeholder: "Informations suppl√©mentaires..." %>
          </div>

          <%= submit_tag "Cr√©er le Paiement", class: "btn" do %>
            <i class="fa-icon fa-md fa-credit-card"></i> Cr√©er le Paiement
          <% end %>
        <% end %>
      </div>

      <div class="card">
        <h2>Ajouter un Cr√©dit</h2>
        <%= form_with model: [:admin, Credit.new], method: :post do |f| %>
          <%= f.hidden_field :user_id, value: @client.id %>
          
          <div class="form-group">
            <%= f.label :amount, "Montant (‚Ç¨)" %>
            <%= f.number_field :amount, step: 0.01, min: 0, required: true %>
          </div>

          <div class="form-group">
            <%= f.label :reason, "Raison" %>
            <%= f.text_area :reason %>
          </div>

          <%= f.submit "Cr√©er le Cr√©dit", class: "btn" do %>
            <span class="material-icons md-18" style="vertical-align: middle;">add_circle</span> Cr√©er le Cr√©dit
          <% end %>
        <% end %>
      </div>
    </div>
    <% end %>

    <% if current_user.is_admin? %>
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0;">Historique des Paiements</h2>
        <% if current_user.is_admin? %>
          <button onclick="toggleDeleteMode()" id="lockButton" class="btn" style="background: #666; padding: 8px 16px; font-size: 14px;">
            <i class="fa-icon fa-md fa-lock"></i> D√©verrouiller Mode Suppression
          </button>
        <% end %>
      </div>
      <div id="deleteModeWarning" style="display: none; background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; margin-bottom: 15px; border-radius: 4px;">
        <strong style="color: #856404;"><i class="fa-icon fa-md fa-exclamation-triangle"></i> Mode Suppression Actif</strong>
        <p style="color: #856404; margin: 5px 0 0 0; font-size: 13px;">Vous pouvez maintenant supprimer des paiements. Cliquez √† nouveau sur le verrou pour d√©sactiver ce mode.</p>
      </div>
      <% if @payments.any? %>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Montant</th>
              <th>M√©thode</th>
              <th>R√©f√©rence</th>
              <th>Watermarks √† Validation</th>
              <th>Statut</th>
              <th>Notes</th>
              <% if current_user.is_admin? %>
                <th>Actions</th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <% @payments.each do |payment| %>
              <tr>
                <td><%= payment.payment_date.strftime("%Y-%m-%d") %></td>
                <td><%= number_to_currency(payment.amount, unit: "‚Ç¨", format: "%n %u") %></td>
                <td><%= payment.payment_method_label %></td>
                <td><%= payment.reference %></td>
                <td>
                  <% if payment.status == "validated" && payment.watermark_data.any? %>
                    <% payment.watermark_data.each do |mt5_id, data| %>
                      <div style="font-size: 12px; margin-bottom: 3px;">
                        <strong><%= data["account_name"] %></strong> (<%= mt5_id %>)<br>
                        WM : <%= number_to_currency(data["watermark"], unit: "‚Ç¨", format: "%n %u") %> <i class='fa-icon fa-md fa-arrow-right'></i> <%= number_to_currency(data["balance"], unit: "‚Ç¨", format: "%n %u") %><br>
                        <span style="color: #4CAF50;">Commissionnable : <%= number_to_currency(data["commissionable"], unit: "‚Ç¨", format: "%n %u") %></span>
                      </div>
                    <% end %>
                  <% elsif payment.status == "validated" %>
                    <span style="color: #999; font-size: 12px;">Pas de donn√©es</span>
                  <% else %>
                    <span style="color: #999; font-size: 12px;">-</span>
                  <% end %>
                </td>
                <td>
                  <span class="status-badge status-<%= payment.status %>">
                    <%= payment.status.upcase %>
                  </span>
                </td>
                <td><%= payment.notes %></td>
                <% if current_user.is_admin? %>
                  <td>
                    <% if payment.status == "pending" %>
                      <%= button_to "Valider", admin_payment_path(payment, action_type: "validate"), method: :patch, class: "btn btn-validate" %>
                      <%= button_to "Rejeter", admin_payment_path(payment, action_type: "reject"), method: :patch, class: "btn btn-reject" %>
                    <% end %>
                    <%= button_to "Supprimer", admin_payment_path(payment), method: :delete, data: { turbo_confirm: "√ätes-vous s√ªr de vouloir supprimer ce paiement ? Cette action ne peut pas √™tre annul√©e." }, class: "btn btn-danger delete-btn", style: "display: none; padding: 6px 12px; font-size: 12px;" %>
                  </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
        
        <script>
          let deleteModeActive = false;
          
          function toggleDeleteMode() {
            deleteModeActive = !deleteModeActive;
            const lockButton = document.getElementById('lockButton');
            const warning = document.getElementById('deleteModeWarning');
            const deleteButtons = document.querySelectorAll('.delete-btn');
            
            if (deleteModeActive) {
              lockButton.innerHTML = '<span class="material-icons md-18" style="vertical-align: middle;">lock_open</span> Verrouiller Mode Suppression';
              lockButton.style.background = '#f44336';
              warning.style.display = 'block';
              deleteButtons.forEach(btn => btn.style.display = 'inline-block');
            } else {
              lockButton.innerHTML = '<i class="fa-icon fa-md fa-lock"></i> D√©verrouiller Mode Suppression';
              lockButton.style.background = '#666';
              warning.style.display = 'none';
              deleteButtons.forEach(btn => btn.style.display = 'none');
            }
          }
        </script>
        
        <script>
          function showAddWithdrawalModal() {
            window.location.href = '<%= new_admin_withdrawal_path %>';
          }
        </script>
      <% else %>
        <p style="color: #999;">Aucun paiement pour le moment</p>
      <% end %>
    </div>
    <% end %>

    <% if current_user.is_admin? %>
      <div class="card">
        <h2>Historique des Cr√©dits</h2>
        <% if @credits.any? %>
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Montant</th>
                <th>Raison</th>
                <% if current_user.is_admin? %>
                  <th>Actions</th>
                <% end %>
              </tr>
            </thead>
            <tbody>
              <% @credits.each do |credit| %>
                <tr>
                  <td><%= credit.created_at.strftime("%d/%m/%Y") %></td>
                  <td><%= number_to_currency(credit.amount, unit: "‚Ç¨", format: "%n %u") %></td>
                  <td><%= credit.reason %></td>
                  <% if current_user.is_admin? %>
                    <td>
                      <%= button_to "Supprimer", admin_credit_path(credit), method: :delete, data: { turbo_confirm: "√ätes-vous s√ªr ?" }, class: "btn btn-danger" %>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% else %>
          <p style="color: #999;">Aucun cr√©dit pour le moment</p>
        <% end %>
      </div>
    <% end %>
    </div>
  </div>
</body>
</html>


