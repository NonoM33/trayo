<!DOCTYPE html>
<html>
<head>
  <title>Client Details - Admin Trayo</title>
  <%= stylesheet_link_tag "admin" %>
  <style>
    .container { max-width: 1600px; }
    .alert { padding: 15px; margin-bottom: 20px; background: #f44336; color: white; border-radius: 4px; }
    .status-pending { color: #ff9800; font-weight: 600; }
    .status-validated { color: #4CAF50; font-weight: 600; }
    .status-rejected { color: #f44336; font-weight: 600; }
    .form-inline { display: inline; }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  </style>
</head>
<body>
  <% @page_title = "Client Details" %>
  
  <div class="app-layout">
    <%= render 'admin/shared/sidebar' %>
    
    <div class="main-content">
      <%= render 'admin/shared/navbar' %>
      
      <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <% if current_user.is_admin? %>
        <%= link_to "‚Üê Retour aux Clients", admin_clients_path, class: "back-link", style: "margin: 0;" %>
      <% else %>
        <h1 style="margin: 0;">Mon Profil</h1>
      <% end %>
      <%= link_to "‚úèÔ∏è Modifier #{current_user.is_admin? ? 'le Profil Utilisateur' : 'Mon Profil'}", edit_admin_client_path(@client), class: "btn btn-primary" %>
    </div>

    <% if flash[:notice] %>
      <div class="notice"><%= flash[:notice] %></div>
    <% end %>
    <% if flash[:alert] %>
      <div class="alert"><%= flash[:alert] %></div>
    <% end %>

    <div class="card">
      <h2><%= current_user.is_admin? ? "Client : #{@client.email}" : "Informations Personnelles" %></h2>
      
      <% if @client.mt5_api_token.present? %>
        <div style="background: #e3f2fd; padding: 15px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
          <div style="font-weight: 600; color: #1976D2; margin-bottom: 8px;">üîë Token API MT5</div>
          <div style="font-family: monospace; font-size: 14px; color: #333; word-break: break-all; background: white; padding: 10px; border-radius: 4px;">
            <%= @client.mt5_api_token %>
          </div>
          <div style="font-size: 12px; color: #666; margin-top: 8px;">
            ‚ÑπÔ∏è Ce token doit √™tre configur√© dans le script MT5 (TrayoSync.mq5) pour la synchronisation du compte
          </div>
        </div>
      <% end %>
      
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">Taux de Commission</div>
          <div class="info-value"><%= number_to_percentage(@client.commission_rate, precision: 1) %></div>
        </div>
        <div class="info-item">
          <div class="info-label">Gains Totaux</div>
          <div class="info-value positive"><%= number_to_currency(@client.total_profits, unit: "‚Ç¨", format: "%n %u") %></div>
        </div>
        <div class="info-item">
          <div class="info-label">Gains Commissionnables</div>
          <div class="info-value positive"><%= number_to_currency(@client.total_commissionable_gains, unit: "‚Ç¨", format: "%n %u") %></div>
        </div>
        <div class="info-item">
          <div class="info-label">Commission Due</div>
          <div class="info-value <%= @client.total_commission_due > 0 ? 'negative' : '' %>">
            <%= number_to_currency(@client.total_commission_due, unit: "‚Ç¨", format: "%n %u") %>
          </div>
        </div>
        <div class="info-item">
          <div class="info-label">Cr√©dits Appliqu√©s</div>
          <div class="info-value positive"><%= number_to_currency(@client.total_credits, unit: "‚Ç¨", format: "%n %u") %></div>
        </div>
        <div class="info-item">
          <% if @client.balance_due > 0 %>
            <div class="info-label">Solde √† Payer</div>
            <div class="info-value negative">
              <%= number_to_currency(@client.balance_due, unit: "‚Ç¨", format: "%n %u") %>
            </div>
          <% elsif @client.balance_due < 0 %>
            <div class="info-label">Solde Cr√©diteur</div>
            <div class="info-value positive">
              <%= number_to_currency(@client.balance_due.abs, unit: "‚Ç¨", format: "%n %u") %>
            </div>
          <% else %>
            <div class="info-label">Solde √† Payer</div>
            <div class="info-value" style="color: #4CAF50;">
              0 ‚Ç¨ ‚úì
            </div>
          <% end %>
        </div>
        <div class="info-item">
          <div class="info-label">Historique Paiements</div>
          <div class="info-value" style="font-size: 16px; color: #666;">
            <%= number_to_currency(@client.total_validated_payments, unit: "‚Ç¨", format: "%n %u") %> pay√©s
          </div>
        </div>
      </div>

      <h3>Mettre √† Jour le Taux de Commission</h3>
      <%= form_with model: @client, url: admin_client_path(@client), method: :patch do |f| %>
        <div class="form-group">
          <%= f.label :commission_rate, "Taux de Commission (%)" %>
          <%= f.number_field :commission_rate, step: 0.01, min: 0, max: 100 %>
        </div>
        <%= f.submit "Mettre √† Jour", class: "btn" %>
      <% end %>
    </div>

    <div class="card">
      <h2>Comptes MT5</h2>
      <% if @mt5_accounts.any? %>
        <table>
          <thead>
            <tr>
              <th>ID MT5</th>
              <th>Nom du Compte</th>
              <th>Balance Initiale</th>
              <th>Balance Actuelle</th>
              <th>Gains Nets</th>
              <th>High Watermark</th>
              <th>Retraits</th>
              <th>WM Ajust√©</th>
              <th>Commissionnable</th>
              <% if current_user.is_admin? %>
                <th>Actions</th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <% @mt5_accounts.each do |account| %>
              <tr>
                <td><%= account.mt5_id %></td>
                <td><%= account.account_name %></td>
                <td><%= number_to_currency(account.initial_balance, unit: "‚Ç¨", format: "%n %u") %></td>
                <td><%= number_to_currency(account.balance, unit: "‚Ç¨", format: "%n %u") %></td>
                <td class="<%= account.net_gains > 0 ? 'positive' : 'negative' %>">
                  <%= number_to_currency(account.net_gains, unit: "‚Ç¨", format: "%n %u") %>
                </td>
                <td><%= number_to_currency(account.high_watermark, unit: "‚Ç¨", format: "%n %u") %></td>
                <td><%= number_to_currency(account.total_withdrawals, unit: "‚Ç¨", format: "%n %u") %></td>
                <td><%= number_to_currency(account.adjusted_watermark, unit: "‚Ç¨", format: "%n %u") %></td>
                <td class="positive"><%= number_to_currency(account.commissionable_gains, unit: "‚Ç¨", format: "%n %u") %></td>
                <% if current_user.is_admin? %>
                  <td>
                    <button onclick="document.getElementById('edit-account-<%= account.id %>').style.display='block'" class="btn-validate" style="font-size: 12px; padding: 6px 12px;">
                      Modifier
                    </button>
                  </td>
                <% end %>
              </tr>
              <% if current_user.is_admin? %>
              <tr id="edit-account-<%= account.id %>" style="display: none; background: #f9f9f9;">
                <td colspan="10" style="padding: 20px;">
                  <%= form_with model: account, url: admin_mt5_account_path(account), method: :patch do |f| %>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                      <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Balance Initiale (‚Ç¨)</label>
                        <%= f.number_field :initial_balance, step: 0.01, style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" %>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                          Capital de d√©part pour ce compte
                        </div>
                      </div>
                      <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">High Watermark (‚Ç¨)</label>
                        <%= f.number_field :high_watermark, step: 0.01, style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" %>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                          Actuel : <%= number_to_currency(account.high_watermark, unit: "‚Ç¨", format: "%n %u") %>
                        </div>
                      </div>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 4px; font-size: 13px; color: #1976D2;">
                      <strong>Calcul Actuel :</strong><br>
                      Gains Nets = Balance (<%= number_to_currency(account.balance, unit: "‚Ç¨", format: "%n %u") %>) - Initial (<%= number_to_currency(account.initial_balance, unit: "‚Ç¨", format: "%n %u") %>) = <%= number_to_currency(account.net_gains, unit: "‚Ç¨", format: "%n %u") %><br>
                      WM Ajust√© = High WM (<%= number_to_currency(account.high_watermark, unit: "‚Ç¨", format: "%n %u") %>) - Retraits (<%= number_to_currency(account.total_withdrawals, unit: "‚Ç¨", format: "%n %u") %>) = <%= number_to_currency(account.adjusted_watermark, unit: "‚Ç¨", format: "%n %u") %><br>
                      Commissionnable = Balance (<%= number_to_currency(account.balance, unit: "‚Ç¨", format: "%n %u") %>) - WM Ajust√© (<%= number_to_currency(account.adjusted_watermark, unit: "‚Ç¨", format: "%n %u") %>) = <%= number_to_currency(account.commissionable_gains, unit: "‚Ç¨", format: "%n %u") %>
                    </div>
                    <div style="margin-top: 15px;">
                      <%= f.submit "Mettre √† Jour", class: "btn", style: "padding: 10px 20px;" %>
                      <button type="button" onclick="document.getElementById('edit-account-<%= account.id %>').style.display='none'" class="btn" style="background: #999; padding: 10px 20px;">
                        Annuler
                      </button>
                    </div>
                  <% end %>
                </td>
              </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p style="color: #999;">Aucun compte MT5 pour le moment</p>
      <% end %>
    </div>

    <% if current_user.is_admin? %>
    <div class="two-col">
      <div class="card">
        <h2>Ajouter un Paiement</h2>
        
        <% if @client.balance_due > 0 %>
          <div style="background: #fff3cd; padding: 12px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
            <div style="font-weight: 600; color: #856404; margin-bottom: 5px;">üí∞ Solde √† Payer</div>
            <div style="font-size: 24px; font-weight: 700; color: #856404;">
              <%= number_to_currency(@client.balance_due, unit: "‚Ç¨", format: "%n %u") %>
            </div>
            <div style="font-size: 12px; color: #856404; margin-top: 5px;">
              Commission : <%= number_to_currency(@client.total_commission_due, unit: "‚Ç¨", format: "%n %u") %> | 
              Cr√©dits : -<%= number_to_currency(@client.total_credits, unit: "‚Ç¨", format: "%n %u") %>
            </div>
          </div>
        <% elsif @client.balance_due < 0 %>
          <div style="background: #d4edda; padding: 12px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #28a745;">
            <div style="font-weight: 600; color: #155724; margin-bottom: 5px;">üíö Solde Cr√©diteur</div>
            <div style="font-size: 24px; font-weight: 700; color: #155724;">
              <%= number_to_currency(@client.balance_due.abs, unit: "‚Ç¨", format: "%n %u") %>
            </div>
            <div style="font-size: 12px; color: #155724; margin-top: 5px;">
              Le client a un cr√©dit qui sera appliqu√© aux futures commissions
            </div>
          </div>
        <% else %>
          <div style="background: #d4edda; padding: 12px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #28a745;">
            <div style="font-weight: 600; color: #155724; margin-bottom: 5px;">‚úì Enti√®rement Pay√©</div>
            <div style="font-size: 18px; color: #155724;">
              Aucun solde restant
            </div>
          </div>
        <% end %>

        <% if @mt5_accounts.any? %>
          <div style="background: #e3f2fd; padding: 12px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #2196F3;">
            <div style="font-weight: 600; color: #1976D2; margin-bottom: 5px;">üìä Watermarks par Compte</div>
            <% @mt5_accounts.each do |account| %>
              <div style="font-size: 13px; color: #1976D2; margin-top: 3px;">
                ‚Ä¢ <%= account.account_name %> (<%= account.mt5_id %>) : WM = <%= number_to_currency(account.high_watermark, unit: "‚Ç¨", format: "%n %u") %>
              </div>
            <% end %>
          </div>
        <% end %>

        <%= form_with model: [:admin, Payment.new], method: :post do |f| %>
          <%= f.hidden_field :user_id, value: @client.id %>
          
          <div class="form-group">
            <%= f.label :amount, "Montant (‚Ç¨)" %>
            <%= f.number_field :amount, step: 0.01, min: 0, required: true, value: @client.balance_due > 0 ? @client.balance_due : nil, placeholder: "Entrer le montant" %>
            <div class="help-text">Pr√©-rempli avec le solde actuel d√ª</div>
          </div>

          <div class="form-group">
            <%= f.label :payment_method, "M√©thode de Paiement" %>
            <%= f.select :payment_method, 
                options_for_select([
                  ['Virement Bancaire', 'bank_transfer'],
                  ['Esp√®ces', 'cash'],
                  ['PayPal', 'paypal'],
                  ['Carte de Cr√©dit', 'credit_card'],
                  ['Ch√®que', 'check'],
                  ['Autre', 'other']
                ]), 
                { prompt: 'S√©lectionner la m√©thode' },
                { style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" } 
            %>
          </div>

          <div class="form-group">
            <%= f.label :payment_date, "Date de Paiement" %>
            <%= f.date_field :payment_date, value: Date.today, required: true %>
          </div>

          <div class="form-group">
            <%= f.label :reference, "R√©f√©rence / ID Transaction" %>
            <%= f.text_field :reference, placeholder: "ex. VIREMENT123456" %>
          </div>

          <div class="form-group">
            <%= f.label :notes, "Notes" %>
            <%= f.text_area :notes, placeholder: "Informations suppl√©mentaires..." %>
          </div>

          <%= f.submit "Cr√©er le Paiement", class: "btn" %>
        <% end %>
      </div>

      <div class="card">
        <h2>Ajouter un Cr√©dit</h2>
        <%= form_with model: [:admin, Credit.new], method: :post do |f| %>
          <%= f.hidden_field :user_id, value: @client.id %>
          
          <div class="form-group">
            <%= f.label :amount, "Montant (‚Ç¨)" %>
            <%= f.number_field :amount, step: 0.01, min: 0, required: true %>
          </div>

          <div class="form-group">
            <%= f.label :reason, "Raison" %>
            <%= f.text_area :reason %>
          </div>

          <%= f.submit "Cr√©er le Cr√©dit", class: "btn" %>
        <% end %>
      </div>
    </div>
    <% end %>

    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">Historique des Paiements</h2>
        <% if current_user.is_admin? %>
          <button onclick="toggleDeleteMode()" id="lockButton" class="btn" style="background: #666; padding: 8px 16px; font-size: 14px;">
            üîí D√©verrouiller Mode Suppression
          </button>
        <% end %>
      </div>
      <div id="deleteModeWarning" style="display: none; background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; margin-bottom: 15px; border-radius: 4px;">
        <strong style="color: #856404;">‚ö†Ô∏è Mode Suppression Actif</strong>
        <p style="color: #856404; margin: 5px 0 0 0; font-size: 13px;">Vous pouvez maintenant supprimer des paiements. Cliquez √† nouveau sur le verrou pour d√©sactiver ce mode.</p>
      </div>
      <% if @payments.any? %>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Montant</th>
              <th>M√©thode</th>
              <th>R√©f√©rence</th>
              <th>Watermarks √† Validation</th>
              <th>Statut</th>
              <th>Notes</th>
              <% if current_user.is_admin? %>
                <th>Actions</th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <% @payments.each do |payment| %>
              <tr>
                <td><%= payment.payment_date.strftime("%Y-%m-%d") %></td>
                <td><%= number_to_currency(payment.amount, unit: "‚Ç¨", format: "%n %u") %></td>
                <td><%= payment.payment_method_label %></td>
                <td><%= payment.reference %></td>
                <td>
                  <% if payment.status == "validated" && payment.watermark_data.any? %>
                    <% payment.watermark_data.each do |mt5_id, data| %>
                      <div style="font-size: 12px; margin-bottom: 3px;">
                        <strong><%= data["account_name"] %></strong> (<%= mt5_id %>)<br>
                        WM : <%= number_to_currency(data["watermark"], unit: "‚Ç¨", format: "%n %u") %> ‚Üí <%= number_to_currency(data["balance"], unit: "‚Ç¨", format: "%n %u") %><br>
                        <span style="color: #4CAF50;">Commissionnable : <%= number_to_currency(data["commissionable"], unit: "‚Ç¨", format: "%n %u") %></span>
                      </div>
                    <% end %>
                  <% elsif payment.status == "validated" %>
                    <span style="color: #999; font-size: 12px;">Pas de donn√©es</span>
                  <% else %>
                    <span style="color: #999; font-size: 12px;">-</span>
                  <% end %>
                </td>
                <td class="status-<%= payment.status %>"><%= payment.status.upcase %></td>
                <td><%= payment.notes %></td>
                <% if current_user.is_admin? %>
                  <td>
                    <% if payment.status == "pending" %>
                      <%= button_to "Valider", admin_payment_path(payment, action_type: "validate"), method: :patch, class: "btn btn-validate" %>
                      <%= button_to "Rejeter", admin_payment_path(payment, action_type: "reject"), method: :patch, class: "btn btn-reject" %>
                    <% end %>
                    <%= button_to "Supprimer", admin_payment_path(payment), method: :delete, data: { turbo_confirm: "√ätes-vous s√ªr de vouloir supprimer ce paiement ? Cette action ne peut pas √™tre annul√©e." }, class: "btn btn-danger delete-btn", style: "display: none; padding: 6px 12px; font-size: 12px;" %>
                  </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
        
        <script>
          let deleteModeActive = false;
          
          function toggleDeleteMode() {
            deleteModeActive = !deleteModeActive;
            const lockButton = document.getElementById('lockButton');
            const warning = document.getElementById('deleteModeWarning');
            const deleteButtons = document.querySelectorAll('.delete-btn');
            
            if (deleteModeActive) {
              lockButton.innerHTML = 'üîì Verrouiller Mode Suppression';
              lockButton.style.background = '#f44336';
              warning.style.display = 'block';
              deleteButtons.forEach(btn => btn.style.display = 'inline-block');
            } else {
              lockButton.innerHTML = 'üîí D√©verrouiller Mode Suppression';
              lockButton.style.background = '#666';
              warning.style.display = 'none';
              deleteButtons.forEach(btn => btn.style.display = 'none');
            }
          }
        </script>
      <% else %>
        <p style="color: #999;">Aucun paiement pour le moment</p>
      <% end %>
    </div>

    <div class="card">
      <h2>Historique des Cr√©dits</h2>
      <% if @credits.any? %>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Montant</th>
              <th>Raison</th>
              <% if current_user.is_admin? %>
                <th>Actions</th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <% @credits.each do |credit| %>
              <tr>
                <td><%= credit.created_at.strftime("%d/%m/%Y") %></td>
                <td><%= number_to_currency(credit.amount, unit: "‚Ç¨", format: "%n %u") %></td>
                <td><%= credit.reason %></td>
                <% if current_user.is_admin? %>
                  <td>
                    <%= button_to "Supprimer", admin_credit_path(credit), method: :delete, data: { turbo_confirm: "√ätes-vous s√ªr ?" }, class: "btn btn-danger" %>
                  </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p style="color: #999;">Aucun cr√©dit pour le moment</p>
      <% end %>
      </div>
    </div>
  </div>
</body>
</html>


