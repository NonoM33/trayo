<% content_for :title, "Client - #{@client.full_name}" %>

<!-- Conteneur pour les messages flash Turbo -->
<div id="flash_messages"></div>

<div class="space-y-6">
  <!-- Banni√®re Impay√© Commission -->
  <% if @client.commission_payment_failed? || @client.bots_suspended_for_payment? %>
    <div class="rounded-xl bg-gradient-to-r from-red-900/80 to-red-800/60 border border-red-500/50 p-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center">
          <i class="fa-solid fa-exclamation-triangle text-red-400 text-xl"></i>
        </div>
        <div>
          <h3 class="font-semibold text-white">Paiement Commission √âchou√©</h3>
          <p class="text-red-200 text-sm">
            Montant d√ª: <strong><%= number_to_currency(@client.commission_balance_due, unit: "‚Ç¨", format: "%n%u") %></strong>
            <% if @client.bots_suspended_for_payment? %>
              ‚Äî <span class="text-red-300">Bots suspendus</span>
            <% end %>
            <% hours = (Time.current - (@client.commission_payment_failed_at || Time.current)).to_i / 3600 %>
            <% if hours >= 48 %>
              ‚Äî <span class="text-red-300">+120‚Ç¨ frais de remise en route</span>
            <% end %>
          </p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <% pending_invoice = @client.commission_invoices.unpaid.first %>
        <% if pending_invoice %>
          <%= link_to admin_invoice_path(pending_invoice.invoice), class: "px-4 py-2 rounded-lg bg-white text-red-600 font-semibold hover:bg-red-50 transition-colors" do %>
            <i class="fa-solid fa-credit-card mr-2"></i>R√©gler maintenant
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div class="flex items-center gap-4">
      <div class="flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-500 to-purple-600 text-white text-2xl font-bold">
        <%= @client.first_name&.first&.upcase %><%= @client.last_name&.first&.upcase %>
      </div>
      <div>
        <h1 class="text-2xl font-bold text-white"><%= @client.full_name %></h1>
        <p class="text-neutral-400"><%= @client.email %></p>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <%= link_to admin_clients_path, class: "inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-neutral-700 text-neutral-300 hover:bg-neutral-800 transition-colors" do %>
        <i class="fa-solid fa-arrow-left"></i>
        Retour
      <% end %>
      
      <!-- Bouton SMS -->
      <div data-controller="slideover">
        <button type="button"
                data-action="slideover#show:prevent"
                <%= 'disabled' if @client.phone.blank? %>
                class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
          <i class="fa-solid fa-comment-sms"></i>
          SMS
        </button>

        <!-- Slideover SMS Complet -->
        <dialog data-slideover-target="dialog" data-action="mousedown->slideover#backdropClose" class="slideover slideover-right fixed inset-0 m-0 ml-auto h-dvh max-h-full border-l border-white/10 outline-hidden">
          <div class="inset-y-0 flex h-dvh w-full flex-col bg-gradient-to-b from-neutral-900 via-neutral-900 to-neutral-950 shadow-2xl outline-hidden sm:w-[440px] lg:w-[480px] text-neutral-100">
            
            <!-- Header avec d√©grad√© -->
            <div class="relative overflow-hidden flex-shrink-0">
              <div class="absolute inset-0 bg-gradient-to-r from-emerald-600/20 via-teal-600/10 to-transparent"></div>
              <button type="button" data-action="slideover#hide:prevent" class="absolute top-4 right-4 z-10 w-8 h-8 rounded-full bg-white/10 backdrop-blur flex items-center justify-center text-white/70 hover:text-white hover:bg-white/20 transition-all">
                <i class="fa-solid fa-xmark"></i>
              </button>
              
              <div class="relative p-6 pb-5">
                <div class="flex items-center gap-4">
                  <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-emerald-400 to-teal-500 flex items-center justify-center shadow-lg shadow-emerald-500/25">
                    <i class="fa-solid fa-paper-plane text-white text-xl"></i>
                  </div>
                  <div>
                    <h4 class="text-xl font-bold text-white">Centre SMS</h4>
                    <div class="flex items-center gap-2 mt-1">
                      <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
                      <span class="text-sm text-emerald-400 font-medium"><%= @client.phone %></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="flex-1 overflow-y-auto">
              <!-- Destinataire -->
              <div class="px-6 py-3 bg-neutral-800/30 border-y border-white/5">
                <div class="flex items-center gap-3">
                  <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-xs">
                    <%= @client.first_name&.first&.upcase %><%= @client.last_name&.first&.upcase %>
                  </div>
                  <div>
                    <div class="font-medium text-white text-sm"><%= @client.full_name %></div>
                    <div class="text-xs text-neutral-400"><%= @client.email %></div>
                  </div>
                </div>
              </div>

              <div class="p-5 space-y-5">
                <!-- Templates rapides -->
                <div>
                  <div class="flex items-center justify-between mb-3">
                    <h5 class="text-sm font-semibold text-white flex items-center gap-2">
                      <i class="fa-solid fa-bolt text-amber-400"></i>
                      Templates
                    </h5>
                    <span class="text-xs text-neutral-500">Cliquer pour pr√©-remplir</span>
                  </div>
                  
                  <div class="grid grid-cols-2 gap-2">
                    <button type="button" onclick="fillTemplate('commission')" class="p-3 rounded-xl bg-gradient-to-br from-amber-500/10 to-amber-600/5 border border-amber-500/20 hover:border-amber-400/50 transition-all text-left group">
                      <div class="w-9 h-9 rounded-lg bg-amber-500/20 flex items-center justify-center mb-2">
                        <i class="fa-solid fa-coins text-amber-400"></i>
                      </div>
                      <div class="text-sm font-medium text-white group-hover:text-amber-300">Commission</div>
                      <div class="text-xs text-neutral-500">Relance paiement</div>
                    </button>
                    
                    <button type="button" onclick="fillTemplate('paiement')" class="p-3 rounded-xl bg-gradient-to-br from-red-500/10 to-red-600/5 border border-red-500/20 hover:border-red-400/50 transition-all text-left group">
                      <div class="w-9 h-9 rounded-lg bg-red-500/20 flex items-center justify-center mb-2">
                        <i class="fa-solid fa-credit-card text-red-400"></i>
                      </div>
                      <div class="text-sm font-medium text-white group-hover:text-red-300">Paiement</div>
                      <div class="text-xs text-neutral-500">Rappel facture</div>
                    </button>
                    
                    <button type="button" onclick="fillTemplate('performance')" class="p-3 rounded-xl bg-gradient-to-br from-emerald-500/10 to-emerald-600/5 border border-emerald-500/20 hover:border-emerald-400/50 transition-all text-left group">
                      <div class="w-9 h-9 rounded-lg bg-emerald-500/20 flex items-center justify-center mb-2">
                        <i class="fa-solid fa-chart-line text-emerald-400"></i>
                      </div>
                      <div class="text-sm font-medium text-white group-hover:text-emerald-300">Performance</div>
                      <div class="text-xs text-neutral-500">Mise √† jour</div>
                    </button>
                    
                    <button type="button" onclick="fillTemplate('bienvenue')" class="p-3 rounded-xl bg-gradient-to-br from-purple-500/10 to-purple-600/5 border border-purple-500/20 hover:border-purple-400/50 transition-all text-left group">
                      <div class="w-9 h-9 rounded-lg bg-purple-500/20 flex items-center justify-center mb-2">
                        <i class="fa-solid fa-sparkles text-purple-400"></i>
                      </div>
                      <div class="text-sm font-medium text-white group-hover:text-purple-300">Bienvenue</div>
                      <div class="text-xs text-neutral-500">Accueil</div>
                    </button>
                  </div>
                </div>

                <!-- Formulaire SMS -->
                <%= form_with url: send_sms_admin_client_path(@client), method: :post, local: true, id: "sms-form", class: "space-y-4" do %>
                  <input type="hidden" name="sms_type" id="sms-type" value="personnalise">
                  
                  <div>
                    <label class="text-sm font-medium text-neutral-300 mb-2 block">Message</label>
                    <div class="relative">
                      <textarea name="message" id="sms-message" rows="4" class="w-full px-4 py-3 rounded-xl bg-neutral-800/50 border border-neutral-700/50 text-white placeholder-neutral-500 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 focus:bg-neutral-800 transition-all resize-none text-sm" placeholder="TRAYO: Bonjour <%= @client.first_name %>..."></textarea>
                      <div class="absolute bottom-2 right-3 text-xs text-neutral-500">
                        <span id="char-count">0</span>/160
                      </div>
                    </div>
                    <div class="flex items-center gap-1 mt-2">
                      <span class="text-xs text-neutral-500">Variables:</span>
                      <button type="button" onclick="insertVar('{prenom}')" class="px-1.5 py-0.5 rounded bg-neutral-800 text-xs text-neutral-400 hover:text-emerald-400 hover:bg-neutral-700 transition-colors">{prenom}</button>
                      <button type="button" onclick="insertVar('{solde}')" class="px-1.5 py-0.5 rounded bg-neutral-800 text-xs text-neutral-400 hover:text-emerald-400 hover:bg-neutral-700 transition-colors">{solde}</button>
                      <button type="button" onclick="insertVar('{commission}')" class="px-1.5 py-0.5 rounded bg-neutral-800 text-xs text-neutral-400 hover:text-emerald-400 hover:bg-neutral-700 transition-colors">{commission}</button>
                    </div>
                  </div>

                  <!-- Programmation -->
                  <div class="p-3 rounded-xl bg-neutral-800/30 border border-neutral-700/30">
                    <label class="flex items-center gap-3 cursor-pointer">
                      <input type="checkbox" id="schedule-toggle" name="schedule" class="w-4 h-4 rounded bg-neutral-700 border-neutral-600 text-emerald-500 focus:ring-emerald-500">
                      <div>
                        <span class="text-sm text-white">Programmer l'envoi</span>
                        <p class="text-xs text-neutral-500">Envoyer √† une date/heure pr√©cise</p>
                      </div>
                    </label>
                    <div id="schedule-options" class="hidden mt-3 pt-3 border-t border-neutral-700/50">
                      <input type="datetime-local" name="scheduled_at" class="w-full px-3 py-2 rounded-lg bg-neutral-800 border border-neutral-700 text-white text-sm focus:border-emerald-500">
                    </div>
                  </div>

                  <!-- Actions -->
                  <div class="flex items-center gap-2">
                    <button type="submit" class="flex-1 py-2.5 rounded-xl bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-medium hover:from-emerald-600 hover:to-emerald-700 transition-all shadow-lg shadow-emerald-500/20 flex items-center justify-center gap-2">
                      <i class="fa-solid fa-paper-plane"></i>
                      <span id="send-btn-text">Envoyer maintenant</span>
                    </button>
                  </div>
                <% end %>

                <!-- Historique -->
                <% recent_sms = SmsCampaignLog.where(user: @client).order(sent_at: :desc).limit(5) %>
                <% scheduled_sms = ScheduledSms.where(user: @client, status: 'pending').order(scheduled_at: :asc) rescue [] %>
                
                <div>
                  <div class="flex items-center justify-between mb-3">
                    <h5 class="text-sm font-semibold text-white flex items-center gap-2">
                      <i class="fa-solid fa-clock-rotate-left text-neutral-400"></i>
                      Historique
                    </h5>
                    <%= link_to admin_client_path(@client, tab: 'sms'), class: "text-xs text-emerald-400 hover:text-emerald-300" do %>
                      Voir tout ‚Üí
                    <% end %>
                  </div>
                  
                  <% has_scheduled = (scheduled_sms.any? rescue false) %>
                  <% if has_scheduled %>
                    <div class="mb-3">
                      <div class="text-xs text-amber-400 font-medium mb-2 flex items-center gap-1">
                        <i class="fa-solid fa-clock"></i> Programm√©s
                      </div>
                      <% scheduled_sms.each do |sms| %>
                        <div class="p-2 rounded-lg bg-amber-500/10 border border-amber-500/20 flex items-center gap-2 mb-1">
                          <i class="fa-solid fa-clock text-amber-400 text-xs"></i>
                          <span class="text-xs text-neutral-300 flex-1 truncate"><%= sms.message.to_s.truncate(40) %></span>
                          <span class="text-xs text-amber-400"><%= sms.scheduled_at&.strftime("%d/%m %H:%M") %></span>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                  
                  <div class="space-y-1.5">
                    <% recent_sms.each do |sms| %>
                      <div class="p-2 rounded-lg bg-neutral-800/30 border border-neutral-800/50 flex items-center gap-2">
                        <div class="w-6 h-6 rounded flex items-center justify-center flex-shrink-0 <%= sms.status == 'sent' ? 'bg-emerald-500/20' : 'bg-red-500/20' %>">
                          <i class="fa-solid <%= sms.status == 'sent' ? 'fa-check text-emerald-400' : 'fa-xmark text-red-400' %> text-xs"></i>
                        </div>
                        <span class="text-xs text-neutral-300 flex-1 truncate"><%= sms.message.to_s.truncate(35) %></span>
                        <span class="text-xs text-neutral-500"><%= sms.sent_at&.strftime("%d/%m") %></span>
                      </div>
                    <% end %>
                    <% if recent_sms.empty? %>
                      <div class="text-center py-4 text-neutral-500 text-xs">
                        Aucun SMS envoy√©
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </dialog>
        
        <script>
          const templates = {
            commission: "TRAYO: Bonjour <%= @client.first_name %>, votre commission de <%= number_to_currency(@performance[:pending_commission], unit: '‚Ç¨', format: '%n%u') %> est en attente de r√®glement. Merci de r√©gulariser votre situation.",
            paiement: "TRAYO: Bonjour <%= @client.first_name %>, un paiement est en attente sur votre compte. R√©glez-le rapidement pour √©viter toute interruption de service.",
            performance: "TRAYO: Bonjour <%= @client.first_name %>! üìà Mise √† jour: Solde actuel <%= number_to_currency(@performance[:total_balance], unit: '‚Ç¨', format: '%n%u') %>. Continuez comme √ßa!",
            bienvenue: "TRAYO: Bienvenue <%= @client.first_name %>! üéâ Votre compte est pr√™t. Vos bots de trading sont configur√©s. Bon trading!"
          };

          function fillTemplate(type) {
            const ta = document.getElementById('sms-message');
            const typeInput = document.getElementById('sms-type');
            if (ta && templates[type]) {
              ta.value = templates[type];
              typeInput.value = type;
              updateCharCount();
              ta.focus();
            }
          }

          function insertVar(v) {
            const ta = document.getElementById('sms-message');
            if (ta) {
              const start = ta.selectionStart;
              const end = ta.selectionEnd;
              ta.value = ta.value.substring(0, start) + v + ta.value.substring(end);
              ta.focus();
              ta.selectionStart = ta.selectionEnd = start + v.length;
              updateCharCount();
            }
          }

          function updateCharCount() {
            const ta = document.getElementById('sms-message');
            const counter = document.getElementById('char-count');
            if (ta && counter) {
              counter.textContent = ta.value.length;
              counter.className = ta.value.length > 160 ? 'text-amber-400' : '';
            }
          }

          document.addEventListener('DOMContentLoaded', function() {
            const ta = document.getElementById('sms-message');
            if (ta) {
              ta.addEventListener('input', updateCharCount);
            }

            const scheduleToggle = document.getElementById('schedule-toggle');
            const scheduleOptions = document.getElementById('schedule-options');
            const sendBtnText = document.getElementById('send-btn-text');
            
            if (scheduleToggle) {
              scheduleToggle.addEventListener('change', function() {
                scheduleOptions.classList.toggle('hidden', !this.checked);
                sendBtnText.textContent = this.checked ? 'Programmer' : 'Envoyer maintenant';
              });
            }
          });
        </script>
      </div>

      <!-- Bouton Modifier -->
      <div data-controller="slideover">
        <button type="button"
                data-action="slideover#show:prevent"
                class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-white text-neutral-900 hover:bg-neutral-100 transition-colors">
          <i class="fa-solid fa-pen"></i>
          Modifier
        </button>

      <!-- Slideover pour modifier le client -->
      <dialog data-slideover-target="dialog" data-action="mousedown->slideover#backdropClose" class="slideover slideover-right fixed inset-0 m-0 ml-auto h-dvh max-h-full border-l border-white/10 outline-hidden">
        <div class="inset-y-0 flex h-dvh w-full flex-col bg-neutral-900 shadow-lg outline-hidden sm:w-96 lg:w-[480px] text-neutral-100 shadow-neutral-950">
          <button type="button" data-action="slideover#hide:prevent" class="absolute top-4 right-4 mt-1 rounded-full p-1.5 opacity-70 transition-opacity hover:cursor-pointer hover:bg-neutral-500/15 hover:opacity-100 focus:outline-hidden active:bg-neutral-500/25 md:top-5">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
              <line x1="18" x2="6" y1="6" y2="18"></line>
              <line x1="6" x2="18" y1="6" y2="18"></line>
            </svg>
          </button>

          <div class="flex items-center gap-3 border-b border-white/10 p-5 pr-12 md:p-6">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-lg font-bold">
              <%= @client.first_name&.first&.upcase %><%= @client.last_name&.first&.upcase %>
            </div>
            <div>
              <h4 class="font-semibold text-lg text-white">Modifier le client</h4>
              <p class="text-sm text-neutral-400"><%= @client.email %></p>
            </div>
          </div>

          <%= form_with url: admin_client_path(@client), method: :patch, local: true, class: "flex flex-col flex-1 overflow-hidden" do %>
            <div class="flex-1 overflow-y-auto p-5 md:p-6 space-y-5">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-neutral-300 mb-2">Pr√©nom</label>
                  <input type="text" name="user[first_name]" value="<%= @client.first_name %>" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white placeholder-neutral-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="Pr√©nom">
                </div>
                <div>
                  <label class="block text-sm font-medium text-neutral-300 mb-2">Nom</label>
                  <input type="text" name="user[last_name]" value="<%= @client.last_name %>" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white placeholder-neutral-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="Nom">
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-neutral-300 mb-2">Email</label>
                <input type="email" name="user[email]" value="<%= @client.email %>" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white placeholder-neutral-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="email@exemple.com">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-neutral-300 mb-2">T√©l√©phone</label>
                <input type="tel" name="user[phone]" value="<%= @client.phone %>" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white placeholder-neutral-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="+33 6 12 34 56 78">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-neutral-300 mb-2">Taux de commission (%)</label>
                <input type="number" step="0.1" min="0" max="100" name="user[commission_rate]" value="<%= @client.commission_rate %>" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white placeholder-neutral-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="25.0">
              </div>
              
              <div class="pt-4 border-t border-neutral-800">
                <label class="block text-sm font-medium text-neutral-300 mb-2">Nouveau mot de passe</label>
                <p class="text-xs text-neutral-500 mb-2">Laisser vide pour ne pas changer</p>
                <input type="password" name="user[password]" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white placeholder-neutral-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-neutral-300 mb-2">Confirmation</label>
                <input type="password" name="user[password_confirmation]" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white placeholder-neutral-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
              </div>

              <% if current_user.is_admin? %>
                <div class="pt-4 border-t border-neutral-800">
                  <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" name="user[is_admin]" value="1" <%= 'checked' if @client.is_admin? %> class="w-5 h-5 rounded border-neutral-600 bg-neutral-800 text-blue-500 focus:ring-blue-500 focus:ring-offset-0">
                    <span class="text-neutral-300">Administrateur</span>
                  </label>
                </div>
              <% end %>
            </div>

            <div class="flex items-center justify-end gap-3 border-t border-white/10 p-5 md:p-6">
              <button type="button" data-action="slideover#hide:prevent" class="px-4 py-2.5 rounded-lg border border-neutral-700 text-neutral-300 hover:bg-neutral-800 transition-colors font-medium">
                Annuler
              </button>
              <button type="submit" class="px-5 py-2.5 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors">
                <i class="fa-solid fa-check mr-2"></i>Enregistrer
              </button>
            </div>
          <% end %>
        </div>
      </dialog>
      </div>
    </div>
  </div>

  <!-- Stats Cards - Performance -->
  <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
    <div class="p-4 rounded-xl bg-neutral-900 border border-neutral-800">
      <div class="text-xs text-neutral-500 mb-1 uppercase tracking-wide">Solde Actuel</div>
      <div class="text-xl font-bold <%= @performance[:total_balance] >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
        <%= number_to_currency(@performance[:total_balance], unit: "‚Ç¨", format: "%n%u") %>
      </div>
    </div>
    
    <div class="p-4 rounded-xl bg-neutral-900 border border-neutral-800">
      <div class="text-xs text-neutral-500 mb-1 uppercase tracking-wide">Solde Initial</div>
      <div class="text-xl font-bold text-white">
        <%= number_to_currency(@performance[:initial_balance], unit: "‚Ç¨", format: "%n%u") %>
      </div>
    </div>
    
    <div class="p-4 rounded-xl bg-neutral-900 border border-neutral-800">
      <div class="text-xs text-neutral-500 mb-1 uppercase tracking-wide">High Watermark</div>
      <div class="text-xl font-bold text-cyan-400">
        <%= number_to_currency(@performance[:high_watermark], unit: "‚Ç¨", format: "%n%u") %>
      </div>
    </div>
    
    <div class="p-4 rounded-xl bg-neutral-900 border border-neutral-800">
      <div class="text-xs text-neutral-500 mb-1 uppercase tracking-wide">Profit Total</div>
      <div class="text-xl font-bold <%= @performance[:total_profit] >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
        <%= number_to_currency(@performance[:total_profit], unit: "‚Ç¨", format: "%n%u") %>
        <span class="text-xs font-normal text-neutral-500">(<%= @performance[:total_profit_percent] %>%)</span>
      </div>
    </div>
    
    <div class="p-4 rounded-xl bg-neutral-900 border border-neutral-800">
      <div class="text-xs text-neutral-500 mb-1 uppercase tracking-wide">Perf. Journali√®re</div>
      <div class="text-xl font-bold <%= @performance[:daily_average] >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
        <%= number_to_currency(@performance[:daily_average], unit: "‚Ç¨", format: "%n%u") %>/j
      </div>
      <div class="text-xs text-neutral-500"><%= @performance[:days_trading] %> jours</div>
    </div>
    
    <div class="p-4 rounded-xl bg-gradient-to-br from-blue-900/50 to-purple-900/30 border border-blue-700/50">
      <div class="text-xs text-blue-300 mb-1 uppercase tracking-wide">Commission Due</div>
      <div class="text-xl font-bold text-blue-400">
        <%= number_to_currency(@performance[:pending_commission], unit: "‚Ç¨", format: "%n%u") %>
      </div>
      <div class="text-xs text-neutral-400">Taux: <%= @performance[:commission_rate] %>%</div>
    </div>
  </div>

  <!-- Quick Stats Row -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <div class="p-4 rounded-xl bg-neutral-900 border border-neutral-800">
      <div class="text-sm text-neutral-400 mb-1">Bots Actifs</div>
      <div class="text-2xl font-bold text-white">
        <%= @client.bot_purchases.where(is_running: true).count %> / <%= @client.bot_purchases.count %>
      </div>
    </div>
    
    <div class="p-4 rounded-xl bg-neutral-900 border border-neutral-800">
      <div class="text-sm text-neutral-400 mb-1">Comptes MT5</div>
      <div class="text-2xl font-bold text-white">
        <%= @client.mt5_accounts.count %>
      </div>
    </div>
    
    <div class="p-4 rounded-xl bg-neutral-900 border border-neutral-800">
      <div class="text-sm text-neutral-400 mb-1">Trades Total</div>
      <div class="text-2xl font-bold text-white">
        <%= Trade.joins(:mt5_account).where(mt5_accounts: { user_id: @client.id }).count %>
      </div>
    </div>
    
    <% if @client.commission_balance_due.to_f > 0 %>
      <div class="p-4 rounded-xl bg-red-900/30 border border-red-700/50">
        <div class="text-sm text-red-300 mb-1">√Ä R√©gler</div>
        <div class="text-2xl font-bold text-red-400">
          <%= number_to_currency(@client.commission_balance_due, unit: "‚Ç¨", format: "%n%u") %>
        </div>
      </div>
    <% else %>
      <div class="p-4 rounded-xl bg-emerald-900/30 border border-emerald-700/50">
        <div class="text-sm text-emerald-300 mb-1">Statut Paiement</div>
        <div class="text-xl font-bold text-emerald-400">
          <i class="fa-solid fa-check-circle mr-1"></i> √Ä jour
        </div>
      </div>
    <% end %>
  </div>

  <!-- Tabs Navigation - Optimis√© -->
  <% unpaid_commissions = @client.commission_invoices.unpaid.count rescue 0 %>
  <% active_subs = @client.subscriptions.active.count rescue 0 %>
  <% pending_sms = ScheduledSms.where(user: @client, status: 'pending').count rescue 0 %>
  
  <div data-controller="tabs" data-tabs-default-value="overview">
    <div class="flex items-center gap-1 p-1.5 rounded-xl bg-neutral-900 border border-neutral-800">
      <button type="button" data-tabs-target="tab" data-action="click->tabs#select" data-tab="overview" class="px-4 py-2.5 rounded-lg text-sm font-medium whitespace-nowrap transition-colors">
        <i class="fa-solid fa-chart-pie mr-2"></i>Vue d'ensemble
      </button>
      <button type="button" data-tabs-target="tab" data-action="click->tabs#select" data-tab="trading" class="px-4 py-2.5 rounded-lg text-sm font-medium whitespace-nowrap transition-colors">
        <i class="fa-solid fa-chart-line mr-2"></i>Trading
      </button>
      <button type="button" data-tabs-target="tab" data-action="click->tabs#select" data-tab="finances" class="px-4 py-2.5 rounded-lg text-sm font-medium whitespace-nowrap transition-colors">
        <i class="fa-solid fa-coins mr-2"></i>Finances
        <% if unpaid_commissions > 0 || active_subs > 0 %>
          <span class="ml-1 px-1.5 py-0.5 text-xs rounded-full <%= unpaid_commissions > 0 ? 'bg-red-500/20 text-red-400' : 'bg-emerald-500/20 text-emerald-400' %>">
            <%= unpaid_commissions > 0 ? unpaid_commissions : active_subs %>
          </span>
        <% end %>
      </button>
      <button type="button" data-tabs-target="tab" data-action="click->tabs#select" data-tab="sms" class="px-4 py-2.5 rounded-lg text-sm font-medium whitespace-nowrap transition-colors">
        <i class="fa-solid fa-comment-sms mr-2"></i>SMS
        <% if pending_sms > 0 %>
          <span class="ml-1 px-1.5 py-0.5 text-xs rounded-full bg-amber-500/20 text-amber-400"><%= pending_sms %></span>
        <% end %>
      </button>
      <% if current_user.is_admin? %>
        <button type="button" data-tabs-target="tab" data-action="click->tabs#select" data-tab="admin" class="px-4 py-2.5 rounded-lg text-sm font-medium whitespace-nowrap transition-colors">
          <i class="fa-solid fa-shield mr-2"></i>Admin
        </button>
      <% end %>
    </div>

    <!-- Tab: Overview -->
    <div data-tabs-target="panel" data-tab="overview" class="mt-6 space-y-6">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Informations Client -->
        <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-6">
          <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <i class="fa-solid fa-user text-blue-400"></i>
            Informations
          </h3>
          <div class="space-y-3">
            <div class="flex justify-between py-2 border-b border-neutral-800">
              <span class="text-neutral-400">Email</span>
              <span class="text-white font-medium"><%= @client.email %></span>
            </div>
            <div class="flex justify-between py-2 border-b border-neutral-800">
              <span class="text-neutral-400">T√©l√©phone</span>
              <span class="text-white font-medium"><%= @client.phone || "‚Äî" %></span>
            </div>
            <div class="flex justify-between py-2 border-b border-neutral-800">
              <span class="text-neutral-400">Inscrit le</span>
              <span class="text-white font-medium"><%= @client.created_at.strftime("%d/%m/%Y") %></span>
            </div>
            <div class="flex justify-between py-2">
              <span class="text-neutral-400">Commission</span>
              <span class="text-blue-400 font-bold"><%= @client.commission_rate %>%</span>
            </div>
          </div>
        </div>

        <!-- R√©sum√© Financier ou Abonnement -->
        <% active_subscription = @client.subscriptions.active.first %>
        <% if active_subscription %>
          <!-- Abonnement Actif -->
          <div class="rounded-xl bg-gradient-to-br from-emerald-900/50 to-green-900/30 border border-emerald-700/50 p-6">
            <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
              <i class="fa-solid fa-repeat text-emerald-400"></i>
              Abonnement Actif
            </h3>
            <div class="flex items-center gap-4 mb-4">
              <div class="w-12 h-12 rounded-xl bg-emerald-500 flex items-center justify-center">
                <i class="fa-solid fa-crown text-white text-xl"></i>
              </div>
              <div>
                <div class="text-2xl font-bold text-white"><%= active_subscription.plan_name %></div>
                <div class="text-emerald-400"><%= number_to_currency(active_subscription.monthly_price, unit: "‚Ç¨", format: "%n%u") %>/mois</div>
              </div>
            </div>
            <div class="space-y-3">
              <div class="flex justify-between py-2 border-b border-emerald-800/50">
                <span class="text-neutral-400">Statut</span>
                <span class="px-2 py-1 rounded-full text-xs font-semibold bg-emerald-500/20 text-emerald-400">‚úì Actif</span>
              </div>
              <div class="flex justify-between py-2 border-b border-emerald-800/50">
                <span class="text-neutral-400">Prochain pr√©l√®vement</span>
                <span class="text-white font-medium"><%= active_subscription.current_period_end&.strftime("%d/%m/%Y") || "‚Äî" %></span>
              </div>
              <div class="flex justify-between py-2">
                <span class="text-neutral-400">Inclus</span>
                <span class="text-emerald-400 font-medium">Bots + VPS</span>
              </div>
            </div>
          </div>
        <% else %>
          <!-- R√©sum√© Financier (pas d'abonnement) -->
          <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-6">
            <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
              <i class="fa-solid fa-coins text-amber-400"></i>
              R√©sum√© Financier
            </h3>
            <% invoices = @client.invoices.order(created_at: :desc) %>
            <% total_invoiced = invoices.sum(:total_amount) %>
            <% total_due = invoices.sum(:balance_due) %>
            <% total_paid = total_invoiced - total_due %>
            <div class="space-y-3">
              <div class="flex justify-between py-2 border-b border-neutral-800">
                <span class="text-neutral-400">Total Factur√©</span>
                <span class="text-white font-medium"><%= number_to_currency(total_invoiced, unit: "‚Ç¨", format: "%n%u") %></span>
              </div>
              <div class="flex justify-between py-2 border-b border-neutral-800">
                <span class="text-neutral-400">Total Pay√©</span>
                <span class="text-emerald-400 font-medium"><%= number_to_currency(total_paid, unit: "‚Ç¨", format: "%n%u") %></span>
              </div>
              <div class="flex justify-between py-2">
                <span class="text-neutral-400">Reste √† Payer</span>
                <span class="<%= total_due > 0 ? 'text-red-400' : 'text-emerald-400' %> font-bold"><%= number_to_currency(total_due, unit: "‚Ç¨", format: "%n%u") %></span>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Derni√®res Factures -->
      <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-white flex items-center gap-2">
            <i class="fa-solid fa-file-invoice text-purple-400"></i>
            Derni√®res Factures
          </h3>
        </div>
        <% recent_invoices = @client.invoices.order(created_at: :desc).limit(5) %>
        <% if recent_invoices.any? %>
          <div class="space-y-3">
            <% recent_invoices.each do |invoice| %>
              <div class="flex items-center justify-between p-4 rounded-lg bg-neutral-800/50 hover:bg-neutral-800 transition-colors">
                <div class="flex items-center gap-4">
                  <div class="w-10 h-10 rounded-lg bg-neutral-700 flex items-center justify-center">
                    <i class="fa-solid fa-file-invoice text-neutral-400"></i>
                  </div>
                  <div>
                    <div class="font-medium text-white"><%= invoice.reference %></div>
                    <div class="text-sm text-neutral-400"><%= invoice.created_at.strftime("%d/%m/%Y") %></div>
                  </div>
                </div>
                <div class="flex items-center gap-4">
                  <div class="text-right">
                    <div class="font-bold text-white"><%= number_to_currency(invoice.total_amount, unit: "‚Ç¨", format: "%n%u") %></div>
                    <% if invoice.balance_due <= 0 %>
                      <span class="text-xs px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-400">Pay√©e</span>
                    <% elsif invoice.balance_due < invoice.total_amount %>
                      <span class="text-xs px-2 py-0.5 rounded-full bg-amber-500/20 text-amber-400">Partiel</span>
                    <% else %>
                      <span class="text-xs px-2 py-0.5 rounded-full bg-red-500/20 text-red-400">En attente</span>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="text-center py-8 text-neutral-500">
            <i class="fa-solid fa-file-invoice text-4xl mb-2"></i>
            <p>Aucune facture</p>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Tab: Trading (MT5 + Bots + Trades) -->
    <div data-tabs-target="panel" data-tab="trading" class="mt-6 hidden space-y-6">
      <!-- Sub-navigation -->
      <div class="flex items-center gap-2 pb-4 border-b border-neutral-800">
        <button type="button" onclick="showTradingSection('mt5')" id="trading-tab-mt5" class="trading-subtab px-4 py-2 rounded-lg text-sm font-medium bg-neutral-800 text-white border border-neutral-700">
          <i class="fa-solid fa-wallet mr-2"></i>Comptes MT5
        </button>
        <button type="button" onclick="showTradingSection('bots')" id="trading-tab-bots" class="trading-subtab px-4 py-2 rounded-lg text-sm font-medium text-neutral-400 hover:text-white hover:bg-neutral-800/50 transition-colors">
          <i class="fa-solid fa-robot mr-2"></i>Bots
        </button>
        <button type="button" onclick="showTradingSection('trades')" id="trading-tab-trades" class="trading-subtab px-4 py-2 rounded-lg text-sm font-medium text-neutral-400 hover:text-white hover:bg-neutral-800/50 transition-colors">
          <i class="fa-solid fa-chart-line mr-2"></i>Trades
        </button>
      </div>

      <!-- Section: MT5 -->
      <div id="trading-section-mt5" class="trading-section space-y-4">
      <% @client.mt5_accounts.each do |account| %>
        <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-6" data-controller="slideover">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center">
                <i class="fa-solid fa-wallet text-white text-xl"></i>
              </div>
              <div>
                <h3 class="font-semibold text-white"><%= account.account_name %></h3>
                <p class="text-sm text-neutral-400">ID: <%= account.mt5_id %> ‚Ä¢ <%= account.broker_name %></p>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <div class="text-right">
                <div class="text-2xl font-bold <%= account.balance >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
                  <%= number_to_currency(account.balance, unit: "‚Ç¨", format: "%n%u") %>
                </div>
                <div class="text-sm text-neutral-400">Solde</div>
              </div>
              <button type="button" 
                      data-action="slideover#show:prevent"
                      class="p-2 rounded-lg bg-neutral-800 hover:bg-neutral-700 text-neutral-400 hover:text-white transition-colors"
                      title="Modifier">
                <i class="fa-solid fa-pen"></i>
              </button>
            </div>
          </div>
          
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 pt-4 border-t border-neutral-800">
            <div>
              <div class="text-sm text-neutral-400">Balance Initiale</div>
              <div class="font-semibold text-white"><%= number_to_currency(account.initial_balance, unit: "‚Ç¨", format: "%n%u") %></div>
            </div>
            <div>
              <div class="text-sm text-neutral-400">High Watermark</div>
              <div class="font-semibold text-white"><%= number_to_currency(account.high_watermark, unit: "‚Ç¨", format: "%n%u") %></div>
            </div>
            <div>
              <div class="text-sm text-neutral-400">Serveur</div>
              <div class="font-semibold text-white"><%= account.broker_server %></div>
            </div>
            <div>
              <div class="text-sm text-neutral-400 mb-1">Mot de passe</div>
              <div class="flex items-center gap-2">
                <div class="relative flex-1" id="pw-container-<%= account.id %>">
                  <input type="password" 
                         value="<%= account.broker_password %>" 
                         id="pw-input-<%= account.id %>"
                         readonly
                         class="w-full font-mono text-sm text-white bg-neutral-800 px-3 py-1.5 rounded border border-neutral-700 pr-20">
                  <div class="absolute right-1 top-1/2 -translate-y-1/2 flex gap-1">
                    <button type="button" 
                            onclick="togglePassword(<%= account.id %>)"
                            class="p-1.5 rounded hover:bg-neutral-700 text-neutral-400 hover:text-white transition-colors"
                            title="Afficher/Masquer">
                      <i class="fa-solid fa-eye text-xs" id="pw-icon-<%= account.id %>"></i>
                    </button>
                    <button type="button" 
                            onclick="copyPassword(<%= account.id %>)"
                            id="pw-copy-<%= account.id %>"
                            class="p-1.5 rounded hover:bg-neutral-700 text-neutral-400 hover:text-emerald-400 transition-colors"
                            title="Copier">
                      <i class="fa-solid fa-copy text-xs"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Slideover pour modifier le compte MT5 -->
          <dialog data-slideover-target="dialog" data-action="mousedown->slideover#backdropClose" class="slideover slideover-right fixed inset-0 m-0 ml-auto h-dvh max-h-full border-l border-white/10 outline-hidden">
            <div class="inset-y-0 flex h-dvh w-full flex-col bg-neutral-900 shadow-lg outline-hidden sm:w-96 lg:w-[420px] text-neutral-100 shadow-neutral-950">
              <button type="button" data-action="slideover#hide:prevent" class="absolute top-4 right-4 mt-1 rounded-full p-1.5 opacity-70 transition-opacity hover:cursor-pointer hover:bg-neutral-500/15 hover:opacity-100 focus:outline-hidden active:bg-neutral-500/25 md:top-5">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                  <line x1="18" x2="6" y1="6" y2="18"></line>
                  <line x1="6" x2="18" y1="6" y2="18"></line>
                </svg>
              </button>

              <div class="flex items-center gap-3 border-b border-white/10 p-5 pr-12 md:p-6">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center">
                  <i class="fa-solid fa-wallet text-white"></i>
                </div>
                <div>
                  <h4 class="font-semibold text-lg text-white">Modifier le compte MT5</h4>
                  <p class="text-sm text-neutral-400"><%= account.mt5_id %></p>
                </div>
              </div>

              <%= form_with url: admin_mt5_account_path(account), method: :patch, local: true, class: "flex flex-col flex-1 overflow-hidden" do %>
                <div class="flex-1 overflow-y-auto p-5 md:p-6 space-y-5">
                  <div>
                    <label class="block text-sm font-medium text-neutral-300 mb-2">Nom du compte</label>
                    <input type="text" name="mt5_account[account_name]" value="<%= account.account_name %>" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white placeholder-neutral-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="Ex: Compte principal">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-neutral-300 mb-2">ID MT5</label>
                    <input type="text" name="mt5_account[mt5_id]" value="<%= account.mt5_id %>" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white placeholder-neutral-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="Ex: 123456">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-neutral-300 mb-2">Mot de passe Broker</label>
                    <input type="text" name="mt5_account[broker_password]" value="<%= account.broker_password %>" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white placeholder-neutral-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="Mot de passe">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-neutral-300 mb-2">Nom du Broker</label>
                    <input type="text" name="mt5_account[broker_name]" value="<%= account.broker_name %>" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white placeholder-neutral-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="Ex: Fusion Markets">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-neutral-300 mb-2">Serveur</label>
                    <input type="text" name="mt5_account[broker_server]" value="<%= account.broker_server %>" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white placeholder-neutral-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="Ex: FusionMarkets-Live">
                  </div>
                  
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-neutral-300 mb-2">Balance Initiale</label>
                      <input type="number" step="0.01" name="mt5_account[initial_balance]" value="<%= account.initial_balance %>" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white placeholder-neutral-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="0.00">
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-neutral-300 mb-2">High Watermark</label>
                      <input type="number" step="0.01" name="mt5_account[high_watermark]" value="<%= account.high_watermark %>" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white placeholder-neutral-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="0.00">
                    </div>
                  </div>
                </div>

                <div class="flex items-center justify-end gap-3 border-t border-white/10 p-5 md:p-6">
                  <button type="button" data-action="slideover#hide:prevent" class="px-4 py-2.5 rounded-lg border border-neutral-700 text-neutral-300 hover:bg-neutral-800 transition-colors font-medium">
                    Annuler
                  </button>
                  <button type="submit" class="px-5 py-2.5 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors">
                    <i class="fa-solid fa-check mr-2"></i>Enregistrer
                  </button>
                </div>
              <% end %>
            </div>
          </dialog>
        </div>
      <% end %>
      
      <% if @client.mt5_accounts.empty? %>
        <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-12 text-center">
          <i class="fa-solid fa-wallet text-4xl text-neutral-600 mb-4"></i>
          <p class="text-neutral-400">Aucun compte MT5</p>
        </div>
      <% end %>
    </div>

    <!-- Tab: Bots -->
    <div data-tabs-target="panel" data-tab="bots" class="mt-6 hidden space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <% @client.bot_purchases.includes(:trading_bot).each do |purchase| %>
          <%= render partial: "admin/clients/bot_purchase_card", locals: { bot: purchase } %>
        <% end %>
      </div>
      
      <% if @client.bot_purchases.empty? %>
        <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-12 text-center">
          <i class="fa-solid fa-robot text-4xl text-neutral-600 mb-4"></i>
          <p class="text-neutral-400">Aucun bot assign√©</p>
        </div>
      <% end %>

      <% if current_user.is_admin? %>
        <!-- Assigner un Bot -->
        <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-6">
          <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <i class="fa-solid fa-plus text-blue-400"></i>
            Assigner un Bot
          </h3>
          <%= form_with url: assign_to_user_admin_bot_purchases_path, method: :post, local: true, class: "flex flex-col md:flex-row gap-4" do |f| %>
            <input type="hidden" name="user_id" value="<%= @client.id %>">
            <div class="flex-1">
              <select name="trading_bot_id" required class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                <option value="">S√©lectionner un bot...</option>
                <% TradingBot.active.each do |bot| %>
                  <option value="<%= bot.id %>"><%= bot.name %> - <%= number_to_currency(bot.price, unit: "‚Ç¨", format: "%n%u") %></option>
                <% end %>
              </select>
            </div>
            <button type="submit" class="px-6 py-2.5 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors">
              <i class="fa-solid fa-plus mr-2"></i>Assigner
            </button>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- Tab: Trades -->
    <div data-tabs-target="panel" data-tab="trades" class="mt-6 hidden space-y-6">
      <% trades = Trade.joins(mt5_account: :user).where(users: { id: @client.id }).order(close_time: :desc).limit(50) %>
      
      <div class="rounded-xl bg-neutral-900 border border-neutral-800 overflow-hidden">
        <div class="p-4 border-b border-neutral-800">
          <h3 class="text-lg font-semibold text-white">Derniers Trades</h3>
        </div>
        <% if trades.any? %>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-neutral-800/50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-neutral-400 uppercase">Symbol</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-neutral-400 uppercase">Type</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-neutral-400 uppercase">Volume</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-neutral-400 uppercase">Prix Entr√©e</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-neutral-400 uppercase">Prix Sortie</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-neutral-400 uppercase">Profit</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-neutral-400 uppercase">Date</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-neutral-800">
                <% trades.each do |trade| %>
                  <tr class="hover:bg-neutral-800/30">
                    <td class="px-4 py-3 text-white font-medium"><%= trade.symbol %></td>
                    <td class="px-4 py-3">
                      <span class="px-2 py-1 rounded text-xs font-semibold <%= trade.trade_type&.downcase == 'buy' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400' %>">
                        <%= trade.trade_type %>
                      </span>
                    </td>
                    <td class="px-4 py-3 text-neutral-300"><%= trade.volume %></td>
                    <td class="px-4 py-3 text-neutral-300"><%= trade.open_price %></td>
                    <td class="px-4 py-3 text-neutral-300"><%= trade.close_price %></td>
                    <td class="px-4 py-3 font-semibold <%= trade.profit >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
                      <%= number_to_currency(trade.profit, unit: "‚Ç¨", format: "%n%u") %>
                    </td>
                    <td class="px-4 py-3 text-neutral-400 text-sm"><%= trade.close_time&.strftime("%d/%m/%Y %H:%M") %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="p-12 text-center">
            <i class="fa-solid fa-chart-line text-4xl text-neutral-600 mb-4"></i>
            <p class="text-neutral-400">Aucun trade</p>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Tab: Invoices -->
    <div data-tabs-target="panel" data-tab="invoices" class="mt-6 hidden space-y-6">
      <% @client.invoices.order(created_at: :desc).each do |invoice| %>
        <div class="rounded-xl bg-neutral-900 border border-neutral-800 overflow-hidden">
          <div class="p-4 flex items-center justify-between flex-wrap gap-4">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-lg bg-neutral-800 flex items-center justify-center">
                <i class="fa-solid fa-file-invoice text-neutral-400"></i>
              </div>
              <div>
                <h4 class="font-semibold text-white"><%= invoice.reference %></h4>
                <p class="text-sm text-neutral-400"><%= invoice.created_at.strftime("%d/%m/%Y") %></p>
              </div>
            </div>
            <div class="flex items-center gap-6 flex-wrap">
              <div class="text-right">
                <div class="text-sm text-neutral-400">Total</div>
                <div class="font-bold text-white"><%= number_to_currency(invoice.total_amount, unit: "‚Ç¨", format: "%n%u") %></div>
              </div>
              <div class="text-right">
                <div class="text-sm text-neutral-400">Pay√©</div>
                <div class="font-bold text-emerald-400"><%= number_to_currency(invoice.total_amount - invoice.balance_due, unit: "‚Ç¨", format: "%n%u") %></div>
              </div>
              <div class="text-right">
                <div class="text-sm text-neutral-400">Reste</div>
                <div class="font-bold <%= invoice.balance_due > 0 ? 'text-red-400' : 'text-emerald-400' %>"><%= number_to_currency(invoice.balance_due, unit: "‚Ç¨", format: "%n%u") %></div>
              </div>
              <% if invoice.balance_due <= 0 %>
                <span class="px-3 py-1 rounded-full text-sm font-medium bg-emerald-500/20 text-emerald-400">Pay√©e</span>
              <% elsif invoice.balance_due < invoice.total_amount %>
                <span class="px-3 py-1 rounded-full text-sm font-medium bg-amber-500/20 text-amber-400">Partiel</span>
              <% else %>
                <span class="px-3 py-1 rounded-full text-sm font-medium bg-red-500/20 text-red-400">En attente</span>
              <% end %>
              
              <% if invoice.stripe_payment_intent_id.present? %>
                <a href="https://dashboard.stripe.com/payments/<%= invoice.stripe_payment_intent_id %>" 
                   target="_blank" 
                   rel="noopener noreferrer"
                   class="px-3 py-1 rounded-lg text-sm font-medium bg-purple-600 text-white hover:bg-purple-700 transition-colors flex items-center gap-2">
                  <i class="fa-brands fa-stripe"></i>
                  Voir sur Stripe
                </a>
              <% end %>
            </div>
          </div>
          
          <% if invoice.invoice_items.any? %>
            <div class="border-t border-neutral-800 p-4">
              <div class="space-y-2">
                <% invoice.invoice_items.each do |item| %>
                  <div class="flex justify-between py-2 px-3 rounded bg-neutral-800/50">
                    <span class="text-neutral-300"><%= item.label %></span>
                    <span class="text-white font-medium"><%= number_to_currency(item.total_price, unit: "‚Ç¨", format: "%n%u") %></span>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
          
          <% if invoice.invoice_payments.any? %>
            <div class="border-t border-neutral-800 p-4">
              <h5 class="text-sm font-semibold text-neutral-400 mb-3 flex items-center gap-2">
                <i class="fa-solid fa-credit-card"></i>
                Paiements enregistr√©s
              </h5>
              <div class="space-y-2">
                <% invoice.invoice_payments.each do |payment| %>
                  <div class="flex justify-between items-center py-2 px-3 rounded bg-emerald-500/10">
                    <div class="flex items-center gap-3">
                      <i class="fa-solid fa-check-circle text-emerald-400"></i>
                      <div>
                        <span class="text-neutral-300"><%= payment.payment_method == 'stripe' ? 'Paiement Stripe' : payment.payment_method %></span>
                        <% if payment.notes.present? %>
                          <p class="text-xs text-neutral-500"><%= payment.notes.truncate(50) %></p>
                        <% end %>
                      </div>
                    </div>
                    <div class="text-right">
                      <span class="text-emerald-400 font-medium"><%= number_to_currency(payment.amount, unit: "‚Ç¨", format: "%n%u") %></span>
                      <span class="text-xs text-neutral-500 block"><%= payment.paid_at&.strftime("%d/%m/%Y %H:%M") %></span>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
      
      <% if @client.invoices.empty? %>
        <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-12 text-center">
          <i class="fa-solid fa-file-invoice text-4xl text-neutral-600 mb-4"></i>
          <p class="text-neutral-400">Aucune facture</p>
        </div>
      <% end %>
    </div>

    <!-- Tab: Commissions -->
    <div data-tabs-target="panel" data-tab="commissions" class="mt-6 hidden space-y-6">
      <!-- R√©sum√© Performance -->
      <div class="rounded-xl bg-gradient-to-r from-blue-900/30 to-purple-900/20 border border-blue-700/30 p-6">
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
          <i class="fa-solid fa-chart-line text-blue-400"></i>
          Performance & Commission
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
          <div>
            <div class="text-sm text-neutral-400">High Watermark</div>
            <div class="text-xl font-bold text-cyan-400"><%= number_to_currency(@performance[:high_watermark], unit: "‚Ç¨", format: "%n%u") %></div>
          </div>
          <div>
            <div class="text-sm text-neutral-400">Dernier Snapshot</div>
            <div class="text-xl font-bold text-white"><%= number_to_currency(@client.last_watermark_snapshot || 0, unit: "‚Ç¨", format: "%n%u") %></div>
          </div>
          <div>
            <div class="text-sm text-neutral-400">Commission en cours</div>
            <div class="text-xl font-bold text-blue-400"><%= number_to_currency(@performance[:pending_commission], unit: "‚Ç¨", format: "%n%u") %></div>
          </div>
          <div>
            <div class="text-sm text-neutral-400">Prochaine facturation</div>
            <div class="text-xl font-bold text-white">
              <% next_billing = Date.current.day < 14 ? Date.new(Date.current.year, Date.current.month, 14) : (Date.current.day < 28 ? Date.new(Date.current.year, Date.current.month, 28) : Date.new(Date.current.year, Date.current.month, 14) + 1.month) %>
              <%= next_billing.strftime("%d/%m/%Y") %>
            </div>
          </div>
        </div>
      </div>

      <!-- Historique des Commissions -->
      <div class="rounded-xl bg-neutral-900 border border-neutral-800 overflow-hidden" data-controller="slideover">
        <div class="p-4 border-b border-neutral-800 flex items-center justify-between">
          <h3 class="text-lg font-semibold text-white">Historique des Commissions</h3>
          <% if current_user.is_admin? %>
            <button type="button" data-action="slideover#show:prevent" class="px-3 py-1.5 rounded-lg bg-blue-600 text-white text-sm hover:bg-blue-700 transition-colors flex items-center gap-1.5">
              <i class="fa-solid fa-plus"></i>Cr√©er facture manuelle
            </button>
          <% end %>
        </div>

        <!-- Slideover Cr√©er Facture Commission -->
        <dialog data-slideover-target="dialog" data-action="mousedown->slideover#backdropClose" class="slideover slideover-right fixed inset-0 m-0 ml-auto h-dvh max-h-full border-l border-white/10 outline-hidden">
          <div class="inset-y-0 flex h-dvh w-full flex-col bg-neutral-900 shadow-lg outline-hidden sm:w-96 lg:w-[480px] text-neutral-100 shadow-neutral-950">
            <button type="button" data-action="slideover#hide:prevent" class="absolute top-4 right-4 mt-1 rounded-full p-1.5 opacity-70 transition-opacity hover:cursor-pointer hover:bg-neutral-500/15 hover:opacity-100 focus:outline-hidden active:bg-neutral-500/25 md:top-5">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                <line x1="18" x2="6" y1="6" y2="18"></line>
                <line x1="6" x2="18" y1="6" y2="18"></line>
              </svg>
            </button>

            <div class="flex items-center gap-3 border-b border-white/10 p-5 pr-12 md:p-6">
              <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                <i class="fa-solid fa-percent text-white text-xl"></i>
              </div>
              <div>
                <h4 class="font-semibold text-lg text-white">Cr√©er Facture Commission</h4>
                <p class="text-sm text-neutral-400"><%= @client.full_name %></p>
              </div>
            </div>

            <%= form_with url: admin_commission_invoices_path, method: :post, local: true, class: "flex flex-col flex-1 overflow-hidden" do |f| %>
              <input type="hidden" name="user_id" value="<%= @client.id %>">
              
              <div class="flex-1 overflow-y-auto p-5 md:p-6 space-y-5">
                <!-- Info Performance -->
                <div class="rounded-lg bg-neutral-800 p-4 space-y-3">
                  <div class="flex justify-between">
                    <span class="text-neutral-400">High Watermark actuel</span>
                    <span class="text-cyan-400 font-semibold"><%= number_to_currency(@performance[:high_watermark], unit: "‚Ç¨", format: "%n%u") %></span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-neutral-400">Solde actuel</span>
                    <span class="text-white font-semibold"><%= number_to_currency(@performance[:total_balance], unit: "‚Ç¨", format: "%n%u") %></span>
                  </div>
                  <div class="flex justify-between border-t border-neutral-700 pt-3">
                    <span class="text-neutral-400">Commission estim√©e (<%= @performance[:commission_rate] %>%)</span>
                    <span class="text-blue-400 font-bold"><%= number_to_currency(@performance[:pending_commission], unit: "‚Ç¨", format: "%n%u") %></span>
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-neutral-300 mb-2">P√©riode D√©but</label>
                    <input type="date" name="period_start" value="<%= Date.current.beginning_of_month.strftime('%Y-%m-%d') %>" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-neutral-300 mb-2">P√©riode Fin</label>
                    <input type="date" name="period_end" value="<%= Date.current.strftime('%Y-%m-%d') %>" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-neutral-300 mb-2">Profit r√©alis√© sur la p√©riode</label>
                  <div class="relative">
                    <input type="number" step="0.01" name="total_profit" value="<%= (@performance[:total_balance] - (@client.last_watermark_snapshot || @performance[:initial_balance])).round(2) %>" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 pr-10" placeholder="0.00">
                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400">‚Ç¨</span>
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-neutral-300 mb-2">Taux de commission (%)</label>
                  <input type="number" step="0.1" name="commission_rate" value="<%= @client.commission_rate %>" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="25.0">
                </div>

                <div>
                  <label class="block text-sm font-medium text-neutral-300 mb-2">Montant Commission</label>
                  <div class="relative">
                    <input type="number" step="0.01" name="commission_amount" value="<%= @performance[:pending_commission].round(2) %>" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 pr-10 text-lg font-bold" placeholder="0.00">
                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400">‚Ç¨</span>
                  </div>
                  <p class="text-xs text-neutral-500 mt-1">Vous pouvez ajuster manuellement ce montant</p>
                </div>

                <div>
                  <label class="block text-sm font-medium text-neutral-300 mb-2">Date d'√©ch√©ance</label>
                  <input type="date" name="due_date" value="<%= (Date.current + 1.day).strftime('%Y-%m-%d') %>" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                </div>

                <div>
                  <label class="block text-sm font-medium text-neutral-300 mb-2">Notes (optionnel)</label>
                  <textarea name="notes" rows="2" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white placeholder-neutral-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="Notes internes..."></textarea>
                </div>

                <div class="flex items-center gap-3 pt-2">
                  <input type="checkbox" name="send_notification" value="1" checked class="w-5 h-5 rounded border-neutral-600 bg-neutral-800 text-blue-500 focus:ring-blue-500">
                  <label class="text-neutral-300">Envoyer notification SMS au client</label>
                </div>

                <div class="flex items-center gap-3">
                  <input type="checkbox" name="update_watermark" value="1" checked class="w-5 h-5 rounded border-neutral-600 bg-neutral-800 text-blue-500 focus:ring-blue-500">
                  <label class="text-neutral-300">Mettre √† jour le High Watermark</label>
                </div>
              </div>

              <div class="flex items-center justify-end gap-3 border-t border-white/10 p-5 md:p-6">
                <button type="button" data-action="slideover#hide:prevent" class="px-4 py-2.5 rounded-lg border border-neutral-700 text-neutral-300 hover:bg-neutral-800 transition-colors font-medium">
                  Annuler
                </button>
                <button type="submit" class="px-5 py-2.5 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors">
                  <i class="fa-solid fa-file-invoice mr-2"></i>Cr√©er la facture
                </button>
              </div>
            <% end %>
          </div>
        </dialog>
        
        <% if @client.commission_invoices.any? %>
          <div class="divide-y divide-neutral-800">
            <% @client.commission_invoices.order(created_at: :desc).each do |ci| %>
              <div class="p-4 hover:bg-neutral-800/50 transition-colors">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-lg flex items-center justify-center <%= ci.paid? ? 'bg-emerald-500/20' : (ci.overdue? ? 'bg-red-500/20' : 'bg-amber-500/20') %>">
                      <i class="fa-solid <%= ci.paid? ? 'fa-check text-emerald-400' : (ci.overdue? ? 'fa-exclamation text-red-400' : 'fa-clock text-amber-400') %>"></i>
                    </div>
                    <div>
                      <div class="font-medium text-white"><%= ci.reference %></div>
                      <div class="text-sm text-neutral-400">
                        P√©riode: <%= ci.period_start&.strftime("%d/%m") %> - <%= ci.period_end&.strftime("%d/%m/%Y") %>
                      </div>
                    </div>
                  </div>
                  <div class="flex items-center gap-6">
                    <div class="text-right">
                      <div class="text-sm text-neutral-400">Profit</div>
                      <div class="font-medium text-white"><%= number_to_currency(ci.total_profit, unit: "‚Ç¨", format: "%n%u") %></div>
                    </div>
                    <div class="text-right">
                      <div class="text-sm text-neutral-400">Commission (<%= ci.commission_rate %>%)</div>
                      <div class="font-bold text-blue-400"><%= number_to_currency(ci.commission_amount, unit: "‚Ç¨", format: "%n%u") %></div>
                    </div>
                    <% if ci.late_fee > 0 %>
                      <div class="text-right">
                        <div class="text-sm text-red-400">Frais</div>
                        <div class="font-bold text-red-400">+<%= number_to_currency(ci.late_fee, unit: "‚Ç¨", format: "%n%u") %></div>
                      </div>
                    <% end %>
                    <div class="text-right min-w-[100px]">
                      <% case ci.status %>
                      <% when 'paid' %>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold bg-emerald-500/20 text-emerald-400">Pay√©e</span>
                      <% when 'pending', 'reminder_sent' %>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold bg-amber-500/20 text-amber-400">En attente</span>
                      <% when 'failed' %>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold bg-red-500/20 text-red-400">√âchec</span>
                      <% when 'overdue' %>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold bg-red-500/20 text-red-400">Impay√©e</span>
                      <% end %>
                    </div>
                    <% if ci.invoice.present? %>
                      <%= link_to admin_invoice_path(ci.invoice), class: "p-2 rounded-lg hover:bg-neutral-700 text-neutral-400 hover:text-white transition-colors" do %>
                        <i class="fa-solid fa-eye"></i>
                      <% end %>
                    <% end %>
                  </div>
                </div>
                <% if ci.paid_at.present? %>
                  <div class="mt-2 text-xs text-neutral-500">
                    <i class="fa-solid fa-check mr-1"></i>Pay√©e le <%= ci.paid_at.strftime("%d/%m/%Y √† %H:%M") %>
                  </div>
                <% elsif ci.due_date.present? %>
                  <div class="mt-2 text-xs <%= ci.due_date < Date.current ? 'text-red-400' : 'text-neutral-500' %>">
                    <i class="fa-solid fa-calendar mr-1"></i>√âch√©ance: <%= ci.due_date.strftime("%d/%m/%Y") %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="p-12 text-center">
            <i class="fa-solid fa-percent text-4xl text-neutral-600 mb-4"></i>
            <p class="text-neutral-400">Aucune facture de commission</p>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Tab: Subscriptions -->
    <div data-tabs-target="panel" data-tab="subscriptions" class="mt-6 hidden space-y-6">
      <% @client.subscriptions.order(created_at: :desc).each do |subscription| %>
        <div class="rounded-xl bg-neutral-900 border border-neutral-800 overflow-hidden">
          <div class="p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-4">
                <div class="w-14 h-14 rounded-xl bg-gradient-to-br <%= subscription.active? ? 'from-emerald-500 to-green-600' : 'from-neutral-600 to-neutral-700' %> flex items-center justify-center">
                  <i class="fa-solid fa-repeat text-white text-2xl"></i>
                </div>
                <div>
                  <h3 class="text-xl font-bold text-white">Abonnement <%= subscription.plan_name %></h3>
                  <p class="text-sm text-neutral-400">
                    Depuis le <%= subscription.created_at.strftime("%d/%m/%Y") %>
                  </p>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <div class="text-right">
                  <div class="text-2xl font-bold text-white"><%= number_to_currency(subscription.monthly_price, unit: "‚Ç¨", format: "%n%u") %></div>
                  <div class="text-sm text-neutral-400">par mois</div>
                </div>
                <span class="px-4 py-2 rounded-full text-sm font-semibold <%= 
                  case subscription.status
                  when 'active' then 'bg-emerald-500/20 text-emerald-400'
                  when 'past_due' then 'bg-amber-500/20 text-amber-400'
                  when 'canceled' then 'bg-red-500/20 text-red-400'
                  else 'bg-neutral-700 text-neutral-400'
                  end
                %>">
                  <%= case subscription.status
                      when 'active' then '‚úì Actif'
                      when 'past_due' then '‚ö†Ô∏è Impay√©'
                      when 'canceled' then '‚úï Annul√©'
                      when 'paused' then '‚è∏ En pause'
                      else subscription.status.titleize
                      end
                  %>
                </span>
              </div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6 pt-6 border-t border-neutral-800">
              <div>
                <div class="text-sm text-neutral-400">Prochain pr√©l√®vement</div>
                <div class="font-semibold text-white"><%= subscription.current_period_end&.strftime("%d/%m/%Y") || "‚Äî" %></div>
              </div>
              <div>
                <div class="text-sm text-neutral-400">√âchecs de paiement</div>
                <div class="font-semibold <%= subscription.failed_payment_count > 0 ? 'text-amber-400' : 'text-white' %>">
                  <%= subscription.failed_payment_count %>
                </div>
              </div>
              <div>
                <div class="text-sm text-neutral-400">ID Stripe</div>
                <div class="font-mono text-xs text-neutral-400 truncate"><%= subscription.stripe_subscription_id %></div>
              </div>
              <div>
                <div class="text-sm text-neutral-400">Dernier rappel</div>
                <div class="font-semibold text-white"><%= subscription.last_reminder_sent_at&.strftime("%d/%m/%Y %H:%M") || "‚Äî" %></div>
              </div>
            </div>
            
            <% if subscription.stripe_subscription_id.present? && !subscription.stripe_subscription_id.start_with?('sub_manual') %>
              <div class="mt-6 pt-6 border-t border-neutral-800 flex gap-3">
                <a href="https://dashboard.stripe.com/subscriptions/<%= subscription.stripe_subscription_id %>" 
                   target="_blank" 
                   rel="noopener noreferrer"
                   class="px-4 py-2 rounded-lg bg-purple-600 text-white text-sm font-medium hover:bg-purple-700 transition-colors flex items-center gap-2">
                  <i class="fa-brands fa-stripe"></i>
                  Voir sur Stripe
                </a>
                
                <% if subscription.active? && current_user.is_admin? %>
                  <%= button_to "#", method: :post, class: "px-4 py-2 rounded-lg bg-amber-600 text-white text-sm font-medium hover:bg-amber-700 transition-colors", disabled: true do %>
                    <i class="fa-solid fa-pause mr-2"></i>Mettre en pause
                  <% end %>
                  <%= button_to "#", method: :delete, class: "px-4 py-2 rounded-lg bg-red-600 text-white text-sm font-medium hover:bg-red-700 transition-colors", disabled: true, data: { confirm: "Annuler cet abonnement ?" } do %>
                    <i class="fa-solid fa-times mr-2"></i>Annuler
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>
          
          <% if subscription.past_due? && subscription.failed_payment_count > 0 %>
            <div class="bg-amber-500/10 border-t border-amber-500/30 p-4">
              <div class="flex items-center gap-3 text-amber-400">
                <i class="fa-solid fa-exclamation-triangle text-lg"></i>
                <div>
                  <span class="font-semibold">Paiement √©chou√©</span>
                  <p class="text-sm text-amber-300/80">
                    <% if subscription.last_reminder_sent_at %>
                      Dernier SMS de relance envoy√© le <%= subscription.last_reminder_sent_at.strftime("%d/%m/%Y √† %H:%M") %>
                    <% else %>
                      Un SMS de relance sera envoy√© automatiquement.
                    <% end %>
                  </p>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
      
      <% if @client.subscriptions.empty? %>
        <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-12 text-center">
          <i class="fa-solid fa-repeat text-4xl text-neutral-600 mb-4"></i>
          <p class="text-neutral-400">Aucun abonnement</p>
        </div>
      <% end %>
    </div>

    <!-- Tab: VPS -->
    <div data-tabs-target="panel" data-tab="vps" class="mt-6 hidden space-y-6">
      <% @client.vps.each do |vps| %>
        <%= render partial: "admin/clients/vps_card", locals: { vps: vps } %>
      <% end %>
      
      <% if @client.vps.empty? %>
        <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-12 text-center">
          <i class="fa-solid fa-server text-4xl text-neutral-600 mb-4"></i>
          <p class="text-neutral-400">Aucun VPS</p>
        </div>
      <% end %>
    </div>

    <!-- Tab: SMS -->
    <div data-tabs-target="panel" data-tab="sms" class="mt-6 hidden space-y-6">
      <% scheduled_sms = ScheduledSms.where(user: @client).order(created_at: :desc) rescue [] %>
      <% sent_sms = SmsCampaignLog.where(user: @client).order(sent_at: :desc) %>
      
      <!-- SMS Programm√©s -->
      <% pending_sms = scheduled_sms.select(&:pending?) rescue [] %>
      <% if pending_sms.any? %>
        <div class="rounded-xl bg-gradient-to-br from-amber-900/20 to-orange-900/10 border border-amber-500/30 p-6">
          <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <i class="fa-solid fa-clock text-amber-400"></i>
            SMS Programm√©s
            <span class="px-2 py-0.5 rounded-full text-xs bg-amber-500/20 text-amber-400"><%= pending_sms.count %></span>
          </h3>
          <div class="space-y-3">
            <% pending_sms.each do |sms| %>
              <div class="p-4 rounded-xl bg-neutral-900/50 border border-neutral-800 flex items-start gap-4">
                <div class="w-10 h-10 rounded-xl bg-amber-500/20 flex items-center justify-center flex-shrink-0">
                  <i class="fa-solid fa-clock text-amber-400"></i>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm text-white"><%= sms.message.truncate(100) %></p>
                  <div class="flex items-center gap-3 mt-2 text-xs text-neutral-400">
                    <span><i class="fa-solid fa-calendar mr-1"></i><%= sms.scheduled_at.strftime("%d/%m/%Y √† %H:%M") %></span>
                    <span><i class="fa-solid fa-user mr-1"></i><%= sms.created_by&.full_name || 'Syst√®me' %></span>
                  </div>
                </div>
                <%= button_to cancel_scheduled_sms_admin_client_path(@client, sms_id: sms.id), method: :post, data: { confirm: "Annuler ce SMS programm√© ?" }, class: "px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 text-xs font-medium" do %>
                  <i class="fa-solid fa-xmark mr-1"></i>Annuler
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Historique des SMS -->
      <div class="rounded-xl bg-neutral-900 border border-neutral-800 overflow-hidden">
        <div class="p-4 border-b border-neutral-800 flex items-center justify-between">
          <h3 class="font-semibold text-white flex items-center gap-2">
            <i class="fa-solid fa-clock-rotate-left text-neutral-400"></i>
            Historique des SMS
          </h3>
          <span class="text-sm text-neutral-400"><%= sent_sms.count %> envoy√©(s)</span>
        </div>
        
        <% if sent_sms.any? %>
          <div class="divide-y divide-neutral-800">
            <% sent_sms.limit(20).each do |sms| %>
              <div class="p-4 hover:bg-neutral-800/30 transition-colors">
                <div class="flex items-start gap-3">
                  <div class="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 <%= sms.status == 'sent' ? 'bg-emerald-500/20' : 'bg-red-500/20' %>">
                    <i class="fa-solid <%= sms.status == 'sent' ? 'fa-check text-emerald-400' : 'fa-xmark text-red-400' %> text-sm"></i>
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class="text-sm text-white"><%= sms.message %></p>
                    <div class="flex items-center gap-4 mt-2 text-xs text-neutral-500">
                      <span><i class="fa-solid fa-calendar mr-1"></i><%= sms.sent_at&.strftime("%d/%m/%Y √† %H:%M") %></span>
                      <% if sms.sms_type.present? %>
                        <span class="px-2 py-0.5 rounded bg-neutral-800 text-neutral-400"><%= sms.sms_type %></span>
                      <% end %>
                      <% if sms.sent_by.present? %>
                        <span><i class="fa-solid fa-user mr-1"></i><%= sms.sent_by.full_name rescue 'Admin' %></span>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="p-12 text-center">
            <i class="fa-solid fa-comment-sms text-4xl text-neutral-600 mb-4"></i>
            <p class="text-neutral-400">Aucun SMS envoy√© √† ce client</p>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Tab: Admin -->
    <% if current_user.is_admin? %>
      <div data-tabs-target="panel" data-tab="admin" class="mt-6 hidden space-y-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Modifier Commission -->
          <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-6">
            <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
              <i class="fa-solid fa-percent text-amber-400"></i>
              Taux de Commission
            </h3>
            <%= form_with url: admin_client_path(@client), method: :patch, local: true, class: "flex gap-4" do |f| %>
              <div class="flex-1">
                <input type="number" name="user[commission_rate]" value="<%= @client.commission_rate %>" step="0.1" min="0" max="100" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white focus:border-blue-500">
              </div>
              <button type="submit" class="px-6 py-2.5 rounded-lg bg-amber-600 text-white font-medium hover:bg-amber-700 transition-colors">
                Mettre √† jour
              </button>
            <% end %>
          </div>

          <!-- Ajouter Paiement -->
          <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-6">
            <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
              <i class="fa-solid fa-credit-card text-emerald-400"></i>
              Ajouter un Paiement
            </h3>
            <%= form_with url: admin_payments_path, method: :post, local: true, class: "space-y-4" do |f| %>
              <input type="hidden" name="payment[user_id]" value="<%= @client.id %>">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm text-neutral-400 mb-1">Montant</label>
                  <input type="number" name="payment[amount]" step="0.01" required class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white focus:border-blue-500">
                </div>
                <div>
                  <label class="block text-sm text-neutral-400 mb-1">M√©thode</label>
                  <select name="payment[payment_method]" class="w-full px-4 py-2.5 rounded-lg bg-neutral-800 border border-neutral-700 text-white focus:border-blue-500">
                    <option value="bank_transfer">Virement</option>
                    <option value="card">Carte</option>
                    <option value="cash">Esp√®ces</option>
                  </select>
                </div>
              </div>
              <button type="submit" class="w-full px-6 py-2.5 rounded-lg bg-emerald-600 text-white font-medium hover:bg-emerald-700 transition-colors">
                <i class="fa-solid fa-plus mr-2"></i>Enregistrer le paiement
              </button>
            <% end %>
          </div>
        </div>

        <!-- Zone Danger -->
        <div class="rounded-xl bg-red-950/20 border border-red-900/50 p-6">
          <h3 class="text-lg font-semibold text-red-400 mb-4 flex items-center gap-2">
            <i class="fa-solid fa-triangle-exclamation"></i>
            Zone Dangereuse
          </h3>
          <div class="flex flex-wrap gap-4">
            <%= button_to admin_client_path(@client), method: :delete, data: { confirm: "√ätes-vous s√ªr de vouloir supprimer ce client ? Cette action est irr√©versible." }, class: "px-4 py-2 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition-colors" do %>
              <i class="fa-solid fa-trash mr-2"></i>Supprimer le client
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Tabs management
  const controller = document.querySelector('[data-controller="tabs"]');
  if (controller) {
    const tabs = controller.querySelectorAll('[data-tabs-target="tab"]');
    const panels = controller.querySelectorAll('[data-tabs-target="panel"]');
    const defaultTab = controller.dataset.tabsDefaultValue || 'overview';
    
    function selectTab(tabName) {
      tabs.forEach(tab => {
        const isActive = tab.dataset.tab === tabName;
        tab.classList.toggle('bg-white', isActive);
        tab.classList.toggle('text-neutral-900', isActive);
        tab.classList.toggle('text-neutral-400', !isActive);
        tab.classList.toggle('hover:text-white', !isActive);
        tab.classList.toggle('hover:bg-neutral-800', !isActive);
      });
      
      panels.forEach(panel => {
        const isActive = panel.dataset.tab === tabName;
        panel.classList.toggle('hidden', !isActive);
      });
    }
    
    tabs.forEach(tab => {
      tab.addEventListener('click', () => selectTab(tab.dataset.tab));
    });
    
    selectTab(defaultTab);
  }
});

// Password toggle functions
function togglePassword(accountId) {
  const input = document.getElementById('pw-input-' + accountId);
  const icon = document.getElementById('pw-icon-' + accountId);
  if (input.type === 'password') {
    input.type = 'text';
    icon.classList.remove('fa-eye');
    icon.classList.add('fa-eye-slash');
  } else {
    input.type = 'password';
    icon.classList.remove('fa-eye-slash');
    icon.classList.add('fa-eye');
  }
}

function copyPassword(accountId) {
  const input = document.getElementById('pw-input-' + accountId);
  const btn = document.getElementById('pw-copy-' + accountId);
  const originalType = input.type;
  input.type = 'text';
  input.select();
  navigator.clipboard.writeText(input.value).then(() => {
    const icon = btn.querySelector('i');
    icon.className = 'fa-solid fa-check text-xs';
    btn.classList.add('text-emerald-400');
    setTimeout(() => {
      icon.className = 'fa-solid fa-copy text-xs';
      btn.classList.remove('text-emerald-400');
    }, 1500);
  });
  input.type = originalType;
}
</script>
