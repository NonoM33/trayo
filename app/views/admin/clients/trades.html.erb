<% content_for :title, "Trades - #{@client.first_name} #{@client.last_name}" %>

<div class="page-header">
  <div class="page-header-content">
    <div class="page-header-left">
      <h1>Trades - <%= @client.first_name %> <%= @client.last_name %></h1>
      <p class="page-description">Historique détaillé des trades</p>
    </div>
    <div class="page-header-right">
      <%= link_to "← Retour au profil", admin_client_path(@client), class: "btn btn-outline" %>
    </div>
  </div>
</div>

<div class="page-content">
  <!-- Statistiques -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value"><%= @total_trades %></div>
      <div class="stat-label">Total Trades</div>
    </div>
    <div class="stat-card">
      <div class="stat-value <%= @total_profit >= 0 ? 'positive' : 'negative' %>">
        <%= number_to_currency(@total_profit, unit: "€", format: "%n %u") %>
      </div>
      <div class="stat-label">Profit Total</div>
    </div>
    <div class="stat-card">
      <div class="stat-value"><%= @win_rate %>%</div>
      <div class="stat-label">Taux de Réussite</div>
    </div>
    <div class="stat-card">
      <div class="stat-value"><%= @winning_trades %>/<%= @losing_trades %></div>
      <div class="stat-label">Gagnants/Perdants</div>
    </div>
  </div>

  <!-- Filtres -->
  <div class="filters-section">
    <%= form_with url: trades_admin_client_path(@client), method: :get, local: true, class: "filters-form" do |form| %>
      <div class="filters-grid">
        <div class="filter-group">
          <%= form.label :symbol, "Symbole", class: "filter-label" %>
          <%= form.select :symbol, options_for_select([["Tous les symboles", ""]] + @symbols.map { |s| [s, s] }, params[:symbol]), {}, { class: "filter-select" } %>
        </div>
        
        <div class="filter-group">
          <%= form.label :magic_number, "Bot (Magic Number)", class: "filter-label" %>
          <%= form.select :magic_number, options_for_select([["Tous les bots", ""]] + @magic_numbers.map { |m| ["Bot #{m}", m] }, params[:magic_number]), {}, { class: "filter-select" } %>
        </div>
        
        <div class="filter-group">
          <%= form.label :date_from, "Date de début", class: "filter-label" %>
          <%= form.date_field :date_from, value: params[:date_from], class: "filter-input" %>
        </div>
        
        <div class="filter-group">
          <%= form.label :date_to, "Date de fin", class: "filter-label" %>
          <%= form.date_field :date_to, value: params[:date_to], class: "filter-input" %>
        </div>
        
        <div class="filter-group">
          <%= form.label :sort, "Trier par", class: "filter-label" %>
          <%= form.select :sort, options_for_select([
            ["Date de fermeture", "close_time"],
            ["Symbole", "symbol"],
            ["Profit", "profit"],
            ["Bot (Magic Number)", "magic_number"]
          ], params[:sort]), {}, { class: "filter-select" } %>
        </div>
        
        <div class="filter-actions">
          <%= form.submit "Filtrer", class: "btn btn-primary" %>
          <%= link_to "Réinitialiser", trades_admin_client_path(@client), class: "btn btn-outline" %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Table des trades -->
  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Symbole</th>
          <th>Type</th>
          <th>Volume</th>
          <th>Prix Ouverture</th>
          <th>Prix Fermeture</th>
          <th>Profit</th>
          <th>Commission</th>
          <th>Swap</th>
          <th>Bot</th>
          <th>Compte MT5</th>
          <th>Commentaire</th>
        </tr>
      </thead>
      <tbody>
        <% @trades.each do |trade| %>
          <tr>
            <td>
              <div class="date-cell">
                <%= trade.close_time&.strftime("%d/%m/%Y") %>
                <small><%= trade.close_time&.strftime("%H:%M") %></small>
              </div>
            </td>
            <td><%= trade.symbol %></td>
            <td>
              <span class="trade-type <%= trade.trade_type %>">
                <%= trade.trade_type&.upcase %>
              </span>
            </td>
            <td><%= trade.volume %></td>
            <td><%= number_with_precision(trade.open_price, precision: 5) %></td>
            <td><%= number_with_precision(trade.close_price, precision: 5) %></td>
            <td>
              <span class="profit-value <%= trade.profit >= 0 ? 'positive' : 'negative' %>">
                <%= number_to_currency(trade.profit, unit: "€", format: "%n %u") %>
              </span>
            </td>
            <td><%= number_to_currency(trade.commission, unit: "€", format: "%n %u") %></td>
            <td><%= number_to_currency(trade.swap, unit: "€", format: "%n %u") %></td>
            <td>
              <% if trade.magic_number.present? %>
                <span class="magic-number"><%= bot_name_for_magic_number(trade.magic_number, @bots_cache) %></span>
              <% else %>
                <span class="text-muted">-</span>
              <% end %>
            </td>
            <td><%= trade.mt5_account.account_name %></td>
            <td>
              <% if trade.comment.present? %>
                <span class="comment-text" title="<%= trade.comment %>">
                  <%= truncate(trade.comment, length: 30) %>
                </span>
              <% else %>
                <span class="text-muted">-</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    
    <% if @trades.empty? %>
      <div class="empty-state">
        <div class="empty-state-icon">
          <i class="fa-icon fa-lg fa-chart-line"></i>
        </div>
        <h3>Aucun trade trouvé</h3>
        <p>Aucun trade ne correspond aux critères de recherche.</p>
      </div>
    <% end %>
  </div>

  <!-- Pagination -->
  <% if @trades.respond_to?(:current_page) %>
    <div class="pagination-container">
      <%= paginate @trades, theme: 'github' %>
    </div>
  <% end %>
</div>

<style>
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 1.5rem;
  text-align: center;
}

.stat-value {
  font-size: 2rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.stat-value.positive {
  color: var(--success-color);
}

.stat-value.negative {
  color: var(--error-color);
}

.stat-label {
  color: var(--text-muted);
  font-size: 0.875rem;
}

.filters-section {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 1.5rem;
  margin-bottom: 2rem;
}

.filters-form {
  width: 100%;
}

.filters-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  align-items: end;
}

.filter-group {
  display: flex;
  flex-direction: column;
}

.filter-label {
  font-weight: 500;
  margin-bottom: 0.5rem;
  color: var(--text-color);
}

.filter-select,
.filter-input {
  padding: 0.75rem;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  background: var(--input-bg);
  color: var(--text-color);
}

.filter-actions {
  display: flex;
  gap: 0.5rem;
  align-items: end;
}

.date-cell {
  display: flex;
  flex-direction: column;
}

.date-cell small {
  color: var(--text-muted);
  font-size: 0.75rem;
}

.trade-type {
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
}

.trade-type.buy {
  background: var(--success-color);
  color: white;
}

.trade-type.sell {
  background: var(--error-color);
  color: white;
}

.profit-value {
  font-weight: 600;
}

.profit-value.positive {
  color: var(--success-color);
}

.profit-value.negative {
  color: var(--error-color);
}

.magic-number {
  background: var(--primary-color);
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
}

.comment-text {
  font-size: 0.875rem;
  color: var(--text-muted);
}

.pagination-container {
  margin-top: 2rem;
  display: flex;
  justify-content: center;
}

.empty-state {
  text-align: center;
  padding: 3rem;
  color: var(--text-muted);
}

.empty-state-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.empty-state h3 {
  margin-bottom: 0.5rem;
  color: var(--text-color);
}

@media (max-width: 768px) {
  .filters-grid {
    grid-template-columns: 1fr;
  }
  
  .filter-actions {
    justify-content: stretch;
  }
  
  .filter-actions .btn {
    flex: 1;
  }
}
</style>
