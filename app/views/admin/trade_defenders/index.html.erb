<% @page_title = "Trade Defender" %>

<div class="space-y-6">
  <%= render 'admin/shared/flash_messages' %>

  <% pending = @pending_trades || 0 %>
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
    <%= render 'admin/shared/stat_card',
        icon: 'fa-clock',
        icon_color: 'amber',
        label: 'En Attente',
        value: pending,
        value_color: pending > 0 ? 'amber' : nil %>
    
    <%= render 'admin/shared/stat_card',
        icon: 'fa-check',
        icon_color: 'green',
        label: 'Mes Trades',
        value: @admin_trades || 0,
        value_color: 'green' %>
    
    <div class="bg-neutral-900 rounded-xl p-4">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-red-500/10 flex items-center justify-center">
          <i class="fa-solid fa-exclamation-triangle text-red-400"></i>
        </div>
        <div>
          <p class="text-sm text-neutral-400">Clients (sanctionnés)</p>
          <p class="text-2xl font-bold text-red-400"><%= @client_trades || 0 %></p>
          <p class="text-xs text-neutral-500">Impact: <%= number_to_currency(@total_penalty || 0, unit: "€", format: "%n%u") %></p>
        </div>
      </div>
    </div>
  </div>

  <% if pending > 0 %>
    <div class="bg-amber-500/10 rounded-xl p-6">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 rounded-xl bg-amber-500/20 flex items-center justify-center text-amber-400 shrink-0">
            <i class="fa-solid fa-exclamation-triangle text-xl"></i>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-amber-400"><%= pending %> trades en attente</h3>
            <p class="text-sm text-neutral-400">Marquez tous les trades en attente comme vôtres ou comme trades clients</p>
          </div>
        </div>
        <div class="flex gap-2">
          <%= button_to mark_all_pending_as_admin_admin_trade_defenders_path, method: :post, data: { turbo_confirm: "Marquer TOUS les #{pending} trades en attente comme vôtres ?" }, class: "flex items-center justify-center gap-2 rounded-lg border border-neutral-700 bg-neutral-800 px-4 py-2 text-sm font-medium text-neutral-300 transition-colors hover:bg-neutral-700" do %>
            <i class="fa-solid fa-check"></i>
            TOUS → MIENS
          <% end %>
          <%= button_to mark_all_pending_as_client_admin_trade_defenders_path, method: :post, data: { turbo_confirm: "ATTENTION: Marquer TOUS les #{pending} trades comme clients et appliquer les sanctions ?" }, class: "flex items-center justify-center gap-2 rounded-lg border border-red-400/30 bg-red-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-red-500" do %>
            <i class="fa-solid fa-exclamation"></i>
            TOUS → CLIENTS
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <% if @manual_trades&.any? %>
    <div class="relative w-full bg-neutral-950 rounded-xl overflow-hidden"
         data-controller="scroll-area"
         data-scroll-area-target="root"
         data-action="mouseenter->scroll-area#onRootMouseEnter mouseleave->scroll-area#onRootMouseLeave">

      <div class="px-6 py-5 flex flex-col gap-4 bg-neutral-900">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-white flex items-center gap-2">
            <i class="fa-solid fa-shield-alt text-purple-400"></i>
            Trades Manuels
          </h2>
          <div class="flex gap-2">
            <button onclick="markSelectedAsAdmin()" class="flex items-center justify-center gap-1.5 rounded-lg border border-green-400/30 bg-green-600 px-3 py-1.5 text-xs font-medium text-white transition-colors hover:bg-green-500">
              Sélectionnés → MIENS
            </button>
            <button onclick="markSelectedAsClient()" class="flex items-center justify-center gap-1.5 rounded-lg border border-red-400/30 bg-red-600 px-3 py-1.5 text-xs font-medium text-white transition-colors hover:bg-red-500">
              Sélectionnés → CLIENTS
            </button>
          </div>
        </div>
        
        <%= form_with url: admin_trade_defenders_path, method: :get, local: true, class: "flex flex-wrap items-center gap-3" do |f| %>
          <%= select_tag :status, options_for_select([['⏳ En attente', 'manual_pending_review'], ['Tous', 'all'], ['✓ Mes trades', 'manual_admin'], ['⚠️ Clients', 'manual_client']], params[:status] || 'manual_pending_review'), class: "px-3 py-2 bg-neutral-800 border border-neutral-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
          <%= select_tag :account_id, options_from_collection_for_select(@accounts_with_manual_trades, :id, :account_name_with_user, params[:account_id]), include_blank: 'Tous les comptes', class: "px-3 py-2 bg-neutral-800 border border-neutral-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
          <%= select_tag :symbol, options_for_select([['Tous les symbols', '']] + @all_symbols.map { |s| [s, s] }, params[:symbol]), class: "px-3 py-2 bg-neutral-800 border border-neutral-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
          <%= date_field_tag :date_from, params[:date_from], class: "px-3 py-2 bg-neutral-800 border border-neutral-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder: "Début" %>
          <%= date_field_tag :date_to, params[:date_to], class: "px-3 py-2 bg-neutral-800 border border-neutral-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder: "Fin" %>
          <%= submit_tag "Filtrer", class: "px-4 py-2 bg-blue-600 rounded-lg text-white text-sm font-medium cursor-pointer hover:bg-blue-500 transition-colors" %>
          <%= link_to "Reset", admin_trade_defenders_path, class: "px-4 py-2 border border-neutral-700 bg-neutral-800 rounded-lg text-neutral-300 text-sm font-medium hover:bg-neutral-700" %>
        <% end %>
      </div>

      <div data-scroll-area-target="viewport"
           data-action="scroll->scroll-area#onViewportScroll"
           class="max-h-[500px] overflow-auto scrollbar-hide bg-neutral-950">
        <table class="w-full min-w-[900px] !bg-transparent !border-0">
          <thead class="sticky top-0 z-10 !bg-neutral-950">
            <tr class="*:py-3 *:text-left *:align-middle border-b border-neutral-800">
              <th scope="col" class="px-4 w-10"><input type="checkbox" onchange="toggleAll(this)" class="w-4 h-4 rounded bg-neutral-800 border-neutral-700" /></th>
              <th scope="col" class="px-4 text-sm font-semibold text-neutral-100 text-center">Statut</th>
              <th scope="col" class="px-4 text-sm font-semibold text-neutral-100">Trade ID</th>
              <th scope="col" class="px-4 text-sm font-semibold text-neutral-100">Client</th>
              <th scope="col" class="px-4 text-sm font-semibold text-neutral-100">Symbol</th>
              <th scope="col" class="px-4 text-sm font-semibold text-neutral-100 text-right">Volume</th>
              <th scope="col" class="px-4 text-sm font-semibold text-neutral-100 text-right">Profit</th>
              <th scope="col" class="px-4 text-sm font-semibold text-neutral-100">Date</th>
              <th scope="col" class="px-4 text-sm font-semibold text-neutral-100 text-right">Actions</th>
            </tr>
          </thead>
          <tbody class="*:even:bg-neutral-900/50 *:*:py-3 bg-neutral-950">
            <% @manual_trades.each do |trade| %>
              <tr class="hover:bg-neutral-800 transition-colors">
                <td class="px-4">
                  <input type="checkbox" class="trade-checkbox w-4 h-4 rounded bg-neutral-800 border-neutral-700" value="<%= trade.id %>" />
                </td>
                <td class="px-4 text-center">
                  <% if trade.trade_originality == 'manual_pending_review' %>
                    <%= render 'admin/shared/status_badge', label: '⏳', variant: 'warning' %>
                  <% elsif trade.trade_originality == 'manual_admin' %>
                    <%= render 'admin/shared/status_badge', label: '✓', variant: 'success' %>
                  <% else %>
                    <%= render 'admin/shared/status_badge', label: '⚠️', variant: 'danger' %>
                  <% end %>
                </td>
                <td class="px-4 font-mono text-sm font-semibold text-white"><%= trade.trade_id %></td>
                <td class="px-4">
                  <p class="text-sm text-white"><%= trade.mt5_account&.user&.email || 'N/A' %></p>
                  <p class="text-xs text-neutral-500"><%= trade.mt5_account&.account_name || 'N/A' %></p>
                </td>
                <td class="px-4 text-sm text-neutral-300"><%= trade.symbol %></td>
                <td class="px-4 text-sm text-neutral-300 text-right"><%= trade.volume %></td>
                <td class="px-4 text-right">
                  <span class="font-bold <%= trade.profit > 0 ? 'text-green-400' : 'text-red-400' %>">
                    <%= number_to_currency(trade.profit, unit: "€", format: "%n%u") %>
                  </span>
                </td>
                <td class="px-4 text-sm text-neutral-400"><%= trade.close_time&.strftime("%d/%m/%Y %H:%M") || '-' %></td>
                <td class="px-4">
                  <div class="flex items-center justify-end gap-1">
                    <% if trade.trade_originality == 'manual_pending_review' %>
                      <%= button_to approve_trade_admin_trade_defender_path(trade), method: :post, class: "flex items-center justify-center w-7 h-7 rounded-lg bg-green-600 text-white hover:bg-green-500 transition-colors", title: "Marquer comme mien" do %>
                        <i class="fa-solid fa-check text-xs"></i>
                      <% end %>
                      <%= button_to mark_as_client_trade_admin_trade_defender_path(trade), method: :post, data: { turbo_confirm: "Sanctionner ce trade ?" }, class: "flex items-center justify-center w-7 h-7 rounded-lg bg-red-600 text-white hover:bg-red-500 transition-colors", title: "Marquer comme client" do %>
                        <i class="fa-solid fa-exclamation text-xs"></i>
                      <% end %>
                    <% elsif trade.trade_originality == 'manual_admin' %>
                      <%= button_to mark_as_client_trade_admin_trade_defender_path(trade), method: :post, data: { turbo_confirm: "Appliquer la sanction ?" }, class: "flex items-center justify-center w-7 h-7 rounded-lg bg-red-600 text-white hover:bg-red-500 transition-colors", title: "→ Client" do %>
                        <i class="fa-solid fa-arrow-right text-xs"></i>
                      <% end %>
                    <% else %>
                      <%= button_to approve_trade_admin_trade_defender_path(trade), method: :post, class: "flex items-center justify-center w-7 h-7 rounded-lg bg-green-600 text-white hover:bg-green-500 transition-colors", title: "→ Mien" do %>
                        <i class="fa-solid fa-arrow-left text-xs"></i>
                      <% end %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      
      <div class="px-6 py-4 border-t border-neutral-800">
        <%= paginate @manual_trades %>
      </div>
    </div>
  <% else %>
    <%= render 'admin/shared/empty_state',
        icon: 'fa-check-circle',
        icon_gradient: 'from-green-500/20 to-emerald-500/20',
        icon_color: 'text-green-400',
        title: 'Aucun trade manuel détecté',
        description: 'Tous les trades sont conformes aux règles.' %>
  <% end %>

  <% if @accounts_with_manual_trades&.any? %>
    <div class="bg-neutral-900 rounded-xl p-6">
      <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
        <i class="fa-solid fa-users text-blue-400"></i>
        Comptes avec trades manuels
      </h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <% @accounts_with_manual_trades.each do |account| %>
          <% pending_count = account.trades.where(trade_originality: 'manual_pending_review').count %>
          <% client_count = account.trades.where(trade_originality: 'manual_client').count %>
          <% penalty = account.trades.where(trade_originality: 'manual_client').sum(:profit) %>
          <div class="bg-neutral-800 rounded-lg p-4">
            <p class="font-semibold text-white mb-1"><%= account.user&.email || 'N/A' %></p>
            <p class="text-xs text-neutral-500 mb-3"><%= account.account_name || 'N/A' %></p>
            <div class="space-y-1 text-sm">
              <% if pending_count > 0 %>
                <p class="text-amber-400"><i class="fa-solid fa-clock mr-1"></i> <%= pending_count %> en attente</p>
              <% end %>
              <% if client_count > 0 %>
                <p class="text-red-400"><i class="fa-solid fa-exclamation-triangle mr-1"></i> <%= client_count %> sanctionnés (<%= number_to_currency(penalty, unit: "€", format: "%n%u") %>)</p>
              <% end %>
            </div>
            <% if account.user.present? %>
              <%= link_to admin_client_path(account.user), class: "mt-3 inline-flex items-center gap-1.5 text-xs text-blue-400 hover:text-blue-300" do %>
                Voir le client <i class="fa-solid fa-arrow-right"></i>
              <% end %>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>

<script>
  function toggleAll(checkbox) {
    document.querySelectorAll('.trade-checkbox').forEach(function(cb) {
      cb.checked = checkbox.checked;
    });
  }
  
  function getSelectedTradeIds() {
    var ids = [];
    document.querySelectorAll('.trade-checkbox:checked').forEach(function(cb) {
      ids.push(cb.value);
    });
    return ids;
  }
  
  function markSelectedAsAdmin() {
    var ids = getSelectedTradeIds();
    if (ids.length === 0) {
      alert('Veuillez sélectionner au moins un trade');
      return;
    }
    
    if (!confirm('Marquer ' + ids.length + ' trades comme vôtres ?')) {
      return;
    }
    
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = '<%= bulk_mark_as_admin_admin_trade_defenders_path %>';
    
    var csrfToken = document.querySelector('meta[name="csrf-token"]').content;
    var csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'authenticity_token';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    ids.forEach(function(id) {
      var input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'trade_ids[]';
      input.value = id;
      form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
  }
  
  function markSelectedAsClient() {
    var ids = getSelectedTradeIds();
    if (ids.length === 0) {
      alert('Veuillez sélectionner au moins un trade');
      return;
    }
    
    if (!confirm('ATTENTION: Marquer ' + ids.length + ' trades comme clients et appliquer les sanctions ?')) {
      return;
    }
    
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = '<%= bulk_mark_as_client_admin_trade_defenders_path %>';
    
    var csrfToken = document.querySelector('meta[name="csrf-token"]').content;
    var csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'authenticity_token';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    ids.forEach(function(id) {
      var input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'trade_ids[]';
      input.value = id;
      form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
  }
</script>
