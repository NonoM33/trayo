<% @page_title = "Trades" %>

<div class="space-y-6">
  <%= render 'admin/shared/flash_messages' %>

  <% total_profit = @total_profit || 0 %>
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
    <%= render 'admin/shared/stat_card',
        icon: 'fa-chart-line',
        icon_color: 'blue',
        label: 'Total Trades',
        value: @total_trades || 0 %>
    
    <%= render 'admin/shared/stat_card',
        icon: 'fa-euro-sign',
        icon_color: total_profit >= 0 ? 'green' : 'red',
        label: 'Profit Total',
        value: number_to_currency(total_profit, unit: "€", format: "%n%u"),
        value_color: total_profit >= 0 ? 'green' : 'red' %>
    
    <%= render 'admin/shared/stat_card',
        icon: 'fa-percent',
        icon_color: 'purple',
        label: 'Taux de Réussite',
        value: "#{@win_rate || 0}%" %>
    
    <%= render 'admin/shared/stat_card',
        icon: 'fa-trophy',
        icon_color: 'amber',
        label: 'Gagnants / Perdants',
        value: "#{@winning_trades || 0} / #{@losing_trades || 0}" %>
  </div>

  <% if @magic_stats&.any? %>
    <div class="bg-neutral-900 rounded-xl p-6">
      <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
        <i class="fa-solid fa-robot text-cyan-400"></i>
        Statistiques par Bot
      </h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <% @magic_stats.first(8).each do |stat| %>
          <% 
            winning_count = Trade.where(magic_number: stat.magic_number).where('profit > 0').count
            total_count = stat.trades_count
            win_rate = total_count > 0 ? (winning_count.to_f / total_count * 100).round(1) : 0
          %>
          <div class="bg-neutral-800 rounded-lg p-4">
            <div class="flex items-center gap-2 mb-2">
              <span class="px-2 py-1 rounded text-xs font-mono bg-cyan-500/20 text-cyan-400"><%= bot_name_for_magic_number(stat.magic_number, @bots_cache) %></span>
            </div>
            <p class="text-2xl font-bold <%= stat.total_profit >= 0 ? 'text-green-400' : 'text-red-400' %>">
              <%= number_to_currency(stat.total_profit, unit: "€", format: "%n%u") %>
            </p>
            <p class="text-xs text-neutral-500"><%= stat.trades_count %> trades • <%= win_rate %>% win</p>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="bg-neutral-900 rounded-xl p-4">
    <%= form_with url: admin_trades_path, method: :get, local: true, class: "space-y-4" do |form| %>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-7 gap-4">
        <div>
          <label class="block text-sm font-medium text-neutral-400 mb-1.5">Client</label>
          <%= form.select :client_id, options_for_select([["Tous les clients", ""]] + @clients.map { |c| ["#{c.first_name} #{c.last_name}", c.id] }, params[:client_id]), {}, class: "w-full px-3 py-2.5 bg-neutral-800 border border-neutral-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-neutral-400 mb-1.5">Symbole</label>
          <%= form.select :symbol, options_for_select([["Tous", ""]] + @symbols.map { |s| [s, s] }, params[:symbol]), {}, class: "w-full px-3 py-2.5 bg-neutral-800 border border-neutral-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-neutral-400 mb-1.5">Bot</label>
          <%= form.select :magic_number, options_for_select([["Tous", ""]] + @magic_numbers.map { |m| ["Bot #{m}", m] }, params[:magic_number]), {}, class: "w-full px-3 py-2.5 bg-neutral-800 border border-neutral-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-neutral-400 mb-1.5">Profit</label>
          <%= form.select :profit_filter, options_for_select([["Tous", ""], ["Profitables", "positive"], ["Perdants", "negative"], ["Nuls", "zero"]], params[:profit_filter]), {}, class: "w-full px-3 py-2.5 bg-neutral-800 border border-neutral-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-neutral-400 mb-1.5">Date début</label>
          <%= form.date_field :date_from, value: params[:date_from], class: "w-full px-3 py-2.5 bg-neutral-800 border border-neutral-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-neutral-400 mb-1.5">Date fin</label>
          <%= form.date_field :date_to, value: params[:date_to], class: "w-full px-3 py-2.5 bg-neutral-800 border border-neutral-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-neutral-400 mb-1.5">Trier par</label>
          <%= form.select :sort, options_for_select([["Date", "close_time"], ["Client", "client"], ["Symbole", "symbol"], ["Profit", "profit"]], params[:sort]), {}, class: "w-full px-3 py-2.5 bg-neutral-800 border border-neutral-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
      </div>
      
      <div class="flex items-center gap-3">
        <%= form.submit "Filtrer", class: "flex items-center justify-center gap-2 rounded-lg bg-blue-600 px-4 py-2.5 text-sm font-medium text-white transition-colors hover:bg-blue-500 cursor-pointer" %>
        <%= link_to admin_trades_path, class: "flex items-center justify-center gap-2 rounded-lg border border-neutral-700 bg-neutral-800 px-4 py-2.5 text-sm font-medium text-neutral-300 transition-colors hover:bg-neutral-700 hover:text-white" do %>
          Réinitialiser
        <% end %>
        <%= link_to export_admin_trades_path(params.permit!), class: "flex items-center justify-center gap-2 rounded-lg border border-green-400/30 bg-green-600 px-4 py-2.5 text-sm font-medium text-white transition-colors hover:bg-green-500" do %>
          <i class="fa-solid fa-download"></i>
          Exporter CSV
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="relative w-full bg-neutral-950 rounded-xl overflow-hidden"
       data-controller="scroll-area"
       data-scroll-area-target="root"
       data-action="mouseenter->scroll-area#onRootMouseEnter mouseleave->scroll-area#onRootMouseLeave">

    <div class="px-6 py-5 flex items-center justify-between bg-neutral-900">
      <h2 class="text-lg font-semibold text-white flex items-center gap-2">
        <i class="fa-solid fa-exchange-alt text-blue-400"></i>
        Liste des Trades
      </h2>
    </div>

    <% if @trades&.any? %>
      <div data-scroll-area-target="viewport"
           data-action="scroll->scroll-area#onViewportScroll"
           class="max-h-[600px] overflow-auto scrollbar-hide bg-neutral-950">
        <table class="w-full min-w-[1200px] !bg-transparent !border-0">
          <thead class="sticky top-0 z-10 !bg-neutral-950">
            <tr class="*:py-3 *:text-left *:align-middle border-b border-neutral-800">
              <th scope="col" class="px-4 text-sm font-semibold text-neutral-100">Date</th>
              <th scope="col" class="px-4 text-sm font-semibold text-neutral-100">Client</th>
              <th scope="col" class="px-4 text-sm font-semibold text-neutral-100">Symbole</th>
              <th scope="col" class="px-4 text-sm font-semibold text-neutral-100 text-center">Type</th>
              <th scope="col" class="px-4 text-sm font-semibold text-neutral-100 text-right">Volume</th>
              <th scope="col" class="px-4 text-sm font-semibold text-neutral-100 text-right">Ouverture</th>
              <th scope="col" class="px-4 text-sm font-semibold text-neutral-100 text-right">Fermeture</th>
              <th scope="col" class="px-4 text-sm font-semibold text-neutral-100 text-right">Profit</th>
              <th scope="col" class="px-4 text-sm font-semibold text-neutral-100">Bot</th>
            </tr>
          </thead>
          <tbody class="*:even:bg-neutral-900/50 *:*:py-3 bg-neutral-950">
            <% @trades.each do |trade| %>
              <tr class="hover:bg-neutral-800 transition-colors">
                <td class="px-4">
                  <p class="text-sm text-white"><%= trade.close_time&.strftime("%d/%m/%Y") %></p>
                  <p class="text-xs text-neutral-500"><%= trade.close_time&.strftime("%H:%M") %></p>
                </td>
                <td class="px-4">
                  <%= link_to admin_client_path(trade.mt5_account.user), class: "text-blue-400 hover:text-blue-300 text-sm font-medium" do %>
                    <%= "#{trade.mt5_account.user.first_name} #{trade.mt5_account.user.last_name}".strip %>
                  <% end %>
                </td>
                <td class="px-4 text-sm font-medium text-white"><%= trade.symbol %></td>
                <td class="px-4 text-center">
                  <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-bold <%= trade.trade_type == 'buy' ? 'bg-green-500 text-white' : 'bg-red-500 text-white' %>">
                    <%= trade.trade_type&.upcase %>
                  </span>
                </td>
                <td class="px-4 text-sm text-neutral-300 text-right"><%= trade.volume %></td>
                <td class="px-4 text-sm text-neutral-400 text-right font-mono"><%= number_with_precision(trade.open_price, precision: 5) %></td>
                <td class="px-4 text-sm text-neutral-400 text-right font-mono"><%= number_with_precision(trade.close_price, precision: 5) %></td>
                <td class="px-4 text-right">
                  <span class="font-bold <%= trade.profit >= 0 ? 'text-green-400' : 'text-red-400' %>">
                    <%= number_to_currency(trade.profit, unit: "€", format: "%n%u") %>
                  </span>
                </td>
                <td class="px-4">
                  <% if trade.magic_number.present? %>
                    <span class="px-2 py-1 rounded text-xs font-mono bg-cyan-500/20 text-cyan-400"><%= bot_name_for_magic_number(trade.magic_number, @bots_cache) %></span>
                  <% else %>
                    <span class="text-neutral-500">—</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      
      <% if @trades.respond_to?(:current_page) %>
        <div class="px-6 py-4 border-t border-neutral-800">
          <%= paginate @trades %>
        </div>
      <% end %>
    <% else %>
      <%= render 'admin/shared/empty_state',
          icon: 'fa-chart-line',
          icon_gradient: 'from-blue-500/20 to-purple-500/20',
          icon_color: 'text-blue-400',
          title: 'Aucun trade trouvé',
          description: 'Aucun trade ne correspond aux critères de recherche.' %>
    <% end %>
  </div>
</div>
