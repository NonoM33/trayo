<% @page_title = 'Trades' %>
<% content_for :title, "Trades - Administration" %>

<div class="page-header">
  <div class="page-header-content">
    <div class="page-header-left">
      <h1>Trades - Administration</h1>
      <p class="page-description">Vue complète de tous les trades de tous les clients</p>
    </div>
    <div class="page-header-right">
      <%= link_to "Exporter CSV", export_admin_trades_path(params.permit!), class: "btn btn-outline" %>
    </div>
  </div>
</div>

<div class="page-content">
  <!-- Statistiques globales -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value"><%= @total_trades %></div>
      <div class="stat-label">Total Trades</div>
    </div>
    <div class="stat-card">
      <div class="stat-value <%= @total_profit >= 0 ? 'positive' : 'negative' %>">
        <%= number_to_currency(@total_profit, unit: "€", format: "%n %u") %>
      </div>
      <div class="stat-label">Profit Total</div>
    </div>
    <div class="stat-card">
      <div class="stat-value"><%= @win_rate %>%</div>
      <div class="stat-label">Taux de Réussite</div>
    </div>
    <div class="stat-card">
      <div class="stat-value"><%= @winning_trades %>/<%= @losing_trades %></div>
      <div class="stat-label">Gagnants/Perdants</div>
    </div>
  </div>

  <!-- Statistiques par Magic Number -->
  <% if @magic_stats.any? %>
    <div class="card">
      <h3>Statistiques par Bot (Magic Number)</h3>
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Magic Number</th>
              <th>Nombre de Trades</th>
              <th>Profit Total</th>
              <th>Profit Moyen</th>
              <th>Taux de Réussite</th>
            </tr>
          </thead>
          <tbody>
            <% @magic_stats.each do |stat| %>
              <% 
                winning_count = Trade.where(magic_number: stat.magic_number).where('profit > 0').count
                total_count = stat.trades_count
                win_rate = total_count > 0 ? (winning_count.to_f / total_count * 100).round(2) : 0
              %>
              <tr>
                <td>
                  <span class="magic-number"><%= bot_name_for_magic_number(stat.magic_number, @bots_cache) %></span>
                </td>
                <td><%= stat.trades_count %></td>
                <td class="<%= stat.total_profit >= 0 ? 'positive' : 'negative' %>">
                  <%= number_to_currency(stat.total_profit, unit: "€", format: "%n %u") %>
                </td>
                <td class="<%= stat.avg_profit >= 0 ? 'positive' : 'negative' %>">
                  <%= number_to_currency(stat.avg_profit, unit: "€", format: "%n %u") %>
                </td>
                <td><%= win_rate %>%</td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <!-- Filtres -->
  <div class="filters-section">
    <%= form_with url: admin_trades_path, method: :get, local: true, class: "filters-form" do |form| %>
      <div class="filters-grid">
        <div class="filter-group">
          <%= form.label :client_id, "Client", class: "filter-label" %>
          <%= form.select :client_id, options_for_select([["Tous les clients", ""]] + @clients.map { |c| ["#{c.first_name} #{c.last_name}", c.id] }, params[:client_id]), {}, { class: "filter-select" } %>
        </div>
        
        <div class="filter-group">
          <%= form.label :symbol, "Symbole", class: "filter-label" %>
          <%= form.select :symbol, options_for_select([["Tous les symboles", ""]] + @symbols.map { |s| [s, s] }, params[:symbol]), {}, { class: "filter-select" } %>
        </div>
        
        <div class="filter-group">
          <%= form.label :magic_number, "Bot (Magic Number)", class: "filter-label" %>
          <%= form.select :magic_number, options_for_select([["Tous les bots", ""]] + @magic_numbers.map { |m| ["Bot #{m}", m] }, params[:magic_number]), {}, { class: "filter-select" } %>
        </div>
        
        <div class="filter-group">
          <%= form.label :profit_filter, "Filtre Profit", class: "filter-label" %>
          <%= form.select :profit_filter, options_for_select([
            ["Tous", ""],
            ["Profitables", "positive"],
            ["Perdants", "negative"],
            ["Nuls", "zero"]
          ], params[:profit_filter]), {}, { class: "filter-select" } %>
        </div>
        
        <div class="filter-group">
          <%= form.label :date_from, "Date de début", class: "filter-label" %>
          <%= form.date_field :date_from, value: params[:date_from], class: "filter-input" %>
        </div>
        
        <div class="filter-group">
          <%= form.label :date_to, "Date de fin", class: "filter-label" %>
          <%= form.date_field :date_to, value: params[:date_to], class: "filter-input" %>
        </div>
        
        <div class="filter-group">
          <%= form.label :sort, "Trier par", class: "filter-label" %>
          <%= form.select :sort, options_for_select([
            ["Date de fermeture", "close_time"],
            ["Client", "client"],
            ["Symbole", "symbol"],
            ["Profit", "profit"],
            ["Bot (Magic Number)", "magic_number"]
          ], params[:sort]), {}, { class: "filter-select" } %>
        </div>
        
        <div class="filter-actions">
          <%= form.submit "Filtrer", class: "btn btn-primary" %>
          <%= link_to "Réinitialiser", admin_trades_path, class: "btn btn-outline" %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Table des trades -->
  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Client</th>
          <th>Compte MT5</th>
          <th>Symbole</th>
          <th>Type</th>
          <th>Volume</th>
          <th>Prix Ouverture</th>
          <th>Prix Fermeture</th>
          <th>Profit</th>
          <th>Commission</th>
          <th>Swap</th>
          <th>Bot</th>
          <th>Commentaire</th>
        </tr>
      </thead>
      <tbody>
        <% @trades.each do |trade| %>
          <tr>
            <td>
              <div class="date-cell">
                <%= trade.close_time&.strftime("%d/%m/%Y") %>
                <small><%= trade.close_time&.strftime("%H:%M") %></small>
              </div>
            </td>
            <td>
              <%= link_to "#{trade.mt5_account.user.first_name} #{trade.mt5_account.user.last_name}", 
                          admin_client_path(trade.mt5_account.user), 
                          class: "client-link" %>
            </td>
            <td><%= trade.mt5_account.account_name %></td>
            <td><%= trade.symbol %></td>
            <td>
              <span class="trade-type <%= trade.trade_type %>">
                <%= trade.trade_type&.upcase %>
              </span>
            </td>
            <td><%= trade.volume %></td>
            <td><%= number_with_precision(trade.open_price, precision: 5) %></td>
            <td><%= number_with_precision(trade.close_price, precision: 5) %></td>
            <td>
              <span class="profit-value <%= trade.profit >= 0 ? 'positive' : 'negative' %>">
                <%= number_to_currency(trade.profit, unit: "€", format: "%n %u") %>
              </span>
            </td>
            <td><%= number_to_currency(trade.commission, unit: "€", format: "%n %u") %></td>
            <td><%= number_to_currency(trade.swap, unit: "€", format: "%n %u") %></td>
            <td>
              <% if trade.magic_number.present? %>
                <span class="magic-number"><%= bot_name_for_magic_number(trade.magic_number, @bots_cache) %></span>
              <% else %>
                <span class="text-muted">-</span>
              <% end %>
            </td>
            <td>
              <% if trade.comment.present? %>
                <span class="comment-text" title="<%= trade.comment %>">
                  <%= truncate(trade.comment, length: 30) %>
                </span>
              <% else %>
                <span class="text-muted">-</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    
    <% if @trades.empty? %>
      <div class="empty-state">
        <div class="empty-state-icon">
          <i class="fa-icon fa-lg fa-chart-line"></i>
        </div>
        <h3>Aucun trade trouvé</h3>
        <p>Aucun trade ne correspond aux critères de recherche.</p>
      </div>
    <% end %>
  </div>

  <!-- Pagination -->
  <% if @trades.respond_to?(:current_page) %>
    <div class="pagination-container">
      <%= paginate @trades, theme: 'github' %>
    </div>
  <% end %>
</div>

<style>
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 1.5rem;
  text-align: center;
}

.stat-value {
  font-size: 2rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.stat-value.positive {
  color: var(--success-color);
}

.stat-value.negative {
  color: var(--error-color);
}

.stat-label {
  color: var(--text-muted);
  font-size: 0.875rem;
}

.filters-section {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 1.5rem;
  margin-bottom: 2rem;
}

.filters-form {
  width: 100%;
}

.filters-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  align-items: end;
}

.filter-group {
  display: flex;
  flex-direction: column;
}

.filter-label {
  font-weight: 500;
  margin-bottom: 0.5rem;
  color: var(--text-color);
}

.filter-select,
.filter-input {
  padding: 0.75rem;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  background: var(--input-bg);
  color: var(--text-color);
}

.filter-actions {
  display: flex;
  gap: 0.5rem;
  align-items: end;
}

.date-cell {
  display: flex;
  flex-direction: column;
}

.date-cell small {
  color: var(--text-muted);
  font-size: 0.75rem;
}

.trade-type {
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
}

.trade-type.buy {
  background: var(--success-color);
  color: white;
}

.trade-type.sell {
  background: var(--error-color);
  color: white;
}

.profit-value {
  font-weight: 600;
}

.profit-value.positive {
  color: var(--success-color);
}

.profit-value.negative {
  color: var(--error-color);
}

.magic-number {
  background: var(--primary-color);
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
}

.comment-text {
  font-size: 0.875rem;
  color: var(--text-muted);
}

.client-link {
  color: var(--primary-color);
  text-decoration: none;
  font-weight: 500;
}

.client-link:hover {
  text-decoration: underline;
}

.pagination-container {
  margin-top: 2rem;
  display: flex;
  justify-content: center;
}

/* Pagination GitHub Style */
.pagination {
  display: inline-block;
  padding-left: 0;
  margin: 20px 0;
  border-radius: 4px;
}

.pagination > li {
  display: inline;
}

.pagination > li > a,
.pagination > li > span {
  position: relative;
  float: left;
  padding: 6px 12px;
  margin-left: -1px;
  line-height: 1.42857143;
  color: #337ab7;
  text-decoration: none;
  background-color: #fff;
  border: 1px solid #ddd;
}

.pagination > li:first-child > a,
.pagination > li:first-child > span {
  margin-left: 0;
  border-top-left-radius: 4px;
  border-bottom-left-radius: 4px;
}

.pagination > li:last-child > a,
.pagination > li:last-child > span {
  border-top-right-radius: 4px;
  border-bottom-right-radius: 4px;
}

.pagination > li > a:hover,
.pagination > li > span:hover,
.pagination > li > a:focus,
.pagination > li > span:focus {
  color: #23527c;
  background-color: #eee;
  border-color: #ddd;
}

.pagination > .active > a,
.pagination > .active > span,
.pagination > .active > a:hover,
.pagination > .active > span:hover,
.pagination > .active > a:focus,
.pagination > .active > span:focus {
  z-index: 2;
  color: #fff;
  cursor: default;
  background-color: #337ab7;
  border-color: #337ab7;
}

.pagination > .disabled > span,
.pagination > .disabled > span:hover,
.pagination > .disabled > span:focus,
.pagination > .disabled > a,
.pagination > .disabled > a:hover,
.pagination > .disabled > a:focus {
  color: #777;
  cursor: not-allowed;
  background-color: #fff;
  border-color: #ddd;
}

.empty-state {
  text-align: center;
  padding: 3rem;
  color: var(--text-muted);
}

.empty-state-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.empty-state h3 {
  margin-bottom: 0.5rem;
  color: var(--text-color);
}

@media (max-width: 768px) {
  .filters-grid {
    grid-template-columns: 1fr;
  }
  
  .filter-actions {
    justify-content: stretch;
  }
  
  .filter-actions .btn {
    flex: 1;
  }
}
</style>
