<% @page_title = "Retraits" %>

<div class="space-y-6">
  <%= render 'admin/shared/flash_messages' %>

  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
    <%= render 'admin/shared/stat_card',
        icon: 'fa-arrow-up',
        icon_color: 'red',
        label: 'Total Retraits',
        value: @withdrawals.respond_to?(:total_count) ? @withdrawals.total_count : @withdrawals.count %>
    
    <%= render 'admin/shared/stat_card',
        icon: 'fa-euro-sign',
        icon_color: 'amber',
        label: 'Montant Total',
        value: number_to_currency(@withdrawals.sum(:amount), unit: "€", format: "%n%u"),
        value_color: 'red' %>
    
    <%= render 'admin/shared/stat_card',
        icon: 'fa-chart-line',
        icon_color: 'purple',
        label: 'Montant Moyen',
        value: number_to_currency(@withdrawals.average(:amount) || 0, unit: "€", format: "%n%u") %>
    
    <%= render 'admin/shared/stat_card',
        icon: 'fa-users',
        icon_color: 'blue',
        label: 'Comptes Actifs',
        value: Withdrawal.select(:mt5_account_id).distinct.count %>
  </div>

  <div class="relative w-full bg-neutral-950 rounded-xl overflow-hidden"
       data-controller="scroll-area"
       data-scroll-area-target="root"
       data-action="mouseenter->scroll-area#onRootMouseEnter mouseleave->scroll-area#onRootMouseLeave">

    <div class="px-6 py-5 flex flex-col md:flex-row md:items-center md:justify-between gap-4 bg-neutral-900">
      <h2 class="text-lg font-semibold text-white flex items-center gap-2">
        <i class="fa-solid fa-arrow-up text-red-400"></i>
        Tous les Retraits
      </h2>
      <%= link_to new_admin_withdrawal_path, class: "flex items-center justify-center gap-1.5 rounded-lg border border-blue-400/30 bg-blue-600 px-3.5 py-2 text-sm font-medium whitespace-nowrap text-white shadow-sm transition-all hover:bg-blue-500" do %>
        <i class="fa-solid fa-plus"></i>
        <span>Ajouter un retrait</span>
      <% end %>
    </div>

    <% if @withdrawals&.any? %>
      <div data-scroll-area-target="viewport"
           data-action="scroll->scroll-area#onViewportScroll"
           class="max-h-[600px] overflow-auto scrollbar-hide bg-neutral-950">
        <table class="w-full min-w-[800px] !bg-transparent !border-0">
          <thead class="sticky top-0 z-10 !bg-neutral-950">
            <tr class="*:py-3 *:text-left *:align-middle border-b border-neutral-800">
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100">Date</th>
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100">Client</th>
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100">Compte MT5</th>
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100 text-right">Montant</th>
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100">Notes</th>
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100 text-right">Actions</th>
            </tr>
          </thead>
          <tbody class="*:even:bg-neutral-900/50 *:*:py-4 bg-neutral-950">
            <% @withdrawals.each do |withdrawal| %>
              <tr class="hover:bg-neutral-800 transition-colors">
                <td class="px-6 text-sm text-neutral-300"><%= withdrawal.withdrawal_date&.strftime("%d/%m/%Y") %></td>
                <td class="px-6">
                  <% if withdrawal.mt5_account&.user.present? %>
                    <%= render 'admin/shared/avatar', user: withdrawal.mt5_account.user, size: 'sm', link: admin_client_path(withdrawal.mt5_account.user) %>
                  <% else %>
                    <span class="text-sm text-neutral-500 italic">—</span>
                  <% end %>
                </td>
                <td class="px-6 text-sm text-neutral-400"><%= withdrawal.mt5_account&.account_name || "—" %></td>
                <td class="px-6 text-right">
                  <span class="text-lg font-bold text-red-400">-<%= number_to_currency(withdrawal.amount, unit: "€", format: "%n%u") %></span>
                </td>
                <td class="px-6 text-sm text-neutral-400"><%= withdrawal.notes.present? ? truncate(withdrawal.notes, length: 30) : "—" %></td>
                <td class="px-6">
                  <div class="flex items-center justify-end gap-2">
                    <% if defined?(edit_admin_withdrawal_path) %>
                      <%= link_to edit_admin_withdrawal_path(withdrawal), class: "flex items-center justify-center w-8 h-8 rounded-lg border border-amber-400/30 bg-amber-500 text-white hover:bg-amber-400 transition-colors", title: "Modifier" do %>
                        <i class="fa-solid fa-pen text-xs"></i>
                      <% end %>
                    <% end %>
                    <%= button_to admin_withdrawal_path(withdrawal), method: :delete, data: { turbo_confirm: "Supprimer ce retrait ?" }, class: "flex items-center justify-center w-8 h-8 rounded-lg border border-red-400/30 bg-red-600 text-white hover:bg-red-500 transition-colors", title: "Supprimer" do %>
                      <i class="fa-solid fa-trash text-xs"></i>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      
      <% if @withdrawals.respond_to?(:current_page) %>
        <div class="px-6 py-4 border-t border-neutral-800">
          <%= paginate @withdrawals %>
        </div>
      <% end %>
    <% else %>
      <%= render 'admin/shared/empty_state',
          icon: 'fa-arrow-up',
          icon_gradient: 'from-red-500/20 to-orange-500/20',
          icon_color: 'text-red-400',
          title: 'Aucun retrait',
          description: 'Les retraits apparaîtront ici une fois enregistrés.',
          button_label: 'Ajouter un retrait',
          button_href: new_admin_withdrawal_path %>
    <% end %>
  </div>
</div>
