<% content_for :title, @bot.name %>

<div class="space-y-6">
  <!-- Back Link -->
  <%= link_to admin_shop_index_path, class: "inline-flex items-center gap-2 text-neutral-400 hover:text-white transition-colors mb-4" do %>
    <i class="fa-solid fa-arrow-left"></i>
    Retour √† la Boutique
  <% end %>

  <!-- Flash Messages -->
  <% if flash[:notice] %>
    <div class="rounded-xl bg-emerald-500/10 border border-emerald-500/30 p-4 flex items-center gap-3">
      <i class="fa-solid fa-check-circle text-emerald-400"></i>
      <p class="text-emerald-300 font-medium"><%= flash[:notice] %></p>
    </div>
  <% end %>
  <% if flash[:alert] %>
    <div class="rounded-xl bg-red-500/10 border border-red-500/30 p-4 flex items-center gap-3">
      <i class="fa-solid fa-exclamation-circle text-red-400"></i>
      <p class="text-red-300 font-medium"><%= flash[:alert] %></p>
    </div>
  <% end %>

  <!-- Hero Section -->
  <div class="rounded-2xl bg-gradient-to-br from-blue-600 to-purple-700 p-8 md:p-12 text-center relative overflow-hidden">
    <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/4"></div>
    <div class="absolute bottom-0 left-0 w-48 h-48 bg-white/5 rounded-full translate-y-1/2 -translate-x-1/4"></div>
    
    <div class="relative">
      <div class="w-20 h-20 rounded-2xl bg-white/20 backdrop-blur flex items-center justify-center mx-auto mb-6">
        <i class="fa-solid fa-robot text-white text-3xl"></i>
      </div>
      
      <h1 class="text-3xl md:text-4xl font-extrabold text-white mb-3"><%= @bot.name %></h1>
      <p class="text-xl text-white/90 mb-4"><%= @bot.marketing_tagline %></p>
      
      <span class="inline-flex px-4 py-1.5 rounded-full text-sm font-semibold bg-white/20 text-white mb-6">
        <%= @bot.risk_label %>
      </span>
      
      <div class="text-4xl md:text-5xl font-black text-white mb-8"><%= @bot.formatted_price %></div>
      
      <% cart_bots = session[:cart]&.dig(:bots) || [] %>
      <% if @already_owned %>
        <%= link_to admin_my_bots_path, class: "inline-flex items-center gap-2 px-8 py-4 rounded-xl bg-emerald-500 text-white font-bold text-lg hover:bg-emerald-600 transition-all shadow-lg" do %>
          <i class="fa-solid fa-check-circle"></i>
          D√©j√† Poss√©d√© - Voir Mes Bots
        <% end %>
      <% elsif cart_bots.include?(@bot.id) %>
        <div class="inline-flex flex-col items-center gap-3">
          <div class="px-8 py-4 rounded-xl bg-amber-500/20 border-2 border-amber-400 text-amber-300 font-bold text-lg flex items-center gap-2">
            <i class="fa-solid fa-check"></i>
            Dans votre panier
          </div>
          <%= link_to admin_cart_path, class: "px-6 py-3 rounded-xl bg-white text-blue-600 font-bold hover:bg-neutral-100 transition-all shadow-lg flex items-center gap-2" do %>
            <i class="fa-solid fa-shopping-cart"></i>
            Voir le panier
          <% end %>
        </div>
      <% else %>
        <%= button_to add_bot_admin_cart_path(@bot), method: :post, class: "inline-flex items-center gap-2 px-8 py-4 rounded-xl bg-white text-blue-600 font-bold text-lg hover:bg-neutral-100 transition-all shadow-lg cursor-pointer border-none" do %>
          <i class="fa-solid fa-cart-plus"></i>
          Ajouter au panier
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- Stats Grid -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-5 text-center hover:border-neutral-700 transition-colors">
      <div class="text-3xl mb-2">üìà</div>
      <div class="text-xl font-bold text-emerald-400">
        <%= number_to_currency(@bot.projection_monthly_min, unit: "‚Ç¨", format: "%n%u", precision: 0) %> - 
        <%= number_to_currency(@bot.projection_monthly_max, unit: "‚Ç¨", format: "%n%u", precision: 0) %>
      </div>
      <div class="text-xs text-neutral-500 uppercase tracking-wide mt-1">Gain Mensuel</div>
    </div>
    
    <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-5 text-center hover:border-neutral-700 transition-colors">
      <div class="text-3xl mb-2"><i class="fa-solid fa-bullseye text-blue-400"></i></div>
      <div class="text-xl font-bold text-white"><%= number_to_percentage(@bot.win_rate, precision: 0) %></div>
      <div class="text-xs text-neutral-500 uppercase tracking-wide mt-1">Taux de R√©ussite</div>
    </div>
    
    <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-5 text-center hover:border-neutral-700 transition-colors">
      <div class="text-3xl mb-2"><i class="fa-solid fa-wallet text-purple-400"></i></div>
      <div class="text-xl font-bold text-emerald-400"><%= number_to_currency(@bot.projection_yearly, unit: "‚Ç¨", format: "%n%u", precision: 0) %></div>
      <div class="text-xs text-neutral-500 uppercase tracking-wide mt-1">Gain Annuel</div>
    </div>
    
    <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-5 text-center hover:border-neutral-700 transition-colors">
      <div class="text-3xl mb-2"><i class="fa-solid fa-shield-halved text-amber-400"></i></div>
      <div class="text-xl font-bold text-white"><%= number_to_percentage(@bot.max_drawdown_limit, precision: 1) %></div>
      <div class="text-xs text-neutral-500 uppercase tracking-wide mt-1">Drawdown Max</div>
    </div>
  </div>

  <!-- Projection Chart -->
  <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-6">
    <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
      <i class="fa-solid fa-chart-area text-blue-400"></i>
      Projection Interactive
    </h2>
    <div class="relative h-80">
      <canvas id="projectionChart"></canvas>
    </div>
  </div>

  <!-- Calculator -->
  <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-6">
    <h3 class="text-xl font-bold text-white text-center mb-6 flex items-center justify-center gap-2">
      <i class="fa-solid fa-calculator text-amber-400"></i>
      Vos Gains Potentiels avec <%= @bot.name %>
    </h3>
    
    <% user_capital = current_user.mt5_accounts.sum(:balance).to_f %>
    <% user_capital = 10000 if user_capital < 1000 %>
    
    <!-- Current Capital -->
    <div class="rounded-xl bg-blue-500/10 border-l-4 border-blue-500 p-4 mb-6">
      <div class="text-sm text-neutral-400 mb-1 flex items-center gap-2">
        <i class="fa-solid fa-wallet"></i>
        Votre Capital Actuel
      </div>
      <div class="text-3xl font-extrabold text-blue-400">
        <%= number_to_currency(user_capital, unit: "‚Ç¨", format: "%n%u", precision: 0) %>
      </div>
      <% if current_user.mt5_accounts.any? %>
        <div class="text-xs text-neutral-500 mt-1">
          Calcul√© depuis <%= current_user.mt5_accounts.count %> compte(s) MT5
        </div>
      <% end %>
    </div>
    
    <!-- Slider -->
    <div class="mb-6">
      <label class="block text-sm font-medium text-neutral-300 mb-3">
        Ajustez Votre Capital : <strong class="text-white"><span id="capitalDisplay"><%= user_capital.to_i %></span> ‚Ç¨</strong>
      </label>
      <input type="range" id="capitalInput" 
             class="w-full h-2 rounded-full bg-neutral-700 appearance-none cursor-pointer accent-blue-500"
             min="1000" max="<%= [user_capital * 2, 100000].max.to_i %>" step="1000" value="<%= user_capital.to_i %>">
      <div class="text-xs text-neutral-500 mt-2">
        D√©placez le curseur pour simuler avec un capital diff√©rent
      </div>
    </div>
    
    <!-- Results -->
    <div class="grid grid-cols-3 gap-4 mb-6">
      <div class="rounded-xl bg-neutral-800/50 border border-neutral-700 p-4 text-center">
        <div class="text-xs text-neutral-500 uppercase tracking-wide mb-2">Dans 1 Mois</div>
        <div class="text-2xl font-bold text-emerald-400" id="gain1Month">-</div>
        <div class="text-xs text-neutral-500 mt-1">Balance: <span id="balance1Month">-</span></div>
      </div>
      <div class="rounded-xl bg-neutral-800/50 border border-neutral-700 p-4 text-center">
        <div class="text-xs text-neutral-500 uppercase tracking-wide mb-2">Dans 6 Mois</div>
        <div class="text-2xl font-bold text-emerald-400" id="gain6Months">-</div>
        <div class="text-xs text-neutral-500 mt-1">Balance: <span id="balance6Months">-</span></div>
      </div>
      <div class="rounded-xl bg-neutral-800/50 border border-neutral-700 p-4 text-center">
        <div class="text-xs text-neutral-500 uppercase tracking-wide mb-2">Dans 1 An</div>
        <div class="text-2xl font-bold text-emerald-400" id="gain1Year">-</div>
        <div class="text-xs text-neutral-500 mt-1">Balance: <span id="balance1Year">-</span></div>
      </div>
    </div>
    
    <!-- ROI -->
    <div class="rounded-xl bg-emerald-500/10 border border-emerald-500/30 p-5 text-center">
      <div class="text-sm text-neutral-400 mb-2">üíé ROI Estim√© sur 1 An</div>
      <div class="text-4xl font-black text-emerald-400" id="roiDisplay">-</div>
    </div>
  </div>

  <!-- Strategy Description -->
  <% if @bot.strategy_description.present? %>
    <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-6">
      <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
        <i class="fa-solid fa-chess text-purple-400"></i>
        Strat√©gie de Trading
      </h2>
      <p class="text-neutral-300 leading-relaxed whitespace-pre-wrap"><%= @bot.strategy_description %></p>
    </div>
  <% end %>

  <!-- Features -->
  <% if @bot.features_list.any? %>
    <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-6">
      <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
        <i class="fa-solid fa-sparkles text-amber-400"></i>
        Caract√©ristiques Cl√©s
      </h2>
      <ul class="space-y-3">
        <% @bot.features_list.each do |feature| %>
          <li class="flex items-center gap-3 p-3 rounded-lg bg-neutral-800/50 border border-neutral-700 hover:border-neutral-600 transition-colors">
            <i class="fa-solid fa-check-circle text-emerald-400"></i>
            <span class="text-neutral-200"><%= feature %></span>
          </li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- Social Proof -->
  <% if @bot.active_users_count > 0 %>
    <div class="rounded-xl bg-blue-500/10 border border-blue-500/30 p-6">
      <h3 class="font-semibold text-white mb-2 flex items-center gap-2">
        <i class="fa-solid fa-users text-blue-400"></i>
        Preuve Sociale
      </h3>
      <p class="text-lg text-blue-300">
        <strong><%= @bot.active_users_count %></strong> <%= @bot.active_users_count == 1 ? 'trader utilise' : 'traders utilisent' %> d√©j√† ce bot avec succ√®s !
      </p>
    </div>
  <% end %>

  <!-- Final CTA -->
  <div class="rounded-2xl bg-gradient-to-r from-blue-600 to-purple-600 p-8 text-center">
    <h2 class="text-2xl font-bold text-white mb-6">Pr√™t √† Automatiser Vos Trades ?</h2>
    <% if @already_owned %>
      <%= link_to admin_my_bots_path, class: "inline-flex items-center gap-2 px-8 py-4 rounded-xl bg-emerald-500 text-white font-bold text-lg hover:bg-emerald-600 transition-all shadow-lg" do %>
        <i class="fa-solid fa-check-circle"></i>
        Aller √† Mes Bots
      <% end %>
    <% elsif cart_bots.include?(@bot.id) %>
      <%= link_to admin_cart_path, class: "inline-flex items-center gap-2 px-8 py-4 rounded-xl bg-white text-blue-600 font-bold text-lg hover:bg-neutral-100 transition-all shadow-lg" do %>
        <i class="fa-solid fa-shopping-cart"></i>
        Finaliser ma commande
      <% end %>
    <% else %>
      <%= button_to add_bot_admin_cart_path(@bot), method: :post, class: "inline-flex items-center gap-2 px-8 py-4 rounded-xl bg-white text-blue-600 font-bold text-lg hover:bg-neutral-100 transition-all shadow-lg cursor-pointer border-none" do %>
        <i class="fa-solid fa-cart-plus"></i>
        Ajouter <%= @bot.name %> au panier
      <% end %>
    <% end %>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" data-turbo-track="reload"></script>
<script data-turbo-track="reload">
  const monthlyAvg = <%= @bot.projected_monthly_average %>;
  const monthlyMin = <%= @bot.projection_monthly_min %>;
  const monthlyMax = <%= @bot.projection_monthly_max %>;
  const userCapital = <%= current_user.mt5_accounts.sum(:balance).to_f > 1000 ? current_user.mt5_accounts.sum(:balance).to_f : 10000 %>;
  
  function initializeProjectionChart() {
    const ctx = document.getElementById('projectionChart');
    if (!ctx) return;
    
    if (window.projectionChartInstance) {
      window.projectionChartInstance.destroy();
    }
    
    const labels = [];
    const withoutBot = [];
    const withBotMin = [];
    const withBotMax = [];
    
    for (let i = 0; i <= 12; i++) {
      labels.push(`Mois ${i}`);
      withoutBot.push(userCapital);
      withBotMin.push(userCapital + (monthlyMin * i));
      withBotMax.push(userCapital + (monthlyMax * i));
    }
    
    window.projectionChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Sans Bot',
            data: withoutBot,
            borderColor: '#6b7280',
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 0,
            tension: 0
          },
          {
            label: 'Avec Bot (Min)',
            data: withBotMin,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 3,
            fill: '+1',
            pointRadius: 3,
            tension: 0.4
          },
          {
            label: 'Avec Bot (Max)',
            data: withBotMax,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.2)',
            borderWidth: 3,
            pointRadius: 3,
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { intersect: false, mode: 'index' },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              color: '#e5e7eb',
              font: { size: 12, weight: '600' },
              padding: 15,
              usePointStyle: true
            }
          },
          tooltip: {
            backgroundColor: 'rgba(23, 23, 23, 0.95)',
            titleColor: '#fff',
            bodyColor: '#d1d5db',
            borderColor: '#404040',
            borderWidth: 1,
            padding: 12,
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.y.toLocaleString('fr-FR') + ' ‚Ç¨';
              }
            }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { color: '#9ca3af', font: { size: 11 } }
          },
          y: {
            beginAtZero: false,
            grid: { color: 'rgba(255, 255, 255, 0.05)' },
            ticks: {
              color: '#9ca3af',
              font: { size: 11 },
              callback: function(value) {
                return value.toLocaleString('fr-FR') + ' ‚Ç¨';
              }
            }
          }
        }
      }
    });
  }
  
  function updateCalculator() {
    const capital = parseInt(document.getElementById('capitalInput').value);
    document.getElementById('capitalDisplay').textContent = capital.toLocaleString('fr-FR');
    
    const gain1Month = monthlyAvg;
    const gain6Months = monthlyAvg * 6;
    const gain1Year = monthlyAvg * 12;
    
    document.getElementById('gain1Month').textContent = '+' + gain1Month.toLocaleString('fr-FR', { maximumFractionDigits: 0 }) + ' ‚Ç¨';
    document.getElementById('gain6Months').textContent = '+' + gain6Months.toLocaleString('fr-FR', { maximumFractionDigits: 0 }) + ' ‚Ç¨';
    document.getElementById('gain1Year').textContent = '+' + gain1Year.toLocaleString('fr-FR', { maximumFractionDigits: 0 }) + ' ‚Ç¨';
    
    document.getElementById('balance1Month').textContent = (capital + gain1Month).toLocaleString('fr-FR', { maximumFractionDigits: 0 }) + ' ‚Ç¨';
    document.getElementById('balance6Months').textContent = (capital + gain6Months).toLocaleString('fr-FR', { maximumFractionDigits: 0 }) + ' ‚Ç¨';
    document.getElementById('balance1Year').textContent = (capital + gain1Year).toLocaleString('fr-FR', { maximumFractionDigits: 0 }) + ' ‚Ç¨';
    
    const roi = ((gain1Year / capital) * 100);
    document.getElementById('roiDisplay').textContent = '+' + roi.toLocaleString('fr-FR', { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + '%';
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    initializeProjectionChart();
    updateCalculator();
    const input = document.getElementById('capitalInput');
    if (input) input.addEventListener('input', updateCalculator);
  });
  
  document.addEventListener('turbo:load', function() {
    initializeProjectionChart();
    updateCalculator();
    const input = document.getElementById('capitalInput');
    if (input) input.addEventListener('input', updateCalculator);
  });
</script>
