<% @page_title = "Périodes Bonus" %>

<div class="space-y-6">
  <%= render 'admin/shared/flash_messages' %>

  <% if @current_period %>
    <div class="bg-green-500/10 rounded-xl p-6">
      <div class="flex items-start gap-4">
        <div class="w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center text-green-400 shrink-0">
          <i class="fa-solid fa-check-circle text-xl"></i>
        </div>
        <div class="flex-1">
          <h3 class="text-lg font-semibold text-green-400 mb-2">Période Bonus Active</h3>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div>
              <p class="text-sm text-neutral-400">Nom</p>
              <p class="font-semibold text-white"><%= @current_period.name || "Sans nom" %></p>
            </div>
            <div>
              <p class="text-sm text-neutral-400">Taux de Bonus</p>
              <p class="font-bold text-green-400 text-xl"><%= number_to_percentage(@current_period.bonus_percentage, precision: 1) %></p>
            </div>
            <div>
              <p class="text-sm text-neutral-400">Période</p>
              <p class="text-white"><%= @current_period.start_date.strftime("%d/%m/%Y") %> - <%= @current_period.end_date.strftime("%d/%m/%Y") %></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <div class="bg-amber-500/10 rounded-xl p-6">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-xl bg-amber-500/20 flex items-center justify-center text-amber-400 shrink-0">
          <i class="fa-solid fa-exclamation-triangle text-xl"></i>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-amber-400">Aucune Période Active</h3>
          <p class="text-neutral-400 text-sm">Créez une période pour activer le programme bonus.</p>
        </div>
      </div>
    </div>
  <% end %>

  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
    <%= render 'admin/shared/stat_card',
        icon: 'fa-calendar',
        icon_color: 'purple',
        label: 'Total Périodes',
        value: @bonus_periods&.count || 0 %>
    
    <%= render 'admin/shared/stat_card',
        icon: 'fa-check',
        icon_color: 'green',
        label: 'Actives',
        value: @bonus_periods&.select(&:active)&.count || 0,
        value_color: 'green' %>
    
    <%= render 'admin/shared/stat_card',
        icon: 'fa-clock',
        icon_color: 'blue',
        label: 'À Venir',
        value: @bonus_periods&.select { |p| p.active && p.start_date > Date.current }&.count || 0,
        value_color: 'blue' %>
    
    <%= render 'admin/shared/stat_card',
        icon: 'fa-percent',
        icon_color: 'cyan',
        label: 'Bonus Moyen',
        value: @bonus_periods&.any? ? "#{(@bonus_periods.sum(&:bonus_percentage) / @bonus_periods.count).round(1)}%" : "0%",
        value_color: 'cyan' %>
  </div>

  <div class="relative w-full bg-neutral-950 rounded-xl overflow-hidden"
       data-controller="scroll-area"
       data-scroll-area-target="root"
       data-action="mouseenter->scroll-area#onRootMouseEnter mouseleave->scroll-area#onRootMouseLeave">

    <div class="px-6 py-5 flex flex-col md:flex-row md:items-center md:justify-between gap-4 bg-neutral-900">
      <h2 class="text-lg font-semibold text-white flex items-center gap-2">
        <i class="fa-solid fa-gift text-purple-400"></i>
        Périodes de Bonus
      </h2>
      
      <div data-controller="slideover" id="new-period-slideover">
        <button type="button" data-action="slideover#show:prevent" class="flex items-center justify-center gap-1.5 rounded-lg border border-green-400/30 bg-green-600 px-3.5 py-2 text-sm font-medium whitespace-nowrap text-white shadow-sm transition-all hover:bg-green-500">
          <i class="fa-solid fa-plus"></i>
          <span>Nouvelle Période</span>
        </button>

        <dialog data-slideover-target="dialog" data-action="mousedown->slideover#backdropClose" class="slideover slideover-right fixed inset-0 m-0 ml-auto h-dvh max-h-full border-l border-neutral-800 outline-hidden bg-transparent p-0">
          <div class="flex h-full w-80 flex-col bg-neutral-950 shadow-2xl sm:w-96 lg:w-[480px]">
            <div class="flex items-center justify-between border-b border-neutral-800 bg-neutral-900 px-6 py-5">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white shadow-lg">
                  <i class="fa-solid fa-gift"></i>
                </div>
                <h4 class="text-lg font-semibold text-white">Nouvelle Période</h4>
              </div>
              <button type="button" data-action="slideover#hide:prevent" class="rounded-full p-2 text-neutral-400 transition-colors hover:bg-neutral-800 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="18" x2="6" y1="6" y2="18"></line>
                  <line x1="6" x2="18" y1="6" y2="18"></line>
                </svg>
              </button>
            </div>
            
            <%= form_with model: BonusPeriod.new, url: admin_bonus_periods_path, class: "flex flex-1 flex-col min-h-0" do |f| %>
              <div class="flex-1 overflow-y-auto p-6 space-y-4 bg-neutral-950">
                <div>
                  <label class="block text-sm font-medium text-neutral-300 mb-2">Nom *</label>
                  <%= f.text_field :name, required: true, placeholder: "Ex: Bonus Été 2024", class: "w-full px-4 py-3 bg-neutral-900 border border-neutral-800 rounded-lg text-white placeholder-neutral-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" %>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-neutral-300 mb-2">Description</label>
                  <%= f.text_area :description, rows: 2, placeholder: "Description optionnelle...", class: "w-full px-4 py-3 bg-neutral-900 border border-neutral-800 rounded-lg text-white placeholder-neutral-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all resize-none" %>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-neutral-300 mb-2">Taux de Bonus (%) *</label>
                  <%= f.number_field :bonus_percentage, step: 0.1, min: 0, max: 100, required: true, placeholder: "15", class: "w-full px-4 py-3 bg-neutral-900 border border-neutral-800 rounded-lg text-white placeholder-neutral-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" %>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-neutral-300 mb-2">Date de début *</label>
                    <%= f.date_field :start_date, required: true, value: Date.current, class: "w-full px-4 py-3 bg-neutral-900 border border-neutral-800 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" %>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-neutral-300 mb-2">Date de fin *</label>
                    <%= f.date_field :end_date, required: true, value: 1.month.from_now.to_date, class: "w-full px-4 py-3 bg-neutral-900 border border-neutral-800 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" %>
                  </div>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-neutral-300 mb-2">Campagne associée</label>
                  <%= f.select :campaign_id, Campaign.all.map { |c| [c.title, c.id] }, { include_blank: "Aucune campagne" }, class: "w-full px-4 py-3 bg-neutral-900 border border-neutral-800 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" %>
                </div>
                
                <label class="flex items-center gap-3 p-3 rounded-lg border border-neutral-800 bg-neutral-900 cursor-pointer hover:border-neutral-700 transition-colors">
                  <%= f.check_box :active, checked: true, class: "w-4 h-4 text-green-600 bg-neutral-800 border-neutral-700 rounded focus:ring-green-500" %>
                  <span class="text-sm text-neutral-300">Activer cette période</span>
                </label>
              </div>
              
              <div class="flex items-center gap-3 border-t border-neutral-800 bg-neutral-900 px-6 py-5">
                <%= f.submit "Créer la période", class: "flex-1 flex items-center justify-center gap-2 rounded-lg bg-green-600 px-5 py-2.5 text-sm font-medium text-white shadow-lg shadow-green-600/25 transition-all hover:bg-green-500 cursor-pointer" %>
                <button data-action="slideover#hide:prevent" type="button" class="flex items-center justify-center gap-2 rounded-lg border border-neutral-700 bg-neutral-800 px-5 py-2.5 text-sm font-medium text-neutral-300 transition-all hover:bg-neutral-700 hover:text-white">Annuler</button>
              </div>
            <% end %>
          </div>
        </dialog>
      </div>
    </div>

    <% if @bonus_periods && @bonus_periods.any? %>
      <div data-scroll-area-target="viewport"
           data-action="scroll->scroll-area#onViewportScroll"
           class="max-h-[600px] overflow-auto scrollbar-hide bg-neutral-950">
        <table class="w-full min-w-[900px] !bg-transparent !border-0">
          <thead class="sticky top-0 z-10 !bg-neutral-950">
            <tr class="*:py-3 *:text-left *:align-middle border-b border-neutral-800">
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100">Nom</th>
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100">Campagne</th>
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100 text-center">Bonus</th>
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100">Période</th>
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100 text-center">Statut</th>
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100 text-right">Actions</th>
            </tr>
          </thead>
          <tbody class="*:even:bg-neutral-900/50 *:*:py-4 bg-neutral-950">
            <% @bonus_periods.each do |period| %>
              <tr class="hover:bg-neutral-800 transition-colors">
                <td class="px-6">
                  <p class="font-semibold text-white"><%= period.name || "Sans nom" %></p>
                  <% if period.description.present? %>
                    <p class="text-xs text-neutral-500 line-clamp-1"><%= truncate(period.description, length: 50) %></p>
                  <% end %>
                </td>
                <td class="px-6">
                  <% if period.campaign %>
                    <div class="flex items-center gap-2">
                      <div class="w-2.5 h-2.5 rounded-full" style="background: <%= period.campaign.banner_color %>;"></div>
                      <span class="text-sm text-white"><%= period.campaign.title %></span>
                    </div>
                  <% else %>
                    <span class="text-sm text-neutral-500 italic">Aucune</span>
                  <% end %>
                </td>
                <td class="px-6 text-center">
                  <span class="text-xl font-bold text-green-400"><%= number_to_percentage(period.bonus_percentage, precision: 1) %></span>
                </td>
                <td class="px-6 text-sm text-neutral-300">
                  <%= period.start_date.strftime("%d/%m/%Y") %> → <%= period.end_date.strftime("%d/%m/%Y") %>
                </td>
                <td class="px-6 text-center">
                  <% if period.current? %>
                    <%= render 'admin/shared/status_badge', label: 'ACTIVE', variant: 'success', pulse: true %>
                  <% elsif period.active && period.start_date > Date.current %>
                    <%= render 'admin/shared/status_badge', label: 'À VENIR', variant: 'info' %>
                  <% elsif period.active %>
                    <%= render 'admin/shared/status_badge', label: 'EXPIRÉE', variant: 'neutral' %>
                  <% else %>
                    <%= render 'admin/shared/status_badge', label: 'INACTIVE', variant: 'danger' %>
                  <% end %>
                </td>
                <td class="px-6">
                  <div class="flex items-center justify-end gap-2">
                    <%= link_to edit_admin_bonus_period_path(period), class: "flex items-center justify-center w-8 h-8 rounded-lg border border-amber-400/30 bg-amber-500 text-white hover:bg-amber-400 transition-colors", title: "Modifier" do %>
                      <i class="fa-solid fa-pen text-xs"></i>
                    <% end %>
                    <%= button_to toggle_active_admin_bonus_period_path(period), method: :post, class: "flex items-center justify-center w-8 h-8 rounded-lg border #{period.active ? 'border-red-400/30 bg-red-600 hover:bg-red-500' : 'border-green-400/30 bg-green-600 hover:bg-green-500'} text-white transition-colors", title: period.active ? 'Désactiver' : 'Activer' do %>
                      <i class="fa-solid fa-<%= period.active ? 'pause' : 'play' %> text-xs"></i>
                    <% end %>
                    <%= button_to admin_bonus_period_path(period), method: :delete, data: { turbo_confirm: "Supprimer cette période ?" }, class: "flex items-center justify-center w-8 h-8 rounded-lg border border-red-400/30 bg-red-600 text-white hover:bg-red-500 transition-colors", title: "Supprimer" do %>
                      <i class="fa-solid fa-trash text-xs"></i>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <%= render 'admin/shared/empty_state',
          icon: 'fa-calendar',
          icon_gradient: 'from-purple-500/20 to-pink-500/20',
          icon_color: 'text-purple-400',
          title: 'Aucune période bonus',
          description: 'Créez votre première période bonus pour démarrer le programme.',
          button_label: 'Créer une période',
          button_action: "document.querySelector('#new-period-slideover button[data-action]').click()" %>
    <% end %>
  </div>

  <div class="bg-neutral-900 rounded-xl p-6">
    <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
      <i class="fa-solid fa-lightbulb text-amber-400"></i>
      Guide Rapide
    </h3>
    <ul class="space-y-2 text-sm text-neutral-400">
      <li class="flex items-start gap-2"><i class="fa-solid fa-check text-green-400 mt-1"></i> Les périodes actives sont utilisées pour les calculs de bonus</li>
      <li class="flex items-start gap-2"><i class="fa-solid fa-check text-green-400 mt-1"></i> Une seule période peut être active pour une plage de dates donnée</li>
      <li class="flex items-start gap-2"><i class="fa-solid fa-check text-green-400 mt-1"></i> Le système sélectionne automatiquement la période active actuelle</li>
      <li class="flex items-start gap-2"><i class="fa-solid fa-check text-green-400 mt-1"></i> Vous pouvez désactiver une période sans la supprimer</li>
    </ul>
  </div>
</div>
