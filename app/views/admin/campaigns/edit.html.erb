<!DOCTYPE html>
<html>
<head>
  <title>Modifier Campagne - Admin Trayo</title>
  <%= stylesheet_link_tag "admin" %>
</head>
<body>
  <% @page_title = "Modifier Campagne" %>
  
  <div class="app-layout">
    <%= render 'admin/shared/sidebar' %>
    
    <div class="main-content">
      <%= render 'admin/shared/navbar' %>
      
      <div class="container">
        <div class="card">
          <div class="card-header">
            <h2>Modifier la Campagne</h2>
            <%= link_to "Retour", admin_campaigns_path, class: "btn btn-outline" %>
          </div>
          
          <%= form_with url: admin_campaign_path(@campaign), method: :patch, local: true do |form| %>
            <% if @campaign.errors&.any? %>
              <div class="alert">
                <h4><%= pluralize(@campaign.errors.count, "erreur") %> empêche(nt) cette campagne d'être sauvegardée :</h4>
                <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                  <% @campaign.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>
            
            <div class="two-col">
              <div class="form-group">
                <%= form.label :title, "Titre de la Campagne" %>
                <%= form.text_field :title, placeholder: "Ex: Promotion Black Friday 2024", required: true, value: @campaign&.title %>
              </div>
              
              <div class="form-group">
                <%= form.label :banner_color, "Couleur de la Bannière" %>
                <%= form.color_field :banner_color, value: @campaign.banner_color || '#3b82f6' %>
                <div class="help-text">
                  Cette couleur sera utilisée pour la bannière et la popup
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <%= form.label :description, "Description" %>
                <%= form.text_area :description, placeholder: "Description détaillée de la campagne qui apparaîtra dans la bannière...", rows: 3, required: true, value: @campaign&.description %>
            </div>
            
            <div class="two-col">
              <div class="form-group">
                <%= form.label :start_date, "Date de Début" %>
                <%= form.datetime_local_field :start_date, required: true, value: @campaign&.start_date&.strftime("%Y-%m-%dT%H:%M") %>
              </div>
              
              <div class="form-group">
                <%= form.label :end_date, "Date de Fin" %>
                <%= form.datetime_local_field :end_date, required: true, value: @campaign&.end_date&.strftime("%Y-%m-%dT%H:%M") %>
              </div>
            </div>
            
            <div class="form-group">
              <%= form.label :popup_title, "Titre de la Popup" %>
                <%= form.text_field :popup_title, placeholder: "Ex: <i class="fa-icon fa-md fa-bullhorn"></i> Promotion Spéciale !", required: true, value: @campaign&.popup_title %>
              <div class="help-text">
                Titre qui apparaîtra dans la popup quotidienne
              </div>
            </div>
            
            <div class="form-group">
              <%= form.label :popup_message, "Message de la Popup" %>
                <%= form.text_area :popup_message, placeholder: "Message détaillé qui apparaîtra dans la popup quotidienne...", rows: 4, required: true, value: @campaign&.popup_message %>
              <div class="help-text">
                Ce message sera affiché une fois par jour aux utilisateurs
              </div>
            </div>
            
            <div class="two-col">
              <div class="form-group">
                <%= form.label :button_text, "Texte du Bouton" %>
                <%= form.text_field :button_text, placeholder: "Ex: Découvrir l'offre", value: @campaign&.button_text %>
                <div class="help-text">
                  Texte qui apparaîtra sur le bouton (optionnel)
                </div>
              </div>
              
              <div class="form-group">
                <%= form.label :button_url, "Lien du Bouton" %>
                <%= form.url_field :button_url, placeholder: "https://exemple.com/offre", value: @campaign&.button_url %>
                <div class="help-text">
                  URL vers laquelle le bouton redirigera (optionnel)
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <%= form.check_box :is_active, { checked: @campaign&.is_active } %>
                <%= form.label :is_active, "Campagne Active" %>
              </div>
              <div class="help-text">
                Une campagne inactive ne sera pas affichée aux utilisateurs
              </div>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 32px;">
              <%= link_to "Annuler", admin_campaigns_path, class: "btn btn-outline" %>
              <%= form.submit "Mettre à Jour", class: "btn btn-primary" %>
            </div>
          <% end %>
          
          <!-- Prévisualisation en temps réel -->
          <div class="preview-section">
            <h3>Aperçu en Temps Réel</h3>
            
            <!-- Prévisualisation de la bannière -->
            <div class="preview-item">
              <h4>Bannière Dashboard</h4>
              <div class="campaign-banner-preview" id="banner-preview">
                <div class="campaign-banner-content">
                  <div class="campaign-banner-text">
                    <h4 id="banner-title"><%= @campaign&.title || 'Titre de la Campagne' %></h4>
                    <p id="banner-description"><%= @campaign&.description || 'Description de la campagne...' %></p>
                  </div>
                  <div class="campaign-banner-actions">
                    <span class="campaign-banner-days" id="banner-days">7 jours restants</span>
                    <button type="button" class="campaign-banner-dismiss">×</button>
                  </div>
                </div>
                <div class="campaign-progress-bar">
                  <div class="campaign-progress-fill" id="banner-progress" style="width: 45%"></div>
                </div>
              </div>
            </div>
            
            <!-- Prévisualisation de la popup -->
            <div class="preview-item">
              <h4>Popup Quotidienne</h4>
              <div class="campaign-popup-preview" id="popup-preview">
                <div class="campaign-popup-content">
                  <div class="campaign-popup-header">
                    <h3 id="popup-title"><%= @campaign&.popup_title || 'Titre de la Popup' %></h3>
                    <button type="button" class="campaign-popup-close">×</button>
                  </div>
                  <div class="campaign-popup-body">
                    <p id="popup-message"><%= @campaign&.popup_message || 'Message de la popup...' %></p>
                    <div class="campaign-popup-actions">
                      <button type="button" class="btn btn-primary">Découvrir</button>
                      <button type="button" class="btn btn-outline">Plus tard</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <h3>Aperçu de la Campagne</h3>
          <p style="color: var(--text-muted); margin-bottom: 20px;">Voici un aperçu de ce que verront les utilisateurs</p>
          
          <div style="background: <%= @campaign.banner_color %>; color: white; border-radius: var(--radius-lg); padding: 20px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 700;">
              <i class="fa-icon fa-md fa-bullhorn"></i> <%= @campaign.title %>
            </h3>
            <p style="margin: 0; font-size: 14px; opacity: 0.9;">
              <%= @campaign.description %>
            </p>
          </div>
          
          <div style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: 20px;">
            <h4 style="margin: 0 0 12px 0; color: var(--text-primary);">
              <%= @campaign.popup_title %>
            </h4>
            <p style="margin: 0; color: var(--text-secondary); line-height: 1.6;">
              <%= simple_format(@campaign.popup_message) %>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Mise à jour en temps réel de la prévisualisation
    document.addEventListener('DOMContentLoaded', function() {
      const titleInput = document.querySelector('input[name="title"]');
      const descriptionInput = document.querySelector('textarea[name="description"]');
      const bannerColorInput = document.querySelector('input[name="banner_color"]');
      const popupTitleInput = document.querySelector('input[name="popup_title"]');
      const popupMessageInput = document.querySelector('textarea[name="popup_message"]');
      const startDateInput = document.querySelector('input[name="start_date"]');
      const endDateInput = document.querySelector('input[name="end_date"]');
      
      const bannerTitle = document.getElementById('banner-title');
      const bannerDescription = document.getElementById('banner-description');
      const bannerPreview = document.getElementById('banner-preview');
      const bannerDays = document.getElementById('banner-days');
      const bannerProgress = document.getElementById('banner-progress');
      
      const popupTitle = document.getElementById('popup-title');
      const popupMessage = document.getElementById('popup-message');
      
      function updatePreview() {
        // Mise à jour de la bannière
        if (titleInput.value) {
          bannerTitle.textContent = titleInput.value;
        }
        if (descriptionInput.value) {
          bannerDescription.textContent = descriptionInput.value;
        }
        if (bannerColorInput.value) {
          bannerPreview.style.background = `linear-gradient(135deg, ${bannerColorInput.value}, ${adjustColor(bannerColorInput.value, -20)})`;
        }
        
        // Mise à jour de la popup
        if (popupTitleInput.value) {
          popupTitle.textContent = popupTitleInput.value;
        }
        if (popupMessageInput.value) {
          popupMessage.textContent = popupMessageInput.value;
        }
        
        // Calcul des jours restants et progression
        if (startDateInput.value && endDateInput.value) {
          const startDate = new Date(startDateInput.value);
          const endDate = new Date(endDateInput.value);
          const now = new Date();
          
          if (now >= startDate && now <= endDate) {
            const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            const elapsedDays = Math.ceil((now - startDate) / (1000 * 60 * 60 * 24));
            const remainingDays = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
            const progress = Math.min((elapsedDays / totalDays) * 100, 100);
            
            bannerDays.textContent = `${remainingDays} jour${remainingDays > 1 ? 's' : ''} restant${remainingDays > 1 ? 's' : ''}`;
            bannerProgress.style.width = `${progress}%`;
          } else {
            bannerDays.textContent = 'Campagne terminée';
            bannerProgress.style.width = '100%';
          }
        }
      }
      
      function adjustColor(color, amount) {
        const num = parseInt(color.replace("#", ""), 16);
        const amt = Math.round(2.55 * amount);
        const R = (num >> 16) + amt;
        const G = (num >> 8 & 0x00FF) + amt;
        const B = (num & 0x0000FF) + amt;
        return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
          (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
          (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
      }
      
      // Écouteurs d'événements
      [titleInput, descriptionInput, bannerColorInput, popupTitleInput, popupMessageInput, startDateInput, endDateInput].forEach(input => {
        if (input) {
          input.addEventListener('input', updatePreview);
          input.addEventListener('change', updatePreview);
        }
      });
      
      // Mise à jour initiale
      updatePreview();
    });
  </script>
</body>
</html>
