<!DOCTYPE html>
<html>
<head>
  <title>Nouvelle Campagne - Admin Trayo</title>
  <%= stylesheet_link_tag "admin" %>
</head>
<body>
  <% @page_title = "Nouvelle Campagne" %>
  
  <div class="app-layout">
    <%= render 'admin/shared/sidebar' %>
    
    <div class="main-content">
      <%= render 'admin/shared/navbar' %>
      
      <div class="container">
        <div class="card">
          <div class="card-header">
            <h2>Nouvelle Campagne</h2>
            <%= link_to "Retour", admin_campaigns_path, class: "btn btn-outline" %>
          </div>
          
          <%= form_with url: admin_campaigns_path, method: :post, local: true do |form| %>
            <% if @campaign.errors&.any? %>
              <div class="alert">
                <h4><%= pluralize(@campaign.errors.count, "erreur") %> emp√™che(nt) cette campagne d'√™tre sauvegard√©e :</h4>
                <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                  <% @campaign.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>
            
            <div class="two-col">
              <div class="form-group">
                <%= form.label :title, "Titre de la Campagne" %>
                <%= form.text_field :title, placeholder: "Ex: Promotion Black Friday 2024", required: true %>
              </div>
              
              <div class="form-group">
                <%= form.label :banner_color, "Couleur de la Banni√®re" %>
                <%= form.color_field :banner_color, value: @campaign.banner_color || '#3b82f6' %>
                <div class="help-text">
                  Cette couleur sera utilis√©e pour la banni√®re et la popup
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <%= form.label :description, "Description" %>
              <%= form.text_area :description, placeholder: "Description d√©taill√©e de la campagne qui appara√Ætra dans la banni√®re...", rows: 3, required: true %>
            </div>
            
            <div class="two-col">
              <div class="form-group">
                <%= form.label :start_date, "Date de D√©but" %>
                <%= form.datetime_local_field :start_date, required: true %>
              </div>
              
              <div class="form-group">
                <%= form.label :end_date, "Date de Fin" %>
                <%= form.datetime_local_field :end_date, required: true %>
              </div>
            </div>
            
            <div class="form-group">
              <%= form.label :popup_title, "Titre de la Popup" %>
              <%= form.text_field :popup_title, placeholder: "Ex: üéØ Promotion Sp√©ciale !", required: true %>
              <div class="help-text">
                Titre qui appara√Ætra dans la popup quotidienne
              </div>
            </div>
            
            <div class="form-group">
              <%= form.label :popup_message, "Message de la Popup" %>
              <%= form.text_area :popup_message, placeholder: "Message d√©taill√© qui appara√Ætra dans la popup quotidienne...", rows: 4, required: true %>
              <div class="help-text">
                Ce message sera affich√© une fois par jour aux utilisateurs
              </div>
            </div>
            
            <div class="two-col">
              <div class="form-group">
                <%= form.label :button_text, "Texte du Bouton" %>
                <%= form.text_field :button_text, placeholder: "Ex: D√©couvrir l'offre" %>
                <div class="help-text">
                  Texte qui appara√Ætra sur le bouton (optionnel)
                </div>
              </div>
              
              <div class="form-group">
                <%= form.label :button_url, "Lien du Bouton" %>
                <%= form.url_field :button_url, placeholder: "https://exemple.com/offre" %>
                <div class="help-text">
                  URL vers laquelle le bouton redirigera (optionnel)
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <%= form.check_box :is_active %>
                <%= form.label :is_active, "Campagne Active" %>
              </div>
              <div class="help-text">
                Une campagne inactive ne sera pas affich√©e aux utilisateurs
              </div>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 32px;">
              <%= link_to "Annuler", admin_campaigns_path, class: "btn btn-outline" %>
              <%= form.submit "Cr√©er la Campagne", class: "btn btn-primary" %>
            </div>
          <% end %>
          
          <!-- Pr√©visualisation en temps r√©el -->
          <div class="preview-section">
            <h3>Aper√ßu en Temps R√©el</h3>
            
            <!-- Pr√©visualisation de la banni√®re -->
            <div class="preview-item">
              <h4>Banni√®re Dashboard</h4>
              <div class="campaign-banner-preview" id="banner-preview">
                <div class="campaign-banner-content">
                  <div class="campaign-banner-text">
                    <h4 id="banner-title">Titre de la Campagne</h4>
                    <p id="banner-description">Description de la campagne...</p>
                  </div>
                  <div class="campaign-banner-actions">
                    <span class="campaign-banner-days" id="banner-days">7 jours restants</span>
                    <button type="button" class="campaign-banner-dismiss">√ó</button>
                  </div>
                </div>
                <div class="campaign-progress-bar">
                  <div class="campaign-progress-fill" id="banner-progress" style="width: 45%"></div>
                </div>
              </div>
            </div>
            
            <!-- Pr√©visualisation de la popup -->
            <div class="preview-item">
              <h4>Popup Quotidienne</h4>
              <div class="campaign-popup-preview" id="popup-preview">
                <div class="campaign-popup-content">
                  <div class="campaign-popup-header">
                    <h3 id="popup-title">Titre de la Popup</h3>
                    <button type="button" class="campaign-popup-close">√ó</button>
                  </div>
                  <div class="campaign-popup-body">
                    <p id="popup-message">Message de la popup...</p>
                    <div class="campaign-popup-actions" id="popup-actions">
                      <button type="button" class="btn btn-primary" id="popup-custom-button" style="display: none;">Bouton Personnalis√©</button>
                      <button type="button" class="btn btn-outline">Plus tard</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <% if @campaign.persisted? %>
          <div class="card">
            <h3>Aper√ßu de la Campagne</h3>
            <p style="color: var(--text-muted); margin-bottom: 20px;">Voici un aper√ßu de ce que verront les utilisateurs</p>
            
            <div style="background: <%= @campaign.banner_color %>; color: white; border-radius: var(--radius-lg); padding: 20px; margin-bottom: 20px;">
              <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 700;">
                üéØ <%= @campaign.title %>
              </h3>
              <p style="margin: 0; font-size: 14px; opacity: 0.9;">
                <%= @campaign.description %>
              </p>
            </div>
            
            <div style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: 20px;">
              <h4 style="margin: 0 0 12px 0; color: var(--text-primary);">
                <%= @campaign.popup_title %>
              </h4>
              <p style="margin: 0; color: var(--text-secondary); line-height: 1.6;">
                <%= simple_format(@campaign.popup_message) %>
              </p>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  
  <script>
    // Mise √† jour en temps r√©el de la pr√©visualisation
    document.addEventListener('DOMContentLoaded', function() {
      const titleInput = document.querySelector('input[name="title"]');
      const descriptionInput = document.querySelector('textarea[name="description"]');
      const bannerColorInput = document.querySelector('input[name="banner_color"]');
      const popupTitleInput = document.querySelector('input[name="popup_title"]');
      const popupMessageInput = document.querySelector('textarea[name="popup_message"]');
      const buttonTextInput = document.querySelector('input[name="button_text"]');
      const buttonUrlInput = document.querySelector('input[name="button_url"]');
      const startDateInput = document.querySelector('input[name="start_date"]');
      const endDateInput = document.querySelector('input[name="end_date"]');
      
      const bannerTitle = document.getElementById('banner-title');
      const bannerDescription = document.getElementById('banner-description');
      const bannerPreview = document.getElementById('banner-preview');
      const bannerDays = document.getElementById('banner-days');
      const bannerProgress = document.getElementById('banner-progress');
      
      const popupTitle = document.getElementById('popup-title');
      const popupMessage = document.getElementById('popup-message');
      const popupCustomButton = document.getElementById('popup-custom-button');
      
      function updatePreview() {
        // Mise √† jour de la banni√®re
        if (titleInput.value) {
          bannerTitle.textContent = titleInput.value;
        }
        if (descriptionInput.value) {
          bannerDescription.textContent = descriptionInput.value;
        }
        if (bannerColorInput.value) {
          bannerPreview.style.background = `linear-gradient(135deg, ${bannerColorInput.value}, ${adjustColor(bannerColorInput.value, -20)})`;
        }
        
        // Mise √† jour de la popup
        if (popupTitleInput.value) {
          popupTitle.textContent = popupTitleInput.value;
        }
        if (popupMessageInput.value) {
          popupMessage.textContent = popupMessageInput.value;
        }
        
        // Mise √† jour du bouton personnalis√©
        if (buttonTextInput.value && buttonUrlInput.value) {
          popupCustomButton.textContent = buttonTextInput.value;
          popupCustomButton.style.display = 'inline-block';
          popupCustomButton.onclick = function() {
            window.open(buttonUrlInput.value, '_blank');
          };
        } else {
          popupCustomButton.style.display = 'none';
        }
        
        // Calcul des jours restants et progression
        if (startDateInput.value && endDateInput.value) {
          const startDate = new Date(startDateInput.value);
          const endDate = new Date(endDateInput.value);
          const now = new Date();
          
          if (now >= startDate && now <= endDate) {
            const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            const elapsedDays = Math.ceil((now - startDate) / (1000 * 60 * 60 * 24));
            const remainingDays = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
            const progress = Math.min((elapsedDays / totalDays) * 100, 100);
            
            bannerDays.textContent = `${remainingDays} jour${remainingDays > 1 ? 's' : ''} restant${remainingDays > 1 ? 's' : ''}`;
            bannerProgress.style.width = `${progress}%`;
          } else {
            bannerDays.textContent = 'Campagne termin√©e';
            bannerProgress.style.width = '100%';
          }
        }
      }
      
      function adjustColor(color, amount) {
        const num = parseInt(color.replace("#", ""), 16);
        const amt = Math.round(2.55 * amount);
        const R = (num >> 16) + amt;
        const G = (num >> 8 & 0x00FF) + amt;
        const B = (num & 0x0000FF) + amt;
        return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
          (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
          (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
      }
      
      // √âcouteurs d'√©v√©nements
      [titleInput, descriptionInput, bannerColorInput, popupTitleInput, popupMessageInput, buttonTextInput, buttonUrlInput, startDateInput, endDateInput].forEach(input => {
        if (input) {
          input.addEventListener('input', updatePreview);
          input.addEventListener('change', updatePreview);
        }
      });
      
      // Mise √† jour initiale
      updatePreview();
    });
  </script>
</body>
</html>
