<% @page_title = 'SAV' %>

<%= render 'admin/shared/sidebar' %>

<div class="main-content">
  <%= render 'admin/shared/navbar' %>
  
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
      <h1>Support Client (SAV)</h1>
    </div>

    <!-- Statistiques -->
    <% if @stats %>
      <div class="info-grid" style="margin-bottom: 24px;">
        <div class="info-item">
          <div class="info-label">Total</div>
          <div class="info-value"><%= @stats[:total] %></div>
        </div>
        <div class="info-item">
          <div class="info-label">Ouverts</div>
          <div class="info-value" style="color: var(--color-warning);"><%= @stats[:open] %></div>
        </div>
        <div class="info-item">
          <div class="info-label">Fermés</div>
          <div class="info-value" style="color: var(--color-success);"><%= @stats[:closed] %></div>
        </div>
        <div class="info-item">
          <div class="info-label">Non lus</div>
          <div class="info-value" style="color: var(--color-danger);">
            <%= @stats[:unread] %>
            <% if @stats[:unread] > 0 %>
              <i class="fa-icon fa-sm fa-exclamation-circle" style="margin-left: 5px;"></i>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Filtres -->
    <div class="card" style="margin-bottom: 24px;">
      <%= form_with url: admin_support_tickets_path, method: :get, local: true, class: "filters-form" do |f| %>
        <div class="filters-grid">
          <div class="filter-group">
            <label class="filter-label">Statut</label>
            <%= f.select :status, 
                options_for_select([
                  ['Tous', ''],
                  ['Ouvert', 'open'],
                  ['En cours', 'in_progress'],
                  ['En attente client', 'waiting_for_user'],
                  ['Fermé', 'closed']
                ], params[:status]),
                {},
                { class: "filter-select" } %>
          </div>
          <div class="filter-group">
            <label class="filter-label">Numéro de ticket</label>
            <%= f.text_field :ticket_number, value: params[:ticket_number], placeholder: "TKT-...", class: "filter-input" %>
          </div>
          <div class="filter-group">
            <label class="filter-label">Téléphone</label>
            <%= f.text_field :phone, value: params[:phone], placeholder: "+33...", class: "filter-input" %>
          </div>
          <div class="filter-group">
            <%= f.submit "Filtrer", class: "btn btn-primary" %>
            <%= link_to "Réinitialiser", admin_support_tickets_path, class: "btn btn-outline" %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Liste des tickets -->
    <div class="card">
      <% if @tickets.any? %>
        <div class="table-wrapper">
          <table class="table-flat">
            <thead>
              <tr>
                <th>Numéro</th>
                <th>Date</th>
                <th>Client</th>
                <th>Téléphone</th>
                <th>Sujet</th>
                <th>Description</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @tickets.each do |ticket| %>
                <tr class="<%= 'unread-row' if ticket.read_at.nil? %>">
                  <td>
                    <strong><%= ticket.ticket_number %></strong>
                    <% if ticket.read_at.nil? %>
                      <span class="badge badge-danger" style="margin-left: 5px;">Nouveau</span>
                    <% end %>
                  </td>
                  <td><%= ticket.created_at.strftime("%d/%m/%Y %H:%M") %></td>
                  <td>
                    <% if ticket.user %>
                      <%= link_to ticket.user.email, admin_client_path(ticket.user) %>
                    <% else %>
                      <span class="text-muted">Non identifié</span>
                    <% end %>
                  </td>
                  <td><%= ticket.phone_number %></td>
                  <td><%= truncate(ticket.subject || "Sans sujet", length: 40) %></td>
                  <td>
                    <div class="sms-message" title="<%= ticket.description %>">
                      <%= truncate(ticket.description, length: 50) %>
                    </div>
                  </td>
                  <td>
                    <span class="status-pill status-<%= ticket.status %> <%= ticket.status_badge_class %>">
                      <%= ticket.status_label %>
                    </span>
                  </td>
                  <td>
                    <div class="action-buttons">
                      <%= link_to "Voir", admin_support_ticket_path(ticket), class: "btn btn-sm btn-primary" %>
                      <% if ticket.read_at.nil? %>
                        <%= link_to "Marquer lu", mark_as_read_admin_support_ticket_path(ticket), 
                                    method: :post, 
                                    class: "btn btn-sm btn-outline" %>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <div style="margin-top: 12px; text-align: right;">
          <%= paginate @tickets if @tickets.respond_to?(:total_pages) %>
        </div>
      <% else %>
        <div class="empty-state">
          <i class="fa-icon fa-lg fa-inbox"></i>
          <h3>Aucun ticket</h3>
          <p>Aucun ticket ne correspond aux critères de recherche.</p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<style>
.unread-row {
  background-color: rgba(255, 193, 7, 0.1) !important;
  font-weight: 500;
}

.unread-row:hover {
  background-color: rgba(255, 193, 7, 0.15) !important;
}
</style>

