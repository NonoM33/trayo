<!DOCTYPE html>
<html>
<head>
  <title>Bonus Program - Trayo</title>
  <%= stylesheet_link_tag "admin" %>
</head>
<body>
  <% @page_title = "Bonus Program" %>
  
  <div class="app-layout">
    <%= render 'admin/shared/sidebar' %>
    
    <div class="main-content">
      <%= render 'admin/shared/navbar' %>
      
      <div class="container">
        <% if flash[:notice] %>
          <div class="notice"><%= flash[:notice] %></div>
        <% end %>
        <% if flash[:alert] %>
          <div class="alert"><%= flash[:alert] %></div>
        <% end %>
        
        <% unless current_user.is_admin? %>
          <div class="card">
            <h2><i class="fa-icon fa-md fa-gift"></i> Programme de Bonus</h2>
            
            <div class="info-box info-box-info">
              <div class="info-box-title">üí° Comment √ßa marche</div>
              <p style="margin: 12px 0 0 0;">
                Pr√©-financez la plateforme en d√©posant des fonds et recevez un <strong>bonus instantan√©</strong> sur votre d√©p√¥t ! 
                Votre cr√©dit total peut √™tre utilis√© pour payer des commissions ou acheter des bots de trading.
              </p>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 24px 0;">
              <div style="text-align: center; padding: 20px; background: var(--bg-hover); border-radius: 8px;">
                <% if @current_bonus_rate && @current_bonus_rate > 0 %>
                  <div style="font-size: 36px; font-weight: 700; color: var(--color-success);"><%= number_to_percentage(@current_bonus_rate, precision: 1) %></div>
                  <div style="font-size: 14px; color: var(--text-muted); margin-top: 8px;">Taux de Bonus Actuel</div>
                  <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;"><%= l(Date.current, format: "%B %Y") %></div>
                <% else %>
                  <div style="font-size: 24px; font-weight: 700; color: var(--text-muted);">Aucun Bonus Actif</div>
                  <div style="font-size: 14px; color: var(--text-muted); margin-top: 8px;">Pas de p√©riode de bonus active</div>
                  <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;"><%= l(Date.current, format: "%B %Y") %></div>
                <% end %>
              </div>
              
              <div style="text-align: center; padding: 20px; background: var(--bg-hover); border-radius: 8px;">
                <div style="font-size: 36px; font-weight: 700; color: var(--color-accent);">
                  <%= number_to_currency(current_user.total_credits, precision: 2) %>
                </div>
                <div style="font-size: 14px; color: var(--text-muted); margin-top: 8px;">Vos Cr√©dits Totaux</div>
              </div>
            </div>
            
            <% if @current_bonus_rate && @current_bonus_rate > 0 %>
              <%= link_to "<i class=\"fa-icon fa-md fa-wallet\"></i> Faire un D√©p√¥t Bonus", new_admin_bonus_deposit_path, class: "btn btn-success", style: "display: inline-block; margin-top: 8px;" %>
            <% else %>
              <div class="info-box info-box-warning" style="margin-top: 16px;">
                <div class="info-box-title"><i class="fa-icon fa-md fa-exclamation-triangle"></i> Aucune P√©riode de Bonus Active</div>
                <p style="margin: 8px 0 0 0;">
                  Il n'y a actuellement aucune p√©riode de bonus active. Veuillez contacter un administrateur pour plus d'informations.
                </p>
              </div>
            <% end %>
          </div>
          
          <% if @bonus_periods&.any? %>
            <div class="card">
              <h2><i class="fa-icon fa-md fa-chart-bar"></i> Calendrier des Bonus</h2>
              
              <table>
                <thead>
                  <tr>
                    <th>P√©riode</th>
                    <th>Taux de Bonus</th>
                    <th>Exemple</th>
                  </tr>
                </thead>
                <tbody>
                  <% @bonus_periods.each do |period| %>
                    <tr>
                      <td>
                        <strong><%= period.name || "P√©riode sans nom" %></strong><br>
                        <small style="color: var(--text-muted);"><%= l(period.start_date, format: :long) %> - <%= l(period.end_date, format: :long) %></small>
                      </td>
                      <td class="positive"><%= number_to_percentage(period.bonus_percentage, precision: 0) %></td>
                      <td>1 000 ‚Ç¨ <i class="fa-icon fa-md fa-arrow-right"></i> <%= number_to_currency((1000 * (1 + period.bonus_percentage / 100)), precision: 0) %> cr√©dits</td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% end %>
        <% end %>
        
        <% if current_user.is_admin? %>
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
              <div>
                <h2 style="margin: 0;"><span class="material-icons md-24" style="vertical-align: middle;">settings</span> Configuration du Programme Bonus</h2>
                <p style="margin: 8px 0 0 0; color: var(--text-muted);">G√©rer les p√©riodes et taux de bonus</p>
              </div>
              <%= link_to "<i class=\"fa-icon fa-md fa-calendar\"></i> G√©rer les P√©riodes Bonus", admin_bonus_periods_path, class: "btn btn-success" %>
            </div>
            
            <div class="info-box info-box-info">
              <div class="info-box-title">üí° Comment √ßa marche</div>
              <p style="margin: 8px 0 0 0;">
                Cr√©ez des p√©riodes de bonus avec des taux personnalis√©s et des plages de dates. Le syst√®me applique automatiquement la p√©riode active actuelle aux nouveaux d√©p√¥ts.
                Cliquez sur "G√©rer les P√©riodes Bonus" pour configurer les taux.
              </p>
            </div>
          </div>
        <% end %>
        
        <div class="card">
          <h2>üìã <%= current_user.is_admin? ? 'Tous les D√©p√¥ts Bonus' : 'Vos D√©p√¥ts Bonus' %></h2>
          
          <% if @bonus_deposits.any? %>
            <table>
              <thead>
                <tr>
                  <% if current_user.is_admin? %>
                    <th>Client</th>
                  <% end %>
                  <th>Date</th>
                  <th>Montant</th>
                  <th>Bonus</th>
                  <th>Cr√©dit Total</th>
                  <th>Statut</th>
                  <% if current_user.is_admin? %>
                    <th>Actions</th>
                  <% end %>
                </tr>
              </thead>
              <tbody>
                <% @bonus_deposits.each do |deposit| %>
                  <tr>
                    <% if current_user.is_admin? %>
                      <td><%= link_to deposit.user.email, admin_client_path(deposit.user), style: "color: var(--color-accent); text-decoration: none;" %></td>
                    <% end %>
                    <td><%= deposit.created_at.strftime("%d/%m/%Y %H:%M") %></td>
                    <td class="positive"><%= number_to_currency(deposit.amount, precision: 2) %></td>
                    <td class="positive"><%= number_to_percentage(deposit.bonus_percentage, precision: 0) %></td>
                    <td class="positive"><strong><%= number_to_currency(deposit.total_credit, precision: 2) %></strong></td>
                    <td>
                      <span class="status-<%= deposit.status %>">
                        <%= deposit.status.upcase %>
                      </span>
                    </td>
                    <% if current_user.is_admin? %>
                      <td>
                        <div class="action-buttons">
                          <% if deposit.status == "pending" %>
                            <%= button_to "Valider", validate_deposit_admin_bonus_deposit_path(deposit), method: :post, class: "btn btn-success btn-sm" %>
                            <%= button_to "Rejeter", reject_deposit_admin_bonus_deposit_path(deposit), method: :post, class: "btn btn-danger btn-sm" %>
                          <% end %>
                        </div>
                      </td>
                    <% end %>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% else %>
            <p style="text-align: center; color: var(--text-muted); padding: 40px;">Aucun d√©p√¥t bonus pour le moment</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</body>
</html>

