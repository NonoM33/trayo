<% @page_title = "Programme Bonus" %>

<div class="space-y-6">
  <%= render 'admin/shared/flash_messages' %>

  <% unless current_user.is_admin? %>
    <div class="bg-neutral-900 rounded-xl p-6">
      <div class="flex items-start gap-4 mb-6">
        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white shrink-0">
          <i class="fa-solid fa-gift text-xl"></i>
        </div>
        <div>
          <h2 class="text-xl font-bold text-white mb-2">Programme de Bonus</h2>
          <p class="text-neutral-400">Pré-financez la plateforme en déposant des fonds et recevez un <strong class="text-green-400">bonus instantané</strong> sur votre dépôt !</p>
        </div>
      </div>
      
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
        <div class="bg-neutral-800 rounded-xl p-6 text-center">
          <% if @current_bonus_rate && @current_bonus_rate > 0 %>
            <p class="text-4xl font-bold text-green-400 mb-2"><%= number_to_percentage(@current_bonus_rate, precision: 1) %></p>
            <p class="text-sm text-neutral-400">Taux de Bonus Actuel</p>
            <p class="text-xs text-neutral-500 mt-1"><%= l(Date.current, format: "%B %Y") %></p>
          <% else %>
            <p class="text-xl font-bold text-neutral-500 mb-2">Aucun Bonus Actif</p>
            <p class="text-sm text-neutral-400">Pas de période active</p>
          <% end %>
        </div>
        
        <div class="bg-neutral-800 rounded-xl p-6 text-center">
          <p class="text-4xl font-bold text-cyan-400 mb-2"><%= number_to_currency(current_user.total_credits, precision: 2) %></p>
          <p class="text-sm text-neutral-400">Vos Crédits Totaux</p>
        </div>
      </div>
      
      <% if @current_bonus_rate && @current_bonus_rate > 0 %>
        <%= link_to new_admin_bonus_deposit_path, class: "inline-flex items-center justify-center gap-2 rounded-lg bg-gradient-to-r from-green-500 to-emerald-600 px-6 py-3 text-sm font-medium text-white shadow-lg transition-all hover:scale-[1.02]" do %>
          <i class="fa-solid fa-wallet"></i>
          Faire un Dépôt Bonus
        <% end %>
      <% else %>
        <div class="flex items-center gap-3 p-4 rounded-xl bg-amber-500/10">
          <i class="fa-solid fa-exclamation-triangle text-amber-400"></i>
          <p class="text-amber-300 text-sm">Aucune période de bonus active. Contactez un administrateur pour plus d'informations.</p>
        </div>
      <% end %>
    </div>
    
    <% if @bonus_periods&.any? %>
      <div class="bg-neutral-900 rounded-xl p-6">
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
          <i class="fa-solid fa-calendar text-purple-400"></i>
          Calendrier des Bonus
        </h3>
        <div class="space-y-3">
          <% @bonus_periods.each do |period| %>
            <div class="flex items-center justify-between p-4 bg-neutral-800 rounded-lg">
              <div>
                <p class="font-medium text-white"><%= period.name || "Période sans nom" %></p>
                <p class="text-xs text-neutral-500"><%= l(period.start_date, format: :long) %> - <%= l(period.end_date, format: :long) %></p>
              </div>
              <div class="text-right">
                <p class="text-xl font-bold text-green-400"><%= number_to_percentage(period.bonus_percentage, precision: 0) %></p>
                <p class="text-xs text-neutral-500">1000€ → <%= number_to_currency((1000 * (1 + period.bonus_percentage / 100)), precision: 0) %></p>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>

  <% if current_user.is_admin? %>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <%= render 'admin/shared/stat_card',
          icon: 'fa-gift',
          icon_color: 'green',
          label: 'Total Dépôts',
          value: @bonus_deposits&.count || 0 %>
      
      <%= render 'admin/shared/stat_card',
          icon: 'fa-check-circle',
          icon_color: 'emerald',
          label: 'Validés',
          value: @bonus_deposits&.select { |d| d.status == 'validated' }&.count || 0,
          value_color: 'green' %>
      
      <%= render 'admin/shared/stat_card',
          icon: 'fa-clock',
          icon_color: 'amber',
          label: 'En Attente',
          value: @bonus_deposits&.select { |d| d.status == 'pending' }&.count || 0,
          value_color: 'amber' %>
      
      <%= render 'admin/shared/stat_card',
          icon: 'fa-euro-sign',
          icon_color: 'cyan',
          label: 'Montant Total',
          value: number_to_currency(@bonus_deposits&.sum(&:amount) || 0, unit: "€", format: "%n%u"),
          value_color: 'cyan' %>
    </div>

    <div class="bg-neutral-900 rounded-xl p-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-lg font-semibold text-white flex items-center gap-2">
            <i class="fa-solid fa-cog text-neutral-400"></i>
            Configuration du Programme
          </h3>
          <p class="text-sm text-neutral-500 mt-1">Gérez les périodes et taux de bonus</p>
        </div>
        <%= link_to admin_bonus_periods_path, class: "flex items-center justify-center gap-1.5 rounded-lg border border-green-400/30 bg-green-600 px-3.5 py-2 text-sm font-medium text-white transition-all hover:bg-green-500" do %>
          <i class="fa-solid fa-calendar"></i>
          <span>Gérer les Périodes</span>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="relative w-full bg-neutral-950 rounded-xl overflow-hidden"
       data-controller="scroll-area"
       data-scroll-area-target="root"
       data-action="mouseenter->scroll-area#onRootMouseEnter mouseleave->scroll-area#onRootMouseLeave">

    <div class="px-6 py-5 flex flex-col md:flex-row md:items-center md:justify-between gap-4 bg-neutral-900">
      <h2 class="text-lg font-semibold text-white flex items-center gap-2">
        <i class="fa-solid fa-gift text-green-400"></i>
        <%= current_user.is_admin? ? 'Tous les Dépôts Bonus' : 'Vos Dépôts Bonus' %>
      </h2>
    </div>

    <% if @bonus_deposits && @bonus_deposits.any? %>
      <div data-scroll-area-target="viewport"
           data-action="scroll->scroll-area#onViewportScroll"
           class="max-h-[600px] overflow-auto scrollbar-hide bg-neutral-950">
        <table class="w-full min-w-[900px]">
          <thead class="sticky top-0 z-10 bg-neutral-900">
            <tr class="*:py-3 *:text-left *:align-middle *:[box-shadow:inset_0_-1px_0_0_rgb(46_46_46)]">
              <% if current_user.is_admin? %>
                <th scope="col" class="px-6 text-sm font-semibold text-neutral-100">Client</th>
              <% end %>
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100">Date</th>
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100 text-right">Montant</th>
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100 text-center">Bonus</th>
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100 text-right">Crédit Total</th>
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100 text-center">Statut</th>
              <% if current_user.is_admin? %>
                <th scope="col" class="px-6 text-sm font-semibold text-neutral-100 text-right">Actions</th>
              <% end %>
            </tr>
          </thead>
          <tbody class="*:even:bg-neutral-900/50 *:*:py-4 bg-neutral-950">
            <% @bonus_deposits.each do |deposit| %>
              <tr class="hover:bg-neutral-800 transition-colors">
                <% if current_user.is_admin? %>
                  <td class="px-6">
                    <% if deposit.user.present? %>
                      <%= render 'admin/shared/avatar', user: deposit.user, size: 'sm', link: admin_client_path(deposit.user) %>
                    <% else %>
                      <span class="text-sm text-neutral-500 italic">—</span>
                    <% end %>
                  </td>
                <% end %>
                <td class="px-6 text-sm text-neutral-300"><%= deposit.created_at.strftime("%d/%m/%Y %H:%M") %></td>
                <td class="px-6 text-right">
                  <span class="font-bold text-green-400"><%= number_to_currency(deposit.amount, precision: 2) %></span>
                </td>
                <td class="px-6 text-center">
                  <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium bg-green-400/10 text-green-400">
                    +<%= number_to_percentage(deposit.bonus_percentage, precision: 0) %>
                  </span>
                </td>
                <td class="px-6 text-right">
                  <span class="text-lg font-bold text-cyan-400"><%= number_to_currency(deposit.total_credit, precision: 2) %></span>
                </td>
                <td class="px-6 text-center">
                  <%= render 'admin/shared/status_badge',
                      label: deposit.status.upcase,
                      variant: deposit.status == 'validated' ? 'success' : deposit.status == 'pending' ? 'warning' : 'danger',
                      pulse: deposit.status == 'pending' %>
                </td>
                <% if current_user.is_admin? %>
                  <td class="px-6">
                    <div class="flex items-center justify-end gap-2">
                      <% if deposit.status == "pending" %>
                        <%= button_to validate_deposit_admin_bonus_deposit_path(deposit), method: :post, class: "flex items-center justify-center w-8 h-8 rounded-lg border border-green-400/30 bg-green-600 text-white hover:bg-green-500 transition-colors", title: "Valider" do %>
                          <i class="fa-solid fa-check text-xs"></i>
                        <% end %>
                        <%= button_to reject_deposit_admin_bonus_deposit_path(deposit), method: :post, class: "flex items-center justify-center w-8 h-8 rounded-lg border border-red-400/30 bg-red-600 text-white hover:bg-red-500 transition-colors", title: "Rejeter" do %>
                          <i class="fa-solid fa-times text-xs"></i>
                        <% end %>
                      <% end %>
                    </div>
                  </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <%= render 'admin/shared/empty_state',
          icon: 'fa-gift',
          icon_gradient: 'from-green-500/20 to-emerald-500/20',
          icon_color: 'text-green-400',
          title: 'Aucun dépôt bonus',
          description: 'Les dépôts bonus apparaîtront ici.' %>
    <% end %>
  </div>
</div>
