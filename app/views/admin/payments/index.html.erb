<!DOCTYPE html>
<html>
<head>
  <title>Payments - Admin Trayo</title>
  <%= stylesheet_link_tag "admin" %>
</head>
<body>
  <% @page_title = "Payments Management" %>
  
  <div class="app-layout">
    <%= render 'admin/shared/sidebar' %>
    
    <div class="main-content">
      <%= render 'admin/shared/navbar' %>
      
      <div class="container">
        <% if flash[:notice] %>
          <div class="notice"><%= flash[:notice] %></div>
        <% end %>
        <% if flash[:alert] %>
          <div class="alert"><%= flash[:alert] %></div>
        <% end %>
        
        <div class="card">
          <h2>All Payments</h2>
          
          <% if @payments && @payments.any? %>
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Client</th>
                  <th>Amount</th>
                  <th>Method</th>
                  <th>Reference</th>
                  <th>Status</th>
                  <th>Notes</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% @payments.each do |payment| %>
                  <tr>
                    <td><%= payment.payment_date.strftime("%Y-%m-%d") %></td>
                    <td>
                      <%= link_to payment.user.email, admin_client_path(payment.user), style: "color: var(--color-accent); text-decoration: none;" %>
                    </td>
                    <td class="positive"><%= number_to_currency(payment.amount, unit: "€", format: "%n %u") %></td>
                    <td><%= payment.payment_method_label %></td>
                    <td><%= payment.reference || "—" %></td>
                    <td>
                      <span class="status-<%= payment.status %>">
                        <%= payment.status.upcase %>
                      </span>
                    </td>
                    <td><%= payment.notes.present? ? truncate(payment.notes, length: 50) : "—" %></td>
                    <td>
                      <div class="action-buttons">
                        <% if payment.status == "pending" %>
                          <%= button_to "Validate", admin_payment_path(payment), method: :patch, params: { action_type: "validate" }, class: "btn btn-success btn-sm" %>
                        <% end %>
                        <%= link_to "View Client", admin_client_path(payment.user), class: "btn btn-primary btn-sm" %>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% else %>
            <p style="color: var(--text-muted); text-align: center; padding: 40px;">No payments yet</p>
          <% end %>
        </div>
        
        <div class="card">
          <h2>Payment Statistics</h2>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Total Payments</div>
              <div class="info-value"><%= @payments ? @payments.count : 0 %></div>
            </div>
            <div class="info-item">
              <div class="info-label">Validated</div>
              <div class="info-value positive"><%= @payments ? @payments.select { |p| p.status == "validated" }.count : 0 %></div>
            </div>
            <div class="info-item">
              <div class="info-label">Pending</div>
              <div class="info-value" style="color: var(--color-warning);"><%= @payments ? @payments.select { |p| p.status == "pending" }.count : 0 %></div>
            </div>
            <div class="info-item">
              <div class="info-label">Total Amount</div>
              <div class="info-value positive">
                <%= @payments ? number_to_currency(@payments.sum(&:amount), unit: "€", format: "%n %u") : "$0.00" %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>

