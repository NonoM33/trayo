<% @page_title = current_user.is_admin? ? 'Gestion VPS' : 'Mes VPS' %>

<div class="space-y-6">
  <% if flash[:notice] %>
    <div class="flex items-center gap-3 p-4 rounded-xl border border-green-500/20 bg-green-500/10">
      <i class="fa-solid fa-check-circle text-green-400"></i>
      <p class="text-green-300"><%= flash[:notice] %></p>
    </div>
  <% end %>
  <% if flash[:alert] %>
    <div class="flex items-center gap-3 p-4 rounded-xl border border-red-500/20 bg-red-500/10">
      <i class="fa-solid fa-exclamation-circle text-red-400"></i>
      <p class="text-red-300"><%= flash[:alert] %></p>
    </div>
  <% end %>

  <% if @vps_list.any? %>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center">
            <i class="fa-solid fa-server text-blue-400"></i>
          </div>
          <div>
            <p class="text-sm text-neutral-400">Total VPS</p>
            <p class="text-2xl font-bold text-white"><%= @vps_list.count %></p>
          </div>
        </div>
      </div>
      
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-green-500/10 flex items-center justify-center">
            <i class="fa-solid fa-check-circle text-green-400"></i>
          </div>
          <div>
            <p class="text-sm text-neutral-400">VPS Actifs</p>
            <p class="text-2xl font-bold text-green-400"><%= @vps_list.select { |v| v.status == 'active' }.count %></p>
          </div>
        </div>
      </div>
      
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-amber-500/10 flex items-center justify-center">
            <i class="fa-solid fa-cog text-amber-400"></i>
          </div>
          <div>
            <p class="text-sm text-neutral-400">En Configuration</p>
            <p class="text-2xl font-bold text-amber-400"><%= @vps_list.select { |v| %w[pending configuring ordered].include?(v.status) }.count %></p>
          </div>
        </div>
      </div>
      
      <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-cyan-500/10 flex items-center justify-center">
            <i class="fa-solid fa-euro-sign text-cyan-400"></i>
          </div>
          <div>
            <p class="text-sm text-neutral-400">Revenu Annuel</p>
            <p class="text-2xl font-bold text-cyan-400"><%= number_to_currency(@vps_list.sum(&:monthly_price), unit: "€", format: "%n%u", precision: 0) %></p>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="relative w-full bg-neutral-950 rounded-xl border border-white/10 overflow-hidden"
       data-controller="scroll-area"
       data-scroll-area-target="root"
       data-action="mouseenter->scroll-area#onRootMouseEnter mouseleave->scroll-area#onRootMouseLeave">

    <div class="px-6 py-5 border-b border-white/10 flex flex-col md:flex-row md:items-center md:justify-between gap-4 bg-neutral-900">
      <h2 class="text-lg font-semibold text-white flex items-center gap-2">
        <i class="fa-solid fa-server text-cyan-400"></i>
        <%= current_user.is_admin? ? 'Liste des VPS' : 'Mes VPS' %>
      </h2>
      <% if current_user.is_admin? %>
        <div data-controller="slideover">
          <button type="button" data-action="slideover#show:prevent" class="flex items-center justify-center gap-1.5 rounded-lg border border-blue-400/30 bg-blue-600 px-3.5 py-2 text-sm font-medium whitespace-nowrap text-white shadow-sm transition-all duration-100 ease-in-out select-none hover:bg-blue-500">
            <i class="fa-solid fa-plus"></i>
            <span>Nouveau VPS</span>
          </button>

          <dialog data-slideover-target="dialog" data-action="mousedown->slideover#backdropClose" class="slideover slideover-right fixed inset-0 m-0 ml-auto h-dvh max-h-full border-l border-neutral-800 outline-hidden bg-transparent p-0">
            <div class="flex h-full w-80 flex-col bg-neutral-950 shadow-2xl sm:w-[480px] lg:w-[520px]">
              <div class="flex items-center justify-between border-b border-neutral-800 bg-neutral-900 px-6 py-5">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white shadow-lg shadow-cyan-500/20">
                    <i class="fa-solid fa-server"></i>
                  </div>
                  <h4 class="text-lg font-semibold text-white">Nouveau VPS</h4>
                </div>
                <button type="button" data-action="slideover#hide:prevent" class="rounded-full p-2 text-neutral-400 transition-colors hover:bg-neutral-800 hover:text-white">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" x2="6" y1="6" y2="18"></line>
                    <line x1="6" x2="18" y1="6" y2="18"></line>
                  </svg>
                </button>
              </div>
              
              <%= form_with model: Vps.new, url: admin_vps_path, method: :post, class: "flex flex-1 flex-col min-h-0" do |f| %>
                <div class="flex-1 overflow-y-auto p-6 space-y-6 bg-neutral-950">
                  
                  <div class="p-4 rounded-xl border border-neutral-800 bg-neutral-900/50 space-y-4">
                    <h5 class="text-sm font-semibold text-neutral-300 flex items-center gap-2">
                      <i class="fa-solid fa-info-circle text-blue-400"></i>
                      Informations VPS
                    </h5>
                    
                    <div>
                      <label class="block text-sm font-medium text-neutral-300 mb-2">Client *</label>
                      <%= f.select :user_id, User.where(is_admin: false).order(:email).map { |c| ["#{c.first_name} #{c.last_name} (#{c.email})", c.id] }, { prompt: 'Sélectionner un client...' }, required: true, class: "w-full px-4 py-3 bg-neutral-900 border border-neutral-800 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" %>
                    </div>
                    
                    <div>
                      <label class="block text-sm font-medium text-neutral-300 mb-2">Nom du VPS *</label>
                      <%= f.text_field :name, required: true, placeholder: "VPS Trading Pro", class: "w-full px-4 py-3 bg-neutral-900 border border-neutral-800 rounded-lg text-white placeholder-neutral-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" %>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-medium text-neutral-300 mb-2">Emplacement</label>
                        <%= f.text_field :server_location, placeholder: "Paris, France", class: "w-full px-4 py-3 bg-neutral-900 border border-neutral-800 rounded-lg text-white placeholder-neutral-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" %>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-neutral-300 mb-2">Adresse IP</label>
                        <%= f.text_field :ip_address, placeholder: "192.168.1.100", class: "w-full px-4 py-3 bg-neutral-900 border border-neutral-800 rounded-lg text-white placeholder-neutral-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" %>
                      </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-medium text-neutral-300 mb-2">Prix annuel (€)</label>
                        <%= f.number_field :monthly_price, step: 0.01, min: 0, value: 399.99, class: "w-full px-4 py-3 bg-neutral-900 border border-neutral-800 rounded-lg text-white placeholder-neutral-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" %>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-neutral-300 mb-2">Statut</label>
                        <%= f.select :status, Vps::STATUSES.map { |k, v| [v, k] }, {}, class: "w-full px-4 py-3 bg-neutral-900 border border-neutral-800 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" %>
                      </div>
                    </div>
                  </div>

                  <div class="p-4 rounded-xl border border-neutral-800 bg-neutral-900/50 space-y-4">
                    <h5 class="text-sm font-semibold text-neutral-300 flex items-center gap-2">
                      <i class="fa-solid fa-key text-amber-400"></i>
                      Accès & Configuration
                    </h5>
                    
                    <div>
                      <label class="block text-sm font-medium text-neutral-300 mb-2">Identifiants d'accès</label>
                      <%= f.text_area :access_credentials, rows: 3, placeholder: "Username: admin\nPassword: ********", class: "w-full px-4 py-3 bg-neutral-900 border border-neutral-800 rounded-lg text-white placeholder-neutral-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none font-mono text-sm" %>
                    </div>
                    
                    <div>
                      <label class="block text-sm font-medium text-neutral-300 mb-2">Notes</label>
                      <%= f.text_area :notes, rows: 2, placeholder: "Notes internes...", class: "w-full px-4 py-3 bg-neutral-900 border border-neutral-800 rounded-lg text-white placeholder-neutral-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none" %>
                    </div>
                  </div>
                </div>
                
                <div class="flex items-center gap-3 border-t border-neutral-800 bg-neutral-900 px-6 py-5">
                  <%= f.submit "Créer le VPS", class: "flex-1 sm:flex-none flex items-center justify-center gap-2 rounded-lg bg-blue-600 px-5 py-2.5 text-sm font-medium text-white shadow-lg shadow-blue-600/25 transition-all hover:bg-blue-500 hover:shadow-blue-500/30 cursor-pointer" %>
                  <button data-action="slideover#hide:prevent" type="button" class="flex items-center justify-center gap-2 rounded-lg border border-neutral-700 bg-neutral-800 px-5 py-2.5 text-sm font-medium text-neutral-300 transition-all hover:bg-neutral-700 hover:text-white">Annuler</button>
                </div>
              <% end %>
            </div>
          </dialog>
        </div>
      <% end %>
    </div>

    <% if @vps_list.any? %>
      <div data-scroll-area-target="viewport"
           data-action="scroll->scroll-area#onViewportScroll"
           class="max-h-[600px] overflow-auto scrollbar-hide bg-neutral-950">
        <table class="w-full min-w-[900px]">
          <thead class="sticky top-0 z-10 bg-neutral-900">
            <tr class="*:py-3 *:text-left *:align-middle *:[box-shadow:inset_0_-1px_0_0_rgb(46_46_46)]">
              <% if current_user.is_admin? %>
                <th scope="col" class="px-6 text-sm font-semibold text-neutral-100">Client</th>
              <% end %>
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100">VPS</th>
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100">Emplacement</th>
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100 text-center">Statut</th>
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100 text-right">Prix/an</th>
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100">Renouvellement</th>
              <th scope="col" class="px-6 text-sm font-semibold text-neutral-100 text-right">Actions</th>
            </tr>
          </thead>
          <tbody class="*:even:bg-neutral-900/50 *:*:py-4 bg-neutral-950">
            <% @vps_list.each do |vps| %>
              <% days_until_renewal = vps.renewal_date ? (vps.renewal_date - Date.today).to_i : nil %>
              <tr class="hover:bg-neutral-800 transition-colors">
                <% if current_user.is_admin? %>
                  <td class="px-6">
                    <%= link_to admin_client_path(vps.user), class: "flex items-center gap-3 group" do %>
                      <div class="w-9 h-9 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-semibold text-sm shrink-0">
                        <%= vps.user.first_name&.first&.upcase || vps.user.email.first.upcase %>
                      </div>
                      <div>
                        <p class="font-medium text-white group-hover:text-blue-400 transition-colors">
                          <%= "#{vps.user.first_name} #{vps.user.last_name}".strip.presence || "N/A" %>
                        </p>
                        <p class="text-xs text-neutral-500"><%= vps.user.email %></p>
                      </div>
                    <% end %>
                  </td>
                <% end %>
                <td class="px-6">
                  <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white shrink-0">
                      <i class="fa-solid fa-server text-sm"></i>
                    </div>
                    <span class="font-medium text-white"><%= vps.name %></span>
                  </div>
                </td>
                <td class="px-6 text-sm text-neutral-300">
                  <span class="flex items-center gap-1.5">
                    <i class="fa-solid fa-globe text-blue-400 text-xs"></i>
                    <%= vps.server_location || 'Non spécifié' %>
                  </span>
                </td>
                <td class="px-6 text-center">
                  <span class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-xs font-medium <%= 
                    case vps.status
                    when 'active' then 'bg-green-400/10 text-green-400 ring-1 ring-inset ring-green-400/25'
                    when 'ready' then 'bg-emerald-400/10 text-emerald-400 ring-1 ring-inset ring-emerald-400/25'
                    when 'configuring' then 'bg-blue-400/10 text-blue-400 ring-1 ring-inset ring-blue-400/25'
                    when 'ordered' then 'bg-amber-400/10 text-amber-400 ring-1 ring-inset ring-amber-400/25'
                    when 'suspended' then 'bg-red-400/10 text-red-400 ring-1 ring-inset ring-red-400/25'
                    when 'cancelled' then 'bg-neutral-400/10 text-neutral-400 ring-1 ring-inset ring-neutral-400/25'
                    else 'bg-neutral-400/10 text-neutral-400 ring-1 ring-inset ring-neutral-400/25'
                    end %>">
                    <% if vps.status == 'active' %>
                      <span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span>
                    <% end %>
                    <%= vps.status_label %>
                  </span>
                </td>
                <td class="px-6 text-right">
                  <span class="text-lg font-bold text-cyan-400"><%= number_to_currency(vps.monthly_price, unit: "€", format: "%n%u") %></span>
                </td>
                <td class="px-6">
                  <% if vps.renewal_date %>
                    <span class="text-sm font-medium <%= 
                      if days_until_renewal && days_until_renewal <= 0
                        'text-red-400'
                      elsif days_until_renewal && days_until_renewal <= 30
                        'text-amber-400'
                      else
                        'text-neutral-300'
                      end %>">
                      <%= vps.renewal_date.strftime("%d/%m/%Y") %>
                      <% if days_until_renewal && days_until_renewal <= 30 && days_until_renewal > 0 %>
                        <span class="text-xs ml-1 px-1.5 py-0.5 rounded bg-amber-400/10">(J-<%= days_until_renewal %>)</span>
                      <% elsif days_until_renewal && days_until_renewal <= 0 %>
                        <span class="text-xs ml-1 px-1.5 py-0.5 rounded bg-red-400/10">Expiré</span>
                      <% end %>
                    </span>
                  <% else %>
                    <span class="text-sm text-neutral-500">Non défini</span>
                  <% end %>
                </td>
                <td class="px-6">
                  <div class="flex items-center justify-end gap-2">
                    <%= link_to admin_vp_path(vps), class: "flex items-center justify-center w-8 h-8 rounded-lg border border-neutral-700 bg-neutral-800 text-neutral-300 hover:bg-neutral-700 hover:text-white transition-colors" do %>
                      <i class="fa-solid fa-eye text-xs"></i>
                    <% end %>
                    <% if current_user.is_admin? %>
                      <%= link_to edit_admin_vp_path(vps), class: "flex items-center justify-center w-8 h-8 rounded-lg border border-amber-400/30 bg-amber-500 text-white hover:bg-amber-400 transition-colors" do %>
                        <i class="fa-solid fa-pen text-xs"></i>
                      <% end %>
                      <%= button_to admin_vp_path(vps), method: :delete, data: { turbo_confirm: "Supprimer ce VPS ?" }, class: "flex items-center justify-center w-8 h-8 rounded-lg border border-red-400/30 bg-red-600 text-white hover:bg-red-500 transition-colors" do %>
                        <i class="fa-solid fa-trash text-xs"></i>
                      <% end %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <div data-scroll-area-target="scrollbar"
           data-scroll-area-orientation-value="vertical"
           data-action="click->scroll-area#onScrollbarClick"
           class="absolute right-2 top-20 bottom-4 flex w-1.5 justify-center rounded-full bg-black/5 backdrop-blur-sm opacity-0 transition-opacity duration-150 delay-300 pointer-events-none data-[hovering]:opacity-100 data-[hovering]:duration-100 data-[hovering]:delay-0 data-[hovering]:pointer-events-auto data-[scrolling]:opacity-100 data-[scrolling]:duration-100 data-[scrolling]:delay-0 data-[scrolling]:pointer-events-auto data-[visible=false]:hidden dark:bg-white/10">
        <div data-scroll-area-target="thumb"
             data-action="mousedown->scroll-area#onThumbMouseDown"
             class="relative w-full rounded-full bg-neutral-500 transition-opacity duration-100 dark:bg-neutral-400"></div>
      </div>
    <% else %>
      <div class="text-center py-16 px-6 bg-neutral-950">
        <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-cyan-500/20 to-blue-500/20 flex items-center justify-center">
          <i class="fa-solid fa-server text-4xl text-cyan-400"></i>
        </div>
        <h3 class="text-xl font-bold text-white mb-2">Aucun VPS pour le moment</h3>
        <% if current_user.is_admin? %>
          <p class="text-neutral-400 mb-8 max-w-md mx-auto">Créez un serveur VPS dédié pour vos clients de trading.</p>
          <button type="button" onclick="document.querySelector('[data-controller=slideover] button[data-action]').click()" class="inline-flex items-center justify-center gap-2 rounded-lg bg-gradient-to-r from-cyan-500 to-blue-600 px-6 py-3 text-sm font-medium text-white shadow-lg shadow-cyan-600/25 transition-all hover:shadow-cyan-500/40 hover:scale-[1.02]">
            <i class="fa-solid fa-plus"></i>
            Créer un VPS
          </button>
        <% else %>
          <p class="text-neutral-400 mb-8 max-w-md mx-auto">Contactez l'administrateur pour commander un VPS dédié au trading.</p>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
