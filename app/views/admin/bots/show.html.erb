<% @page_title = @bot.name %>
<% projections = @bot.calculate_real_projections %>
<% win_rate = @bot.calculate_global_win_rate %>

<div class="space-y-6">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div class="flex items-center gap-4">
      <% if params[:from] == 'client' && params[:client_id].present? %>
        <%= link_to admin_client_path(params[:client_id]), class: "flex items-center justify-center w-10 h-10 rounded-lg border border-neutral-800 bg-neutral-900 text-neutral-400 hover:bg-neutral-800 hover:text-white transition-colors" do %>
          <i class="fa-solid fa-arrow-left"></i>
        <% end %>
      <% elsif params[:from] == 'my_bots' %>
        <%= link_to admin_my_bots_path, class: "flex items-center justify-center w-10 h-10 rounded-lg border border-neutral-800 bg-neutral-900 text-neutral-400 hover:bg-neutral-800 hover:text-white transition-colors" do %>
          <i class="fa-solid fa-arrow-left"></i>
        <% end %>
      <% else %>
        <%= link_to admin_bots_path, class: "flex items-center justify-center w-10 h-10 rounded-lg border border-neutral-800 bg-neutral-900 text-neutral-400 hover:bg-neutral-800 hover:text-white transition-colors" do %>
          <i class="fa-solid fa-arrow-left"></i>
        <% end %>
      <% end %>
      
      <div class="flex items-center gap-4">
        <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white shadow-lg shadow-blue-500/20">
          <i class="fa-solid fa-robot text-2xl"></i>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-white"><%= @bot.name %></h1>
          <div class="flex items-center gap-2 mt-1">
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold <%= 
              case @bot.risk_level&.downcase
              when 'low' then 'bg-green-400/10 text-green-400 ring-1 ring-inset ring-green-400/25'
              when 'medium' then 'bg-yellow-400/10 text-yellow-400 ring-1 ring-inset ring-yellow-400/25'
              when 'high' then 'bg-red-400/10 text-red-400 ring-1 ring-inset ring-red-400/25'
              else 'bg-neutral-400/10 text-neutral-400 ring-1 ring-inset ring-neutral-400/25'
              end %>">
              <%= @bot.risk_label %>
            </span>
            <% if @bot.is_active? %>
              <span class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-xs font-medium bg-green-400/10 text-green-400 ring-1 ring-inset ring-green-400/25">
                <span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span>
                Disponible
              </span>
            <% else %>
              <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium bg-neutral-400/10 text-neutral-400 ring-1 ring-inset ring-neutral-400/25">
                Non disponible
              </span>
            <% end %>
          </div>
        </div>
      </div>
    </div>
    
    <% if current_user.is_admin? %>
      <div class="flex items-center gap-2">
        <%= link_to admin_bot_bot_updates_path(@bot), class: "flex items-center justify-center gap-2 rounded-lg border border-orange-500/30 bg-gradient-to-r from-orange-500 to-red-600 px-4 py-2.5 text-sm font-medium text-white transition-all hover:from-orange-400 hover:to-red-500 shadow-lg shadow-orange-500/20" do %>
          <i class="fa-solid fa-arrow-up-from-bracket text-xs"></i>
          Mises à jour
          <% users_needing = @bot.users_needing_update.count %>
          <% if users_needing > 0 %>
            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-white/20 text-xs font-bold"><%= users_needing %></span>
          <% end %>
        <% end %>
        <%= link_to admin_bot_backtests_path(@bot), class: "flex items-center justify-center gap-2 rounded-lg border border-neutral-700 bg-neutral-800 px-4 py-2.5 text-sm font-medium text-neutral-100 transition-all hover:bg-neutral-700" do %>
          <i class="fa-solid fa-chart-line text-xs"></i>
          Backtests
        <% end %>
        <%= link_to edit_admin_bot_path(@bot), class: "flex items-center justify-center gap-2 rounded-lg border border-amber-400/30 bg-amber-500 px-4 py-2.5 text-sm font-medium text-white transition-all hover:bg-amber-400" do %>
          <i class="fa-solid fa-pen text-xs"></i>
          Modifier
        <% end %>
        <%= button_to admin_bot_path(@bot), method: :delete, data: { turbo_confirm: "Supprimer ce bot ?" }, class: "flex items-center justify-center gap-2 rounded-lg border border-red-400/30 bg-red-600 px-4 py-2.5 text-sm font-medium text-white transition-all hover:bg-red-500" do %>
          <i class="fa-solid fa-trash text-xs"></i>
        <% end %>
      </div>
    <% end %>
  </div>

  <% if flash[:notice] %>
    <div class="flex items-center gap-3 p-4 rounded-xl border border-green-500/20 bg-green-500/10">
      <i class="fa-solid fa-check-circle text-green-400"></i>
      <p class="text-green-300"><%= flash[:notice] %></p>
    </div>
  <% end %>

  <% if @bot.description.present? %>
    <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-5">
      <p class="text-neutral-300"><%= @bot.description %></p>
    </div>
  <% end %>

  <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
    <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
      <p class="text-xs text-neutral-500 uppercase tracking-wide mb-1">Prix</p>
      <p class="text-2xl font-bold text-white"><%= @bot.formatted_price %></p>
    </div>
    
    <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
      <p class="text-xs text-neutral-500 uppercase tracking-wide mb-1">Mensuel</p>
      <p class="text-xl font-bold text-emerald-400">
        <%= number_to_currency(projections[:monthly_max], unit: "€", format: "%n%u", precision: 0) %>
      </p>
      <p class="text-xs text-neutral-500">max estimé</p>
    </div>
    
    <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
      <p class="text-xs text-neutral-500 uppercase tracking-wide mb-1">Annuel</p>
      <p class="text-xl font-bold <%= projections[:yearly] >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
        <%= number_to_currency(projections[:yearly], unit: "€", format: "%n%u", precision: 0) %>
      </p>
    </div>
    
    <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
      <p class="text-xs text-neutral-500 uppercase tracking-wide mb-1">Win Rate</p>
      <p class="text-2xl font-bold text-emerald-400"><%= number_to_percentage(win_rate, precision: 1) %></p>
    </div>
    
    <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
      <p class="text-xs text-neutral-500 uppercase tracking-wide mb-1">Drawdown</p>
      <p class="text-2xl font-bold <%= projections[:drawdown] <= 30 ? 'text-green-400' : projections[:drawdown] <= 60 ? 'text-yellow-400' : 'text-red-400' %>">
        <%= number_to_percentage(projections[:drawdown], precision: 1) %>
      </p>
    </div>
    
    <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-4">
      <p class="text-xs text-neutral-500 uppercase tracking-wide mb-1">Utilisateurs</p>
      <p class="text-2xl font-bold text-blue-400"><%= @bot.active_users_count %></p>
    </div>
  </div>

  <% if @purchases.any? %>
    <% 
      best_purchase = @purchases.max_by { |p| p.total_profit || 0 }
      all_trades = best_purchase&.associated_trades || []
    %>
    
    <% if all_trades.any? %>
      <div class="bg-neutral-950 border border-neutral-800 rounded-xl overflow-hidden">
        <div class="bg-neutral-900 px-6 py-4 border-b border-neutral-800">
          <h2 class="text-lg font-semibold text-white flex items-center gap-2">
            <i class="fa-solid fa-chart-bar text-blue-400"></i>
            Analyse des Performances
          </h2>
        </div>
        
        <div class="p-6">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <% best_day = best_purchase.get_best_performing_day %>
            <% if best_day %>
              <div class="bg-neutral-900 border border-neutral-800 rounded-lg p-4">
                <p class="text-xs text-neutral-500 mb-1">Meilleur Jour</p>
                <p class="text-lg font-bold text-white"><%= best_day[:day_name] %></p>
                <p class="text-sm text-emerald-400"><%= number_to_currency(best_day[:total_profit], unit: "€", format: "%n%u") %></p>
              </div>
            <% end %>
            
            <% best_hour = best_purchase.get_best_performing_hour %>
            <% if best_hour %>
              <div class="bg-neutral-900 border border-neutral-800 rounded-lg p-4">
                <p class="text-xs text-neutral-500 mb-1">Meilleure Heure</p>
                <p class="text-lg font-bold text-white"><%= best_hour[:hour] %>h</p>
                <p class="text-sm text-emerald-400"><%= number_to_currency(best_hour[:total_profit], unit: "€", format: "%n%u") %></p>
              </div>
            <% end %>
            
            <% 
              winning = all_trades.count { |t| (t.profit || 0) > 0 }
              total = all_trades.count
              wr = total > 0 ? (winning.to_f / total * 100).round(1) : 0
            %>
            <div class="bg-neutral-900 border border-neutral-800 rounded-lg p-4">
              <p class="text-xs text-neutral-500 mb-1">Trades Gagnants</p>
              <p class="text-lg font-bold text-emerald-400"><%= winning %>/<%= total %></p>
              <p class="text-sm text-neutral-400"><%= wr %>%</p>
            </div>
            
            <% drawdown_pct = best_purchase.drawdown_percentage %>
            <div class="bg-neutral-900 border border-neutral-800 rounded-lg p-4">
              <p class="text-xs text-neutral-500 mb-1">Drawdown Actuel</p>
              <p class="text-lg font-bold <%= drawdown_pct <= 50 ? 'text-green-400' : drawdown_pct <= 80 ? 'text-yellow-400' : 'text-red-400' %>">
                <%= number_to_percentage(drawdown_pct, precision: 1) %>
              </p>
            </div>
          </div>

          <% day_stats = best_purchase.analyze_by_day_of_week %>
          <% if day_stats.any? %>
            <div class="mb-6">
              <h3 class="text-sm font-semibold text-neutral-300 mb-3 flex items-center gap-2">
                <i class="fa-solid fa-calendar-week text-purple-400"></i>
                Par Jour
              </h3>
              <div class="overflow-x-auto">
                <table class="w-full !bg-transparent !border-0">
                  <thead class="!bg-transparent">
                    <tr class="border-b border-neutral-800">
                      <th class="text-left py-3 px-4 text-xs font-semibold text-neutral-500 uppercase">Jour</th>
                      <th class="text-right py-3 px-4 text-xs font-semibold text-neutral-500 uppercase">Trades</th>
                      <th class="text-right py-3 px-4 text-xs font-semibold text-neutral-500 uppercase">Profit</th>
                      <th class="text-right py-3 px-4 text-xs font-semibold text-neutral-500 uppercase">Gagnants</th>
                      <th class="text-right py-3 px-4 text-xs font-semibold text-neutral-500 uppercase">Perdants</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-neutral-800/50">
                    <% day_stats.sort_by { |d| d[:wday] }.each do |day| %>
                      <tr class="hover:bg-neutral-800/30">
                        <td class="py-3 px-4 text-sm font-medium text-white"><%= day[:day_name] %></td>
                        <td class="py-3 px-4 text-sm text-neutral-400 text-right"><%= day[:total_trades] %></td>
                        <td class="py-3 px-4 text-sm font-medium text-right <%= day[:total_profit] >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
                          <%= number_to_currency(day[:total_profit], unit: "€", format: "%n%u") %>
                        </td>
                        <td class="py-3 px-4 text-sm text-emerald-400 text-right"><%= day[:winning_trades] %></td>
                        <td class="py-3 px-4 text-sm text-red-400 text-right"><%= day[:losing_trades] %></td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          <% end %>

          <% hour_stats = best_purchase.analyze_by_hour %>
          <% if hour_stats.any? %>
            <div>
              <h3 class="text-sm font-semibold text-neutral-300 mb-3 flex items-center gap-2">
                <i class="fa-solid fa-clock text-blue-400"></i>
                Par Heure (Top 8)
              </h3>
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                <% hour_stats.sort_by { |h| -h[:total_profit] }.first(8).each do |hour| %>
                  <div class="bg-neutral-900 border border-neutral-800 rounded-lg p-3">
                    <div class="flex items-center justify-between mb-1">
                      <span class="text-sm font-bold text-white"><%= hour[:hour] %>h</span>
                      <span class="text-xs text-neutral-500"><%= hour[:total_trades] %> trades</span>
                    </div>
                    <p class="text-sm font-medium <%= hour[:total_profit] >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
                      <%= number_to_currency(hour[:total_profit], unit: "€", format: "%n%u") %>
                    </p>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>

  <% if current_user.is_admin? %>
    <div class="bg-neutral-950 border border-neutral-800 rounded-xl overflow-hidden">
      <div class="bg-neutral-900 px-6 py-4 border-b border-neutral-800">
        <h2 class="text-lg font-semibold text-white flex items-center gap-2">
          <i class="fa-solid fa-users text-purple-400"></i>
          Clients (<%= @purchases.count %>)
        </h2>
      </div>
      
      <% if @purchases.any? %>
        <div class="overflow-x-auto">
          <table class="w-full !bg-transparent !border-0">
            <thead class="!bg-transparent">
              <tr class="border-b border-neutral-800">
                <th class="text-left py-3 px-6 text-xs font-semibold text-neutral-500 uppercase">Client</th>
                <th class="text-left py-3 px-6 text-xs font-semibold text-neutral-500 uppercase">Date</th>
                <th class="text-right py-3 px-6 text-xs font-semibold text-neutral-500 uppercase">Prix</th>
                <th class="text-right py-3 px-6 text-xs font-semibold text-neutral-500 uppercase">Profit</th>
                <th class="text-right py-3 px-6 text-xs font-semibold text-neutral-500 uppercase">Trades</th>
                <th class="text-center py-3 px-6 text-xs font-semibold text-neutral-500 uppercase">Statut</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-neutral-800/50">
              <% @purchases.each do |purchase| %>
                <tr class="hover:bg-neutral-800/30 transition-colors">
                  <td class="py-4 px-6">
                    <%= link_to admin_client_path(purchase.user), class: "flex items-center gap-3 group" do %>
                      <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-semibold text-xs">
                        <%= purchase.user.email[0].upcase %>
                      </div>
                      <span class="text-sm text-neutral-300 group-hover:text-white transition-colors"><%= purchase.user.email %></span>
                    <% end %>
                  </td>
                  <td class="py-4 px-6 text-sm text-neutral-400"><%= purchase.created_at.strftime("%d/%m/%Y") %></td>
                  <td class="py-4 px-6 text-sm text-neutral-300 text-right"><%= number_to_currency(purchase.price_paid, unit: "€", format: "%n%u") %></td>
                  <td class="py-4 px-6 text-sm font-medium text-right <%= (purchase.total_profit || 0) >= 0 ? 'text-emerald-400' : 'text-red-400' %>">
                    <%= number_to_currency(purchase.total_profit || 0, unit: "€", format: "%n%u") %>
                  </td>
                  <td class="py-4 px-6 text-sm text-neutral-400 text-right"><%= purchase.trades_count || 0 %></td>
                  <td class="py-4 px-6 text-center">
                    <% if purchase.status == 'active' %>
                      <span class="inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs font-medium bg-green-400/10 text-green-400 ring-1 ring-inset ring-green-400/25">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-400"></span>
                        Actif
                      </span>
                    <% else %>
                      <span class="inline-flex items-center rounded-full px-2 py-1 text-xs font-medium bg-neutral-400/10 text-neutral-400 ring-1 ring-inset ring-neutral-400/25">
                        Inactif
                      </span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="text-center py-12 px-6">
          <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-neutral-800 flex items-center justify-center">
            <i class="fa-solid fa-users text-2xl text-neutral-600"></i>
          </div>
          <p class="text-neutral-400">Aucun client n'utilise ce bot pour le moment</p>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
