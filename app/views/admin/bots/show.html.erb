<!DOCTYPE html>
<html>
<head>
  <title><%= @bot.name %> - Admin Trayo</title>
  <%= stylesheet_link_tag "admin" %>
</head>
<body>
  <% @page_title = @bot.name %>
  
  <div class="app-layout">
    <%= render 'admin/shared/sidebar' %>
    
    <div class="main-content">
      <%= render 'admin/shared/navbar' %>
      
      <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <% if params[:from] == 'client' && params[:client_id].present? %>
            <%= link_to admin_client_path(params[:client_id]), class: "back-link", style: "margin: 0;" do %>
              <i class="fa-icon fa-md fa-arrow-left"></i> Retour au Client
            <% end %>
          <% elsif params[:from] == 'my_bots' %>
            <%= link_to admin_my_bots_path, class: "back-link", style: "margin: 0;" do %>
              <i class="fa-icon fa-md fa-arrow-left"></i> Retour à Mes Bots
            <% end %>
          <% else %>
            <%= link_to admin_bots_path, class: "back-link", style: "margin: 0;" do %>
              <i class="fa-icon fa-md fa-arrow-left"></i> Retour aux Bots
            <% end %>
          <% end %>
          <% if current_user.is_admin? %>
            <div style="display: flex; gap: 12px;">
              <%= link_to edit_admin_bot_path(@bot), class: "btn btn-primary" do %>
                <i class="fa-icon fa-md fa-edit"></i>
                Modifier
              <% end %>
              <%= button_to admin_bot_path(@bot), method: :delete,
                  data: { turbo_confirm: "Supprimer ce bot ?" }, class: "btn btn-danger" do %>
                <i class="fa-icon fa-md fa-trash"></i>
                Supprimer
              <% end %>
            </div>
          <% end %>
        </div>

        <% if flash[:notice] %>
          <div class="notice"><%= flash[:notice] %></div>
        <% end %>

        <div class="card">
          <div style="display: flex; align-items: start; gap: 24px;">
            <div style="width: 120px; height: 120px; background: linear-gradient(135deg, var(--color-accent), var(--color-accent-hover)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 48px; color: white;">
              <i class="fa-icon fa-md fa-robot"></i>
            </div>
            
            <div style="flex: 1;">
              <h2 style="margin: 0 0 12px 0;"><%= @bot.name %></h2>
              <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                <span class="risk-badge risk-<%= @bot.risk_level.downcase %>">
                  <%= @bot.risk_label %>
                </span>
                <% if @bot.is_active? %>
                  <span class="status-badge status-validated">Disponible</span>
                <% else %>
                  <span class="status-badge status-inactive">Non Disponible</span>
                <% end %>
              </div>
              <p style="margin: 0; color: var(--text-secondary);"><%= @bot.description %></p>
            </div>
          </div>
        </div>

        <div class="two-col">
          <div class="card">
            <h3>
              <i class="fa-icon fa-md fa-credit-card"></i>
              Informations Financières
            </h3>
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">Prix</div>
                <div class="info-value positive"><%= @bot.formatted_price %></div>
              </div>
              <div class="info-item">
                <div class="info-label">Projection Mensuelle</div>
                <div class="info-value">
                  <%= number_to_currency(@bot.projection_monthly_min, unit: "€", format: "%n %u") %> - 
                  <%= number_to_currency(@bot.projection_monthly_max, unit: "€", format: "%n %u") %>
                </div>
              </div>
              <div class="info-item">
                <div class="info-label">Projection Annuelle</div>
                <div class="info-value positive">
                  <%= number_to_currency(@bot.projection_yearly, unit: "€", format: "%n %u") %>
                </div>
              </div>
              <div class="info-item">
                <div class="info-label">Drawdown Max</div>
                <div class="info-value negative">
                  <%= number_to_percentage(@bot.max_drawdown_limit, precision: 1) %>%
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>
              <i class="fa-icon fa-md fa-chart-line"></i>
              Performances
            </h3>
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">Taux de Réussite</div>
                <div class="info-value positive"><%= number_to_percentage(@bot.win_rate, precision: 1) %></div>
              </div>
              <div class="info-item">
                <div class="info-label">Utilisateurs Actifs</div>
                <div class="info-value"><%= @bot.active_users_count %></div>
              </div>
              <div class="info-item">
                <div class="info-label">Performance Moyenne</div>
                <div class="info-value <%= @bot.average_performance > 0 ? 'positive' : 'negative' %>">
                  <%= number_to_currency(@bot.average_performance, unit: "€", format: "%n %u") %>
                </div>
              </div>
              <div class="info-item">
                <div class="info-label">Statut</div>
                <div class="info-value">
                  <% if @bot.status == 'active' %>
                    <span style="color: #4CAF50;"><i class="fa-icon fa-md fa-check-circle"></i> Actif</span>
                  <% else %>
                    <span style="color: #999;"><i class="fa-icon fa-md fa-times-circle"></i> Inactif</span>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>

        <% if @bot.strategy_description.present? %>
          <div class="card">
            <h3>
              <i class="fa-icon fa-md fa-brain"></i>
              Stratégie de Trading
            </h3>
            <p style="white-space: pre-wrap; line-height: 1.6;"><%= @bot.strategy_description %></p>
          </div>
        <% end %>

        <% if @bot.features_list.any? %>
          <div class="card">
            <h3>
              <i class="fa-icon fa-md fa-star"></i>
              Caractéristiques Clés
            </h3>
            <ul style="list-style: none; padding: 0; margin: 0;">
              <% @bot.features_list.each do |feature| %>
                <li style="padding: 12px; margin-bottom: 8px; background: var(--bg-hover); border-radius: 8px; display: flex; align-items: center; gap: 12px;">
                  <i class="fa-icon fa-md fa-check-circle"></i>
                  <span><%= feature %></span>
                </li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div class="card">
          <h3>
            <i class="fa-icon fa-md fa-chart-bar"></i>
            Analyse des Performances
          </h3>
          <% if @purchases.any? %>
            <% 
              # Analyser les statistiques des meilleurs purchases
              best_purchase = @purchases.max_by { |p| p.total_profit || 0 }
              most_active_purchase = @purchases.max_by { |p| p.trades_count || 0 }
            %>
            
            <% if best_purchase && best_purchase.associated_trades.any? %>
              <div class="info-grid" style="margin-bottom: 24px;">
                <div class="info-item">
                  <div class="info-label">Meilleur Jour (profit)</div>
                  <% best_day = best_purchase.get_best_performing_day %>
                  <% if best_day %>
                    <div class="info-value positive"><%= best_day[:day_name] %></div>
                    <div class="help-text">
                      <%= number_to_currency(best_day[:total_profit], unit: "€", format: "%n %u") %> 
                      (<%= best_day[:total_trades] %> trades)
                    </div>
                  <% else %>
                    <div class="info-value">N/A</div>
                  <% end %>
                </div>
                
                <div class="info-item">
                  <div class="info-label">Jour le Plus Actif</div>
                  <% active_day = best_purchase.get_most_active_day %>
                  <% if active_day %>
                    <div class="info-value"><%= active_day[:day_name] %></div>
                    <div class="help-text">
                      <%= active_day[:total_trades] %> trades
                      (<%= number_to_currency(active_day[:total_profit], unit: "€", format: "%n %u") %>)
                    </div>
                  <% else %>
                    <div class="info-value">N/A</div>
                  <% end %>
                </div>
                
                <div class="info-item">
                  <div class="info-label">Jour le Plus Risqué</div>
                  <% risk_day = best_purchase.get_riskiest_day %>
                  <% if risk_day %>
                    <div class="info-value <%= risk_day[:total_profit] > 0 ? 'positive' : 'negative' %>">
                      <%= risk_day[:day_name] %>
                    </div>
                    <div class="help-text">
                      <%= risk_day[:losing_trades] %> trades perdants
                    </div>
                  <% else %>
                    <div class="info-value">N/A</div>
                  <% end %>
                </div>
                
                <div class="info-item">
                  <div class="info-label">Meilleure Heure</div>
                  <% best_hour = best_purchase.get_best_performing_hour %>
                  <% if best_hour %>
                    <div class="info-value positive"><%= best_hour[:hour] %>h</div>
                    <div class="help-text">
                      <%= number_to_currency(best_hour[:total_profit], unit: "€", format: "%n %u") %>
                      (<%= best_hour[:total_trades] %> trades)
                    </div>
                  <% else %>
                    <div class="info-value">N/A</div>
                  <% end %>
                </div>
              </div>
              
              <div class="info-grid" style="margin-bottom: 24px;">
                <div class="info-item">
                  <div class="info-label">Heure la Plus Active</div>
                  <% active_hour = best_purchase.get_most_active_hour %>
                  <% if active_hour %>
                    <div class="info-value"><%= active_hour[:hour] %>h</div>
                    <div class="help-text">
                      <%= active_hour[:total_trades] %> trades
                      (<%= number_to_currency(active_hour[:total_profit], unit: "€", format: "%n %u") %>)
                    </div>
                  <% else %>
                    <div class="info-value">N/A</div>
                  <% end %>
                </div>
                
                <div class="info-item">
                  <div class="info-label">Durée Moyenne des Trades</div>
                  <% duration = best_purchase.analyze_trade_duration %>
                  <% if duration[:avg_duration_minutes] == 0 && duration[:avg_duration_hours] == 0 %>
                    <div class="info-value" style="color: #999;">Non disponible</div>
                    <div class="help-text" style="font-size: 11px;">
                      Les timestamps MT5 sont identiques pour open/close
                    </div>
                  <% else %>
                    <div class="info-value">
                      <%= format_duration(duration[:avg_duration_minutes]) %>
                    </div>
                    <div class="help-text">
                      Min: <%= format_duration(duration[:min_duration_minutes]) %>
                      | Max: <%= format_duration(duration[:max_duration_minutes]) %>
                    </div>
                  <% end %>
                </div>
                
                <div class="info-item">
                  <div class="info-label">Taux de Réussite Global</div>
                  <% 
                    all_trades = best_purchase.associated_trades
                    winning = all_trades.count { |t| (t.profit || 0) > 0 }
                    win_rate = all_trades.any? ? (winning.to_f / all_trades.count * 100).round(2) : 0
                  %>
                  <div class="info-value positive"><%= win_rate %>%</div>
                  <div class="help-text">
                    <%= winning %> gagnants / <%= all_trades.count %> total
                  </div>
                </div>
                
                <div class="info-item">
                  <div class="info-label">Drawdown Max</div>
                  <% 
                    drawdown_pct = best_purchase.drawdown_percentage
                    drawdown_amount = best_purchase.get_current_drawdown
                  %>
                  <div class="info-value <%= drawdown_pct <= 80 ? 'positive' : drawdown_pct <= 95 ? '' : 'negative' %>">
                    <%= number_to_percentage(drawdown_pct, precision: 1) %>%
                  </div>
                  <div class="help-text">
                    <%= number_to_currency(drawdown_amount, unit: "€", format: "%n %u") %>
                    sur <%= number_to_currency(best_purchase.trading_bot.max_drawdown_limit, unit: "€", format: "%n %u") %>
                  </div>
                </div>
              </div>
              
              <% 
                day_stats = best_purchase.analyze_by_day_of_week 
                hour_stats = best_purchase.analyze_by_hour 
              %>
              
              <% if day_stats.any? %>
                <h4 style="margin-bottom: 16px;">📊 Analyse par Jour de la Semaine</h4>
                <div class="table-wrapper">
                  <table>
                    <thead>
                      <tr>
                        <th>Jour</th>
                        <th>Trades</th>
                        <th>Profit Total</th>
                        <th>Profit Moyen</th>
                        <th>Gagnants</th>
                        <th>Perdants</th>
                        <th>Commission</th>
                        <th>Swap</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% day_stats.sort_by { |d| d[:wday] }.each do |day| %>
                        <tr>
                          <td><strong><%= day[:day_name] %></strong></td>
                          <td><%= day[:total_trades] %></td>
                          <td class="<%= day[:total_profit] >= 0 ? 'positive' : 'negative' %>">
                            <%= number_to_currency(day[:total_profit], unit: "€", format: "%n %u") %>
                          </td>
                          <td class="<%= day[:avg_profit] >= 0 ? 'positive' : 'negative' %>">
                            <%= number_to_currency(day[:avg_profit], unit: "€", format: "%n %u") %>
                          </td>
                          <td style="color: #10b981;"><%= day[:winning_trades] %></td>
                          <td style="color: #ef4444;"><%= day[:losing_trades] %></td>
                          <td><%= number_to_currency(day[:total_commission], unit: "€", format: "%n %u") %></td>
                          <td><%= number_to_currency(day[:total_swap], unit: "€", format: "%n %u") %></td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              <% end %>
              
              <% if hour_stats.any? %>
                <h4 style="margin-top: 24px; margin-bottom: 16px;">⏰ Analyse par Heure</h4>
                <div class="table-wrapper">
                  <table>
                    <thead>
                      <tr>
                        <th>Heure</th>
                        <th>Trades</th>
                        <th>Profit Total</th>
                        <th>Profit Moyen</th>
                        <th>Gagnants</th>
                        <th>Perdants</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% hour_stats.each do |hour| %>
                        <tr>
                          <td><strong><%= hour[:hour] %>h</strong></td>
                          <td><%= hour[:total_trades] %></td>
                          <td class="<%= hour[:total_profit] >= 0 ? 'positive' : 'negative' %>">
                            <%= number_to_currency(hour[:total_profit], unit: "€", format: "%n %u") %>
                          </td>
                          <td class="<%= hour[:avg_profit] >= 0 ? 'positive' : 'negative' %>">
                            <%= number_to_currency(hour[:avg_profit], unit: "€", format: "%n %u") %>
                          </td>
                          <td style="color: #10b981;"><%= hour[:winning_trades] %></td>
                          <td style="color: #ef4444;"><%= hour[:losing_trades] %></td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              <% end %>
            <% else %>
              <p style="text-align: center; color: var(--text-muted); padding: 20px;">
                Aucune donnée de trading disponible pour l'analyse
              </p>
            <% end %>
          <% else %>
            <p style="text-align: center; color: var(--text-muted); padding: 20px;">
              Aucun client n'utilise ce bot pour le moment
            </p>
          <% end %>
        </div>

        <% if current_user.is_admin? %>
          <div class="card">
            <h3>
              <i class="fa-icon fa-md fa-users"></i>
              Clients Utilisant ce Bot
            </h3>
            <% if @purchases.any? %>
            <table>
              <thead>
                <tr>
                  <th>Client</th>
                  <th>Date d'Achat</th>
                  <th>Prix Payé</th>
                  <th>Statut</th>
                  <th>Profit Total</th>
                  <th>Trades</th>
                  <th>Actif</th>
                </tr>
              </thead>
              <tbody>
                <% @purchases.each do |purchase| %>
                  <tr>
                    <td>
                      <%= link_to admin_client_path(purchase.user) do %>
                        <span style="color: white;"><%= purchase.user.email %></span>
                      <% end %>
                    </td>
                    <td><%= purchase.created_at.strftime("%d/%m/%Y") %></td>
                    <td><%= number_to_currency(purchase.price_paid, unit: "€", format: "%n %u") %></td>
                    <td>
                      <% if purchase.status == 'active' %>
                        <span style="color: #4CAF50;">Actif</span>
                      <% else %>
                        <span style="color: #999;">Inactif</span>
                      <% end %>
                    </td>
                    <td class="<%= purchase.total_profit > 0 ? 'positive' : 'negative' %>">
                      <%= number_to_currency(purchase.total_profit, unit: "€", format: "%n %u") %>
                    </td>
                    <td><%= purchase.trades_count %></td>
                    <td>
                      <%= purchase.status_badge %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
            <% else %>
              <p style="text-align: center; color: var(--text-muted); padding: 40px;">
                Aucun client n'utilise ce bot pour le moment
              </p>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</body>
</html>
