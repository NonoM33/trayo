<% @page_title = "Gestion des Bots de Trading" %>

<% if flash[:notice] %>
  <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 text-green-800 dark:text-green-200 px-4 py-3 rounded-lg mb-4">
    <%= flash[:notice] %>
  </div>
<% end %>
<% if flash[:alert] %>
  <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-800 dark:text-red-200 px-4 py-3 rounded-lg mb-4">
    <%= flash[:alert] %>
  </div>
<% end %>

<% if @bots.any? %>
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-neutral-50 dark:bg-neutral-900 rounded-lg p-4 border border-neutral-200 dark:border-neutral-800">
      <div class="text-sm text-neutral-600 dark:text-neutral-400 mb-1">Total Bots</div>
      <div class="text-2xl font-bold text-blue-600 dark:text-blue-400"><%= @bots.count %></div>
    </div>
    <div class="bg-neutral-50 dark:bg-neutral-900 rounded-lg p-4 border border-neutral-200 dark:border-neutral-800">
      <div class="text-sm text-neutral-600 dark:text-neutral-400 mb-1">Bots Actifs</div>
      <div class="text-2xl font-bold text-green-600 dark:text-green-400"><%= @bots.select(&:is_active?).count %></div>
    </div>
    <div class="bg-neutral-50 dark:bg-neutral-900 rounded-lg p-4 border border-neutral-200 dark:border-neutral-800">
      <div class="text-sm text-neutral-600 dark:text-neutral-400 mb-1">Utilisateurs Totaux</div>
      <div class="text-2xl font-bold text-purple-600 dark:text-purple-400"><%= @bots.sum(&:active_users_count) %></div>
    </div>
    <div class="bg-neutral-50 dark:bg-neutral-900 rounded-lg p-4 border border-neutral-200 dark:border-neutral-800">
      <div class="text-sm text-neutral-600 dark:text-neutral-400 mb-1">Taux Moyen RÃ©ussite</div>
      <div class="text-2xl font-bold text-green-600 dark:text-green-400"><%= number_to_percentage(@bots.average(:win_rate) || 0, precision: 1) %></div>
    </div>
  </div>
<% end %>

<div class="bg-neutral-50 dark:bg-neutral-900 rounded-lg border border-neutral-200 dark:border-neutral-800 p-6">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-xl font-bold text-neutral-900 dark:text-white">Bots de Trading</h2>
    <%= link_to "Nouveau Bot", new_admin_bot_path, class: "px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors" %>
  </div>
  
  <% if @bots.any? %>
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr class="border-b border-neutral-200 dark:border-neutral-800">
            <th class="text-left py-3 px-4 text-sm font-semibold text-neutral-700 dark:text-neutral-300">Bot</th>
            <th class="text-left py-3 px-4 text-sm font-semibold text-neutral-700 dark:text-neutral-300">Prix</th>
            <th class="text-left py-3 px-4 text-sm font-semibold text-neutral-700 dark:text-neutral-300">Risque</th>
            <th class="text-left py-3 px-4 text-sm font-semibold text-neutral-700 dark:text-neutral-300">Projection Mensuelle</th>
            <th class="text-left py-3 px-4 text-sm font-semibold text-neutral-700 dark:text-neutral-300">Win Rate</th>
            <th class="text-left py-3 px-4 text-sm font-semibold text-neutral-700 dark:text-neutral-300">Statut</th>
            <th class="text-left py-3 px-4 text-sm font-semibold text-neutral-700 dark:text-neutral-300">Utilisateurs</th>
            <th class="text-left py-3 px-4 text-sm font-semibold text-neutral-700 dark:text-neutral-300">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @bots.each do |bot| %>
            <tr class="border-b border-neutral-200 dark:border-neutral-800 hover:bg-neutral-100 dark:hover:bg-neutral-800/50">
              <td class="py-3 px-4">
                <div class="font-semibold text-neutral-900 dark:text-white"><%= bot.name %></div>
                <% tagline = bot.real_marketing_tagline %>
                <% if tagline.present? %>
                  <div class="text-sm text-neutral-600 dark:text-neutral-400"><%= tagline.truncate(40) %></div>
                <% end %>
              </td>
              <td class="py-3 px-4">
                <div class="font-bold text-neutral-900 dark:text-white"><%= bot.formatted_price %></div>
              </td>
              <td class="py-3 px-4">
                <span class="px-2 py-1 rounded text-xs font-semibold <%= bot.risk_level.downcase == 'low' ? 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400' : bot.risk_level.downcase == 'medium' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400' : 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400' %>">
                  <%= bot.risk_label %>
                </span>
              </td>
              <td class="py-3 px-4 text-sm font-semibold">
                <% projections = bot.calculate_real_projections %>
                <%= number_to_currency(projections[:monthly_min], unit: "â‚¬", format: "%n %u", precision: 0) %> - 
                <%= number_to_currency(projections[:monthly_max], unit: "â‚¬", format: "%n %u", precision: 0) %>
              </td>
              <td class="py-3 px-4">
                <% win_rate = bot.calculate_global_win_rate %>
                <div class="flex items-center gap-2">
                  <div class="flex-1 h-2 bg-neutral-200 dark:bg-neutral-700 rounded-full overflow-hidden">
                    <div class="h-full bg-green-500 rounded-full" style="width: <%= win_rate %>%;"></div>
                  </div>
                  <span class="text-sm font-bold text-green-600 dark:text-green-400 min-w-[50px]">
                    <%= number_to_percentage(win_rate, precision: 1) %>
                  </span>
                </div>
              </td>
              <td class="py-3 px-4">
                <% if bot.is_active? %>
                  <span class="px-2 py-1 rounded text-xs font-semibold bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400">Actif</span>
                <% else %>
                  <span class="px-2 py-1 rounded text-xs font-semibold bg-neutral-100 text-neutral-800 dark:bg-neutral-800 dark:text-neutral-400">Inactif</span>
                <% end %>
              </td>
              <td class="py-3 px-4 text-center">
                <span class="px-2 py-1 rounded text-xs font-semibold bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400">
                  <%= bot.active_users_count %>
                </span>
              </td>
              <td class="py-3 px-4">
                <div class="flex gap-2">
                  <%= link_to "Voir", admin_bot_path(bot), class: "px-3 py-1 text-sm border border-neutral-300 dark:border-neutral-700 rounded hover:bg-neutral-100 dark:hover:bg-neutral-800" %>
                  <%= link_to "Modifier", edit_admin_bot_path(bot), class: "px-3 py-1 text-sm bg-yellow-600 hover:bg-yellow-700 text-white rounded" %>
                  <%= button_to "Supprimer", admin_bot_path(bot), method: :delete, 
                      data: { turbo_confirm: "Supprimer ce bot ?" }, 
                      class: "px-3 py-1 text-sm bg-red-600 hover:bg-red-700 text-white rounded" %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="text-center py-20">
      <div class="text-6xl mb-6">ðŸ¤–</div>
      <h3 class="text-xl font-bold text-neutral-900 dark:text-white mb-2">Aucun bot pour le moment</h3>
      <p class="text-neutral-600 dark:text-neutral-400 mb-6">CrÃ©ez votre premier bot de trading intelligent</p>
      <%= link_to "CrÃ©er mon Premier Bot", new_admin_bot_path, class: "px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors" %>
    </div>
  <% end %>
</div>
