<!DOCTYPE html>
<html>
<head>
  <title>Gestion des Bots - Admin Trayo</title>
  <%= stylesheet_link_tag "admin" %>
</head>
<body>
  <% @page_title = "Gestion des Bots de Trading" %>
  
  <div class="app-layout">
    <%= render 'admin/shared/sidebar' %>
    
    <div class="main-content">
      <%= render 'admin/shared/navbar' %>
      
      <div class="container">
        <% if flash[:notice] %>
          <div class="notice"><%= flash[:notice] %></div>
        <% end %>
        <% if flash[:alert] %>
          <div class="alert"><%= flash[:alert] %></div>
        <% end %>

        <% if @bots.any? %>
          <div class="info-grid" style="margin-bottom: 32px;">
            <div class="info-item">
              <div class="info-label">Total Bots</div>
              <div class="info-value" style="color: var(--color-accent);"><%= @bots.count %></div>
            </div>
            <div class="info-item">
              <div class="info-label">Bots Actifs</div>
              <div class="info-value positive"><%= @bots.select(&:is_active?).count %></div>
            </div>
            <div class="info-item">
              <div class="info-label">Utilisateurs Totaux</div>
              <div class="info-value" style="color: var(--color-info);"><%= @bots.sum(&:active_users_count) %></div>
            </div>
            <div class="info-item">
              <div class="info-label">Taux Moyen Réussite</div>
              <div class="info-value" style="color: var(--color-success);"><%= number_to_percentage(@bots.average(:win_rate) || 0, precision: 1) %></div>
            </div>
          </div>
        <% end %>

        <div class="card-enhanced">
          <div class="card-enhanced-header">
            <h2 class="card-enhanced-title">
              <i class="fa-icon fa-md fa-robot" style="margin-right: 8px;" aria-hidden="true"></i>
              Bots de Trading
            </h2>
            <%= link_to new_admin_bot_path, class: "btn btn-primary", style: "display: inline-flex; align-items: center; gap: 8px;" do %>
              <i class="fa-icon fa-md fa-plus" aria-hidden="true"></i>
              Nouveau Bot
            <% end %>
          </div>
          
          <!-- Filtres et Recherche -->
          <div class="filters-section" style="margin-bottom: var(--spacing-lg);">
            <div class="filters-form">
              <div class="filters-grid">
                <div class="filter-group">
                  <label class="filter-label">Recherche</label>
                  <input type="text" id="botSearch" class="filter-input" placeholder="Rechercher un bot..." onkeyup="filterBots()">
                </div>
                <div class="filter-group">
                  <label class="filter-label">Statut</label>
                  <select id="statusFilter" class="filter-select" onchange="filterBots()">
                    <option value="">Tous</option>
                    <option value="active">Actif</option>
                    <option value="inactive">Inactif</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label class="filter-label">Risque</label>
                  <select id="riskFilter" class="filter-select" onchange="filterBots()">
                    <option value="">Tous</option>
                    <option value="low">Faible</option>
                    <option value="medium">Moyen</option>
                    <option value="high">Élevé</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label class="filter-label">Tri</label>
                  <select id="sortFilter" class="filter-select" onchange="sortBots()">
                    <option value="name">Nom (A-Z)</option>
                    <option value="price">Prix</option>
                    <option value="users">Utilisateurs</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          
          <% if @bots.any? %>
            <div class="grid-12 gutter-md" id="botsGrid">
              <% @bots.each do |bot| %>
                <div class="col-12 col-md-6 col-lg-4 bot-card-item" 
                     data-name="<%= bot.name.downcase %>" 
                     data-status="<%= bot.is_active? ? 'active' : 'inactive' %>"
                     data-risk="<%= bot.risk_level.downcase %>"
                     data-price="<%= bot.price %>"
                     data-users="<%= bot.active_users_count %>">
                  <div class="card-enhanced" style="height: 100%; display: flex; flex-direction: column;">
                    <div style="flex: 1;">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-md);">
                        <div style="flex: 1;">
                          <h3 style="margin: 0 0 var(--spacing-xs) 0; font-size: var(--font-size-lg); font-weight: var(--font-weight-bold);">
                            <%= bot.name %>
                          </h3>
                          <% tagline = bot.real_marketing_tagline %>
                          <% if tagline.present? %>
                            <p style="margin: 0; font-size: var(--font-size-sm); color: var(--text-muted);">
                              <%= tagline.truncate(60) %>
                            </p>
                          <% end %>
                        </div>
                        <div class="dropdown" style="position: relative;">
                          <button class="icon-btn outline sm" onclick="event.stopPropagation(); this.closest('.dropdown').classList.toggle('active');" aria-label="Actions">
                            <i class="fa-icon fa-md fa-ellipsis-v"></i>
                          </button>
                          <ul class="dropdown-menu" style="right: 0; left: auto;">
                            <li><%= link_to "Voir", admin_bot_path(bot), class: "dropdown-item" %></li>
                            <li><%= link_to "Modifier", edit_admin_bot_path(bot), class: "dropdown-item" %></li>
                            <li class="dropdown-divider"></li>
                            <li>
                              <%= button_to "Supprimer", admin_bot_path(bot), method: :delete, 
                                  data: { turbo_confirm: "Supprimer ce bot ?" }, 
                                  class: "dropdown-item",
                                  style: "color: var(--color-danger); background: none; border: none; width: 100%; text-align: left; cursor: pointer; padding: 8px 16px;" %>
                            </li>
                          </ul>
                        </div>
                      </div>
                      
                      <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                        <span class="risk-badge risk-<%= bot.risk_level.downcase %>">
                          <%= bot.risk_label %>
                        </span>
                        <% if bot.is_active? %>
                          <span class="status-active">Actif</span>
                        <% else %>
                          <span class="status-inactive">Inactif</span>
                        <% end %>
                      </div>
                      
                      <div style="margin-bottom: var(--spacing-md);">
                        <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-accent);">
                          <%= bot.formatted_price %>
                        </div>
                        <% projections = bot.calculate_real_projections %>
                        <div style="font-size: var(--font-size-sm); color: var(--text-muted); margin-top: var(--spacing-xs);">
                          <%= number_to_currency(projections[:monthly_min], unit: "€", format: "%n %u", precision: 0) %> - 
                          <%= number_to_currency(projections[:monthly_max], unit: "€", format: "%n %u", precision: 0) %>/mois
                        </div>
                      </div>
                      
                      <div style="display: flex; justify-content: space-between; align-items: center; padding-top: var(--spacing-md); border-top: 1px solid var(--border-color);">
                        <div>
                          <div style="font-size: var(--font-size-xs); color: var(--text-muted); margin-bottom: var(--spacing-xs);">Win Rate</div>
                          <% win_rate = bot.calculate_global_win_rate %>
                          <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <div style="flex: 1; height: 6px; background: var(--bg-hover); border-radius: var(--radius-full); overflow: hidden;">
                              <div style="width: <%= win_rate %>%; height: 100%; background: var(--gradient-success); border-radius: var(--radius-full);"></div>
                            </div>
                            <span class="positive" style="font-weight: var(--font-weight-semibold); font-size: var(--font-size-sm); min-width: 45px;">
                              <%= number_to_percentage(win_rate, precision: 1) %>
                            </span>
                          </div>
                        </div>
                        <div style="text-align: right;">
                          <div style="font-size: var(--font-size-xs); color: var(--text-muted); margin-bottom: var(--spacing-xs);">Utilisateurs</div>
                          <span class="status-badge" style="background: var(--bg-info-box); color: var(--color-info);">
                            <%= bot.active_users_count %>
                          </span>
                        </div>
                      </div>
                    </div>
                    
                    <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--border-color);">
                      <%= link_to "Voir les détails", admin_bot_path(bot), class: "btn btn-outline", style: "width: 100%;" %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div style="text-align: center; padding: 80px 24px; color: var(--text-muted);">
              <div style="font-size: 72px; margin-bottom: 24px; animation: bounce 2s infinite;"><i class="fa-icon fa-md fa-robot"></i></div>
              <h3 style="margin: 0 0 12px 0; font-size: 24px; color: var(--text-primary);">Aucun bot pour le moment</h3>
              <p style="margin: 0 0 32px 0; font-size: 16px;">Créez votre premier bot de trading intelligent</p>
              <%= link_to "Créer mon Premier Bot", new_admin_bot_path, class: "btn btn-success btn-lg" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Floating Action Button pour mobile -->
  <% unless current_user.is_admin? %>
    <%= link_to new_admin_bot_path, { class: "fab", id: "fabAddBot", "aria-label": "Ajouter un bot" } do %>
      <i class="fa-icon fa-md fa-plus"></i>
    <% end %>
  <% end %>
  
  <script>
    function filterBots() {
      const search = document.getElementById('botSearch').value.toLowerCase();
      const status = document.getElementById('statusFilter').value;
      const risk = document.getElementById('riskFilter').value;
      const cards = document.querySelectorAll('.bot-card-item');
      
      cards.forEach(card => {
        const name = card.dataset.name;
        const cardStatus = card.dataset.status;
        const cardRisk = card.dataset.risk;
        
        const matchesSearch = !search || name.includes(search);
        const matchesStatus = !status || cardStatus === status;
        const matchesRisk = !risk || cardRisk === risk;
        
        if (matchesSearch && matchesStatus && matchesRisk) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });
    }
    
    function sortBots() {
      const sortBy = document.getElementById('sortFilter').value;
      const grid = document.getElementById('botsGrid');
      const cards = Array.from(grid.querySelectorAll('.bot-card-item'));
      
      cards.sort((a, b) => {
        switch(sortBy) {
          case 'name':
            return a.dataset.name.localeCompare(b.dataset.name);
          case 'price':
            return parseFloat(b.dataset.price) - parseFloat(a.dataset.price);
          case 'users':
            return parseInt(b.dataset.users) - parseInt(a.dataset.users);
          default:
            return 0;
        }
      });
      
      cards.forEach(card => grid.appendChild(card));
    }
  </script>
</body>
</html>

